import{j as e,B as G,l as N,m as y,r as d,I as re,aA as ae,aE as Z,aF as ne,aG as K,w as k,ad as ue,at as he,a7 as pe,au as me,aH as ge,aI as fe,aJ as ee,L as Q,y as le,aK as xe,T as X,N as be,aL as _e,S as se,F as we,G as je,J as ve,K as Ce,t as ke}from"./index-C80WCJxQ.js";import{d as ye,L as Se}from"./LiveMapTopBar-DT-KzeG8.js";import{V as Be}from"./VehicleMenu-kymceFR7.js";import{L as De,t as Te}from"./LeftSideBar2-DM6YFDmN.js";import"./Loader-BeUh3DG4.js";import"./LiveMapServices-BtUYyrPm.js";import"./Socket-0N_gnJcr.js";import{T as R,P as Ie}from"./Parameters-nOW1tpk2.js";/* empty css           */import"./proj-XQwXs9DQ.js";import{M as ie,D as ce,a as Pe,T as Le}from"./TablePagination-DlJ-ZBoO.js";import{D as de,a as Ae,E as Ve,T as qe}from"./Edit-BwU6Huch.js";import{B as L,F as Ee,a as Oe}from"./menu2-CFXc4SKc.js";import{T as Re,a as Fe}from"./TableHead-zFMKDUqv.js";import{T as We,b as te,a as Me}from"./TableRow-ClB4Msc9.js";import{u as $e}from"./formik.esm-Cx9KS4gr.js";import{c as Ge,a as D}from"./index.esm-318LxAl7.js";import{A as oe}from"./Autocomplete-BrxF0nam.js";import{T as P,M as Ne,a as z}from"./TextField-ClTxL0ks.js";import{S as Ue}from"./SearchInput-BDN8omBg.js";import{V as He}from"./VehicleGroups-BGRaV0P7.js";import"./createSvgIcon-BK9GXnLR.js";import"./useControlled-hauubYp4.js";import"./jcb-aCHXMCXy.js";import"./index-DCFRHXqm.js";import"./index-Co4BIDnM.js";import"./index-CTpo5nt8.js";import"./Card-DtaOBkgE.js";import"./CardContent-ByW9qawY.js";const Je=({open:v,onClose:g,onConfirm:w})=>e.jsxs(ie,{open:v,onClose:g,children:[e.jsx(de,{children:"Confirm Deletion"}),e.jsx(ce,{children:e.jsxs(Ae,{children:["Are you sure you want to delete this vehicle data?"," ",e.jsx("span",{style:{color:"red"},children:"This action cannot be undone."})]})}),e.jsxs(Pe,{children:[e.jsx(G,{onClick:g,color:"primary",children:"Cancel"}),e.jsx(G,{onClick:w,color:"secondary",children:"Delete"})]})]}),Ye="http://134.209.145.234/api/v1",ze={display:"flex",alignItems:"left",justifyContent:"left",gap:"8px"},Ke=({inspectionData:v})=>{const g=N(),{isUpdateInspection:w}=y(x=>x.inspection),[f,o]=d.useState(!1),C=()=>{console.log("inspectionData",v);const x=localStorage.getItem("role");ae.includes(x)?(g(Z(!w)),g(ne(v)),g(K(v))):k.error(`Sorry! Your role is ${x}. You're not allowed to add, edit or delete the vehicle`)},b=async()=>{console.log("Vehicle data deleting");try{await ue.delete(`${Ye}/vehicles/delete/${vehicleData.id}/`),k.success("Vehicle data deleted successfully!"),g(he())}catch(x){console.error("Error deleting vehicle data:",x),k.error("Failed to delete vehicle data. Please try again.")}o(!1)},j=()=>{o(!1)},_={color:"#686868"};return e.jsxs(L,{sx:ze,children:[e.jsx(re,{onClick:C,children:e.jsx(Ve,{sx:_})}),e.jsx(Je,{open:f,onClose:j,onConfirm:b})]})},Qe=[{id:"BDID",label:"BDID"},{id:"User",label:"User"},{id:"SubmissionDate",label:"Submission Date"},{id:"WorkshopGroup",label:"Workshop Group"},{id:"Status",label:"Status"},{id:"Actions",label:"Actions"}],Xe=()=>{const{breakdowns:v}=y(t=>t.breakdown),{searchTerm:g}=y(t=>t.inspection),[w,f]=d.useState("asc"),[o,C]=d.useState("BDID"),[b,j]=d.useState(0),[_,x]=d.useState(5),[q,S]=d.useState({id:"",status:"",workshop:"",user:""}),m=t=>{f(o===t&&w==="asc"?"desc":"asc"),C(t)},T=(t,n)=>{j(n)},s=t=>{x(parseInt(t.target.value,10)),j(0)},E=(t,n,u)=>t.filter(i=>{const c=u.toLowerCase(),h=i.breakdown_id.toLowerCase().includes(c),F=`${i.user.us_user.first_name} ${i.user.us_user.last_name}`.toLowerCase().includes(c),U=i.status.toLowerCase().includes(c),p=i.workshop_group.group_name.toLowerCase().includes(c);return!(u&&!(h||F||U||p)||n.id&&!i.breakdown_id.includes(n.id)||n.status&&i.status!==n.status||n.workshop&&i.workshop_group.group_name!==n.workshop||n.user&&!i.user.us_user.first_name.toLowerCase().includes(n.user.toLowerCase())&&!i.user.us_user.last_name.toLowerCase().includes(n.user.toLowerCase()))}),A=(t,n,u,i)=>{if(i==="User"){const c=`${t.user.us_user.first_name} ${t.user.us_user.last_name}`.toLowerCase(),h=`${n.user.us_user.first_name} ${n.user.us_user.last_name}`.toLowerCase();return u==="asc"?c.localeCompare(h):h.localeCompare(c)}if(i==="WorkshopGroup"){const c=t.workshop_group.group_name.toLowerCase(),h=n.workshop_group.group_name.toLowerCase();return u==="asc"?c.localeCompare(h):h.localeCompare(c)}if(i==="BDID"){const c=parseInt(t.breakdown_id.replace("BD-",""),10),h=parseInt(n.breakdown_id.replace("BD-",""),10);return u==="asc"?c-h:h-c}if(i==="SubmissionDate"){const c=new Date(t.submission_date),h=new Date(n.submission_date);return u==="asc"?c-h:h-c}if(i==="Status"){const c={Open:1,Close:2,Rejected:3},h=c[t.status]||0,F=c[n.status]||0;return u==="asc"?h-F:F-h}return 0},V=E(v.slice(),q,g).sort((t,n)=>A(t,n,w,o)),r=V.slice(b*_,b*_+_),l={fontSize:"14px",fontWeight:"bold",fontFamily:"Ubuntu",color:"black",cursor:"pointer",background:"#f2f2f2"};return e.jsx(L,{sx:{m:"10px"},children:e.jsxs(pe,{children:[e.jsx(Re,{sx:{height:"73vh",bgcolor:"white",borderRadius:"10px"},children:e.jsxs(We,{stickyHeader:!0,children:[e.jsx(Fe,{children:e.jsx(te,{children:Qe.map(t=>e.jsx(R,{sx:l,children:e.jsx(qe,{active:o===t.id,direction:o===t.id?w:"asc",onClick:()=>m(t.id),children:t.label})},t.id))})}),e.jsx(Me,{children:r.map((t,n)=>e.jsxs(te,{children:[e.jsx(R,{children:t.breakdown_id}),e.jsx(R,{children:`${t.user.us_user.first_name} ${t.user.us_user.last_name}`}),e.jsx(R,{children:t.submission_date||"N/A"}),e.jsx(R,{children:t.workshop_group.group_name}),e.jsx(R,{sx:{color:t.status==="Open"?"blue":t.status==="Close"?"green":"red"},children:t.status}),e.jsx(R,{children:e.jsx(Ke,{inspectionData:t})})]},n))})]})}),e.jsx(Le,{component:"div",count:V.length,page:b,onPageChange:T,rowsPerPage:_,onRowsPerPageChange:s,rowsPerPageOptions:[5,10,15]})]})})},Ze=Xe;function es({searchTerm:v}){var A,V;const{vehicles_details:g}=y(r=>r.dashboard),{breakdownTopics:w,UpdatedBreakdownData:f}=y(r=>r.breakdown),{UpdatedInspectionData:o}=y(r=>r.inspection),{w_customer_id:C}=y(r=>r.auth),[b,j]=d.useState(null),[_,x]=d.useState(""),[q,S]=d.useState(!1);let m=N(),T=JSON.parse(localStorage.getItem("w_userDetails"));d.useEffect(()=>{console.log("UpdatedInspectionData",o)},[o]),d.useEffect(()=>{o&&(j(o.attachment),x("edit"))},[o]);const s=$e({initialValues:{vehicle:((A=o==null?void 0:o.vehicle)==null?void 0:A.id)||"",breakdown_topic:((V=o==null?void 0:o.breakdown_topic)==null?void 0:V.id)||"",odometer_reading:(o==null?void 0:o.odometer_reading)||"",description:(o==null?void 0:o.description)||"",mob_no:(o==null?void 0:o.mob_no)||"",email:(o==null?void 0:o.email)||"",attachment:(o==null?void 0:o.attachment)||"",submitted_by:`${T.first_name} ${T.last_name}`||"",resolved_issue:"",pending_issue:"",status:"Open"},validationSchema:Ge({vehicle:D().required("Vehicle is required"),breakdown_topic:D().required("Breakdown Topic is required"),odometer_reading:D().required("Odometer Reading is required"),description:D().required("Description is required"),mob_no:D().matches(/^\d{10,11}$/,"Mobile number must be 10-11 digits").required("Mobile number is required"),email:D().email("Invalid email format").required("Email is required"),resolved_issue:D().required("Resolved issue is required"),pending_issue:D().required("Pending issue is required"),status:D().oneOf(["Open","Close","Rejected"],"Invalid status").required("Status is required"),submitted_by:D().required("Submitted is required")}),onSubmit:async(r,{resetForm:l})=>{try{S(!0),console.log("Submitted values:",r),r.submitted_by=T.user_id,r.location=f.location,r.breakdown=f.id,r.workshop_group=f.workshop_group.id;const t=[];if(f){let i=await me(f.attachment);console.log("file conversion",i),r.attachment=i;const c=f.id;t.push(m(ge({values:r,id:c})))}t.push(m(fe({values:r})));const n=await Promise.allSettled(t);let u=!0;n.forEach((i,c)=>{if(i.status==="fulfilled"){const h=i.value.payload;h.success?(c===0&&f?k.success("Breakdown updated successfully!"):k.success("Inspection created successfully!"),l(),x(""),j(null),m(K(null)),m(Z(!1)),m(ne(null)),m(ee(!1)),m(Q(C)),m(le()),S(!1)):(u=!1,k.error(h.error||"Failed to submit breakdown or inspection"))}else u=!1,k.error(i.reason.message||"Error occurred during submission")}),u&&(l(),x(""),j(null),m(K(null)),m(ee(!1)),m(xe(!1)),m(Q(C))),S(!1)}catch(t){console.error("Submission Error:",t),k.error("Failed to submit breakdown or inspection. Please try again."),S(!1)}}}),E=r=>{const l=r.currentTarget.files[0];if(s.setFieldValue("attachment",l),x((l==null?void 0:l.name)||""),l&&l.type.startsWith("image/")){const t=new FileReader;t.onload=()=>j(t.result),t.readAsDataURL(l)}else j(null)};return e.jsx(L,{sx:{p:3,maxWidth:600,margin:"auto"},children:q?e.jsx(X,{children:"Submitted the form data..."}):e.jsx(e.Fragment,{children:e.jsxs("form",{onSubmit:s.handleSubmit,children:[e.jsx(oe,{options:g,getOptionLabel:r=>r.registration_id,value:g.find(r=>r.id===s.values.vehicle)||null,onChange:(r,l)=>s.setFieldValue("vehicle",(l==null?void 0:l.id)||""),renderInput:r=>e.jsx(P,{...r,label:"Vehicle",error:s.touched.vehicle&&!!s.errors.vehicle,helperText:s.touched.vehicle&&s.errors.vehicle,fullWidth:!0})}),e.jsx(oe,{options:w,getOptionLabel:r=>r.topic,value:w.find(r=>r.id===s.values.breakdown_topic)||null,onChange:(r,l)=>s.setFieldValue("breakdown_topic",(l==null?void 0:l.id)||""),renderOption:(r,l)=>d.createElement("li",{...r,key:l.id},l.topic),renderInput:r=>e.jsx(P,{...r,label:"Breakdown Topic",error:s.touched.breakdown_topic&&!!s.errors.breakdown_topic,helperText:s.touched.breakdown_topic&&s.errors.breakdown_topic,fullWidth:!0,sx:{mt:2}})}),e.jsx(P,{label:"Odometer Reading",name:"odometer_reading",value:s.values.odometer_reading,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.odometer_reading&&!!s.errors.odometer_reading,helperText:s.touched.odometer_reading&&s.errors.odometer_reading,fullWidth:!0,sx:{mt:2}}),e.jsx(P,{label:"Description",name:"description",value:s.values.description,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.description&&!!s.errors.description,helperText:s.touched.description&&s.errors.description,fullWidth:!0,sx:{mt:2}}),e.jsx(P,{label:"Mobile Number",name:"mob_no",value:s.values.mob_no,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.mob_no&&!!s.errors.mob_no,helperText:s.touched.mob_no&&s.errors.mob_no,fullWidth:!0,sx:{mt:2}}),e.jsx(P,{label:"Email",name:"email",type:"email",value:s.values.email,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.email&&!!s.errors.email,helperText:s.touched.email&&s.errors.email,fullWidth:!0,sx:{mt:2}}),e.jsx(P,{label:"Submitted By",name:"submitted_by",value:s.values.submitted_by,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.submitted_by&&!!s.errors.submitted_by,helperText:s.touched.submitted_by&&s.errors.submitted_by,fullWidth:!0,sx:{mt:2}}),e.jsx(P,{label:"Resolved Issue",name:"resolved_issue",value:s.values.resolved_issue,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.resolved_issue&&!!s.errors.resolved_issue,helperText:s.touched.resolved_issue&&s.errors.resolved_issue,fullWidth:!0,sx:{mt:2}}),e.jsx(P,{label:"Pending Issue",name:"pending_issue",value:s.values.pending_issue,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.pending_issue&&!!s.errors.pending_issue,helperText:s.touched.pending_issue&&s.errors.pending_issue,fullWidth:!0,sx:{mt:2}}),e.jsxs(Ee,{fullWidth:!0,sx:{mt:2},children:[e.jsx(Oe,{children:"Status"}),e.jsxs(Ne,{label:"Status",name:"status",value:s.values.status,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.status&&!!s.errors.status,children:[e.jsx(z,{value:"Open",children:"Open"}),e.jsx(z,{value:"Close",children:"Close"}),e.jsx(z,{value:"Rejected",children:"Rejected"})]})]}),e.jsxs(G,{component:"label",sx:{mt:2,border:"1px solid #f5f5f5",color:"black"},children:["Upload Attachment",e.jsx("input",{type:"file",hidden:!0,onChange:E})]}),_&&e.jsxs(X,{variant:"body2",sx:{mt:1},children:["Uploaded File: ",_]}),b&&e.jsx(L,{component:"img",src:b,alt:"Image Preview",sx:{mt:1,width:"100%",maxHeight:200}}),e.jsx(G,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,sx:{mt:3},children:"Submit"})]})})})}function ss({where:v}){const{isUpdateInspection:g,UpdatedInspectionData:w}=y(b=>b.inspection);let f=N();const o=()=>{f(Z(!1))},C={fontSize:"18px",fontWeight:500,lineHeight:"18.38px",textAlign:"center",paddingTop:"5px",fontFamily:"ubuntu"};return e.jsxs(L,{sx:{bgcolor:"white",m:"10px",display:"flex",textAlign:"left",justifyContent:"space-between",alignItems:"center",borderRadius:"6px",padding:"20px"},children:[e.jsx(Ue,{}),e.jsx(X,{variant:"h6",sx:C,children:"New Breakdown Requests"}),e.jsxs(ie,{open:g,onClose:o,maxWidth:"md",fullWidth:!0,children:[e.jsxs(de,{children:["Update Breakdown Status",e.jsx(re,{"aria-label":"close",onClick:o,sx:{position:"absolute",right:8,top:8,color:b=>b.palette.grey[500]},children:e.jsx(ye,{})})]}),e.jsx(ce,{children:e.jsx(es,{})})]})]})}function Ps(){const{locationData:v,selectedVehicle:g,selectedParameterList:w}=y(p=>p.liveMap),{mode:f,selectedVehicleGroup:o}=y(p=>p.dashboard),C=Te(f),[b,j]=d.useState([]),{w_customer_id:_}=y(p=>p.auth),[x,q]=d.useState(),[S,m]=d.useState(!1),[T,s]=d.useState(!1),[E,A]=d.useState([]);d.useState(!0);const[V,r]=d.useState(!1),[l,t]=d.useState(!1),n=JSON.parse(localStorage.getItem("w_userDetails"));let u=N(),i=be();d.useEffect(()=>{ae.includes(n.role)?console.log("you can access this route"):(console.log("you can't access this route"),c())},[]);const c=()=>{console.log("oh! this route not allowed"),i("/dashboard"),k.error("You're not allowed to access inspection.")};d.useEffect(()=>{h(),u(le()),u(Q(_)),u(_e())},[]),d.useEffect(()=>{A([]),u(se([{reg_id:"",imei:"",params:[]}]))},[g]);const h=async()=>{try{t(!0);let p=[],I=[];const W=await u(we({w_customer_id:_}));if(Array.isArray(W.payload)){W.payload.forEach(a=>{var M,O,Y,B;Array.isArray(a.imei)&&a.imei.length>0&&((M=a.imei[0])!=null&&M.mac_id)?(p.push({id:a.id,label:a.registration_id,value:(O=a.imei[0])==null?void 0:O.mac_id,vehilce_type:a==null?void 0:a.segment,chassis_no:a==null?void 0:a.chassis_no,engine_no:a==null?void 0:a.engine_no,workShop:a==null?void 0:a.workshop,registration_id:a==null?void 0:a.registration_id,sell_date:a==null?void 0:a.sell_date,customer_name:a==null?void 0:a.customer_name,vehicle_model:(Y=a==null?void 0:a.vehicle_model)==null?void 0:Y.name,vehicle_group:a==null?void 0:a.vehicle_group}),I.push((B=a.imei[0])==null?void 0:B.mac_id)):console.error("IMEI data not found for item:",a)});const H="one",J=I;I.length>0&&u(je({type:H,imei:J})),j(p),u(ve(p)),t(!1),u(Ce({w_customer_id:_}))}else t(!1),console.error("Unexpected data format:",W),k.error("Unexpected data format:")}catch(p){console.error("Error fetching vehicle data:",p),k.error(`Error fetching vehicle data: ${p}`)}},F=async p=>{const{label:I,imei:W,id:H,reg_id:J,checked:a}=p;q(B=>B.map($=>$.id===H?{...$,checked:!a}:$));let M=[...E],O=[...E];if(!a)v.forEach(B=>{B.latestDocument.imei===W&&(M.push({label:I,value:B.latestDocument[I==="maininputvoltage"?"mainInputVoltage":I]}),O=M,A(M))});else{let B=E.filter($=>$.label!==I);O=B,A(B)}console.log("tempParamList",O),u(se([{reg_id:J,imei:W,params:O}]))},U=b.filter(p=>Object.keys(o).length===0||p.vehicle_group===o.id);return e.jsxs("div",{className:"app",children:[e.jsx(De,{}),e.jsxs("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:[e.jsx(Se,{title:"Inspections",setShowVehicles:m,showVehicles:S,setShowVehiclesGroup:r,showVehiclesGroup:V}),e.jsx(He,{setShowVehiclesGroup:r,showVehiclesGroup:V}),e.jsxs(L,{style:{display:"flex",width:"100%",height:"95vh"},children:[e.jsxs(L,{style:{width:S||T?"80%":"100%",background:ke.bgShadow},children:[e.jsx(ss,{where:"inspection"}),e.jsx(Ze,{})]}),S&&e.jsx(L,{style:{width:"20%",backgroundColor:C.grey[100]},children:e.jsx(Be,{vehicleData:U,title:"Inspections",setParameterData:q,loadingVehicle:l,setShowVehicles:m,showVehicles:S,showParameters:T,setShowParameters:s})}),T&&e.jsx(L,{style:{width:"20%",backgroundColor:C.grey[100]},children:e.jsx(Ie,{parametersData:x,setParameterData:q,handleParameterChange:F})})]})]})]})}export{Ps as default};
