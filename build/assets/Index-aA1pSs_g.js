import{c as le,j as e,B as W,i as N,k as y,r as c,I as Y,aN as Q,aK as Z,ac as ie,q as B,ae as ce,J as X,a6 as de,az as ue,aL as he,aQ as pe,aO as J,T as K,aR as me,t as te,aP as ge,P as ee,D as xe,E as fe,H as be,G as we}from"./index-C2R-h_GK.js";import{d as _e,L as je}from"./LiveMapTopBar-CUZjyb7_.js";import{V as ke}from"./VehicleMenu-1cidQdJw.js";import{L as Ce,t as ve}from"./LeftSideBar2-Ca56j9LJ.js";import"./Loader-DCg_lMYG.js";import"./LiveMapServices-Crsk9j6B.js";import"./Socket-0N_gnJcr.js";import{P as ye}from"./Parameters-B4czr-Tp.js";/* empty css           */import"./proj-XQwXs9DQ.js";import{M as re,D as ae,a as Se,T as Be}from"./TablePagination-DVDmssnl.js";import{D as ne,a as Le,E as De,T as Te}from"./Edit-CdVI4Xgf.js";import{B as D}from"./menu2-kNFC5OGf.js";import{T as Pe,a as Ae}from"./TableHead-C4sw742j.js";import{T as Ie,b as oe,a as Ve}from"./TableRow--3GlRT-B.js";import{T as F}from"./TableCell-SXThuXH9.js";import{d as Ee}from"./Add-Dcki_os4.js";import{u as Fe}from"./formik.esm-CUd-5DmB.js";import{c as qe,a as q}from"./index.esm-C24zpc25.js";import{A as se}from"./Autocomplete-B6V5HFWU.js";import{T as R}from"./TextField-C88VS50p.js";import{S as Re}from"./SearchInput-BBJR4hgw.js";import{V as Me}from"./VehicleGroups-C9JR-tI6.js";import"./createSvgIcon-Cxx9lPp_.js";import"./useControlled-B1v3_3J2.js";import"./jcb-aCHXMCXy.js";import"./index-BaCpmYHv.js";import"./index-CqA8f-s-.js";import"./index-BhgM9pO9.js";import"./Card-CPcAUniM.js";import"./CardContent-DPYcc4DD.js";const Oe=le(e.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"}),"Delete"),We=({open:h,onClose:x,onConfirm:f})=>e.jsxs(re,{open:h,onClose:x,children:[e.jsx(ne,{children:"Confirm Deletion"}),e.jsx(ae,{children:e.jsxs(Le,{children:["Are you sure you want to delete this vehicle data?"," ",e.jsx("span",{style:{color:"red"},children:"This action cannot be undone."})]})}),e.jsxs(Se,{children:[e.jsx(W,{onClick:x,color:"primary",children:"Cancel"}),e.jsx(W,{onClick:f,color:"secondary",children:"Delete"})]})]}),$e="http://134.209.145.234/api/v1",Ge={display:"flex",alignItems:"left",justifyContent:"left",gap:"8px"},Ne=({breakdownData:h})=>{const x=N(),{isUpdateBreakdown:f}=y(g=>g.equipment),{w_customer_id:a}=y(g=>g.auth),[m,p]=c.useState(!1),j=()=>{console.log("breakdownData",h),localStorage.getItem("role"),x(Q(!f)),x(Z(h))},_=()=>{console.log("dlt btn clicked");const g=localStorage.getItem("role");ie.includes(g)?p(!0):B.error(`Sorry! Your role is ${g}. You're not allowed to add, edit or delete the vehicle`)},b=async()=>{console.log("breakdownData data deleting");try{await ce.delete(`${$e}/vehicles/breakdown/create/${h.id}/`),B.success("breakdownData data deleted successfully!"),x(X(a))}catch(g){console.error("Error deleting breakdown data:",g),B.error("Failed to delete breakdown data. Please try again.")}p(!1)},L=()=>{p(!1)},k={color:"#686868"};return e.jsxs(D,{sx:Ge,children:[e.jsx(Y,{onClick:j,children:e.jsx(De,{sx:k})}),e.jsx(Y,{onClick:_,children:e.jsx(Oe,{sx:k})}),e.jsx(We,{open:m,onClose:L,onConfirm:b})]})},He=[{id:"BDID",label:"BDID"},{id:"User",label:"User"},{id:"SubmissionDate",label:"Submission Date"},{id:"WorkshopGroup",label:"Workshop Group"},{id:"Status",label:"Status"},{id:"Actions",label:"Actions"}],ze=()=>{const{breakdowns:h}=y(t=>t.breakdown),{searchTerm:x}=y(t=>t.inspection),[f,a]=c.useState("asc"),[m,p]=c.useState("BDID"),[j,_]=c.useState(0),[b,L]=c.useState(5),[k,g]=c.useState({id:"",status:"",workshop:"",user:""}),I=t=>{a(m===t&&f==="asc"?"desc":"asc"),p(t)},T=(t,o)=>{_(o)},C=t=>{L(parseInt(t.target.value,10)),_(0)},s=(t,o,l)=>t.filter(n=>{const i=l.toLowerCase(),u=n.breakdown_id.toLowerCase().includes(i),v=`${n.user.us_user.first_name} ${n.user.us_user.last_name}`.toLowerCase().includes(i),d=n.status.toLowerCase().includes(i),w=n.workshop_group.group_name.toLowerCase().includes(i);return!(l&&!(u||v||d||w)||o.id&&!n.breakdown_id.includes(o.id)||o.status&&n.status!==o.status||o.workshop&&n.workshop_group.group_name!==o.workshop||o.user&&!n.user.us_user.first_name.toLowerCase().includes(o.user.toLowerCase())&&!n.user.us_user.last_name.toLowerCase().includes(o.user.toLowerCase()))}),$=(t,o,l,n)=>{if(n==="User"){const i=`${t.user.us_user.first_name} ${t.user.us_user.last_name}`.toLowerCase(),u=`${o.user.us_user.first_name} ${o.user.us_user.last_name}`.toLowerCase();return l==="asc"?i.localeCompare(u):u.localeCompare(i)}if(n==="WorkshopGroup"){const i=t.workshop_group.group_name.toLowerCase(),u=o.workshop_group.group_name.toLowerCase();return l==="asc"?i.localeCompare(u):u.localeCompare(i)}if(n==="BDID"){const i=parseInt(t.breakdown_id.replace("BD-",""),10),u=parseInt(o.breakdown_id.replace("BD-",""),10);return l==="asc"?i-u:u-i}if(n==="SubmissionDate"){const i=new Date(t.submission_date),u=new Date(o.submission_date);return l==="asc"?i-u:u-i}if(n==="Status"){const i={Open:1,Close:2,Rejected:3},u=i[t.status]||0,v=i[o.status]||0;return l==="asc"?u-v:v-u}return 0},P=s(h.slice(),k,x).sort((t,o)=>$(t,o,f,m)),V=P.slice(j*b,j*b+b),M={fontSize:"14px",fontWeight:"bold",fontFamily:"Ubuntu",color:"black",cursor:"pointer",background:"#f2f2f2"};return e.jsx(D,{sx:{m:"10px"},children:e.jsxs(de,{children:[e.jsx(Pe,{sx:{height:"73vh",bgcolor:"white",borderRadius:"10px"},children:e.jsxs(Ie,{stickyHeader:!0,children:[e.jsx(Ae,{children:e.jsx(oe,{children:He.map(t=>e.jsx(F,{sx:M,children:e.jsx(Te,{active:m===t.id,direction:m===t.id?f:"asc",onClick:()=>I(t.id),children:t.label})},t.id))})}),e.jsx(Ve,{children:V.map((t,o)=>e.jsxs(oe,{children:[e.jsx(F,{children:t.breakdown_id}),e.jsx(F,{children:`${t.user.us_user.first_name} ${t.user.us_user.last_name}`}),e.jsx(F,{children:t.submission_date||"N/A"}),e.jsx(F,{children:t.workshop_group.group_name}),e.jsx(F,{sx:{color:t.status==="Open"?"blue":t.status==="Close"?"green":"red"},children:t.status}),e.jsx(F,{children:e.jsx(Ne,{breakdownData:t})})]},o))})]})}),e.jsx(Be,{component:"div",count:P.length,page:j,onPageChange:T,rowsPerPage:b,onRowsPerPageChange:C,rowsPerPageOptions:[5,10,15]})]})})},Ue=ze;function Ye(){var M,t;const{vehicles_details:h}=y(o=>o.dashboard),{w_customer_id:x}=y(o=>o.auth),{breakdownTopics:f,UpdatedBreakdownData:a}=y(o=>o.breakdown),[m,p]=c.useState(null),[j,_]=c.useState(""),[b,L]=c.useState(!1),[k,g]=c.useState(!1),[I,T]=c.useState("");let C=N();c.useEffect(()=>{a&&(p(a.attachment),_("edit"))},[a]);const s=Fe({initialValues:{vehicle:((M=a==null?void 0:a.vehicle)==null?void 0:M.id)||"",breakdown_topic:((t=a==null?void 0:a.breakdown_topic)==null?void 0:t.id)||"",odometer_reading:(a==null?void 0:a.odometer_reading)||"",description:(a==null?void 0:a.description)||"",mob_no:(a==null?void 0:a.mob_no)||"",email:(a==null?void 0:a.email)||"",attachment:(a==null?void 0:a.attachment)||"",location:(a==null?void 0:a.location)||""},validationSchema:qe({vehicle:q().required("Vehicle is required"),breakdown_topic:q().required("Breakdown Topic is required"),odometer_reading:q().required("Odometer Reading is required"),description:q().required("Description is required"),mob_no:q().matches(/^\d{10,11}$/,"Mobile number must be 10-11 digits").required("Mobile number is required"),email:q().email("Invalid email format").required("Email is required"),location:q().required("Location is required")}),onSubmit:async(o,{resetForm:l})=>{var n,i,u;try{L(!0),console.log("Submitted values:",o);const v=P(o.vehicle);o.user=v[0].user.id,o.status="Open",o.workshop_group=(u=(i=(n=v[0])==null?void 0:n.workShop)==null?void 0:i.group_name)==null?void 0:u.id,o.submission_date=new Date().toISOString().split("T")[0];let d;if(a){let w=await ue(a.attachment);console.log("file conversion",w),o.attachment=w;const A=a.id;d=await C(he({values:o,id:A}))}else d=await C(pe(o));if(d.payload.success)B.success("Breakdown submitted successfully!"),l(),_(""),p(null),C(Z(null)),C(Q(!1)),C(J(!1)),C(X(x)),L(!1);else throw L(!1),new Error(d.payload.error||"Failed to submit breakdown")}catch(v){console.error("Submission Error:",v),B.error("Failed to submit breakdown. Please try again.")}}}),$=async()=>{g(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition(async o=>{const{latitude:l,longitude:n}=o.coords;try{const i=await me(l,n);s.setFieldValue("location",i)}catch(i){console.error("Error fetching address:",i),B.error("Failed to convert coordinates to address.")}finally{g(!1)}},o=>{console.error("Geolocation Error:",o),B.error("Failed to retrieve location. Please try again."),g(!1)}):(B.error("Geolocation is not supported by this browser."),g(!1))},P=o=>(h==null?void 0:h.length)>0&&h.filter(n=>n.id===o),V=o=>{const l=o.currentTarget.files[0];if(s.setFieldValue("attachment",l),_((l==null?void 0:l.name)||""),l&&l.type.startsWith("image/")){const n=new FileReader;n.onload=()=>p(n.result),n.readAsDataURL(l)}else p(null)};return e.jsx(D,{sx:{p:3,maxWidth:600,margin:"auto"},children:b?e.jsx(K,{children:"Submitted the form data..."}):e.jsx(e.Fragment,{children:e.jsxs("form",{onSubmit:s.handleSubmit,children:[e.jsx(se,{options:h,getOptionLabel:o=>o.registration_id,value:h.find(o=>o.id===s.values.vehicle)||null,onChange:(o,l)=>s.setFieldValue("vehicle",(l==null?void 0:l.id)||""),renderInput:o=>e.jsx(R,{...o,label:"Vehicle",error:s.touched.vehicle&&!!s.errors.vehicle,helperText:s.touched.vehicle&&s.errors.vehicle,fullWidth:!0})}),e.jsx(se,{options:f,getOptionLabel:o=>o.topic,value:f.find(o=>o.id===s.values.breakdown_topic)||null,onChange:(o,l)=>s.setFieldValue("breakdown_topic",(l==null?void 0:l.id)||""),renderOption:(o,l)=>c.createElement("li",{...o,key:l.id},l.topic),renderInput:o=>e.jsx(R,{...o,label:"Breakdown Topic",error:s.touched.breakdown_topic&&!!s.errors.breakdown_topic,helperText:s.touched.breakdown_topic&&s.errors.breakdown_topic,fullWidth:!0,sx:{mt:2}})}),e.jsx(R,{label:"Odometer Reading",name:"odometer_reading",value:s.values.odometer_reading,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.odometer_reading&&!!s.errors.odometer_reading,helperText:s.touched.odometer_reading&&s.errors.odometer_reading,fullWidth:!0,sx:{mt:2}}),e.jsx(R,{label:"Description",name:"description",value:s.values.description,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.description&&!!s.errors.description,helperText:s.touched.description&&s.errors.description,fullWidth:!0,sx:{mt:2}}),e.jsx(R,{label:"Mobile Number",name:"mob_no",value:s.values.mob_no,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.mob_no&&!!s.errors.mob_no,helperText:s.touched.mob_no&&s.errors.mob_no,fullWidth:!0,sx:{mt:2}}),e.jsx(R,{label:"Email",name:"email",type:"email",value:s.values.email,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.email&&!!s.errors.email,helperText:s.touched.email&&s.errors.email,fullWidth:!0,sx:{mt:2}}),e.jsx(R,{label:"Location",name:"location",value:I||s.values.location,onChange:o=>{T(o.target.value),s.setFieldValue("location",o.target.value)},onBlur:s.handleBlur,error:s.touched.location&&!!s.errors.location,helperText:s.touched.location&&s.errors.location,fullWidth:!0,sx:{mt:2}}),e.jsx(W,{variant:"outlined",onClick:$,disabled:k,sx:{mt:2},children:k?"Fetching Location...":"Use Current Location"}),e.jsxs(W,{component:"label",sx:{mt:2,border:"1px solid #f5f5f5",color:"black"},children:["Upload Attachment",e.jsx("input",{type:"file",hidden:!0,onChange:V})]}),j&&e.jsxs(K,{variant:"body2",sx:{mt:1},children:["Uploaded File: ",j]}),m&&e.jsx(D,{component:"img",src:m,alt:"Image Preview",sx:{mt:1,width:"100%",maxHeight:200}}),e.jsx(W,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,sx:{mt:3},children:"Submit"})]})})})}function Je({where:h}){const{isAddBreakdown:x,isUpdateBreakdown:f,UpdatedBreakdownData:a}=y(b=>b.breakdown);let m=N();const p=()=>{m(J(!1)),m(Q(!1)),m(Z(null))},j=()=>{m(J(!x))},_={fontSize:"18px",fontWeight:500,lineHeight:"18.38px",textAlign:"center",paddingTop:"5px",fontFamily:"ubuntu"};return e.jsxs(D,{sx:{bgcolor:"white",m:"10px",display:"flex",textAlign:"left",justifyContent:"space-between",alignItems:"center",borderRadius:"6px",padding:"20px"},children:[e.jsx(K,{variant:"h6",sx:_,children:h==="breakdown"?"Breakdown New Request":"New Breakdown Requests"}),e.jsx(Re,{}),h==="breakdown"&&e.jsxs(W,{onClick:j,sx:{color:"black",background:te.bgColor},children:[e.jsx(Ee,{}),"Breakdown"]}),e.jsxs(re,{open:x||f,onClose:p,maxWidth:"md",fullWidth:!0,children:[e.jsxs(ne,{children:[f?"Update":"Add"," Breakdown",e.jsx(Y,{"aria-label":"close",onClick:p,sx:{position:"absolute",right:8,top:8,color:b=>b.palette.grey[500]},children:e.jsx(_e,{})})]}),e.jsx(ae,{children:e.jsx(Ye,{})})]})]})}function Lo(){const{locationData:h,selectedVehicle:x,selectedParameterList:f,onlineVehicle:a}=y(d=>d.liveMap),{mode:m,selectedVehicleGroup:p,vehicleZone:j}=y(d=>d.dashboard),_=ve(m),[b,L]=c.useState([]),{w_customer_id:k}=y(d=>d.auth),[g,I]=c.useState(),[T,C]=c.useState(!1),[s,$]=c.useState(!1),[P,V]=c.useState([]);c.useState(!0);const[M,t]=c.useState(!1),[o,l]=c.useState(!1);let n=N();c.useEffect(()=>{i(),n(ge()),n(X(k))},[]),c.useEffect(()=>{console.log("selectedVehicleGroup",p)},[p]),c.useEffect(()=>{V([]),n(ee([{reg_id:"",imei:"",params:[]}]))},[x]);const i=async()=>{try{t(!0);let d=[],w=[];const A=await n(xe({w_customer_id:k}));if(Array.isArray(A.payload)){A.payload.forEach(r=>{var O,E,U,S;Array.isArray(r.imei)&&r.imei.length>0&&((O=r.imei[0])!=null&&O.mac_id)?(d.push({id:r.id,label:r.registration_id,value:(E=r.imei[0])==null?void 0:E.mac_id,vehilce_type:r==null?void 0:r.segment,chassis_no:r==null?void 0:r.chassis_no,engine_no:r==null?void 0:r.engine_no,workShop:r==null?void 0:r.workshop,registration_id:r==null?void 0:r.registration_id,sell_date:r==null?void 0:r.sell_date,customer_name:r==null?void 0:r.customer_name,vehicle_model:(U=r==null?void 0:r.vehicle_model)==null?void 0:U.name,user:r==null?void 0:r.user,vehicle_group:r==null?void 0:r.vehicle_group}),w.push((S=r.imei[0])==null?void 0:S.mac_id)):console.error("IMEI data not found for item:",r)});const H="one",z=w;w.length>0&&n(fe({type:H,imei:z})),L(d),n(be({w_customer_id:k})),n(we(d)),t(!1)}else t(!1),console.error("Unexpected data format:",A),B.error("Unexpected data format:")}catch(d){console.error("Error fetching vehicle data:",d),B.error(`Error fetching vehicle data: ${d}`)}},u=async d=>{const{label:w,imei:A,id:H,reg_id:z,checked:r}=d;I(S=>S.map(G=>G.id===H?{...G,checked:!r}:G));let O=[...P],E=[...P];if(!r)h.forEach(S=>{S.latestDocument.imei===A&&(O.push({label:w,value:S.latestDocument[w==="maininputvoltage"?"mainInputVoltage":w]}),E=O,V(O))});else{let S=P.filter(G=>G.label!==w);E=S,V(S)}console.log("tempParamList",E),n(ee([{reg_id:z,imei:A,params:E}]))},v=b.filter(d=>Object.keys(p).length===0||d.vehicle_group===p.id);return e.jsxs("div",{className:"app",children:[e.jsx(Ce,{}),e.jsxs("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:[e.jsx(je,{title:"Breakdown",setShowVehicles:C,showVehicles:T,setShowVehiclesGroup:l,showVehiclesGroup:o}),e.jsx(Me,{setShowVehiclesGroup:l,showVehiclesGroup:o}),e.jsxs(D,{style:{display:"flex",width:"100%",height:"95vh"},children:[e.jsxs(D,{style:{width:T||s?"80%":"100%",background:te.bgShadow},children:[e.jsx(Je,{where:"breakdown"}),e.jsx(Ue,{})]}),T&&e.jsx(D,{style:{width:"20%",backgroundColor:_.grey[100]},children:e.jsx(ke,{vehicleData:v,title:"Inspections",setParameterData:I,loadingVehicle:M,setShowVehicles:C,showVehicles:T,showParameters:s,setShowParameters:$})}),s&&e.jsx(D,{style:{width:"20%",backgroundColor:_.grey[100]},children:e.jsx(ye,{parametersData:g,setParameterData:I,handleParameterChange:u})})]})]})]})}export{Lo as default};
