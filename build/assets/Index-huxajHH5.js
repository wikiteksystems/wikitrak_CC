import{j as e,B as G,k as H,l as y,r as d,aG as K,aD as Q,ax as le,v as E,aa as ie,J as X,ar as ce,aE as de,aJ as ue,aH as J,T as Y,t as re,aI as he,P as ee,E as pe,F as me,I as ge,H as xe}from"./index-_AP5_ja-.js";import{L as fe}from"./LiveMapTopBar-DLYVe5y4.js";import{V as be}from"./VehicleMenu-C6vthrFf.js";import{L as we,t as _e}from"./LeftSideBar2-BShcj1oI.js";import"./Loader-7EPz6vV7.js";import"./LiveMapServices-Ce6wck5f.js";import"./Socket-0N_gnJcr.js";import{T as V,P as je}from"./Parameters-DCXJ3AlX.js";/* empty css           */import"./proj-XQwXs9DQ.js";import{M as te,D as ae,a as ke,T as Ce}from"./TablePagination-B5pXYn9K.js";import{D as ne,a as Se,E as ye,T as ve}from"./Edit-BYXOmCZH.js";import{B as D}from"./menu2-D4qRwxJv.js";import{c as Be,I as Z}from"./IconButton-Dm8z4gX2.js";import{M as De}from"./Paper-72qtvNCE.js";import{T as Te,a as Pe}from"./TableHead-BhJbZxfS.js";import{T as Ie,b as se,a as Ae}from"./TableRow-Be1_jOfS.js";import{d as Le}from"./Close-CpsdJc0a.js";import{d as Ve}from"./Add-CQpDV1Sl.js";import{u as Ee}from"./formik.esm-CyRRzo0A.js";import{c as Fe,a as O}from"./index.esm-DUk6PuBC.js";import{A as oe}from"./Autocomplete-CnyYk5cd.js";import{T as W}from"./TextField-CdM8DFuo.js";import{S as Me}from"./SearchInput-DCNB91lM.js";import{V as Re}from"./VehicleGroups-C-qfTF1C.js";import"./wikitrak-DHdU3BBz.js";import"./createSvgIcon-CXJV2zZH.js";import"./index-DSo8kL6S.js";import"./index-F5-geWg7.js";import"./Card-B44ewC5r.js";import"./CardContent-BaZtGxBE.js";const qe=Be(e.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"}),"Delete"),Oe=({open:u,onClose:f,onConfirm:w})=>e.jsxs(te,{open:u,onClose:f,children:[e.jsx(ne,{children:"Confirm Deletion"}),e.jsx(ae,{children:e.jsxs(Se,{children:["Are you sure you want to delete this vehicle data?"," ",e.jsx("span",{style:{color:"red"},children:"This action cannot be undone."})]})}),e.jsxs(ke,{children:[e.jsx(G,{onClick:f,color:"primary",children:"Cancel"}),e.jsx(G,{onClick:w,color:"secondary",children:"Delete"})]})]}),We="http://134.209.145.234/api/v1",$e={display:"flex",alignItems:"left",justifyContent:"left",gap:"8px"},Ge=({breakdownData:u})=>{const f=H(),{isUpdateBreakdown:w}=y(s=>s.equipment),{w_customer_id:a}=y(s=>s.auth),[g,h]=d.useState(!1),C=()=>{console.log("breakdownData",u),localStorage.getItem("role"),f(K(!w)),f(Q(u))},k=()=>{console.log("dlt btn clicked");const s=localStorage.getItem("role");le.includes(s)?h(!0):E.error(`Sorry! Your role is ${s}. You're not allowed to add, edit or delete the vehicle`)},_=async()=>{console.log("breakdownData data deleting");try{await ie.delete(`${We}/vehicles/breakdown/create/${u.id}/`),E.success("breakdownData data deleted successfully!"),f(X(a))}catch(s){console.error("Error deleting breakdown data:",s),E.error("Failed to delete breakdown data. Please try again.")}h(!1)},B=()=>{h(!1)},b={color:"#686868"};return e.jsxs(D,{sx:$e,children:[e.jsx(Z,{onClick:C,children:e.jsx(ye,{sx:b})}),e.jsx(Z,{onClick:k,children:e.jsx(qe,{sx:b})}),e.jsx(Oe,{open:g,onClose:B,onConfirm:_})]})},He=[{id:"BDID",label:"BDID"},{id:"User",label:"User"},{id:"SubmissionDate",label:"Submission Date"},{id:"WorkshopGroup",label:"Workshop Group"},{id:"Status",label:"Status"},{id:"Actions",label:"Actions"}],Ne=()=>{const{breakdowns:u}=y(o=>o.breakdown),{searchTerm:f}=y(o=>o.inspection),[w,a]=d.useState("asc"),[g,h]=d.useState("BDID"),[C,k]=d.useState(0),[_,B]=d.useState(5),[b,s]=d.useState({id:"",status:"",workshop:"",user:""}),I=o=>{a(g===o&&w==="asc"?"desc":"asc"),h(o)},T=(o,n)=>{k(n)},A=o=>{B(parseInt(o.target.value,10)),k(0)},P=(o,n,x)=>o.filter(i=>{const c=x.toLowerCase(),p=i.breakdown_id.toLowerCase().includes(c),M=`${i.user.us_user.first_name} ${i.user.us_user.last_name}`.toLowerCase().includes(c),m=i.status.toLowerCase().includes(c),S=i.workshop_group.group_name.toLowerCase().includes(c);return!(x&&!(p||M||m||S)||n.id&&!i.breakdown_id.includes(n.id)||n.status&&i.status!==n.status||n.workshop&&i.workshop_group.group_name!==n.workshop||n.user&&!i.user.us_user.first_name.toLowerCase().includes(n.user.toLowerCase())&&!i.user.us_user.last_name.toLowerCase().includes(n.user.toLowerCase()))}),t=(o,n,x,i)=>{if(i==="User"){const c=`${o.user.us_user.first_name} ${o.user.us_user.last_name}`.toLowerCase(),p=`${n.user.us_user.first_name} ${n.user.us_user.last_name}`.toLowerCase();return x==="asc"?c.localeCompare(p):p.localeCompare(c)}if(i==="WorkshopGroup"){const c=o.workshop_group.group_name.toLowerCase(),p=n.workshop_group.group_name.toLowerCase();return x==="asc"?c.localeCompare(p):p.localeCompare(c)}if(i==="BDID"){const c=parseInt(o.breakdown_id.replace("BD-",""),10),p=parseInt(n.breakdown_id.replace("BD-",""),10);return x==="asc"?c-p:p-c}if(i==="SubmissionDate"){const c=new Date(o.submission_date),p=new Date(n.submission_date);return x==="asc"?c-p:p-c}if(i==="Status"){const c={Open:1,Close:2,Rejected:3},p=c[o.status]||0,M=c[n.status]||0;return x==="asc"?p-M:M-p}return 0},l=P(u.slice(),b,f).sort((o,n)=>t(o,n,w,g)),j=l.slice(C*_,C*_+_),F={fontSize:"14px",fontWeight:"bold",fontFamily:"Ubuntu",color:"black",cursor:"pointer",background:"#f2f2f2"};return e.jsx(D,{sx:{m:"10px"},children:e.jsxs(De,{children:[e.jsx(Te,{sx:{height:"73vh",bgcolor:"white",borderRadius:"10px"},children:e.jsxs(Ie,{stickyHeader:!0,children:[e.jsx(Pe,{children:e.jsx(se,{children:He.map(o=>e.jsx(V,{sx:F,children:e.jsx(ve,{active:g===o.id,direction:g===o.id?w:"asc",onClick:()=>I(o.id),children:o.label})},o.id))})}),e.jsx(Ae,{children:j.map((o,n)=>e.jsxs(se,{children:[e.jsx(V,{children:o.breakdown_id}),e.jsx(V,{children:`${o.user.us_user.first_name} ${o.user.us_user.last_name}`}),e.jsx(V,{children:o.submission_date||"N/A"}),e.jsx(V,{children:o.workshop_group.group_name}),e.jsx(V,{sx:{color:o.status==="Open"?"blue":o.status==="Close"?"green":"red"},children:o.status}),e.jsx(V,{children:e.jsx(Ge,{breakdownData:o})})]},n))})]})}),e.jsx(Ce,{component:"div",count:l.length,page:C,onPageChange:T,rowsPerPage:_,onRowsPerPageChange:A,rowsPerPageOptions:[5,10,15]})]})})},ze=Ne;function Ue(){var A,P;const{vehicles_details:u}=y(t=>t.dashboard),{w_customer_id:f}=y(t=>t.auth),{breakdownTopics:w,UpdatedBreakdownData:a}=y(t=>t.breakdown),[g,h]=d.useState(null),[C,k]=d.useState(""),[_,B]=d.useState(!1);let b=H();d.useEffect(()=>{a&&(h(a.attachment),k("edit"))},[a]);const s=Ee({initialValues:{vehicle:((A=a==null?void 0:a.vehicle)==null?void 0:A.id)||"",breakdown_topic:((P=a==null?void 0:a.breakdown_topic)==null?void 0:P.id)||"",odometer_reading:(a==null?void 0:a.odometer_reading)||"",description:(a==null?void 0:a.description)||"",mob_no:(a==null?void 0:a.mob_no)||"",email:(a==null?void 0:a.email)||"",attachment:(a==null?void 0:a.attachment)||""},validationSchema:Fe({vehicle:O().required("Vehicle is required"),breakdown_topic:O().required("Breakdown Topic is required"),odometer_reading:O().required("Odometer Reading is required"),description:O().required("Description is required"),mob_no:O().matches(/^\d{10,11}$/,"Mobile number must be 10-11 digits").required("Mobile number is required"),email:O().email("Invalid email format").required("Email is required")}),onSubmit:async(t,{resetForm:l})=>{var j,F,o;try{B(!0),console.log("Submitted values:",t);const n=I(t.vehicle);t.user=n[0].user.id,t.status="Open",t.location="Pune",t.workshop_group=(o=(F=(j=n[0])==null?void 0:j.workShop)==null?void 0:F.group_name)==null?void 0:o.id,t.submission_date=new Date().toISOString().split("T")[0];let x;if(a){let i=await ce(a.attachment);console.log("file conversion",i),t.attachment=i;const c=a.id;x=await b(de({values:t,id:c}))}else x=await b(ue(t));if(x.payload.success)E.success("Breakdown submitted successfully!"),l(),k(""),h(null),b(Q(null)),b(K(!1)),b(J(!1)),b(X(f)),B(!1);else throw B(!1),new Error(x.payload.error||"Failed to submit breakdown")}catch(n){console.error("Submission Error:",n),E.error("Failed to submit breakdown. Please try again.")}}}),I=t=>(u==null?void 0:u.length)>0&&u.filter(j=>j.id===t),T=t=>{const l=t.currentTarget.files[0];if(s.setFieldValue("attachment",l),k((l==null?void 0:l.name)||""),l&&l.type.startsWith("image/")){const j=new FileReader;j.onload=()=>h(j.result),j.readAsDataURL(l)}else h(null)};return e.jsx(D,{sx:{p:3,maxWidth:600,margin:"auto"},children:_?e.jsx(Y,{children:"Submitted the form data..."}):e.jsx(e.Fragment,{children:e.jsxs("form",{onSubmit:s.handleSubmit,children:[e.jsx(oe,{options:u,getOptionLabel:t=>t.registration_id,value:u.find(t=>t.id===s.values.vehicle)||null,onChange:(t,l)=>s.setFieldValue("vehicle",(l==null?void 0:l.id)||""),renderInput:t=>e.jsx(W,{...t,label:"Vehicle",error:s.touched.vehicle&&!!s.errors.vehicle,helperText:s.touched.vehicle&&s.errors.vehicle,fullWidth:!0})}),e.jsx(oe,{options:w,getOptionLabel:t=>t.topic,value:w.find(t=>t.id===s.values.breakdown_topic)||null,onChange:(t,l)=>s.setFieldValue("breakdown_topic",(l==null?void 0:l.id)||""),renderOption:(t,l)=>d.createElement("li",{...t,key:l.id},l.topic),renderInput:t=>e.jsx(W,{...t,label:"Breakdown Topic",error:s.touched.breakdown_topic&&!!s.errors.breakdown_topic,helperText:s.touched.breakdown_topic&&s.errors.breakdown_topic,fullWidth:!0,sx:{mt:2}})}),e.jsx(W,{label:"Odometer Reading",name:"odometer_reading",value:s.values.odometer_reading,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.odometer_reading&&!!s.errors.odometer_reading,helperText:s.touched.odometer_reading&&s.errors.odometer_reading,fullWidth:!0,sx:{mt:2}}),e.jsx(W,{label:"Description",name:"description",value:s.values.description,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.description&&!!s.errors.description,helperText:s.touched.description&&s.errors.description,fullWidth:!0,sx:{mt:2}}),e.jsx(W,{label:"Mobile Number",name:"mob_no",value:s.values.mob_no,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.mob_no&&!!s.errors.mob_no,helperText:s.touched.mob_no&&s.errors.mob_no,fullWidth:!0,sx:{mt:2}}),e.jsx(W,{label:"Email",name:"email",type:"email",value:s.values.email,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.email&&!!s.errors.email,helperText:s.touched.email&&s.errors.email,fullWidth:!0,sx:{mt:2}}),e.jsxs(G,{component:"label",sx:{mt:2,border:"1px solid #f5f5f5",color:"black"},children:["Upload Attachment",e.jsx("input",{type:"file",hidden:!0,onChange:T})]}),C&&e.jsxs(Y,{variant:"body2",sx:{mt:1},children:["Uploaded File: ",C]}),g&&e.jsx(D,{component:"img",src:g,alt:"Image Preview",sx:{mt:1,width:"100%",maxHeight:200}}),e.jsx(G,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,sx:{mt:3},children:"Submit"})]})})})}function Je({where:u}){const{isAddBreakdown:f,isUpdateBreakdown:w,UpdatedBreakdownData:a}=y(_=>_.breakdown);let g=H();const h=()=>{g(J(!1)),g(K(!1)),g(Q(null))},C=()=>{g(J(!f))},k={fontSize:"18px",fontWeight:500,lineHeight:"18.38px",textAlign:"center",paddingTop:"5px",fontFamily:"ubuntu"};return e.jsxs(D,{sx:{bgcolor:"white",m:"10px",display:"flex",textAlign:"left",justifyContent:"space-between",alignItems:"center",borderRadius:"6px",padding:"20px"},children:[e.jsx(Y,{variant:"h6",sx:k,children:u==="breakdown"?"Breakdown New Request":"New Breakdown Requests"}),e.jsx(Me,{}),u==="breakdown"&&e.jsxs(G,{onClick:C,sx:{color:"black",background:re.bgColor},children:[e.jsx(Ve,{}),"Breakdown"]}),e.jsxs(te,{open:f||w,onClose:h,maxWidth:"md",fullWidth:!0,children:[e.jsxs(ne,{children:[w?"Update":"Add"," Breakdown",e.jsx(Z,{"aria-label":"close",onClick:h,sx:{position:"absolute",right:8,top:8,color:_=>_.palette.grey[500]},children:e.jsx(Le,{})})]}),e.jsx(ae,{children:e.jsx(Ue,{})})]})]})}function vs(){const{locationData:u,selectedVehicle:f,selectedParameterList:w,onlineVehicle:a}=y(m=>m.liveMap),{mode:g,selectedVehicleGroup:h,vehicleZone:C}=y(m=>m.dashboard),k=_e(g),[_,B]=d.useState([]),{w_customer_id:b}=y(m=>m.auth),[s,I]=d.useState(),[T,A]=d.useState(!1),[P,t]=d.useState(!1),[l,j]=d.useState([]);d.useState(!0);const[F,o]=d.useState(!1),[n,x]=d.useState(!1);let i=H();d.useEffect(()=>{c(),i(he()),i(X(b))},[]),d.useEffect(()=>{console.log("selectedVehicleGroup",h)},[h]),d.useEffect(()=>{j([]),i(ee([{reg_id:"",imei:"",params:[]}]))},[f]);const c=async()=>{try{o(!0);let m=[],S=[];const R=await i(pe({w_customer_id:b}));if(Array.isArray(R.payload)){R.payload.forEach(r=>{var q,L,U,v;Array.isArray(r.imei)&&r.imei.length>0&&((q=r.imei[0])!=null&&q.mac_id)?(m.push({id:r.id,label:r.registration_id,value:(L=r.imei[0])==null?void 0:L.mac_id,vehilce_type:r==null?void 0:r.segment,chassis_no:r==null?void 0:r.chassis_no,engine_no:r==null?void 0:r.engine_no,workShop:r==null?void 0:r.workshop,registration_id:r==null?void 0:r.registration_id,sell_date:r==null?void 0:r.sell_date,customer_name:r==null?void 0:r.customer_name,vehicle_model:(U=r==null?void 0:r.vehicle_model)==null?void 0:U.name,user:r==null?void 0:r.user,vehicle_group:r==null?void 0:r.vehicle_group}),S.push((v=r.imei[0])==null?void 0:v.mac_id)):console.error("IMEI data not found for item:",r)});const N="one",z=S;S.length>0&&i(me({type:N,imei:z})),B(m),i(ge({w_customer_id:b})),i(xe(m)),o(!1)}else o(!1),console.error("Unexpected data format:",R),E.error("Unexpected data format:")}catch(m){console.error("Error fetching vehicle data:",m),E.error(`Error fetching vehicle data: ${m}`)}},p=async m=>{const{label:S,imei:R,id:N,reg_id:z,checked:r}=m;I(v=>v.map($=>$.id===N?{...$,checked:!r}:$));let q=[...l],L=[...l];if(!r)u.forEach(v=>{v.latestDocument.imei===R&&(q.push({label:S,value:v.latestDocument[S==="maininputvoltage"?"mainInputVoltage":S]}),L=q,j(q))});else{let v=l.filter($=>$.label!==S);L=v,j(v)}console.log("tempParamList",L),i(ee([{reg_id:z,imei:R,params:L}]))},M=_.filter(m=>Object.keys(h).length===0||m.vehicle_group===h.id);return e.jsxs("div",{className:"app",children:[e.jsx(we,{}),e.jsxs("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:[e.jsx(fe,{title:"Breakdown",setShowVehicles:A,showVehicles:T,setShowVehiclesGroup:x,showVehiclesGroup:n}),e.jsx(Re,{setShowVehiclesGroup:x,showVehiclesGroup:n}),e.jsxs(D,{style:{display:"flex",width:"100%",height:"95vh"},children:[e.jsxs(D,{style:{width:T||P?"80%":"100%",background:re.bgShadow},children:[e.jsx(Je,{where:"breakdown"}),e.jsx(ze,{})]}),T&&e.jsx(D,{style:{width:"20%",backgroundColor:k.grey[100]},children:e.jsx(be,{vehicleData:M,title:"Inspections",setParameterData:I,loadingVehicle:F,setShowVehicles:A,showVehicles:T,showParameters:P,setShowParameters:t})}),P&&e.jsx(D,{style:{width:"20%",backgroundColor:k.grey[100]},children:e.jsx(je,{parametersData:s,setParameterData:I,handleParameterChange:p})})]})]})]})}export{vs as default};
