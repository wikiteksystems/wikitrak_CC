import{j as i,t as ge,P as Y,r as o,a as W,u as oe,v as ve,a9 as ee,l as xe,_ as Q,m as ye,a1 as Pe}from"./index-D0aNwlmP.js";import{L as Ee}from"./LightModeOutlined-Dy-oKYkP.js";import{L as be}from"./LiveMapTopBar-CVIHJtBa.js";import{V as Se}from"./VehicleMenu-D1SddK0Z.js";import{d as Ie,t as we}from"./Search-DzLS79QW.js";import"./Loader-BnupwI8C.js";import{s as U}from"./Socket-Bai6kHrq.js";import{P as Ce}from"./Parameters-B0s5WS54.js";/* empty css           */import{B as Le,C as Oe,r as Me,c as je,u as Ne,l as Ve,d as De,o as Te,e as ke,g as _e,M as Fe,T as Ae,O as Re,b as Be,f as $,a as te,V as ze,F as $e,P as We,S as Ke,I as Ge,h as Xe}from"./Vector-BEQdHjna.js";import{B as F,C as He}from"./CircularProgress-D0vTU0dk.js";import{S as se}from"./Select-izrswFFx.js";import{v as Ye}from"./3W-CBKYabV4.js";import{b as Qe}from"./OutlinedInput-CyZt5XCD.js";import{I as Ue}from"./IconButton-CSU8wmWS.js";import"./createSvgIcon-BJRz-VQo.js";import"./jcb-aCHXMCXy.js";import"./index-B-MMvrfw.js";import"./roundedArrow-BBersqtH.js";import"./TextArea-BCWfbs8Q.js";import"./index-BVHdkCjo.js";import"./Card-LM4OS8qK.js";import"./Paper-2h0VwTET.js";import"./CardContent-C11j1Jb2.js";const ne="/assets/motorbike-Ve1wpD8A.png";function qe({activeParams:y}){return i.jsx(F,{sx:{bgcolor:ge.bgColor,position:"relative",color:"white",display:"flex",alignItems:"center",justifyContent:"space-around",overflowX:"hidden",flexWrap:"wrap",border:"1px solid white"},children:y&&y[0].params.length>0?i.jsxs(i.Fragment,{children:[y[0].params.length>0&&i.jsxs(Y,{variant:"outlined",sx:{color:"black",border:"1px solid white",fontSize:"12px",background:"white","&:hover":{border:"1px solid white",background:"transparent",color:"white"}},children:["Registration Id : ",y[0].reg_id]}),y.length>0&&y[0].params.map((e,d)=>{e.label==="maininputvoltage"&&console.log("item.label",e.label,e);const r=y[0].params.find(P=>P.label==="ignition"),l=r&&(r.value===!0||r.value===1)?e.value:0,c=e.label==="mainInputVoltage"||e.label==="maininputvoltage";return i.jsx(Y,{variant:"outlined",sx:{color:"black",border:"1px solid white",mx:"5px",my:"15px",fontSize:"12px",background:"white","&:hover":{border:"1px solid white",background:"transparent",color:"white"}},children:e.label==="speed"?`${e.label} : ${l} km/h`:c&&e.value!==void 0?`${e.label} : ${e.value} voltage`:e.label==="ignition"?`${e.label} : ${e.value===!0||(e==null?void 0:e.value)===1?"On":"Off"}`:`${e.label} : ${e.value!==void 0?e.value:""}`},d)})]}):i.jsx(i.Fragment,{children:i.jsx(Y,{variant:"outlined",sx:{color:"white",border:"1px solid white",mx:"5px",my:"15px"},children:"No Parameters Selected"})})})}const f={ELEMENT:"element",MAP:"map",OFFSET:"offset",POSITION:"position",POSITIONING:"positioning"};class Je extends Le{constructor(e){super(),this.on,this.once,this.un,this.options=e,this.id=e.id,this.insertFirst=e.insertFirst!==void 0?e.insertFirst:!0,this.stopEvent=e.stopEvent!==void 0?e.stopEvent:!0,this.element=document.createElement("div"),this.element.className=e.className!==void 0?e.className:"ol-overlay-container "+Oe,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.autoPan=e.autoPan===!0?{}:e.autoPan||void 0,this.rendered={transform_:"",visible:!0},this.mapPostrenderListenerKey=null,this.addChangeListener(f.ELEMENT,this.handleElementChanged),this.addChangeListener(f.MAP,this.handleMapChanged),this.addChangeListener(f.OFFSET,this.handleOffsetChanged),this.addChangeListener(f.POSITION,this.handlePositionChanged),this.addChangeListener(f.POSITIONING,this.handlePositioningChanged),e.element!==void 0&&this.setElement(e.element),this.setOffset(e.offset!==void 0?e.offset:[0,0]),this.setPositioning(e.positioning||"top-left"),e.position!==void 0&&this.setPosition(e.position)}getElement(){return this.get(f.ELEMENT)}getId(){return this.id}getMap(){return this.get(f.MAP)||null}getOffset(){return this.get(f.OFFSET)}getPosition(){return this.get(f.POSITION)}getPositioning(){return this.get(f.POSITIONING)}handleElementChanged(){Me(this.element);const e=this.getElement();e&&this.element.appendChild(e)}handleMapChanged(){this.mapPostrenderListenerKey&&(je(this.element),Ne(this.mapPostrenderListenerKey),this.mapPostrenderListenerKey=null);const e=this.getMap();if(e){this.mapPostrenderListenerKey=Ve(e,De.POSTRENDER,this.render,this),this.updatePixelPosition();const d=this.stopEvent?e.getOverlayContainerStopEvent():e.getOverlayContainer();this.insertFirst?d.insertBefore(this.element,d.childNodes[0]||null):d.appendChild(this.element),this.performAutoPan()}}render(){this.updatePixelPosition()}handleOffsetChanged(){this.updatePixelPosition()}handlePositionChanged(){this.updatePixelPosition(),this.performAutoPan()}handlePositioningChanged(){this.updatePixelPosition()}setElement(e){this.set(f.ELEMENT,e)}setMap(e){this.set(f.MAP,e)}setOffset(e){this.set(f.OFFSET,e)}setPosition(e){this.set(f.POSITION,e)}performAutoPan(){this.autoPan&&this.panIntoView(this.autoPan)}panIntoView(e){const d=this.getMap();if(!d||!d.getTargetElement()||!this.get(f.POSITION))return;const r=this.getRect(d.getTargetElement(),d.getSize()),l=this.getElement(),c=this.getRect(l,[Te(l),ke(l)]);e=e||{};const P=e.margin===void 0?20:e.margin;if(!_e(r,c)){const m=c[0]-r[0],C=r[2]-c[2],S=c[1]-r[1],u=r[3]-c[3],I=[0,0];if(m<0?I[0]=m-P:C<0&&(I[0]=Math.abs(C)+P),S<0?I[1]=S-P:u<0&&(I[1]=Math.abs(u)+P),I[0]!==0||I[1]!==0){const A=d.getView().getCenterInternal(),L=d.getPixelFromCoordinateInternal(A);if(!L)return;const T=[L[0]+I[0],L[1]+I[1]],k=e.animation||{};d.getView().animateInternal({center:d.getCoordinateFromPixelInternal(T),duration:k.duration,easing:k.easing})}}}getRect(e,d){const r=e.getBoundingClientRect(),l=r.left+window.pageXOffset,c=r.top+window.pageYOffset;return[l,c,l+d[0],c+d[1]]}setPositioning(e){this.set(f.POSITIONING,e)}setVisible(e){this.rendered.visible!==e&&(this.element.style.display=e?"":"none",this.rendered.visible=e)}updatePixelPosition(){const e=this.getMap(),d=this.getPosition();if(!e||!e.isRendered()||!d){this.setVisible(!1);return}const r=e.getPixelFromCoordinate(d),l=e.getSize();this.updateRenderedPosition(r,l)}updateRenderedPosition(e,d){const r=this.element.style,l=this.getOffset(),c=this.getPositioning();this.setVisible(!0);const P=Math.round(e[0]+l[0])+"px",m=Math.round(e[1]+l[1])+"px";let C="0%",S="0%";c=="bottom-right"||c=="center-right"||c=="top-right"?C="-100%":(c=="bottom-center"||c=="center-center"||c=="top-center")&&(C="-50%"),c=="bottom-left"||c=="bottom-center"||c=="bottom-right"?S="-100%":(c=="center-left"||c=="center-center"||c=="center-right")&&(S="-50%");const u=`translate(${C}, ${S}) translate(${P}, ${m})`;this.rendered.transform_!=u&&(this.rendered.transform_=u,r.transform=u)}getOptions(){return this.options}}const Ze="/assets/4W-zFlpw5ld.png";function et({showCard:y,loadingVehicle:e}){const d=o.useRef(),r=o.useRef(),[l,c]=o.useState(null),{selectedParameterList:P,selectedVehicle:m,vehicleList:C,icons:S,locationData:u,placesData:I,imeiNumbers:A,onlineVehicle:L,loading:T,services_loading:k}=W(t=>t.liveMap),{mode:H,styles:q,vehicles_details:O}=W(t=>t.dashboard);o.useState("");const[K,V]=o.useState([]),[J,G]=o.useState([]),[h,E]=o.useState(),[b,R]=o.useState(),[B,p]=o.useState(null),[_,w]=o.useState(""),[g,M]=o.useState({lat:18.516726,lng:73.856255}),[j,ie]=o.useState(""),[ae,re]=o.useState(null),le=oe();o.useEffect(()=>{if(l){const t=document.getElementById("popup");t&&(t.style.background="white",t.style.padding="10px",t.style.borderRadius="8px",t.style.cursor="pointer")}},[l]),o.useEffect(()=>{var t,s,a,v;if(console.log("locationData",u),console.log("vehicles_details",O),Object.keys(m).length>0){console.log("selectedVehicle",m);const n=u==null?void 0:u.filter(x=>{var N;return((N=x==null?void 0:x.latestDocument)==null?void 0:N.imei)==(m==null?void 0:m.imei)});console.log("filteredVehicle",n),E(n),M({lat:(s=(t=n==null?void 0:n[0])==null?void 0:t.latestDocument)==null?void 0:s.lat,lng:(v=(a=n==null?void 0:n[0])==null?void 0:a.latestDocument)==null?void 0:v.lng})}else E(u)},[u,m]),o.useEffect(()=>{R(P)},[P]),o.useEffect(()=>(U.on("locationinfo",t=>{if(console.log("locationinfo",t),h==null||h.map(s=>{if(s.latestDocument.imei===t.imei){const a={lat:s.latestDocument.lat,lng:s.latestDocument.lng},v=500,n=60,x=v/(1e3/n),N=(t.lat-a.lat)/x,D=(t.lng-a.lng)/x;let z=0;const X=setInterval(()=>{const he=a.lat+N*z,pe=a.lng+D*z,fe={...s,latestDocument:{...s.latestDocument,lat:he,lng:pe}};z++,z>=x&&clearInterval(X),E(me=>me.map(Z=>Z.latestDocument.imei===t.imei?fe:Z))},1e3/n)}return s}),String(t==null?void 0:t.imei)===String(b[0].imei)){const s=b[0].params.map(a=>{let v=a.label;return{...a,value:t[v]}});R([{...b[0],params:s}])}}),()=>{U.off("locationinfo")}),[U,h,b]),o.useEffect(()=>{le(ve({}))},[m]),o.useEffect(()=>{if((u==null?void 0:u.length)>0&&L.length>0){const t=[],s=[];u==null||u.forEach(a=>{L.some(n=>String(n)===String(a._id))?t.push(a):s.push(a)}),V(t),G(s)}else V([]),G([])},[u,L]),o.useEffect(()=>{const t=new Fe({target:d.current,layers:[new Ae({source:new Re})],view:new Be({center:$([g==null?void 0:g.lng,g==null?void 0:g.lat]),zoom:Object.keys(m).length>0?15:6})});re(t),r.current=t;const s=document.createElement("div");s.id="popup",s.className="ol-popup",s.innerHTML='<div id="popup-content"></div><a href="#" id="popup-closer" className="ol-popup-closer"></a>',document.body.appendChild(s);const a=new Je({element:s,autoPan:!0,autoPanAnimation:{duration:250}});return t.addOverlay(a),c(a),()=>{r.current&&r.current.setTarget(null),s&&s.parentNode&&s.parentNode.removeChild(s)}},[g]),o.useEffect(()=>{g&&r.current&&r.current.getView().setCenter($([g.lng,g.lat]))},[g]),o.useEffect(()=>{var t;if(r.current){let s=(t=r.current.getLayers().getArray().find(n=>n instanceof te))==null?void 0:t.getSource();if(s)s.clear();else{s=new ze;const n=new te({source:s});r.current.addLayer(n)}h&&h.length>0&&h.forEach(n=>{const x=new $e({geometry:new We($([n.latestDocument.lng,n.latestDocument.lat])),name:n.latestDocument.imei,vehicle:n}),N=ce(n.latestDocument.imei);if(x.setStyle(new Ke({image:new Ge({anchor:[.5,1],src:(()=>{switch(N){case"2W":return ne;case"3W":return Ye;case"4W":return Ze;default:return ne}})(),scale:.1})})),s.addFeature(x),n.latestDocument.imei===B){const D=$([n.latestDocument.lng,n.latestDocument.lat]);l.setPosition(D)}}),r.current.getInteractions().getArray().forEach(n=>{n instanceof se&&r.current.removeInteraction(n)});const v=new se({condition:Xe});r.current.addInteraction(v),v.on("select",function(n){if(n.selected.length>0){const x=n.selected[0],N=x.getGeometry().getCoordinates(),D=x.get("vehicle"),z=de(D.latestDocument.imei);if(p(D.latestDocument.imei),w(D.latestDocument.imei),l){l.setPosition(N);const X=document.getElementById("popup-content");X&&(X.innerHTML=`
                 <div>Vehicle No: ${z}</div>
                 <div>IMEI No: ${D.latestDocument.imei}</div>
               `)}}else p(null),w(""),l&&l.setPosition(void 0)})}},[h,B]),o.useEffect(()=>{const t=s=>{l&&!document.getElementById("popup").contains(s.target)&&(p(null),w(""),l.setPosition(void 0))};return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[l]);const ce=t=>{const s=O&&(O==null?void 0:O.length)>0&&O.find(a=>(a==null?void 0:a.value)===t&&(a==null?void 0:a.vehilce_type));return s?s.vehilce_type:null},de=t=>{const s=C.find(a=>{var v;return a.imei&&((v=a.imei[0])==null?void 0:v.mac_id)===t});return s?s.registration_id:"IMEI doesn't exist."},ue=async t=>{if(t.preventDefault(),j.trim()==="")return;const a=await(await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${j}`)).json();if(a.length>0){const{lon:v,lat:n}=a[0],x=$([parseFloat(v),parseFloat(n)]);ae.getView().animate({center:x,zoom:15})}};return i.jsxs(i.Fragment,{children:[y&&i.jsx(qe,{activeParams:b}),(T||e)&&i.jsx(F,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:10},children:i.jsx(He,{})}),i.jsx("div",{ref:d,style:{width:"100%",height:y?"85vh":"93vh"}}),i.jsxs(F,{component:"form",onSubmit:ue,border:"1px solid white",backgroundColor:"white",borderRadius:"3px",sx:{my:"6px",ml:"90px",position:"absolute",top:y?132:63,left:200,zIndex:1},children:[i.jsx(Qe,{sx:{my:.5,mx:2},placeholder:"Search Locations",value:j,onChange:t=>ie(t.target.value)}),i.jsx(Ue,{type:"submit",sx:{p:1},children:i.jsx(Ie,{})})]}),i.jsxs("div",{id:"popup",className:"ol-popup",style:{background:"white",padding:"10px",borderRadius:"8px"},children:[i.jsx("div",{id:"popup-content"}),i.jsx("a",{href:"#",id:"popup-closer",className:"ol-popup-closer"})]})]})}function wt(){const{locationData:y,selectedVehicle:e,selectedParameterList:d}=W(h=>h.liveMap),{mode:r}=W(h=>h.dashboard),l=we(r),[c,P]=o.useState([]),{w_customer_id:m}=W(h=>h.auth),[C,S]=o.useState(),[u,I]=o.useState(!1),[A,L]=o.useState(!1),[T,k]=o.useState([]),[H,q]=o.useState(!0),[O,K]=o.useState(!1);let V=oe();o.useEffect(()=>{J()},[]),o.useEffect(()=>{k([]),V(ee([{reg_id:"",imei:"",params:[]}]))},[e]);const J=async()=>{try{K(!0);let h=[],E=[];const b=await V(xe({w_customer_id:m}));if(Array.isArray(b.payload)){b.payload.forEach(p=>{var _,w,g;Array.isArray(p.imei)&&p.imei.length>0&&((_=p.imei[0])!=null&&_.mac_id)?(h.push({id:p.id,label:p.registration_id,value:(w=p.imei[0])==null?void 0:w.mac_id,vehilce_type:p==null?void 0:p.segment}),E.push((g=p.imei[0])==null?void 0:g.mac_id)):(console.error("IMEI data not found for item:",p),Q.error(`IMEI Number not found for the vehicle: ${p==null?void 0:p.registration_id}`))});const R="one",B=E;E.length>0&&V(ye({type:R,imei:B})),P(h),V(Pe(h)),K(!1)}else K(!1),console.error("Unexpected data format:",b),Q.error("Unexpected data format:")}catch(h){console.error("Error fetching vehicle data:",h),Q.error(`Error fetching vehicle data: ${h}`)}},G=async h=>{const{label:E,imei:b,id:R,reg_id:B,checked:p}=h;S(M=>M.map(j=>j.id===R?{...j,checked:!p}:j));let _=[...T],w=[...T];if(!p)y.forEach(M=>{M.latestDocument.imei===b&&(_.push({label:E,value:M.latestDocument[E==="maininputvoltage"?"mainInputVoltage":E]}),w=_,k(_))});else{let M=T.filter(j=>j.label!==E);w=M,k(M)}console.log("tempParamList",w),V(ee([{reg_id:B,imei:b,params:w}]))};return i.jsxs("div",{className:"app",children:[i.jsx(Ee,{}),i.jsxs("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:[i.jsx(be,{title:"Live Map",setShowVehicles:I,showVehicles:u,showParameters:A,setShowParameters:L,setShowCard:q,showCard:H}),i.jsxs(F,{style:{display:"flex",width:"100%",height:"95vh"},children:[i.jsx(F,{style:{width:u||A?"80%":"100%"},children:i.jsx(et,{showCard:H,loadingVehicle:O})}),u&&i.jsx(F,{style:{width:"20%",backgroundColor:l.grey[100]},children:i.jsx(Se,{vehicleData:c,title:"Live Map",setParameterData:S,loadingVehicle:O})}),A&&i.jsx(F,{style:{width:"20%",backgroundColor:l.grey[100]},children:i.jsx(Ce,{parametersData:C,setParameterData:S,handleParameterChange:G})})]})]})]})}export{wt as default};
