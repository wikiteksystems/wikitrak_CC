import{r as l,j as t,u as z,a as F,af as me,t as we,T as _,P as H,a4 as Se,_ as B,ag as U,X as je,Y as K,Z as N,c as Y,$ as J,W as ye,a0 as ve,l as be,m as Ce}from"./index-Dd5O25NJ.js";import{L as Me}from"./LightModeOutlined-DDx2Rx2I.js";import{L as Pe}from"./LiveMapTopBar-cMUvo5YN.js";import{V as ke}from"./VehicleMenu-DZ5kL43-.js";import{P as Q,u as De,G as Le,a as Ie,b as Z}from"./esm-6KE22fkC.js";import"./index-DJr9dsEl.js";import{T as Fe}from"./TripGraph-DLxiHtmT.js";import{B as f,C as ee}from"./CircularProgress-DDtA4O1n.js";import{D as Te}from"./DateTimePicker-BN9lczAP.js";import{t as te}from"./Search-YvtTYn1Q.js";import"./createSvgIcon-CPJ04Nu6.js";import"./IconButton-CyvlakxD.js";import"./jcb-aCHXMCXy.js";import"./index-DIwncpT-.js";import"./roundedArrow-DJIdObUx.js";import"./TextArea-Cg6PMy_c.js";import"./OutlinedInput-Bl1re5Hz.js";import"./button-BQgjyNUa.js";function Ae({trip:i,tripPlay:j,setTripPlay:T,setSpeed:D}){const[y,C]=l.useState([]),[I,G]=l.useState(0),[L,e]=l.useState([]),[v,A]=l.useState([null]),V=l.useRef(null);return l.useEffect(()=>{A([null]);const S=[];if(i&&i.length>0&&(i==null||i.map(x=>{S.push(x.speed).toFixed(2)}),e(S)),i&&(i==null?void 0:i.length)>0){const x=i==null?void 0:i.map(b=>({lat:parseFloat(b.lat),lng:parseFloat(b.lng)}));C(x),A(x.slice(0))}},[i]),l.useEffect(()=>{if(j){const S=y.length,x=9e3,b=1e4,s=performance.now();let h=0;const c=g=>{const m=(g-s)/x,P=Math.min(Math.floor(m*S),S-1);P!==V.current&&(G(P),D(L[P]),V.current=P),h<b&&(requestAnimationFrame(c),h++)};return requestAnimationFrame(c),()=>{}}},[j]),t.jsxs("div",{children:[v.length>0&&t.jsx(t.Fragment,{children:t.jsx(Q,{path:v,options:{strokeColor:"red",strokeOpacity:1,strokeWeight:4}})}),j&&t.jsx(Q,{path:y.slice(0,I+1),options:{strokeColor:"green",strokeOpacity:1,strokeWeight:4,zIndex:1e3,geodesic:!0}})]})}const Ee=({selectedTrip:i,center:j,showCard:T})=>{var X,$;const D=z(),{isLoaded:y,loadError:C}=De({googleMapsApiKey:"AIzaSyA_S7GfAh6rJYWQ5X4n4X-3poo3vymuspU"}),{Acreage:I}=F(o=>o.tripMonitor);F(o=>o.liveMap);const{singleTrip_Data:G,tripLoading:L}=F(o=>o.tripMonitor),{selectedTripData:e,mode:v,styles:A}=F(o=>o.dashboard),V=l.useRef(null),[S,x]=l.useState(null),[b,s]=l.useState(null),[h,c]=l.useState([]);l.useState([]);const[g,M]=l.useState(!1),[m,P]=l.useState(0),[E,O]=l.useState(!1),[oe,se]=l.useState(0),[ne,_e]=l.useState([]),[Ge,ae]=l.useState([]);l.useState([]),l.useEffect(()=>{S&&b&&S.fitBounds(b)},[S,b,e]),l.useEffect(()=>{if(console.log("selectedTripData",e),(e==null?void 0:e.length)>0){const o=re({selectedTripData:e});se(o)}},[e]);const re=({selectedTripData:o})=>{const d=o.reduce((n,r,a)=>{if(a===0)return n;const u=o[a-1],p=me(u.lat,u.lng,r.lat,r.lng);return n+p},0);return d==null?void 0:d.toFixed(2)};l.useEffect(()=>{var o,d,n,r,a;if(e&&(e==null?void 0:e.length)>0){const u=new window.google.maps.LatLngBounds,p=new window.google.maps.LatLng(parseFloat((o=e[0])==null?void 0:o.lat),parseFloat((d=e[0])==null?void 0:d.lng)),w=new window.google.maps.LatLng(parseFloat((n=e[(e==null?void 0:e.length)-1])==null?void 0:n.lat),parseFloat((r=e[(e==null?void 0:e.length)-1])==null?void 0:r.lng));u.extend(p),u.extend(w),P((a=e[0])==null?void 0:a.speed),s(u)}M(!1),le()},[e]);const le=()=>{if(e&&e.length>0){const o=(r,a)=>{const p=new Date(r.createdAt).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0});return{Date:r.createdAt.substring(0,10),Time:p,value:r[a]}},n=["speed","mainInputVoltage","ignition"].map(r=>({label:r==="speed"?"Speed":r==="mainInputVoltage"?"MainInputVoltage":"Ignition",randomColor:ie(),data:e.map(a=>o(a,r))}));c(n)}else c([])},ie=()=>"#"+Math.floor(Math.random()*16777215).toString(16),ce=()=>{var o;if((e==null?void 0:e.length)>0)M(!g),P(0);else return((o=Object.keys(e))==null?void 0:o.length)===0?B.error("Please Select Vehicle",{id:"vehicle"}):B.error("Please Select Trip",{id:"trip error"})},de=()=>{var o;if((e==null?void 0:e.length)>0)O(!E);else return((o=Object.keys(e))==null?void 0:o.length)===0?B.error("Please Select Vehicle",{id:"vehicle"}):B.error("Please Select Trip",{id:"trip error"})};if(C)return"Error loading maps";if(!y)return"Loading maps";const he={width:"100%",height:T?"87vh":"93vh"},pe=o=>{if(!window.google||!window.google.maps.geometry){console.log("not loaded");return}const n=window.google.maps.geometry.spherical.computeArea(o.getPath())/4046.86;D(U(n))},ge=()=>{const n=[];e.length>0&&e.map((a,u)=>{let p={latitude:a.lat,longitude:a.lng},w=[];e.map(k=>{const R={latitude:k.lat,longitude:k.lng};if(R.latitude!==p.latitude&&R.longitude!==p.longitude){const W=fe(a.lat,a.lng,k.lat,k.lng);W<20&&W>10&&w.push(k)}}),w.length>10&&n.push(a)});const r=n.map(a=>({lat:parseFloat(a.lat),lng:parseFloat(a.lng)}));if(n&&n.length>0){ae(n);const a=xe(r),u=ue(a),p=new window.google.maps.Polygon({paths:u});pe(p)}else D(U(0))},ue=o=>{o.sort((r,a)=>r.lng-a.lng||r.lat-a.lat);const d=[],n=[];for(const r of o){for(;d.length>=2&&q(d[d.length-2],d[d.length-1],r)<=0;)d.pop();d.push(r)}for(let r=o.length-1;r>=0;r--){const a=o[r];for(;n.length>=2&&q(n[n.length-2],n[n.length-1],a)<=0;)n.pop();n.push(a)}return[...d.slice(0,-1),...n.slice(0,-1)]},q=(o,d,n)=>(d.lat-o.lat)*(n.lng-o.lng)-(d.lng-o.lng)*(n.lat-o.lat),xe=o=>{const d=(p,w,k)=>{const R=(w.lat-p.lat)*(k.lng-w.lng)-(w.lng-p.lng)*(k.lat-w.lat);return R===0?0:R>0?1:2},n=o.reduce((p,w)=>w.lng<p.lng?w:p);let r=[],a=n,u;do{r.push(a),u=o[0]===a?o[1]:o[0];for(let p=0;p<o.length;p++)d(a,u,o[p])===2&&(u=o[p]);a=u}while(a!==n);return r};function fe(o,d,n,r){const u=o*Math.PI/180,p=n*Math.PI/180,w=(n-o)*Math.PI/180,k=(r-d)*Math.PI/180,R=Math.sin(w/2)*Math.sin(w/2)+Math.cos(u)*Math.cos(p)*Math.sin(k/2)*Math.sin(k/2);return 6371e3*(2*Math.atan2(Math.sqrt(R),Math.sqrt(1-R)))}return t.jsxs(t.Fragment,{children:[L&&t.jsx(f,{sx:{position:"absolute",top:"50vh",left:"50%",zIndex:"1000"},children:t.jsx(ee,{})}),T&&t.jsxs(f,{sx:{bgcolor:we.bgColor,position:"relative",color:"white",display:"flex",alignItems:"center",justifyContent:"left",overflowX:"hidden",flexWrap:"wrap",border:"1px solid white",height:"60px",gap:"15px",paddingLeft:"30px"},children:[t.jsxs(f,{sx:{padding:"5px 15px",border:"1px solid white",borderRadius:"5px",width:"150px",display:"flex",justifyContent:"space-evenly"},children:[t.jsx(_,{children:"Speed"}),t.jsxs(_,{children:[g?m:0," KM/H"]})]}),t.jsxs(_,{sx:{padding:"5px 15px",border:"1px solid white",borderRadius:"5px"},children:["Total-Distance ",oe," KM"]}),t.jsxs(_,{sx:{padding:"5px 15px",border:"1px solid white",borderRadius:"5px"},children:[parseFloat(I).toFixed(2)," acre"]}),t.jsxs(H,{sx:{background:"white",border:"1px solid white",borderRadius:"5px",padding:"5px 20px",color:"black"},onClick:()=>{ge()},children:[" ","Calculate Acerage"]}),t.jsxs(H,{sx:{background:g?"transparent":"white",border:"1px solid white",borderRadius:"5px",height:"38px",padding:"5px 20px",color:g?"white":"black","&:hover":{background:"transparent",color:"white"}},onClick:()=>{ce()},children:[g?"Pause":"Play","-Trip"]}),t.jsxs(H,{style:{height:"38px",padding:"5px 20px"},sx:{background:E?"transparent":"white",border:"1px solid white",borderRadius:"5px",color:E?"white":"black","&:hover":{background:"transparent",color:"white"}},onClick:()=>{de()},children:[E?"Hide":"Show","-Graph"]})]}),t.jsxs(Le,{ref:V,mapContainerStyle:he,zoom:10,center:j,onLoad:o=>x(o),options:{styles:v?A:""},children:[t.jsx(Ie,{paths:ne,options:{fillColor:"#00FF00",fillOpacity:.4,strokeColor:"#000",strokeOpacity:1,strokeWeight:2}}),e&&(e==null?void 0:e.length)>0&&(e==null?void 0:e.map((o,d)=>{var n,r,a,u;return t.jsxs(Se.Fragment,{children:[t.jsx(Z,{position:{lat:parseFloat((n=e[0])==null?void 0:n.lat),lng:parseFloat((r=e[0])==null?void 0:r.lng)},animation:"BOUNCE",icon:{url:"http://maps.google.com/mapfiles/ms/icons/green-dot.png"}}),t.jsx(Ae,{trip:e,tripPlay:g,setTripPlay:M,setSpeed:P}),t.jsx(Z,{position:{lat:parseFloat((a=e[(e==null?void 0:e.length)-1])==null?void 0:a.lat),lng:parseFloat((u=e[(e==null?void 0:e.length)-1])==null?void 0:u.lng)},animation:"BOUNCE",icon:{url:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"}})]},d)})),t.jsx("div",{style:{position:"relative",top:320,left:15,color:"green"},children:(($=(X=h[0])==null?void 0:X.data)==null?void 0:$.length)>0&&E&&t.jsx(Fe,{item:h})})]})]})},Re=Ee,Be=()=>{const i=z(),{tripList:j,selectedTripData:T,loading:D,trips:y,activeIndex:C,searchText:I,mode:G,isNavigate:L}=F(s=>s.dashboard),{selectedVehicle:e}=F(s=>s.liveMap),v=te(G);l.useEffect(()=>{const s=V(j);i(je(s))},[j]),l.useEffect(()=>{!(T.length>0)&&L&&C!==null&&x.length>0&&A(x[C])},[T,L]);const A=async s=>{var g;let h={imei:e.imei,startDate:s.startDate,endDate:s.endDate};const c=await K(h);((g=c==null?void 0:c.data)==null?void 0:g.documents.length)>0?(i(L(!1)),i(N(c.data.documents[0].data))):(i(L(!1)),i(N([])))};l.useState(0);const V=s=>{const h=new Set,c=[];return s.forEach(g=>{h.has(g.formatedDate)||(h.add(g.formatedDate),c.push(g.formatedDate))}),c},S=s=>{i(J(null)),i(ye(s)),i(ve(!1))},x=j&&j.length>0&&j.filter(s=>s.formatedDate.toLowerCase().includes(I.toLowerCase())),b=async(s,h)=>{var g;let c={imei:e.imei,startDate:h.startDate,endDate:h.endDate};if(console.log("payload",c),c&&(c!=null&&c.imei)&&(c!=null&&c.startDate)&&(c!=null&&c.endDate)){const M=await K(c);((g=M==null?void 0:M.data)==null?void 0:g.documents.length)>0?(i(N(M.data.documents[0].data)),i(U(0))):(i(N([])),i(U(0))),i(J(s))}else B.error("Something is missing start or end date.",{id:"getTrip"})};return t.jsx(t.Fragment,{children:t.jsxs(f,{children:[t.jsxs(f,{children:[t.jsx(f,{sx:{color:v.grey[400]},children:"Select Date"}),t.jsx(f,{sx:{mt:1},children:t.jsx(Te,{})})]}),D?t.jsx("div",{style:{width:"100%",margin:"38%"},children:t.jsx(ee,{})}):t.jsxs(t.Fragment,{children:[t.jsx(f,{children:t.jsx(f,{sx:{display:"flex",overflowX:"auto",gap:"10px",paddingBottom:"5px"},children:y&&(y==null?void 0:y.length)>0?y.map((s,h)=>t.jsx(f,{children:t.jsx(H,{onClick:()=>{S(s)},style:{backgroundColor:I===s?v.grey[300]:v.grey[200],color:I===s?"black":v.grey[300],height:"35px",fontWeight:700,fontSize:"12px",width:"90px",marginTop:"20px"},children:s})},h)):t.jsx(_,{sx:{width:"100%",mt:"50%",textAlign:"center"},children:"Sorry! No Trips Found"})})}),t.jsx(f,{sx:{height:"70vh",width:"100%",overflowY:"auto"},children:x&&x.length>0&&x.map((s,h)=>t.jsxs(f,{sx:{m:"15px",border:"1px solid #e8edea",borderRadius:"5px",padding:"10px",justifyContent:"space-between",alignItems:"center",color:C===h?"black":v.grey[400],backgroundColor:C===h?"#e8edea":"undefined",fontSize:"10px",cursor:"pointer","&:hover":{background:"#e8edea"}},onClick:()=>b(h,s),children:[t.jsxs(_,{children:[h+1,". ",s.startLocation," to ",s.endLocation]}),t.jsxs(_,{children:[s!=null&&s.startDate?Y(new Date(s.startDate).toISOString()).format("LT"):""," ","/"," ",s!=null&&s.endDate?Y(new Date(s.endDate).toISOString()).format("LT"):"----"]})]}))})]})]})})},Ve=Be;function at(){const{w_customer_id:i}=F(s=>s.auth),{collapsed:j}=F(s=>s.auth),{mode:T}=F(s=>s.dashboard),[D,y]=l.useState(!1),[C,I]=l.useState(!0),[G,L]=l.useState([]),[e,v]=l.useState(!1);l.useState([]);const[A,V]=l.useState({lat:18.516726,lng:73.856255});l.useState([]);const S=te(T);let x=z();l.useEffect(()=>{b()},[]);const b=async()=>{try{let s=[],h=[];const c=await x(be({w_customer_id:i}));if(Array.isArray(c.payload)){c.payload.forEach(m=>{var P,E,O;Array.isArray(m.imei)&&m.imei.length>0&&((P=m.imei[0])!=null&&P.mac_id)?(s.push({id:m.id,label:m.registration_id,value:(E=m.imei[0])==null?void 0:E.mac_id}),h.push((O=m.imei[0])==null?void 0:O.mac_id)):(console.error("IMEI data not found for item:",m),B.error(`IMEI Number not found for the vehicle: ${m==null?void 0:m.registration_id}`))});const g="one",M=h;h.length>0&&x(Ce({type:g,imei:M})),L(s)}else console.error("Unexpected data format:",c),B.error("Unexpected data format:")}catch(s){console.error("Error fetching vehicle data:",s),B.error(`Error fetching vehicle data: ${s}`)}};return t.jsxs("div",{className:"app",children:[t.jsx(Me,{}),t.jsxs("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:[t.jsx(Pe,{title:"Trip Monitor",setShowVehicles:y,showVehicles:D,setShowCard:I,showCard:C,sideBarTrip:e,setSideBarTrip:v}),t.jsxs(f,{style:{display:"flex",width:"100%",height:"95vh"},children:[t.jsx(f,{style:{width:D||e?"80%":"100%"},children:t.jsx(Re,{center:A,showCard:C})}),D&&t.jsx(f,{style:{width:"20%",backgroundColor:S.grey[100]},children:t.jsx(ke,{vehicleData:G,title:"Live Monitor"})}),t.jsx(f,{style:{width:j?"22%":"20%",display:e?"block":"none",backgroundColor:S.grey[100]},children:t.jsx(Ve,{})})]})]})]})}export{at as default};
