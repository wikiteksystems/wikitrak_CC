import{r as l,j as t,u as z,a as L,ae as me,t as we,T as G,P as N,a3 as Se,_ as R,af as U,X as je,Y as K,Z as H,c as Y,$ as J,W as ye,l as be,m as ve}from"./index-CdPlqq14.js";import{L as Ce}from"./LightModeOutlined-CLLsxRoi.js";import{L as Me}from"./LiveMapTopBar-BgLDtD5B.js";import{V as Pe}from"./VehicleMenu-BxpcgtxA.js";import{P as Q,u as ke,G as De,a as Le,b as Z}from"./esm-E4nnkJbM.js";import"./index-Iq_7tsmd.js";import{T as Te}from"./TripGraph-aKedghV1.js";import{B as w,C as ee}from"./CircularProgress-B6B_e09D.js";import{D as Fe}from"./DateTimePicker-CVtDd-2_.js";import{t as te}from"./Search-DXTvpPLc.js";import"./createSvgIcon-DBYm-kMN.js";import"./IconButton-CxmOAX2k.js";import"./jcb-aCHXMCXy.js";import"./index-CW5hIiOs.js";import"./roundedArrow-zid0F1vm.js";import"./TextArea-oGLqkpCn.js";import"./OutlinedInput-DvWr59RR.js";import"./button-BQX-k0SJ.js";function Ie({trip:d,tripPlay:j,setTripPlay:k,setSpeed:P}){const[b,v]=l.useState([]),[D,V]=l.useState(0),[T,e]=l.useState([]),[F,I]=l.useState([null]),B=l.useRef(null);return l.useEffect(()=>{I([null]);const u=[];if(d&&d.length>0&&(d==null||d.map(y=>{u.push(y.speed).toFixed(2)}),e(u)),d&&(d==null?void 0:d.length)>0){const y=d==null?void 0:d.map(s=>({lat:parseFloat(s.lat),lng:parseFloat(s.lng)}));v(y),I(y.slice(0))}},[d]),l.useEffect(()=>{if(j){const u=b.length,y=9e3,s=1e4,i=performance.now();let c=0;const x=S=>{const f=(S-i)/y,C=Math.min(Math.floor(f*u),u-1);C!==B.current&&(V(C),P(T[C]),B.current=C),c<s&&(requestAnimationFrame(x),c++)};return requestAnimationFrame(x),()=>{}}},[j]),t.jsxs("div",{children:[F.length>0&&t.jsx(t.Fragment,{children:t.jsx(Q,{path:F,options:{strokeColor:"red",strokeOpacity:1,strokeWeight:4}})}),j&&t.jsx(Q,{path:b.slice(0,D+1),options:{strokeColor:"green",strokeOpacity:1,strokeWeight:4,zIndex:1e3,geodesic:!0}})]})}const Ae=({selectedTrip:d,center:j,showCard:k})=>{var X,$;const P=z(),{isLoaded:b,loadError:v}=ke({googleMapsApiKey:"AIzaSyA_S7GfAh6rJYWQ5X4n4X-3poo3vymuspU"}),{Acreage:D}=L(o=>o.tripMonitor);L(o=>o.liveMap);const{singleTrip_Data:V,tripLoading:T}=L(o=>o.tripMonitor),{selectedTripData:e,mode:F,styles:I}=L(o=>o.dashboard),B=l.useRef(null),[u,y]=l.useState(null),[s,i]=l.useState(null),[c,x]=l.useState([]);l.useState([]);const[S,_]=l.useState(!1),[f,C]=l.useState(0),[A,O]=l.useState(!1),[oe,se]=l.useState(0),[ne,Ve]=l.useState([]),[_e,ae]=l.useState([]);l.useState([]),l.useEffect(()=>{u&&s&&u.fitBounds(s)},[u,s,e]),l.useEffect(()=>{if(console.log("selectedTripData",e),(e==null?void 0:e.length)>0){const o=re({selectedTripData:e});se(o)}},[e]);const re=({selectedTripData:o})=>{const h=o.reduce((n,r,a)=>{if(a===0)return n;const g=o[a-1],p=me(g.lat,g.lng,r.lat,r.lng);return n+p},0);return h==null?void 0:h.toFixed(2)};l.useEffect(()=>{var o,h,n,r,a;if(e&&(e==null?void 0:e.length)>0){const g=new window.google.maps.LatLngBounds,p=new window.google.maps.LatLng(parseFloat((o=e[0])==null?void 0:o.lat),parseFloat((h=e[0])==null?void 0:h.lng)),m=new window.google.maps.LatLng(parseFloat((n=e[(e==null?void 0:e.length)-1])==null?void 0:n.lat),parseFloat((r=e[(e==null?void 0:e.length)-1])==null?void 0:r.lng));g.extend(p),g.extend(m),C((a=e[0])==null?void 0:a.speed),i(g)}_(!1),le()},[e]);const le=()=>{if(e&&e.length>0){const o=(r,a)=>{const p=new Date(r.createdAt).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0});return{Date:r.createdAt.substring(0,10),Time:p,value:r[a]}},n=["speed","mainInputVoltage","ignition"].map(r=>({label:r==="speed"?"Speed":r==="mainInputVoltage"?"MainInputVoltage":"Ignition",randomColor:ie(),data:e.map(a=>o(a,r))}));x(n)}else x([])},ie=()=>"#"+Math.floor(Math.random()*16777215).toString(16),ce=()=>{var o;if((e==null?void 0:e.length)>0)_(!S),C(0);else return((o=Object.keys(e))==null?void 0:o.length)===0?R.error("Please Select Vehicle",{id:"vehicle"}):R.error("Please Select Trip",{id:"trip error"})},de=()=>{var o;if((e==null?void 0:e.length)>0)O(!A);else return((o=Object.keys(e))==null?void 0:o.length)===0?R.error("Please Select Vehicle",{id:"vehicle"}):R.error("Please Select Trip",{id:"trip error"})};if(v)return"Error loading maps";if(!b)return"Loading maps";const he={width:"100%",height:k?"87vh":"93vh"},pe=o=>{if(!window.google||!window.google.maps.geometry){console.log("not loaded");return}const n=window.google.maps.geometry.spherical.computeArea(o.getPath())/4046.86;P(U(n))},ge=()=>{const n=[];e.length>0&&e.map((a,g)=>{let p={latitude:a.lat,longitude:a.lng},m=[];e.map(M=>{const E={latitude:M.lat,longitude:M.lng};if(E.latitude!==p.latitude&&E.longitude!==p.longitude){const W=fe(a.lat,a.lng,M.lat,M.lng);W<20&&W>10&&m.push(M)}}),m.length>10&&n.push(a)});const r=n.map(a=>({lat:parseFloat(a.lat),lng:parseFloat(a.lng)}));if(n&&n.length>0){ae(n);const a=xe(r),g=ue(a),p=new window.google.maps.Polygon({paths:g});pe(p)}else P(U(0))},ue=o=>{o.sort((r,a)=>r.lng-a.lng||r.lat-a.lat);const h=[],n=[];for(const r of o){for(;h.length>=2&&q(h[h.length-2],h[h.length-1],r)<=0;)h.pop();h.push(r)}for(let r=o.length-1;r>=0;r--){const a=o[r];for(;n.length>=2&&q(n[n.length-2],n[n.length-1],a)<=0;)n.pop();n.push(a)}return[...h.slice(0,-1),...n.slice(0,-1)]},q=(o,h,n)=>(h.lat-o.lat)*(n.lng-o.lng)-(h.lng-o.lng)*(n.lat-o.lat),xe=o=>{const h=(p,m,M)=>{const E=(m.lat-p.lat)*(M.lng-m.lng)-(m.lng-p.lng)*(M.lat-m.lat);return E===0?0:E>0?1:2},n=o.reduce((p,m)=>m.lng<p.lng?m:p);let r=[],a=n,g;do{r.push(a),g=o[0]===a?o[1]:o[0];for(let p=0;p<o.length;p++)h(a,g,o[p])===2&&(g=o[p]);a=g}while(a!==n);return r};function fe(o,h,n,r){const g=o*Math.PI/180,p=n*Math.PI/180,m=(n-o)*Math.PI/180,M=(r-h)*Math.PI/180,E=Math.sin(m/2)*Math.sin(m/2)+Math.cos(g)*Math.cos(p)*Math.sin(M/2)*Math.sin(M/2);return 6371e3*(2*Math.atan2(Math.sqrt(E),Math.sqrt(1-E)))}return t.jsxs(t.Fragment,{children:[T&&t.jsx(w,{sx:{position:"absolute",top:"50vh",left:"50%",zIndex:"1000"},children:t.jsx(ee,{})}),k&&t.jsxs(w,{sx:{bgcolor:we.bgColor,position:"relative",color:"white",display:"flex",alignItems:"center",justifyContent:"left",overflowX:"hidden",flexWrap:"wrap",border:"1px solid white",height:"60px",gap:"15px",paddingLeft:"30px"},children:[t.jsxs(G,{sx:{padding:"5px 15px",border:"1px solid white",borderRadius:"5px"},children:["Speed ",f," KM/H"]}),t.jsxs(G,{sx:{padding:"5px 15px",border:"1px solid white",borderRadius:"5px"},children:["Total-Distance ",oe," KM"]}),t.jsxs(G,{sx:{padding:"5px 15px",border:"1px solid white",borderRadius:"5px"},children:[parseFloat(D).toFixed(2)," acre"]}),t.jsx(N,{sx:{background:"white",border:"1px solid white",borderRadius:"5px",padding:"5px 20px",color:"black"},onClick:()=>{ge()},children:" Calculate Acerage"}),t.jsxs(N,{sx:{background:S?"transparent":"white",border:"1px solid white",borderRadius:"5px",height:"38px",padding:"5px 20px",color:S?"white":"black","&:hover":{background:"transparent",color:"white"}},onClick:()=>{ce()},children:[S?"Pause":"Play","-Trip"]}),t.jsxs(N,{style:{height:"38px",padding:"5px 20px"},sx:{background:A?"transparent":"white",border:"1px solid white",borderRadius:"5px",color:A?"white":"black","&:hover":{background:"transparent",color:"white"}},onClick:()=>{de()},children:[A?"Hide":"Show","-Graph"]})]}),t.jsxs(De,{ref:B,mapContainerStyle:he,zoom:10,center:j,onLoad:o=>y(o),options:{styles:F?I:""},children:[t.jsx(Le,{paths:ne,options:{fillColor:"#00FF00",fillOpacity:.4,strokeColor:"#000",strokeOpacity:1,strokeWeight:2}}),e&&(e==null?void 0:e.length)>0&&(e==null?void 0:e.map((o,h)=>{var n,r,a,g;return t.jsxs(Se.Fragment,{children:[t.jsx(Z,{position:{lat:parseFloat((n=e[0])==null?void 0:n.lat),lng:parseFloat((r=e[0])==null?void 0:r.lng)},animation:"BOUNCE",icon:{url:"http://maps.google.com/mapfiles/ms/icons/green-dot.png"}}),t.jsx(Ie,{trip:e,tripPlay:S,setTripPlay:_,setSpeed:C}),t.jsx(Z,{position:{lat:parseFloat((a=e[(e==null?void 0:e.length)-1])==null?void 0:a.lat),lng:parseFloat((g=e[(e==null?void 0:e.length)-1])==null?void 0:g.lng)},animation:"BOUNCE",icon:{url:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"}})]},h)})),t.jsx("div",{style:{position:"relative",top:320,left:15,color:"green"},children:(($=(X=c[0])==null?void 0:X.data)==null?void 0:$.length)>0&&A&&t.jsx(Te,{item:c})})]})]})},Ee=Ae,Re=()=>{const d=z(),{tripList:j,selectedTripData:k,loading:P,trips:b,activeIndex:v,searchText:D,mode:V}=L(s=>s.dashboard),{selectedVehicle:T}=L(s=>s.liveMap),e=te(V);l.useEffect(()=>{const s=I(j);d(je(s))},[j]),l.useEffect(()=>{console.log("selectedTripData",k),k.length>0||v!==null&&u.length>0&&(console.log("selected trip",u[v]),F(u[v]))},[k]);const F=async s=>{var x;let i={imei:T.imei,startDate:s.startDate,endDate:s.endDate};const c=await K(i);((x=c==null?void 0:c.data)==null?void 0:x.documents.length)>0?d(H(c.data.documents[0].data)):d(H([]))};l.useState(0);const I=s=>{const i=new Set,c=[];return s.forEach(x=>{i.has(x.formatedDate)||(i.add(x.formatedDate),c.push(x.formatedDate))}),c},B=s=>{d(J(null)),d(ye(s))},u=j&&j.length>0&&j.filter(s=>s.formatedDate.toLowerCase().includes(D.toLowerCase())),y=async(s,i)=>{var x;let c={imei:T.imei,startDate:i.startDate,endDate:i.endDate};if(console.log("payload",c),c&&(c!=null&&c.imei)&&(c!=null&&c.startDate)&&(c!=null&&c.endDate)){const S=await K(c);((x=S==null?void 0:S.data)==null?void 0:x.documents.length)>0?(d(H(S.data.documents[0].data)),d(U(0))):(d(H([])),d(U(0))),d(J(s))}else R.error("Something is missing start or end date.",{id:"getTrip"})};return t.jsx(t.Fragment,{children:t.jsxs(w,{children:[t.jsxs(w,{children:[t.jsx(w,{sx:{color:e.grey[400]},children:"Select Date"}),t.jsx(w,{sx:{mt:1},children:t.jsx(Fe,{})})]}),P?t.jsx("div",{style:{width:"100%",margin:"38%"},children:t.jsx(ee,{})}):t.jsxs(t.Fragment,{children:[t.jsx(w,{children:t.jsx(w,{sx:{display:"flex",overflowX:"auto",gap:"10px",paddingBottom:"5px"},children:b&&(b==null?void 0:b.length)>0?b.map((s,i)=>t.jsx(w,{children:t.jsx(N,{onClick:()=>{B(s)},style:{backgroundColor:D===s?e.grey[300]:e.grey[200],color:D===s?"black":e.grey[300],height:"35px",fontWeight:700,fontSize:"12px",width:"90px",marginTop:"20px"},children:s})},i)):t.jsx(G,{sx:{width:"100%",mt:"50%",textAlign:"center"},children:"Sorry! No Trips Found"})})}),t.jsx(w,{sx:{height:"70vh",width:"100%",overflowY:"auto"},children:u&&u.length>0&&u.map((s,i)=>t.jsxs(w,{sx:{m:"15px",border:"1px solid #e8edea",borderRadius:"5px",padding:"10px",justifyContent:"space-between",alignItems:"center",color:v===i?"black":e.grey[400],backgroundColor:v===i?"#e8edea":"undefined",fontSize:"10px",cursor:"pointer","&:hover":{background:"#e8edea"}},onClick:()=>y(i,s),children:[t.jsxs(G,{children:[i+1,". ",s.startLocation," to ",s.endLocation]}),t.jsxs(G,{children:[s!=null&&s.startDate?Y(new Date(s.startDate).toISOString()).format("LT"):""," ","/"," ",s!=null&&s.endDate?Y(new Date(s.endDate).toISOString()).format("LT"):"----"]})]}))})]})]})})},Be=Re;function nt(){const{w_customer_id:d}=L(i=>i.auth),{collapsed:j}=L(i=>i.auth),{mode:k}=L(i=>i.dashboard),[P,b]=l.useState(!1),[v,D]=l.useState(!0),[V,T]=l.useState([]),[e,F]=l.useState(!1);l.useState([]);const[I,B]=l.useState({lat:18.516726,lng:73.856255});l.useState([]);const u=te(k);let y=z();l.useEffect(()=>{s()},[]);const s=async()=>{try{let i=[],c=[];const x=await y(be({w_customer_id:d}));if(Array.isArray(x.payload)){x.payload.forEach(f=>{var C,A,O;Array.isArray(f.imei)&&f.imei.length>0&&((C=f.imei[0])!=null&&C.mac_id)?(i.push({id:f.id,label:f.registration_id,value:(A=f.imei[0])==null?void 0:A.mac_id}),c.push((O=f.imei[0])==null?void 0:O.mac_id)):(console.error("IMEI data not found for item:",f),R.error(`IMEI Number not found for the vehicle: ${f==null?void 0:f.registration_id}`))});const S="one",_=c;c.length>0&&y(ve({type:S,imei:_})),T(i)}else console.error("Unexpected data format:",x),R.error("Unexpected data format:")}catch(i){console.error("Error fetching vehicle data:",i),R.error(`Error fetching vehicle data: ${i}`)}};return t.jsxs("div",{className:"app",children:[t.jsx(Ce,{}),t.jsxs("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:[t.jsx(Me,{title:"Trip Monitor",setShowVehicles:b,showVehicles:P,setShowCard:D,showCard:v,sideBarTrip:e,setSideBarTrip:F}),t.jsxs(w,{style:{display:"flex",width:"100%",height:"95vh"},children:[t.jsx(w,{style:{width:P||e?"80%":"100%"},children:t.jsx(Ee,{center:I,showCard:v})}),P&&t.jsx(w,{style:{width:"20%",backgroundColor:u.grey[100]},children:t.jsx(Pe,{vehicleData:V,title:"Live Monitor"})}),t.jsx(w,{style:{width:j?"22%":"20%",display:e?"block":"none",backgroundColor:u.grey[100]},children:t.jsx(Be,{})})]})]})]})}export{nt as default};
