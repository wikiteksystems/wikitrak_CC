import{r as c,j as n,u as K,a as N,t as H,T as R,B as q,R as ea,_ as Z,S as V,U as sa,V as oa,n as na,o as la}from"./index-Tb90R2_b.js";import{L as ca}from"./Close-BOsQMh6z.js";import{L as da}from"./LiveMapTopBar-DZzlFNVh.js";import{V as ra}from"./VehicleMenu-C6Wdfeu7.js";import{P as _,u as ha,G as ga,a as I}from"./esm-mwoWbJw9.js";import{T as ua,d as aa,D as ia}from"./DateTimePicker-B63iI8-0.js";import{B as L,C as ta}from"./CircularProgress-Dx35-Vjt.js";import{B as xa}from"./button-CDGZo5rR.js";import"./createSvgIcon-Cw0CjRpW.js";import"./createSvgIcon-_WZAYDUJ.js";import"./index-DvSUm9pq.js";import"./OutlinedInput-DbTc8EPS.js";import"./IconButton-DFxBhuCq.js";function pa({trip:s,tripPlay:w,setTripPlay:M,setSpeed:P}){const[h,l]=c.useState([]),[C,A]=c.useState(0),[i,F]=c.useState([]),[b,k]=c.useState([null]);return c.useEffect(()=>{var S;P((S=s==null?void 0:s.data[2])==null?void 0:S.speed)},[s]),c.useEffect(()=>{var v,x,y,p;k([null]);const S=[];if(s&&(s!=null&&s.data)&&((v=s==null?void 0:s.data)==null?void 0:v.length)>0&&((x=s==null?void 0:s.data)==null||x.map(f=>{S.push(f.speed).toFixed(2)}),F(S)),s&&(s!=null&&s.data)&&((y=s==null?void 0:s.data)==null?void 0:y.length)>0){const f=(p=s==null?void 0:s.data)==null?void 0:p.map(u=>({lat:parseFloat(u.lat),lng:parseFloat(u.lng)}));l(f),k(f.slice(0))}},[s]),c.useEffect(()=>{if(w){const S=h.length,v=9e3,x=1e4,y=v/x;let p=0;const f=setInterval(()=>{if(p<x){const u=p/x,m=Math.floor(u*S);A(m),P(i[m]),p++}else clearInterval(f)},y);return()=>clearInterval(f)}},[w]),n.jsxs("div",{children:[b.length>0&&n.jsx(n.Fragment,{children:n.jsx(_,{path:b,options:{strokeColor:"red",strokeOpacity:1,strokeWeight:4}})}),w&&n.jsx(_,{path:h.slice(0,C+1),options:{strokeColor:"green",strokeOpacity:1,strokeWeight:4,zIndex:1e3,geodesic:!0}})]})}const fa=({selectedTrip:s,center:w,showCard:M})=>{var U,W,t,e;K();const{isLoaded:P,loadError:h}=ha({googleMapsApiKey:"AIzaSyA_S7GfAh6rJYWQ5X4n4X-3poo3vymuspU"});N(a=>a.liveMap);const{singleTrip_Data:l,tripLoading:C}=N(a=>a.tripMonitor),A=c.useRef(null),[i,F]=c.useState(null),[b,k]=c.useState(null),[S,v]=c.useState([]);c.useState([]);const[x,y]=c.useState(!1),[p,f]=c.useState(0),[u,m]=c.useState(!1);c.useEffect(()=>{i&&b&&i.fitBounds(b)},[i,b,l]),c.useEffect(()=>{var a,d;if(l&&((a=l==null?void 0:l.documents)==null?void 0:a.length)>0){const r=new window.google.maps.LatLngBounds;(d=l==null?void 0:l.documents)==null||d.forEach(o=>{var j,E,O,X,J,Q,Y;const g=new window.google.maps.LatLng(parseFloat((j=o==null?void 0:o.data[0])==null?void 0:j.lat),parseFloat((E=o==null?void 0:o.data[0])==null?void 0:E.lng)),D=new window.google.maps.LatLng(parseFloat((X=o==null?void 0:o.data[((O=o==null?void 0:o.data)==null?void 0:O.length)-1])==null?void 0:X.lat),parseFloat((Q=o==null?void 0:o.data[((J=o==null?void 0:o.data)==null?void 0:J.length)-1])==null?void 0:Q.lng));r.extend(g),r.extend(D),f((Y=o==null?void 0:o.data[0])==null?void 0:Y.speed)}),k(r)}y(!1),G()},[l]);const G=()=>{if(l&&l.documents&&l.documents.length>0){const a=(o,g)=>{const j=new Date(o.createdAt).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0});return{Date:o.createdAt.substring(0,10),Time:j,value:o[g]}},r=["speed","mainInputVoltage","ignition"].map(o=>({label:o==="speed"?"Speed":o==="mainInputVoltage"?"MainInputVoltage":"Ignition",randomColor:$(),data:l.documents[0].data.map(g=>a(g,o))}));v(r)}else v([])},$=()=>"#"+Math.floor(Math.random()*16777215).toString(16),z=()=>{var a;if(((a=l==null?void 0:l.documents)==null?void 0:a.length)>0)y(!x),f(0);else return Z.error("Please Select Trip",{id:"trip error"})},B=()=>{if(l!=null&&l.documents)m(!u);else return Z.error("Please Select Trip",{id:"trip error"})};if(h)return"Error loading maps";if(!P)return"Loading maps";const T={width:"100%",height:M?"87vh":"93vh"};return n.jsxs(n.Fragment,{children:[C&&n.jsx(L,{sx:{position:"absolute",top:"50vh",left:"50%",zIndex:"1000"},children:n.jsx(ta,{})}),M&&n.jsxs(L,{sx:{bgcolor:H.bgColor,position:"relative",color:"white",display:"flex",alignItems:"center",justifyContent:"left",overflowX:"hidden",flexWrap:"wrap",border:"1px solid white",height:"60px",gap:"15px",paddingLeft:"30px"},children:[n.jsxs(R,{sx:{padding:"5px 15px",border:"1px solid white",borderRadius:"5px"},children:["Speed ",p," KM/H"]}),n.jsxs(q,{style:{height:"38px",padding:"5px 20px"},sx:{background:x?"transparent":"white",border:"1px solid white",borderRadius:"5px",color:x?"white":"black","&:hover":{background:"transparent",color:"white"}},onClick:()=>{z()},children:[x?"Pause":"Play","-Trip"]}),n.jsxs(q,{style:{height:"38px",padding:"5px 20px"},sx:{background:u?"transparent":"white",border:"1px solid white",borderRadius:"5px",color:u?"white":"black","&:hover":{background:"transparent",color:"white"}},onClick:()=>{B()},children:[u?"Hide":"Show","-Graph"]})]}),n.jsxs(ga,{ref:A,mapContainerStyle:T,zoom:10,center:w,onLoad:a=>F(a),children:[l&&((U=l==null?void 0:l.documents)==null?void 0:U.length)>0&&((W=l==null?void 0:l.documents)==null?void 0:W.map((a,d)=>{var r,o,g,D,j,E;return n.jsxs(ea.Fragment,{children:[n.jsx(I,{position:{lat:parseFloat((r=a==null?void 0:a.data[0])==null?void 0:r.lat),lng:parseFloat((o=a==null?void 0:a.data[0])==null?void 0:o.lng)},animation:"BOUNCE",icon:{url:"http://maps.google.com/mapfiles/ms/icons/green-dot.png"}}),n.jsx(pa,{trip:a,tripPlay:x,setTripPlay:y,setSpeed:f}),n.jsx(I,{position:{lat:parseFloat((D=a==null?void 0:a.data[((g=a==null?void 0:a.data)==null?void 0:g.length)-1])==null?void 0:D.lat),lng:parseFloat((E=a==null?void 0:a.data[((j=a==null?void 0:a.data)==null?void 0:j.length)-1])==null?void 0:E.lng)},animation:"BOUNCE",icon:{url:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"}})]},d)})),n.jsx("div",{style:{position:"relative",top:320,left:15,color:"green"},children:((e=(t=S[0])==null?void 0:t.data)==null?void 0:e.length)>0&&u&&n.jsx(ua,{item:S})})]})]})},Sa=fa;function Da({filteredTrips:s,setFilteredTrips:w,setCenter:M,setSelectedTrip:P}){const{selectedVehicle:h}=N(t=>t.liveMap),{tripHistory:l}=N(t=>t.tripMonitor),[C,A]=c.useState(),[i,F]=c.useState(),[b,k]=c.useState(!1),[S,v]=c.useState(0),[x,y]=c.useState(),[p,f]=c.useState(),[u,m]=c.useState(0);let G=K();c.useEffect(()=>{!i&&!C&&w([]),$()},[i,h]),c.useEffect(()=>{w([])},[h]),c.useEffect(()=>{var t;if(l&&((t=l==null?void 0:l.documents)==null?void 0:t.length)>0){const e=[];l.documents.forEach(a=>{let d;a.data.forEach(r=>{const o=r.createdAt.split("T")[0];d=e.find(g=>g.label===o),d||(d={label:o,data:[]},e.push(d))}),d.data.push({trip:d.data.length+1,tripData:a==null?void 0:a.data,startLocation:a==null?void 0:a.startLocation,endLocation:a==null?void 0:a.endLocation})}),w(e)}else l&&w([])},[l]),c.useEffect(()=>{s&&s.length>0&&(y(s[0].label),v(0))},[s]),c.useEffect(()=>{var t,e,a,d,r,o,g,D,j;if(s&&s.length>0){const E=(a=(e=(t=s[0])==null?void 0:t.data[0])==null?void 0:e.tripData[0])==null?void 0:a.startDate,O=(j=(D=(d=s[0])==null?void 0:d.data[0])==null?void 0:D.tripData[((g=(o=(r=s[0])==null?void 0:r.data[0])==null?void 0:o.tripData)==null?void 0:g.length)-1])==null?void 0:j.endDate,X={imei:h==null?void 0:h.imei,startDate:E,endDate:O};G(V({data:X}))}},[s]),c.useEffect(()=>{if(!s)return;const e=s.filter(a=>a.label===x).map(a=>a.data);e.length>0&&(s==null?void 0:s.length)>0&&(f(e),m(0))},[x,h]);const $=async()=>{if(i&&Object.keys(h).length>0)try{k(!0);const t=aa(C+"12:00:00").toISOString(),e=aa(i+" 23:59:59").toISOString(),a={imei:h==null?void 0:h.imei,startDate:t,endDate:e};f([]),await G(sa({data:a})),k(!1)}catch(t){k(!1),console.log("error in TripDetail",t)}},z=(t,e)=>{var a,d,r,o,g;if(m(t===u?null:t),P([e]),M({lat:(a=e==null?void 0:e.tripData[0])==null?void 0:a.lat,lng:(d=e==null?void 0:e.tripData[0])==null?void 0:d.lng}),i&&Object.keys(h).length>0){const D=(r=e==null?void 0:e.tripData[0])==null?void 0:r.startDate,j=(g=e==null?void 0:e.tripData[((o=e==null?void 0:e.tripData)==null?void 0:o.length)-1])==null?void 0:g.endDate,E={imei:h==null?void 0:h.imei,startDate:D,endDate:j};G(V({data:E}))}},B=(t,e)=>{var a,d,r,o,g,D;if(v(e),y(t.label),s&&s.length>0){const j=(d=(a=t==null?void 0:t.data[0])==null?void 0:a.tripData[0])==null?void 0:d.startDate,E=(D=(g=t==null?void 0:t.data[0])==null?void 0:g.tripData[((o=(r=t==null?void 0:t.data[0])==null?void 0:r.tripData)==null?void 0:o.length)-1])==null?void 0:D.endDate,O={imei:h==null?void 0:h.imei,startDate:j,endDate:E};G(V({data:O}))}},T=t=>{const e=new Date(t),a=e.getHours(),d=e.getMinutes(),r=a<10?`0${a}`:a,o=d<10?`0${d}`:d,g=a>=12?"PM":"AM";return`${r}:${o} ${g}`},U=({item:t})=>{const e=t.tripData.reduce((a,d,r)=>{if(r===0)return a;const o=t.tripData[r-1],g=oa(o.lat,o.lng,d.lat,d.lng);return a+g},0);return e==null?void 0:e.toFixed(2)},W={marginLeft:"15px",fontWeight:"bold",fontSize:"18px",fontFamily:"ubuntu"};return n.jsxs("div",{style:{padding:"10px"},children:[n.jsx(ia,{setStartDate:A,setEndDate:F}),b?n.jsx("div",{style:{width:"100%",margin:"38%"},children:n.jsx(ta,{})}):n.jsxs(L,{className:"scrollbar-container",style:{display:"flex",overflowX:"auto",marginTop:"50px",marginBottom:"50px",gap:"10px",flexDirection:"column"},children:[n.jsxs(L,{sx:{display:"flex",overflowX:"auto",gap:"10px",paddingBottom:"5px",alignItems:"center"},children:[!i&&n.jsx(R,{style:W,children:"Please Select Date"}),!b&&i&&s.length===0&&n.jsx(R,{style:W,children:"No Trip Found"}),s&&i&&s.map((t,e)=>n.jsx(L,{children:n.jsx(xa,{onClick:()=>{B(t,e)},style:{background:S===e?H.bgColor:"transparent",color:S===e?"white":"#666666",height:"45px",fontWeight:700,fontSize:"13px"},children:t.label})},e))]}),n.jsx(L,{style:{display:"flex",flexDirection:"column",height:"70vh"},children:x&&!b&&i&&s.length>0&&p&&(p==null?void 0:p.length)>0&&p[0].map((t,e)=>{var a,d,r;return n.jsxs(L,{sx:{margin:"2px",border:"1px solid #E8E8E8",background:u===e?H.bgShadow:"transparent",color:u===e?"black":"#666666",borderRadius:"5px",padding:"12px","&:hover":{background:H.bgShadow,color:"black"}},onClick:()=>{u!==e&&(z(e,t),m(e))},children:[n.jsxs(R,{children:[t.trip,".",((t==null?void 0:t.startLocation)||"").split(" ").slice(0,3).join(" ")," ","to"," ",((t==null?void 0:t.endLocation)||"").split(" ").slice(0,3).join(" ")]}),n.jsxs(R,{children:[T((a=t==null?void 0:t.tripData[0])==null?void 0:a.startDate)," /"," ",T((r=t==null?void 0:t.tripData[((d=t==null?void 0:t.tripData)==null?void 0:d.length)-1])==null?void 0:r.endDate)]}),n.jsxs(R,{children:["(",U({item:t})," ","km)"]})]},e)})})]})]})}function Aa(){const{w_customer_id:s}=N(u=>u.auth),{collapsed:w}=N(u=>u.auth),[M,P]=c.useState(!1),[h,l]=c.useState(!1),[C,A]=c.useState([]),[i,F]=c.useState(!1),[b,k]=c.useState([]),[S,v]=c.useState({lat:18.516726,lng:73.856255}),[x,y]=c.useState([]);let p=K();c.useEffect(()=>{f()},[]);const f=async()=>{let u=[],m=[];(await p(na({w_customer_id:s}))).payload.map(B=>{u.push({id:B.id,label:B.registration_id,value:B.imei[0].mac_id}),m.push(B.imei[0].mac_id)});const $="one",z=m;m.length>0&&p(la({type:$,imei:z})),A(u)};return n.jsxs("div",{className:"app",children:[n.jsx(ca,{}),n.jsxs("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:[n.jsx(da,{title:"Trip Monitor",setShowVehicles:P,showVehicles:M,setShowCard:l,showCard:h,sideBarTrip:i,setSideBarTrip:F}),n.jsxs(L,{style:{display:"flex",width:"100%",height:"95vh"},children:[n.jsx(L,{style:{width:M||i?"80%":"100%"},children:n.jsx(Sa,{center:S,showCard:h})}),M&&n.jsx(L,{style:{width:w?"25%":"20%"},children:n.jsx(ra,{vehicleData:C,title:"Live Monitor"})}),n.jsx(L,{style:{width:w?"25%":"20%",display:i?"block":"none"},children:n.jsx(Da,{setCenter:v,filteredTrips:b,setFilteredTrips:k,setSelectedTrip:y})})]})]})]})}export{Aa as default};
