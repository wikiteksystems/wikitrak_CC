import{j as e,B as $,k as G,l as k,r as u,ax as le,aB as K,aC as se,aD as z,v as D,aa as ie,aq as ce,ar as de,aE as ue,aF as he,aG as Q,J,x as re,aH as pe,T as Y,aI as me,P as X,E as ge,F as xe,H as fe,I as be,t as _e}from"./index-DSirb0Vv.js";import{L as we}from"./LiveMapTopBar-BSW9IrxS.js";import{V as je}from"./VehicleMenu-C6zFxzfj.js";import{L as ve,t as Ce}from"./LeftSideBar2-Bd-SQDFh.js";import"./Loader-BzzykVas.js";import"./LiveMapServices-DDn9RJgU.js";import"./Socket-0N_gnJcr.js";import{T as O,P as ke}from"./Parameters-CaTxvXXh.js";/* empty css           */import"./proj-XQwXs9DQ.js";import{M as te,D as oe,a as ye,T as Be}from"./TablePagination-B97jsYFQ.js";import{D as ae,a as Se,E as De,T as Te}from"./Edit-BB6dTuzl.js";import{B as P,F as Ie,c as Pe}from"./menu2-BQG8o08i.js";import{I as ne}from"./IconButton-DVPUcXXk.js";import{M as Le}from"./Paper-C9G-BC1_.js";import{T as Ae,a as Ve}from"./TableHead-CwqFVfBM.js";import{T as qe,b as Z,a as Ee}from"./TableRow-KbCK19Vv.js";import{d as Fe}from"./Close-DLILdIkI.js";import{u as Oe}from"./formik.esm-BqJ_FhN4.js";import{c as Re,a as S}from"./index.esm-CkJRGzgI.js";import{A as ee}from"./Autocomplete-Cb5bmvtF.js";import{T as I,M as We,a as H}from"./TextField-CIj5MwFO.js";import{S as Me}from"./SearchInput-Cs5srbeq.js";import{V as $e}from"./VehicleGroups-CtvuVnig.js";import"./wikitrak-DoqphnR6.js";import"./createSvgIcon-B0VyIYeK.js";import"./index-DFlEwBqt.js";import"./index-CfIuLGRf.js";import"./Card-f27UJEx6.js";import"./CardContent-BrYzV4kr.js";const Ge=({open:v,onClose:p,onConfirm:w})=>e.jsxs(te,{open:v,onClose:p,children:[e.jsx(ae,{children:"Confirm Deletion"}),e.jsx(oe,{children:e.jsxs(Se,{children:["Are you sure you want to delete this vehicle data?"," ",e.jsx("span",{style:{color:"red"},children:"This action cannot be undone."})]})}),e.jsxs(ye,{children:[e.jsx($,{onClick:p,color:"primary",children:"Cancel"}),e.jsx($,{onClick:w,color:"secondary",children:"Delete"})]})]}),Ne="http://134.209.145.234/api/v1",Ue={display:"flex",alignItems:"left",justifyContent:"left",gap:"8px"},He=({inspectionData:v})=>{const p=G(),{isUpdateInspection:w}=k(g=>g.inspection),[m,t]=u.useState(!1),C=()=>{console.log("inspectionData",v);const g=localStorage.getItem("role");le.includes(g)?(p(K(!w)),p(se(v)),p(z(v))):D.error(`Sorry! Your role is ${g}. You're not allowed to add, edit or delete the vehicle`)},x=async()=>{console.log("Vehicle data deleting");try{await ie.delete(`${Ne}/vehicles/delete/${vehicleData.id}/`),D.success("Vehicle data deleted successfully!"),p(ce())}catch(g){console.error("Error deleting vehicle data:",g),D.error("Failed to delete vehicle data. Please try again.")}t(!1)},j=()=>{t(!1)},_={color:"#686868"};return e.jsxs(P,{sx:Ue,children:[e.jsx(ne,{onClick:C,children:e.jsx(De,{sx:_})}),e.jsx(Ge,{open:m,onClose:j,onConfirm:x})]})},ze=[{id:"BDID",label:"BDID"},{id:"User",label:"User"},{id:"SubmissionDate",label:"Submission Date"},{id:"WorkshopGroup",label:"Workshop Group"},{id:"Status",label:"Status"},{id:"Actions",label:"Actions"}],Je=()=>{const{breakdowns:v}=k(r=>r.breakdown),{searchTerm:p}=k(r=>r.inspection),[w,m]=u.useState("asc"),[t,C]=u.useState("BDID"),[x,j]=u.useState(0),[_,g]=u.useState(5),[q,y]=u.useState({id:"",status:"",workshop:"",user:""}),h=r=>{m(t===r&&w==="asc"?"desc":"asc"),C(r)},T=(r,l)=>{j(l)},s=r=>{g(parseInt(r.target.value,10)),j(0)},E=(r,l,f)=>r.filter(c=>{const d=f.toLowerCase(),n=c.breakdown_id.toLowerCase().includes(d),b=`${c.user.us_user.first_name} ${c.user.us_user.last_name}`.toLowerCase().includes(d),V=c.status.toLowerCase().includes(d),W=c.workshop_group.group_name.toLowerCase().includes(d);return!(f&&!(n||b||V||W)||l.id&&!c.breakdown_id.includes(l.id)||l.status&&c.status!==l.status||l.workshop&&c.workshop_group.group_name!==l.workshop||l.user&&!c.user.us_user.first_name.toLowerCase().includes(l.user.toLowerCase())&&!c.user.us_user.last_name.toLowerCase().includes(l.user.toLowerCase()))}),L=(r,l,f,c)=>{if(c==="User"){const d=`${r.user.us_user.first_name} ${r.user.us_user.last_name}`.toLowerCase(),n=`${l.user.us_user.first_name} ${l.user.us_user.last_name}`.toLowerCase();return f==="asc"?d.localeCompare(n):n.localeCompare(d)}if(c==="WorkshopGroup"){const d=r.workshop_group.group_name.toLowerCase(),n=l.workshop_group.group_name.toLowerCase();return f==="asc"?d.localeCompare(n):n.localeCompare(d)}if(c==="BDID"){const d=parseInt(r.breakdown_id.replace("BD-",""),10),n=parseInt(l.breakdown_id.replace("BD-",""),10);return f==="asc"?d-n:n-d}if(c==="SubmissionDate"){const d=new Date(r.submission_date),n=new Date(l.submission_date);return f==="asc"?d-n:n-d}if(c==="Status"){const d={Open:1,Close:2,Rejected:3},n=d[r.status]||0,b=d[l.status]||0;return f==="asc"?n-b:b-n}return 0},A=E(v.slice(),q,p).sort((r,l)=>L(r,l,w,t)),o=A.slice(x*_,x*_+_),i={fontSize:"14px",fontWeight:"bold",fontFamily:"Ubuntu",color:"black",cursor:"pointer",background:"#f2f2f2"};return e.jsx(P,{sx:{m:"10px"},children:e.jsxs(Le,{children:[e.jsx(Ae,{sx:{height:"73vh",bgcolor:"white",borderRadius:"10px"},children:e.jsxs(qe,{stickyHeader:!0,children:[e.jsx(Ve,{children:e.jsx(Z,{children:ze.map(r=>e.jsx(O,{sx:i,children:e.jsx(Te,{active:t===r.id,direction:t===r.id?w:"asc",onClick:()=>h(r.id),children:r.label})},r.id))})}),e.jsx(Ee,{children:o.map((r,l)=>e.jsxs(Z,{children:[e.jsx(O,{children:r.breakdown_id}),e.jsx(O,{children:`${r.user.us_user.first_name} ${r.user.us_user.last_name}`}),e.jsx(O,{children:r.submission_date||"N/A"}),e.jsx(O,{children:r.workshop_group.group_name}),e.jsx(O,{sx:{color:r.status==="Open"?"blue":r.status==="Close"?"green":"red"},children:r.status}),e.jsx(O,{children:e.jsx(He,{inspectionData:r})})]},l))})]})}),e.jsx(Be,{component:"div",count:A.length,page:x,onPageChange:T,rowsPerPage:_,onRowsPerPageChange:s,rowsPerPageOptions:[5,10,15]})]})})},Ye=Je;function Ke({searchTerm:v}){var L,A;const{vehicles_details:p}=k(o=>o.dashboard),{breakdownTopics:w,UpdatedBreakdownData:m}=k(o=>o.breakdown),{UpdatedInspectionData:t}=k(o=>o.inspection),{w_customer_id:C}=k(o=>o.auth),[x,j]=u.useState(null),[_,g]=u.useState(""),[q,y]=u.useState(!1);let h=G(),T=JSON.parse(localStorage.getItem("w_userDetails"));u.useEffect(()=>{console.log("UpdatedInspectionData",t)},[t]),u.useEffect(()=>{t&&(j(t.attachment),g("edit"))},[t]);const s=Oe({initialValues:{vehicle:((L=t==null?void 0:t.vehicle)==null?void 0:L.id)||"",breakdown_topic:((A=t==null?void 0:t.breakdown_topic)==null?void 0:A.id)||"",odometer_reading:(t==null?void 0:t.odometer_reading)||"",description:(t==null?void 0:t.description)||"",mob_no:(t==null?void 0:t.mob_no)||"",email:(t==null?void 0:t.email)||"",attachment:(t==null?void 0:t.attachment)||"",submitted_by:`${T.first_name} ${T.last_name}`||"",resolved_issue:"",pending_issue:"",status:"Open"},validationSchema:Re({vehicle:S().required("Vehicle is required"),breakdown_topic:S().required("Breakdown Topic is required"),odometer_reading:S().required("Odometer Reading is required"),description:S().required("Description is required"),mob_no:S().matches(/^\d{10,11}$/,"Mobile number must be 10-11 digits").required("Mobile number is required"),email:S().email("Invalid email format").required("Email is required"),resolved_issue:S().required("Resolved issue is required"),pending_issue:S().required("Pending issue is required"),status:S().oneOf(["Open","Close","Rejected"],"Invalid status").required("Status is required"),submitted_by:S().required("Submitted is required")}),onSubmit:async(o,{resetForm:i})=>{try{y(!0),console.log("Submitted values:",o),o.submitted_by=T.user_id,o.location=m.location,o.breakdown=m.id,o.workshop_group=m.workshop_group.id;const r=[];if(m){let c=await de(m.attachment);console.log("file conversion",c),o.attachment=c;const d=m.id;r.push(h(ue({values:o,id:d})))}r.push(h(he({values:o})));const l=await Promise.allSettled(r);let f=!0;l.forEach((c,d)=>{if(c.status==="fulfilled"){const n=c.value.payload;n.success?(d===0&&m?D.success("Breakdown updated successfully!"):D.success("Inspection created successfully!"),i(),g(""),j(null),h(z(null)),h(K(!1)),h(se(null)),h(Q(!1)),h(J(C)),h(re()),y(!1)):(f=!1,D.error(n.error||"Failed to submit breakdown or inspection"))}else f=!1,D.error(c.reason.message||"Error occurred during submission")}),f&&(i(),g(""),j(null),h(z(null)),h(Q(!1)),h(pe(!1)),h(J(C))),y(!1)}catch(r){console.error("Submission Error:",r),D.error("Failed to submit breakdown or inspection. Please try again."),y(!1)}}}),E=o=>{const i=o.currentTarget.files[0];if(s.setFieldValue("attachment",i),g((i==null?void 0:i.name)||""),i&&i.type.startsWith("image/")){const r=new FileReader;r.onload=()=>j(r.result),r.readAsDataURL(i)}else j(null)};return e.jsx(P,{sx:{p:3,maxWidth:600,margin:"auto"},children:q?e.jsx(Y,{children:"Submitted the form data..."}):e.jsx(e.Fragment,{children:e.jsxs("form",{onSubmit:s.handleSubmit,children:[e.jsx(ee,{options:p,getOptionLabel:o=>o.registration_id,value:p.find(o=>o.id===s.values.vehicle)||null,onChange:(o,i)=>s.setFieldValue("vehicle",(i==null?void 0:i.id)||""),renderInput:o=>e.jsx(I,{...o,label:"Vehicle",error:s.touched.vehicle&&!!s.errors.vehicle,helperText:s.touched.vehicle&&s.errors.vehicle,fullWidth:!0})}),e.jsx(ee,{options:w,getOptionLabel:o=>o.topic,value:w.find(o=>o.id===s.values.breakdown_topic)||null,onChange:(o,i)=>s.setFieldValue("breakdown_topic",(i==null?void 0:i.id)||""),renderOption:(o,i)=>u.createElement("li",{...o,key:i.id},i.topic),renderInput:o=>e.jsx(I,{...o,label:"Breakdown Topic",error:s.touched.breakdown_topic&&!!s.errors.breakdown_topic,helperText:s.touched.breakdown_topic&&s.errors.breakdown_topic,fullWidth:!0,sx:{mt:2}})}),e.jsx(I,{label:"Odometer Reading",name:"odometer_reading",value:s.values.odometer_reading,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.odometer_reading&&!!s.errors.odometer_reading,helperText:s.touched.odometer_reading&&s.errors.odometer_reading,fullWidth:!0,sx:{mt:2}}),e.jsx(I,{label:"Description",name:"description",value:s.values.description,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.description&&!!s.errors.description,helperText:s.touched.description&&s.errors.description,fullWidth:!0,sx:{mt:2}}),e.jsx(I,{label:"Mobile Number",name:"mob_no",value:s.values.mob_no,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.mob_no&&!!s.errors.mob_no,helperText:s.touched.mob_no&&s.errors.mob_no,fullWidth:!0,sx:{mt:2}}),e.jsx(I,{label:"Email",name:"email",type:"email",value:s.values.email,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.email&&!!s.errors.email,helperText:s.touched.email&&s.errors.email,fullWidth:!0,sx:{mt:2}}),e.jsx(I,{label:"Submitted By",name:"submitted_by",value:s.values.submitted_by,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.submitted_by&&!!s.errors.submitted_by,helperText:s.touched.submitted_by&&s.errors.submitted_by,fullWidth:!0,sx:{mt:2}}),e.jsx(I,{label:"Resolved Issue",name:"resolved_issue",value:s.values.resolved_issue,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.resolved_issue&&!!s.errors.resolved_issue,helperText:s.touched.resolved_issue&&s.errors.resolved_issue,fullWidth:!0,sx:{mt:2}}),e.jsx(I,{label:"Pending Issue",name:"pending_issue",value:s.values.pending_issue,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.pending_issue&&!!s.errors.pending_issue,helperText:s.touched.pending_issue&&s.errors.pending_issue,fullWidth:!0,sx:{mt:2}}),e.jsxs(Ie,{fullWidth:!0,sx:{mt:2},children:[e.jsx(Pe,{children:"Status"}),e.jsxs(We,{label:"Status",name:"status",value:s.values.status,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.status&&!!s.errors.status,children:[e.jsx(H,{value:"Open",children:"Open"}),e.jsx(H,{value:"Close",children:"Close"}),e.jsx(H,{value:"Rejected",children:"Rejected"})]})]}),e.jsxs($,{component:"label",sx:{mt:2,border:"1px solid #f5f5f5",color:"black"},children:["Upload Attachment",e.jsx("input",{type:"file",hidden:!0,onChange:E})]}),_&&e.jsxs(Y,{variant:"body2",sx:{mt:1},children:["Uploaded File: ",_]}),x&&e.jsx(P,{component:"img",src:x,alt:"Image Preview",sx:{mt:1,width:"100%",maxHeight:200}}),e.jsx($,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,sx:{mt:3},children:"Submit"})]})})})}function Qe({where:v}){const{isUpdateInspection:p,UpdatedInspectionData:w}=k(x=>x.inspection);let m=G();const t=()=>{m(K(!1))},C={fontSize:"18px",fontWeight:500,lineHeight:"18.38px",textAlign:"center",paddingTop:"5px",fontFamily:"ubuntu"};return e.jsxs(P,{sx:{bgcolor:"white",m:"10px",display:"flex",textAlign:"left",justifyContent:"space-between",alignItems:"center",borderRadius:"6px",padding:"20px"},children:[e.jsx(Me,{}),e.jsx(Y,{variant:"h6",sx:C,children:"New Breakdown Requests"}),e.jsxs(te,{open:p,onClose:t,maxWidth:"md",fullWidth:!0,children:[e.jsxs(ae,{children:["Update Breakdown Status",e.jsx(ne,{"aria-label":"close",onClick:t,sx:{position:"absolute",right:8,top:8,color:x=>x.palette.grey[500]},children:e.jsx(Fe,{})})]}),e.jsx(oe,{children:e.jsx(Ke,{})})]})]})}function Ds(){const{locationData:v,selectedVehicle:p,selectedParameterList:w}=k(n=>n.liveMap),{mode:m,selectedVehicleGroup:t}=k(n=>n.dashboard),C=Ce(m),[x,j]=u.useState([]),{w_customer_id:_}=k(n=>n.auth),[g,q]=u.useState(),[y,h]=u.useState(!1),[T,s]=u.useState(!1),[E,L]=u.useState([]);u.useState(!0);const[A,o]=u.useState(!1),[i,r]=u.useState(!1);let l=G();u.useEffect(()=>{f(),l(re()),l(J(_)),l(me())},[]),u.useEffect(()=>{L([]),l(X([{reg_id:"",imei:"",params:[]}]))},[p]);const f=async()=>{try{r(!0);let n=[],b=[];const V=await l(ge({w_customer_id:_}));if(Array.isArray(V.payload)){V.payload.forEach(a=>{var R,F,U,B;Array.isArray(a.imei)&&a.imei.length>0&&((R=a.imei[0])!=null&&R.mac_id)?(n.push({id:a.id,label:a.registration_id,value:(F=a.imei[0])==null?void 0:F.mac_id,vehilce_type:a==null?void 0:a.segment,chassis_no:a==null?void 0:a.chassis_no,engine_no:a==null?void 0:a.engine_no,workShop:a==null?void 0:a.workshop,registration_id:a==null?void 0:a.registration_id,sell_date:a==null?void 0:a.sell_date,customer_name:a==null?void 0:a.customer_name,vehicle_model:(U=a==null?void 0:a.vehicle_model)==null?void 0:U.name,vehicle_group:a==null?void 0:a.vehicle_group}),b.push((B=a.imei[0])==null?void 0:B.mac_id)):console.error("IMEI data not found for item:",a)});const W="one",N=b;b.length>0&&l(xe({type:W,imei:N})),j(n),l(fe(n)),r(!1),l(be({w_customer_id:_}))}else r(!1),console.error("Unexpected data format:",V),D.error("Unexpected data format:")}catch(n){console.error("Error fetching vehicle data:",n),D.error(`Error fetching vehicle data: ${n}`)}},c=async n=>{const{label:b,imei:V,id:W,reg_id:N,checked:a}=n;q(B=>B.map(M=>M.id===W?{...M,checked:!a}:M));let R=[...E],F=[...E];if(!a)v.forEach(B=>{B.latestDocument.imei===V&&(R.push({label:b,value:B.latestDocument[b==="maininputvoltage"?"mainInputVoltage":b]}),F=R,L(R))});else{let B=E.filter(M=>M.label!==b);F=B,L(B)}console.log("tempParamList",F),l(X([{reg_id:N,imei:V,params:F}]))},d=x.filter(n=>Object.keys(t).length===0||n.vehicle_group===t.id);return e.jsxs("div",{className:"app",children:[e.jsx(ve,{}),e.jsxs("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:[e.jsx(we,{title:"Inspections",setShowVehicles:h,showVehicles:y,setShowVehiclesGroup:o,showVehiclesGroup:A}),e.jsx($e,{setShowVehiclesGroup:o,showVehiclesGroup:A}),e.jsxs(P,{style:{display:"flex",width:"100%",height:"95vh"},children:[e.jsxs(P,{style:{width:y||T?"80%":"100%",background:_e.bgShadow},children:[e.jsx(Qe,{where:"inspection"}),e.jsx(Ye,{})]}),y&&e.jsx(P,{style:{width:"20%",backgroundColor:C.grey[100]},children:e.jsx(je,{vehicleData:d,title:"Inspections",setParameterData:q,loadingVehicle:i,setShowVehicles:h,showVehicles:y,showParameters:T,setShowParameters:s})}),T&&e.jsx(P,{style:{width:"20%",backgroundColor:C.grey[100]},children:e.jsx(ke,{parametersData:g,setParameterData:q,handleParameterChange:c})})]})]})]})}export{Ds as default};
