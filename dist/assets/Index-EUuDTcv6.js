import{k as _,r as i,i as U,aF as oe,aO as te,aP as ae,w as x,aQ as z,aR as X,aS as ie,aT as K,P as H,C as ee,aU as le,j as s,T as J,B as Q,I as ne,x as de,ai as ce,av as ue,Z as Y,K as he,L as me,N as pe,O as ge,t as fe}from"./index-CKjp3d9V.js";import{L as be}from"./LiveMapTopBar-BtNx7u7S.js";import{V as xe}from"./VehicleMenu-BlonerqH.js";import{t as _e}from"./SearchTab-sG8UR0OJ.js";import"./Loader-D5115KPs.js";import"./LiveMapServices-CskllE8p.js";import"./Socket-0N_gnJcr.js";import{P as ve}from"./Parameters-CZMZJRu5.js";/* empty css           */import"./proj-XQwXs9DQ.js";import{L as we}from"./LeftSideBar2-DYhandyc.js";import{I as je}from"./InspectionsTable-xmazTHKE.js";import{d as ye}from"./Close-CgexDTh0.js";import{u as Be}from"./formik.esm-D2pKvO9E.js";import{c as Se,a as m}from"./index.esm-B0zxLEFQ.js";import{B as S,F as ke,a as Ce}from"./menu2-D3H8DLpV.js";import{A as Z}from"./Autocomplete-P2GMHaNS.js";import{T as f,S as Ie,M as $}from"./TextField-DKyp-rgf.js";import{S as Te}from"./SearchInput-Bb08CROk.js";import{D as Ve,a as qe}from"./TablePagination-r-Ej6gSR.js";import{D as Pe}from"./Edit-CbTx1E1f.js";import{V as Le}from"./VehicleGroups-WuZZqOQ_.js";import"./jcb-aCHXMCXy.js";import"./index-CXo5Mh2J.js";import"./index-BDktHC7D.js";import"./createSvgIcon-Bgx1R9qU.js";import"./useControlled-CKWIiIeG.js";import"./Card-Cs-NsU0Q.js";import"./CardContent-CSxZEYeI.js";import"./TableRow-Beqbh2fb.js";import"./TableCell-MHz34M0j.js";function Ee({searchTerm:O}){var T,A;const{vehicles_details:k}=_(o=>o.dashboard),{breakdownTopics:W,UpdatedBreakdownData:u}=_(o=>o.breakdown),{UpdatedInspectionData:t}=_(o=>o.inspection),{w_customer_id:v}=_(o=>o.auth),[b,w]=i.useState(null),[C,I]=i.useState(""),[L,p]=i.useState(!1);let n=U(),j=JSON.parse(localStorage.getItem("w_userDetails"));i.useEffect(()=>{console.log("UpdatedInspectionData",t)},[t]),i.useEffect(()=>{t&&(w(t.attachment),I("edit"))},[t]);const e=Be({initialValues:{vehicle:((T=t==null?void 0:t.vehicle)==null?void 0:T.id)||"",breakdown_topic:((A=t==null?void 0:t.breakdown_topic)==null?void 0:A.id)||"",odometer_reading:(t==null?void 0:t.odometer_reading)||"",description:(t==null?void 0:t.description)||"",mob_no:(t==null?void 0:t.mob_no)||"",email:(t==null?void 0:t.email)||"",attachment:(t==null?void 0:t.attachment)||"",submitted_by:`${j.first_name} ${j.last_name}`||"",resolved_issue:"",pending_issue:"",status:"Open"},validationSchema:Se({vehicle:m().required("Vehicle is required"),breakdown_topic:m().required("Breakdown Topic is required"),odometer_reading:m().required("Odometer Reading is required"),description:m().required("Description is required"),mob_no:m().matches(/^\d{10,11}$/,"Mobile number must be 10-11 digits").required("Mobile number is required"),email:m().email("Invalid email format").required("Email is required"),resolved_issue:m().required("Resolved issue is required"),pending_issue:m().required("Pending issue is required"),status:m().oneOf(["Open","Close","Rejected"],"Invalid status").required("Status is required"),submitted_by:m().required("Submitted is required")}),onSubmit:async(o,{resetForm:a})=>{try{p(!0),console.log("Submitted values:",o),o.submitted_by=j.user_id,o.location=u.location,o.breakdown=u.id,o.workshop_group=u.workshop_group.id;const d=[];if(u){if(u.attachment){let V=await oe(u.attachment);console.log("file conversion",V),o.attachment=V}const y=u.id;d.push(n(te({values:o,id:y})))}d.push(n(ae({values:o})));const R=await Promise.allSettled(d);let c=!0;R.forEach((y,V)=>{if(y.status==="fulfilled"){const F=y.value.payload;F.success?(V===0&&u?x.success("Breakdown updated successfully!"):x.success("Inspection created successfully!"),a(),I(""),w(null),n(z(null)),n(X(!1)),n(ie(null)),n(K(!1)),n(H(v)),n(ee()),p(!1)):(c=!1,x.error(F.error||"Failed to submit breakdown or inspection"))}else c=!1,x.error(y.reason.message||"Error occurred during submission")}),c&&(a(),I(""),w(null),n(z(null)),n(K(!1)),n(le(!1)),n(H(v))),p(!1)}catch(d){console.error("Submission Error:",d),x.error("Failed to submit breakdown or inspection. Please try again."),p(!1)}}}),E=o=>{const a=o.currentTarget.files[0];if(e.setFieldValue("attachment",a),I((a==null?void 0:a.name)||""),a&&a.type.startsWith("image/")){const d=new FileReader;d.onload=()=>w(d.result),d.readAsDataURL(a)}else w(null)};return s.jsx(S,{sx:{p:3,maxWidth:600,margin:"auto"},children:L?s.jsx(J,{children:"Submitted the form data..."}):s.jsx(s.Fragment,{children:s.jsxs("form",{onSubmit:e.handleSubmit,children:[s.jsx(Z,{options:k,getOptionLabel:o=>o.registration_id,value:k.find(o=>o.id===e.values.vehicle)||null,onChange:(o,a)=>e.setFieldValue("vehicle",(a==null?void 0:a.id)||""),renderInput:o=>s.jsx(f,{...o,label:"Vehicle",error:e.touched.vehicle&&!!e.errors.vehicle,helperText:e.touched.vehicle&&e.errors.vehicle,fullWidth:!0})}),s.jsx(Z,{options:W,getOptionLabel:o=>o.topic,value:W.find(o=>o.id===e.values.breakdown_topic)||null,onChange:(o,a)=>e.setFieldValue("breakdown_topic",(a==null?void 0:a.id)||""),renderOption:(o,a)=>i.createElement("li",{...o,key:a.id},a.topic),renderInput:o=>s.jsx(f,{...o,label:"Breakdown Topic",error:e.touched.breakdown_topic&&!!e.errors.breakdown_topic,helperText:e.touched.breakdown_topic&&e.errors.breakdown_topic,fullWidth:!0,sx:{mt:2}})}),s.jsx(f,{label:"Odometer Reading",name:"odometer_reading",value:e.values.odometer_reading,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.odometer_reading&&!!e.errors.odometer_reading,helperText:e.touched.odometer_reading&&e.errors.odometer_reading,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Description",name:"description",value:e.values.description,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.description&&!!e.errors.description,helperText:e.touched.description&&e.errors.description,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Mobile Number",name:"mob_no",value:e.values.mob_no,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.mob_no&&!!e.errors.mob_no,helperText:e.touched.mob_no&&e.errors.mob_no,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Email",name:"email",type:"email",value:e.values.email,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.email&&!!e.errors.email,helperText:e.touched.email&&e.errors.email,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Submitted By",name:"submitted_by",value:e.values.submitted_by,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.submitted_by&&!!e.errors.submitted_by,helperText:e.touched.submitted_by&&e.errors.submitted_by,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Resolved Issue",name:"resolved_issue",value:e.values.resolved_issue,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.resolved_issue&&!!e.errors.resolved_issue,helperText:e.touched.resolved_issue&&e.errors.resolved_issue,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Pending Issue",name:"pending_issue",value:e.values.pending_issue,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.pending_issue&&!!e.errors.pending_issue,helperText:e.touched.pending_issue&&e.errors.pending_issue,fullWidth:!0,sx:{mt:2}}),s.jsxs(ke,{fullWidth:!0,sx:{mt:2},children:[s.jsx(Ce,{children:"Status"}),s.jsxs(Ie,{label:"Status",name:"status",value:e.values.status,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.status&&!!e.errors.status,children:[s.jsx($,{value:"Open",children:"Open"}),s.jsx($,{value:"Close",children:"Close"}),s.jsx($,{value:"Rejected",children:"Rejected"})]})]}),s.jsxs(Q,{component:"label",sx:{mt:2,border:"1px solid #f5f5f5",color:"black"},children:["Upload Attachment",s.jsx("input",{type:"file",hidden:!0,onChange:E})]}),C&&s.jsxs(J,{variant:"body2",sx:{mt:1},children:["Uploaded File: ",C]}),b&&s.jsx(S,{component:"img",src:b,alt:"Image Preview",sx:{mt:1,width:"100%",maxHeight:200}}),s.jsx(Q,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,sx:{mt:3},children:"Submit"})]})})})}function Ae({where:O}){const{isUpdateInspection:k,UpdatedInspectionData:W}=_(b=>b.inspection);let u=U();const t=()=>{u(X(!1))},v={fontSize:"18px",fontWeight:500,lineHeight:"18.38px",textAlign:"center",paddingTop:"5px",fontFamily:"ubuntu"};return s.jsxs(S,{sx:{bgcolor:"white",m:"10px",display:"flex",textAlign:"left",justifyContent:"space-between",alignItems:"center",borderRadius:"6px",padding:"20px"},children:[s.jsx(Te,{}),s.jsx(J,{variant:"h6",sx:v,children:"New Breakdown Requests"}),s.jsxs(Ve,{open:k,onClose:t,maxWidth:"md",fullWidth:!0,children:[s.jsxs(Pe,{children:["Update Breakdown Status",s.jsx(ne,{"aria-label":"close",onClick:t,sx:{position:"absolute",right:8,top:8,color:b=>b.palette.grey[500]},children:s.jsx(ye,{})})]}),s.jsx(qe,{children:s.jsx(Ee,{})})]})]})}function ms(){const{locationData:O,selectedVehicle:k,selectedParameterList:W}=_(l=>l.liveMap),{mode:u,selectedVehicleGroup:t}=_(l=>l.dashboard),v=_e(u),[b,w]=i.useState([]),{w_customer_id:C}=_(l=>l.auth),[I,L]=i.useState(),[p,n]=i.useState(!1),[j,e]=i.useState(!1),[E,T]=i.useState([]);i.useState(!0);const[A,o]=i.useState(!1),[a,d]=i.useState(!1),R=JSON.parse(localStorage.getItem("w_userDetails"));let c=U(),y=de();i.useEffect(()=>{ce.includes(R.role)?console.log("you can access this route"):(console.log("you can't access this route"),V())},[]);const V=()=>{console.log("oh! this route not allowed"),y("/dashboard"),x.error("You're not allowed to access inspection.")};i.useEffect(()=>{F(),c(ee()),c(H(C)),c(ue())},[]),i.useEffect(()=>{T([]),c(Y([{reg_id:"",imei:"",params:[]}]))},[k]);const F=async()=>{try{d(!0);let l=[],g=[];const q=await c(he({w_customer_id:C}));if(Array.isArray(q.payload)){q.payload.forEach(r=>{var P,B,G,h;Array.isArray(r.imei)&&r.imei.length>0&&((P=r.imei[0])!=null&&P.mac_id)?(l.push({id:r.id,label:r.registration_id,value:(B=r.imei[0])==null?void 0:B.mac_id,vehilce_type:r==null?void 0:r.segment,chassis_no:r==null?void 0:r.chassis_no,engine_no:r==null?void 0:r.engine_no,workShop:r==null?void 0:r.workshop,registration_id:r==null?void 0:r.registration_id,sell_date:r==null?void 0:r.sell_date,customer_name:r==null?void 0:r.customer_name,vehicle_model:(G=r==null?void 0:r.vehicle_model)==null?void 0:G.name,vehicle_group:r==null?void 0:r.vehicle_group}),g.push((h=r.imei[0])==null?void 0:h.mac_id)):console.error("IMEI data not found for item:",r)});const N="one",M=g;g.length>0&&c(me({type:N,imei:M})),w(l),c(pe(l)),d(!1),c(ge({w_customer_id:C}))}else d(!1),console.error("Unexpected data format:",q),x.error("Unexpected data format:")}catch(l){console.error("Error fetching vehicle data:",l),x.error(`Error fetching vehicle data: ${l}`)}},se=async l=>{const{label:g,imei:q,id:N,reg_id:M,checked:r}=l;L(h=>h.map(D=>D.id===N?{...D,checked:!r}:D));let P=[...E],B=[...E];if(!r)O.forEach(h=>{h.latestDocument.imei===q&&(P.push({label:g,value:h.latestDocument[g==="maininputvoltage"?"mainInputVoltage":g]}),B=P,T(P))});else{let h=E.filter(D=>D.label!==g);B=h,T(h)}console.log("tempParamList",B),c(Y([{reg_id:M,imei:q,params:B}]))},re=b.filter(l=>Object.keys(t).length===0||l.vehicle_group===t.id);return s.jsxs("div",{className:"app",children:[s.jsx(we,{}),s.jsxs("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:[s.jsx(be,{title:"Inspections",setShowVehicles:n,showVehicles:p,setShowVehiclesGroup:o,showVehiclesGroup:A}),s.jsx(Le,{setShowVehiclesGroup:o,showVehiclesGroup:A}),s.jsxs(S,{style:{display:"flex",width:"100%",height:"95vh"},children:[s.jsxs(S,{style:{width:p||j?"80%":"100%",background:fe.bgShadow},children:[s.jsx(Ae,{where:"inspection"}),s.jsx(je,{})]}),p&&s.jsx(S,{style:{width:"20%",backgroundColor:v.grey[100]},children:s.jsx(xe,{vehicleData:re,title:"Inspections",setParameterData:L,loadingVehicle:a,setShowVehicles:n,showVehicles:p,showParameters:j,setShowParameters:e})}),j&&s.jsx(S,{style:{width:"20%",backgroundColor:v.grey[100]},children:s.jsx(ve,{parametersData:I,setParameterData:L,handleParameterChange:se})})]})]})]})}export{ms as default};
