import{j as r,f3 as xe,f4 as pe,T as ne,aZ as J,ei as me,f5 as je,f6 as ge,bd as I,b0 as M,a$ as be,fl as re,fm as fe,fn as ye,fo as Ce,fp as ve,aX as K,fq as Se,eu as c,dP as _,r as m,fh as Be,bn as y,fi as Te,bg as Ae,da as qe,ch as Pe,dY as ke,dZ as $e,d_ as Ye,d$ as ue,e0 as b,e1 as Fe,f7 as Ve}from"./index-B9W9A0YN.js";import{u as Re}from"./formik.esm-D-reUPUz.js";import{c as Oe,f as he,a as O,e as Me}from"./index.esm-R3Gd3xrx.js";import{A as X}from"./Autocomplete-XJJmeDcA.js";import{R as He,A as Le,D as We}from"./Remove-CXcyEgiF.js";import{T as Ne,d as Ee}from"./excelUtils-CKXoEBjl.js";import{T as Ie,E as Je}from"./Edit-jq5htzrK.js";const Ue=["Approved","Rejected","Open","On Hold"],ze=["Open","Close","Rejected"],Ze=({open:n,handleClose:x,updateData:U,rowData:Y,isTechnician:h,isInspection:$})=>r.jsxs(xe,{open:n,onClose:x,maxWidth:"xl",fullWidth:!0,children:[r.jsxs(pe,{sx:{m:0,p:2},children:[r.jsx(ne,{variant:"h6",children:"Vehicle Service Job Card"}),r.jsx(J,{"aria-label":"close",onClick:x,sx:{position:"absolute",right:8,top:8,color:j=>j.palette.grey[500]},children:r.jsx(me,{})})]}),r.jsx(je,{dividers:!0,children:r.jsx(Ge,{updateData:U,onClose:x,rowData:Y,isTechnician:h,isInspection:$})}),r.jsx(ge,{children:r.jsx(I,{onClick:x,color:"secondary",variant:"outlined",children:"Close"})})]}),Ge=({updateData:n,rowData:x,onClose:U,isTechnician:Y,isInspection:h})=>{var Z,W,G,w,ee,Q;const{loading:$}=M(t=>t.breakdown),j=be(),{vehicleList:ie}=M(t=>t.liveMap),{w_customer_id:F}=M(t=>t.auth),{sparePartList:H}=M(t=>t.inspection),{id:L,vehicle:u,service_type:V}=x||{};let D=(n?n==null?void 0:n.jobcard_parts:x==null?void 0:x.service_parts).map(t=>{var a;return{spare_parts:(a=t==null?void 0:t.spare_parts)==null?void 0:a.id,quantity:t==null?void 0:t.quantity}});const z=Oe({vehicle:O().required("Vehicle is required"),chassis_no:O().required("Chassis No is required"),engine_no:O().required("Engine No is required"),hmr:Me().required("Working Hrs is required").positive("Must be positive").integer("Must be an integer"),submission_date:he().required("Date is required"),technician_observation:O().required("Technician Observations are required"),status:O().required("Status is required"),service_status:O().required("Status is required"),approval_date:h&&he().required("Approval Date is required")}),s=Re({initialValues:{vehicle:((Z=n==null?void 0:n.vehicle)==null?void 0:Z.id)||(u==null?void 0:u.id)||"",service:((W=n==null?void 0:n.service)==null?void 0:W.id)||L||"",chassis_no:(n==null?void 0:n.chassis_no)||(u==null?void 0:u.chassis_no),engine_no:(n==null?void 0:n.engine_no)||(u==null?void 0:u.engine_no),hmr:(n==null?void 0:n.hmr)||"",service_type:(n==null?void 0:n.service_type)||V,submission_date:(n==null?void 0:n.submission_date)||re(new Date),completion_date:(n==null?void 0:n.completion_date)||"",technician_observation:(n==null?void 0:n.technician_observation)||"",jobcard_parts:D||[],status:(n==null?void 0:n.status)||"Open",service_status:(n==null?void 0:n.service_status)||"Open",issued_attachment:(n==null?void 0:n.issued_attachment)||null,submitted_by:(n==null?void 0:n.submitted_by.id)||F,type:"ServiceRecord",approval_date:(n==null?void 0:n.approval_date)||"",reviewed_by:((G=n==null?void 0:n.reviewed_by)==null?void 0:G.id)||(h?F:"")},validationSchema:z,onSubmit:async t=>{var v,p;const a=new FormData;for(const l in s.values)if(l==="issued_attachment"){const d=s.values[l];d instanceof File?a.append("issued_attachment",d):typeof d=="string"&&a.append("issued_attachment_url",d)}else a.append(l,s.values[l]);let o;if(n?(console.log(n,t),o=await j(fe({formData:a,id:n==null?void 0:n.id}))):o=await j(ye(a)),o!=null&&o.payload){console.log("api response",(v=o==null?void 0:o.payload)==null?void 0:v.data);const{id:l}=(p=o==null?void 0:o.payload)==null?void 0:p.data,{jobcard_parts:d}=t;j(Ce({jobcard:l,parts:d})),U(),j(ve({job_card_type:"ServiceRecord",isInspection:h}))}}});return r.jsxs(K,{sx:{padding:"15px"},children:[$&&r.jsx(Se,{}),r.jsx("form",{onSubmit:s.handleSubmit,children:r.jsxs(c,{container:!0,spacing:2,children:[r.jsx(c,{item:!0,xs:6,children:r.jsx(_,{label:"Vehicle*",fullWidth:!0,name:"vehicle",value:((w=n==null?void 0:n.vehicle)==null?void 0:w.registration_id)||(u==null?void 0:u.registration_id),onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.vehicle&&!!s.errors.vehicle,helperText:s.touched.vehicle&&s.errors.vehicle,disabled:!0})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(_,{label:"Chassis No*",fullWidth:!0,name:"chassis_no",value:s.values.chassis_no,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.chassis_no&&!!s.errors.chassis_no,helperText:s.touched.chassis_no&&s.errors.chassis_no,disabled:!0})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(_,{label:"Engine No*",fullWidth:!0,name:"engine_no",value:s.values.engine_no,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.engine_no&&!!s.errors.engine_no,helperText:s.touched.engine_no&&s.errors.engine_no,disabled:!0})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(X,{options:[],getOptionLabel:t=>t,value:s.values.service_type,onChange:(t,a)=>s.setFieldValue("service_type",a||""),disabled:!0,renderInput:t=>r.jsx(_,{...t,label:"Service Type",error:s.touched.service_type&&!!s.errors.service_type,helperText:s.touched.service_type&&s.errors.service_type})})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(_,{label:"HMR*",fullWidth:!0,type:"number",name:"hmr",value:s.values.hmr,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.hmr&&!!s.errors.hmr,helperText:s.touched.hmr&&s.errors.hmr,disabled:h})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(_,{label:"Date",name:"submission_date",type:"datetime-local",value:s.values.submission_date,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.submission_date&&!!s.errors.submission_date,helperText:s.touched.submission_date&&s.errors.submission_date,fullWidth:!0,InputLabelProps:{shrink:!0},disabled:!0})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(_,{label:"Completion Date",name:"completion_date",type:"datetime-local",value:s.values.completion_date,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.completion_date&&!!s.errors.completion_date,helperText:s.touched.completion_date&&s.errors.completion_date,fullWidth:!0,InputLabelProps:{shrink:!0},disabled:!0})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(_,{label:"Technician Observations*",fullWidth:!0,name:"technician_observation",value:s.values.technician_observation,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.technician_observation&&!!s.errors.technician_observation,helperText:s.touched.technician_observation&&s.errors.technician_observation,disabled:h})}),r.jsxs(c,{item:!0,xs:12,children:[r.jsx(ne,{variant:"h6",gutterBottom:!0,children:"Parts Requirement*(If any information available)"}),(Q=(ee=s==null?void 0:s.values)==null?void 0:ee.jobcard_parts)==null?void 0:Q.map((t,a)=>{var p;const o=(p=s.values)==null?void 0:p.jobcard_parts.map(l=>l.spare_parts).filter((l,d)=>d!==a),v=H.filter(l=>!o.includes(l.id));return r.jsxs(c,{container:!0,spacing:2,marginTop:"0px",alignItems:"center",children:[r.jsx(c,{item:!0,xs:12,md:6,children:r.jsx(X,{options:v,getOptionLabel:l=>l.description,value:H.find(l=>l.id===t.spare_parts)||null,onChange:(l,d)=>s.setFieldValue(`jobcard_parts[${a}].spare_parts`,(d==null?void 0:d.id)||""),renderInput:l=>r.jsx(_,{...l,label:"Spare Part",fullWidth:!0})})}),r.jsx(c,{item:!0,xs:8,md:4,children:r.jsxs(K,{display:"flex",alignItems:"center",children:[r.jsx(J,{onClick:()=>s.setFieldValue(`jobcard_parts[${a}].quantity`,Math.max(1,t.quantity-1)),children:r.jsx(He,{})}),r.jsx(_,{value:t.quantity,type:"number",inputProps:{min:1},onChange:l=>s.setFieldValue(`jobcard_parts[${a}].quantity`,parseInt(l.target.value,10)),sx:{width:90,mx:1,textAlign:"center"}}),r.jsx(J,{onClick:()=>s.setFieldValue(`jobcard_parts[${a}].quantity`,t.quantity+1),children:r.jsx(Le,{})})]})}),r.jsx(c,{item:!0,xs:4,md:2,children:r.jsx(J,{color:"error",onClick:()=>{var d;const l=[...(d=s.values)==null?void 0:d.jobcard_parts];l.splice(a,1),s.setFieldValue("jobcard_parts",l)},children:r.jsx(We,{})})})]},a)}),r.jsx(I,{variant:"outlined",onClick:()=>{var o,v,p;const t=(v=(o=s.values)==null?void 0:o.jobcard_parts)==null?void 0:v.map(l=>l.spare_parts);if(H.filter(l=>!(t!=null&&t.includes(l.id))).length===0){toast.error("All available spare parts have already been added.");return}s.setFieldValue("jobcard_parts",[...(p=s.values)==null?void 0:p.jobcard_parts,{spare_parts:"",quantity:1}])},sx:{mt:2},children:"+ Add Spare Part"})]}),r.jsx(c,{item:!0,xs:6,children:r.jsx(_,{label:"Approval Date",name:"approval_date",type:"datetime-local",value:s.values.approval_date,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.approval_date&&!!s.errors.approval_date,helperText:s.touched.approval_date&&s.errors.approval_date,fullWidth:!0,InputLabelProps:{shrink:!0},disabled:!0})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(X,{options:Ue,value:s.values.service_status,onChange:(t,a)=>{s.setFieldValue("service_status",a||""),s.setFieldValue("approval_date",re(new Date))},disabled:!h,renderInput:t=>r.jsx(_,{...t,label:"Approval Status by Service Engineer*",error:s.touched.service_status&&!!s.errors.service_status,helperText:s.touched.service_status&&s.errors.service_status})})}),!h&&r.jsx(c,{item:!0,xs:6,children:r.jsx(X,{options:ze,value:s.values.status,onChange:(t,a)=>{s.setFieldValue("status",a||""),s.setFieldValue("completion_date",re(new Date))},disabled:s.values.service_status!=="Approved",renderInput:t=>r.jsx(_,{...t,label:"Technician Status"})})}),r.jsxs(c,{item:!0,xs:6,children:[!h&&r.jsxs(I,{variant:"outlined",component:"label",fullWidth:!0,children:["Upload File",r.jsx("input",{type:"file",hidden:!0,onChange:t=>{const a=t.currentTarget.files[0];a&&s.setFieldValue("issued_attachment",a)}})]}),s.values.issued_attachment&&r.jsxs(c,{container:!0,spacing:1,mt:1,alignItems:"center",children:[r.jsx(c,{item:!0,children:r.jsxs(ne,{variant:"body2",children:[r.jsx("b",{children:"Attachment:"})," ",typeof s.values.issued_attachment=="string"?s.values.issued_attachment.split("/").pop():s.values.issued_attachment.name]})}),r.jsx(c,{item:!0,children:r.jsx(I,{size:"small",variant:"text",onClick:()=>{const t=typeof s.values.issued_attachment=="string"?s.values.issued_attachment:URL.createObjectURL(s.values.issued_attachment);window.open(t,"_blank")},children:"View File"})})]})]}),r.jsx(c,{item:!0,xs:12,children:r.jsx(I,{type:"submit",variant:"contained",fullWidth:!0,color:"primary",children:n?"Update":"Submit"})})]})})]})},_e=[{id:"service_record_id",label:"SRID"},{id:"registration_id",label:"Vehicle No"},{id:"service_type",label:"Service Type"},{id:"submission_date",label:"Submission Date"},{id:"submission_time",label:"Submission Time"},{id:"completion_date",label:"Completion date"},{id:"submitted_by",label:"Created By"},{id:"reviewed_by",label:"Reviewed By"},{id:"service_status",label:"Approval status"},{id:"status",label:"Status"}],rs=({isInspection:n})=>{const{breakdowns:x,breakdownJobCardList:U,serviceJobCardList:Y}=M(e=>e.breakdown),{searchTerm:h}=M(e=>e.inspection),$=be(),[j,ie]=m.useState("asc"),[F,H]=m.useState("BDID"),[L,u]=m.useState(0),[V,te]=m.useState(8),[D,z]=m.useState(!1),[s,Z]=m.useState(null),[W,G]=m.useState("service_record_id"),[w,ee]=m.useState({id:"",status:"",workshop:"",user:""});m.useEffect(()=>{$(Be({}))},[]),m.useEffect(()=>{$(ve({job_card_type:"ServiceRecord",isInspection:n}))},[]);const Q=e=>{ie(F===e&&j==="asc"?"desc":"asc"),H(e)},t=(e,g)=>{u(g)},a=e=>{te(parseInt(e.target.value,10)),u(0)},v=((e,g,C)=>!g||!C?e:e.filter(i=>(()=>{var S,B,T,A,q,P,k,f,se,E,ae,ce,oe,de;switch(g){case"service_record_id":return(((S=i==null?void 0:i.service)==null?void 0:S.service_record_id)||"").toString();case"registration_id":return((B=i==null?void 0:i.vehicle)==null?void 0:B.registration_id)||"";case"service_type":return(i==null?void 0:i.service_type)||"";case"user_name":return`${((A=(T=i==null?void 0:i.user)==null?void 0:T.us_user)==null?void 0:A.first_name)||""} ${((P=(q=i==null?void 0:i.user)==null?void 0:q.us_user)==null?void 0:P.last_name)||""}`;case"submission_date":return i!=null&&i.submission_date?y(i.submission_date).format("YYYY-MM-DD"):"";case"submission_time":return i!=null&&i.submission_date?y(i.submission_date).format("HH:mm A"):"";case"completion_date":return i!=null&&i.completion_date?y(i.completion_date).format("YYYY-MM-DD"):"";case"submitted_by":return`${((f=(k=i==null?void 0:i.submitted_by)==null?void 0:k.us_user)==null?void 0:f.first_name)||""} ${((E=(se=i==null?void 0:i.submitted_by)==null?void 0:se.us_user)==null?void 0:E.last_name)||""}`;case"reviewed_by":return`${((ce=(ae=i==null?void 0:i.reviewed_by)==null?void 0:ae.us_user)==null?void 0:ce.first_name)||""} ${((de=(oe=i==null?void 0:i.reviewed_by)==null?void 0:oe.us_user)==null?void 0:de.last_name)||""}`||"";case"service_status":return(i==null?void 0:i.service_status)||"";case"status":return(i==null?void 0:i.status)||"";default:return""}})().toLowerCase().includes(C.toLowerCase())))((Y==null?void 0:Y.slice())||[],W,h),p=v.slice(L*V,L*V+V),l={fontSize:"14px",fontWeight:"bold",fontFamily:"Ubuntu",color:"black",cursor:"pointer",background:"#f2f2f2"},d=v&&v.map(e=>{var C,i,R,S,B,T,A,q,P,k;const g=e!=null&&e.jobcard_parts&&(e==null?void 0:e.jobcard_parts.length)>0?e==null?void 0:e.jobcard_parts.map((f,se)=>{var E;return`${(E=f==null?void 0:f.spare_parts)==null?void 0:E.description}: Qty ${f==null?void 0:f.quantity}`}).join(";"):"N/A";return{SRID:((C=e==null?void 0:e.service)==null?void 0:C.service_record_id)||"","Vehicle No":((i=e==null?void 0:e.vehicle)==null?void 0:i.registration_id)||"","Service Type":(e==null?void 0:e.service_type)||"","Submission Date":e!=null&&e.submission_date?y(e.submission_date).format("YYYY-MM-DD"):"","Submission Time":e!=null&&e.submission_date?y(e.submission_date).format("HH:mm A"):"","Completion date":e!=null&&e.completion_date?y(e.completion_date).format("YYYY-MM-DD HH:mm A"):"","Created By":`${((S=(R=e==null?void 0:e.submitted_by)==null?void 0:R.us_user)==null?void 0:S.first_name)||""} ${((T=(B=e==null?void 0:e.submitted_by)==null?void 0:B.us_user)==null?void 0:T.last_name)||""}`,"Reviewed By":`${((q=(A=e==null?void 0:e.reviewed_by)==null?void 0:A.us_user)==null?void 0:q.first_name)||""} ${((k=(P=e==null?void 0:e.reviewed_by)==null?void 0:P.us_user)==null?void 0:k.last_name)||""}`,"Approval status":(e==null?void 0:e.service_status)||"",Status:(e==null?void 0:e.status)||"","Spare parts":g}});let N=Te("Job Card");const le=(N==null?void 0:N.includes("Update"))||N==="Read-Write-Only";return r.jsxs(K,{sx:{m:"10px"},children:[r.jsxs(K,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[r.jsx(Ne,{columns:_e,selectedColumn:W,onColumnChange:G,searchTerm:h,onSearchChange:e=>$(Ae(e))}),r.jsx(qe,{variant:"contained",color:"success",onClick:()=>Ee(d,"service-job-card.xlsx"),children:"Download Excel"})]}),r.jsxs(Pe,{children:[r.jsx(ke,{sx:{height:"73vh",bgcolor:"white",borderRadius:"10px"},children:r.jsxs($e,{stickyHeader:!0,children:[r.jsx(Ye,{children:r.jsxs(ue,{children:[_e.map(e=>r.jsx(b,{sx:l,children:r.jsx(Ie,{active:F===e.id,direction:F===e.id?j:"asc",onClick:()=>Q(e.id),children:e.label})},e.id)),le&&r.jsx(b,{sx:l,children:"Action"}),"              "]})}),r.jsx(Fe,{children:p.map((e,g)=>{var C,i,R,S,B,T,A,q,P,k;return r.jsxs(ue,{children:[r.jsx(b,{children:(C=e==null?void 0:e.service)==null?void 0:C.service_record_id}),r.jsx(b,{children:(i=e==null?void 0:e.vehicle)==null?void 0:i.registration_id}),r.jsx(b,{children:e==null?void 0:e.service_type}),r.jsx(b,{children:(e==null?void 0:e.submission_date)&&y(e.submission_date).format("YYYY-MM-DD")||"N/A"}),r.jsx(b,{children:(e==null?void 0:e.submission_date)&&y(e.submission_date).format("HH:mm A")||"N/A"}),r.jsx(b,{children:(e==null?void 0:e.completion_date)&&y(e.completion_date).format("YYYY-MM-DD HH:mm A")||"N/A"}),r.jsx(b,{children:`${(S=(R=e==null?void 0:e.submitted_by)==null?void 0:R.us_user)==null?void 0:S.first_name} ${(T=(B=e==null?void 0:e.submitted_by)==null?void 0:B.us_user)==null?void 0:T.last_name}`||"N/A"}),r.jsx(b,{children:`${((q=(A=e==null?void 0:e.reviewed_by)==null?void 0:A.us_user)==null?void 0:q.first_name)||""} ${((k=(P=e==null?void 0:e.reviewed_by)==null?void 0:P.us_user)==null?void 0:k.last_name)||""}`||"N/A"}),r.jsx(b,{sx:{color:e.service_status==="Open"?"blue":e.service_status==="Approved"?"green":"red"},children:(e==null?void 0:e.service_status)||"N/A"}),r.jsx(b,{sx:{color:e.status==="Open"?"blue":e.status==="Close"?"green":"red"},children:e.status}),le&&r.jsx(b,{children:r.jsx(J,{onClick:()=>{z(!0),Z(e)},color:"primary",disabled:(e==null?void 0:e.status.toLowerCase())==="close","aria-label":"edit record",children:r.jsx(Je,{})})})]},g)})})]})}),r.jsx(Ve,{component:"div",count:v.length,page:L,onPageChange:t,rowsPerPage:V,onRowsPerPageChange:a,rowsPerPageOptions:[5,10,15]}),r.jsx(Ze,{updateData:s,open:D,handleClose:()=>z(!1),isTechnician:!0,isInspection:n})]})]})};export{rs as S,Ze as a};
