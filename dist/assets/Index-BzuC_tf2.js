import{p as T,r as i,R as Re,o as fe,q as Pe,a9 as Be,X as ne,j as h,B as L,A as Ve,G as $e,fR as Te,aw as Le,M as me,D as Oe,fS as Ne,fT as We,fU as Fe,fV as He,fW as Ue,fX as Ge,fY as ze,fZ as qe,f_ as Ke,f$ as Xe,g0 as Ye,g1 as Ze,bN as Je,g2 as Qe,g3 as et,g4 as tt,g5 as ot,g6 as nt,g7 as st,g8 as at,g9 as rt,fr as ct,fo as lt,ga as it,Q as ut,V as se,ae as ue,gb as ft,a4 as dt,a6 as gt,aH as ht}from"./index-Ds6FVMyp.js";const F="/assets/motorbike-Ve1wpD8A.png",pt="/assets/green_bike-qdoS7u1A.svg",yt="/assets/red_bike-DD7SR04B.svg",wt="/assets/yellow_bike-D4yDBpYn.svg",kt="/assets/black_bike-CjClBA8k.svg",vt="AIzaSyD8TrUWS9FRTu-MRP339mJF_iWlORvEGUA";function xt({loadingVehicle:v,vehicleData:S,center:H,setCenter:j}){const{selectedParameterList:m,selectedVehicle:p,vehicleList:U,zoom:G,icons:z,locationData:g,placesData:E,imeiNumbers:de,onlineVehicle:q,loading:ge,services_loading:K}=T(e=>e.liveMap),{mode:R,styles:X,vehicles_details:w}=T(e=>e.dashboard),D=i.useRef(null),{collapsed:ae}=T(e=>e.auth),[k,u]=i.useState(null),[y,A]=i.useState(""),[b,I]=i.useState([]),[P,r]=i.useState(),[O,B]=i.useState(null),[Y,Z]=i.useState(""),[Dt,re]=i.useState(),[bt,It]=i.useState(!1),[_,J]=i.useState(null),[_t,Mt]=Re.useState(!1),Q=fe(),ee={},V=i.useRef([]),ce=i.useRef(null),$=i.useRef({}),{isLoaded:te,loadError:he}=Pe({googleMapsApiKey:`${vt}`});i.useEffect(()=>{te&&u(window.google.maps)},[te]),i.useEffect(()=>{},[G]),i.useEffect(()=>{var e,t,o,n;if(Object.keys(p).length>0){const s=(_==null?void 0:_.length)>0?_:g,a=s==null?void 0:s.filter(c=>{var l;return((l=c==null?void 0:c.latestDocument)==null?void 0:l.imei)===(p==null?void 0:p.imei)});if((a==null?void 0:a.length)>0){I(a);const c={lat:(t=(e=a[0])==null?void 0:e.latestDocument)==null?void 0:t.lat,lng:(n=(o=a[0])==null?void 0:o.latestDocument)==null?void 0:n.lng};j(c)}}},[g,p]),i.useEffect(()=>{if(!(Object.keys(p).length>0)){const e=g==null?void 0:g.filter(t=>S.some(o=>o.value===t.latestDocument.imei));I(e),J(e)}},[g,p]),i.useEffect(()=>{var e,t,o,n;if(Object.keys(p).length>0){const s=(_==null?void 0:_.length)>0?_:g,a=s==null?void 0:s.filter(c=>{var l;return((l=c==null?void 0:c.latestDocument)==null?void 0:l.imei)===(p==null?void 0:p.imei)});if((a==null?void 0:a.length)>0){I(a);const c={lat:(t=(e=a[0])==null?void 0:e.latestDocument)==null?void 0:t.lat,lng:(n=(o=a[0])==null?void 0:o.latestDocument)==null?void 0:n.lng};j(c)}}else{const s=g==null?void 0:g.filter(a=>S.some(c=>c.value===a.latestDocument.imei));I(s),J(s)}},[g,p]),i.useEffect(()=>{Q(Be({}))},[]),i.useEffect(()=>{if(console.log("before: ",b),!k)return;const e=ce.current;let t=null;return(async()=>{console.log("after: ",b);const n=await pe(b,e);t&&t.clearMarkers(),t=Se(n,e),ne.on("locationinfo",s=>{console.log("locationinfo: ",s),be(s,V),J(a=>{const c=Array.isArray(a)?a:[],l=c.findIndex(f=>String(f.latestDocument.imei)===String(s.imei));if(l!==-1){const f=[...c];return f[l]={...f[l],latestDocument:{...f[l].latestDocument,...s}},f}else return[...c,{_id:s.imei,latestDocument:s}]})})})(),()=>{t&&t.clearMarkers(),Object.keys($.current).forEach(n=>cancelAnimationFrame($.current[n])),ne.off("locationinfo")}},[k,b,ne,P,V,g]);const pe=(e,t)=>e.map(o=>{const n=o.latestDocument.imei,s=V.current[n]||ye(o,t);return V.current[n]&&we(o,s),s}),ye=(e,t)=>{const o=e.latestDocument.imei,n=new k.Marker({position:{lat:e.latestDocument.lat,lng:e.latestDocument.lng},map:t,icon:oe(e)});return n.addListener("click",()=>xe(e,n,t)),V.current[o]=n,n},we=async(e,t)=>{var l;const o=t.getPosition(),n=((l=t.getIcon())==null?void 0:l.rotation)||0,s={lat:e.latestDocument.lat,lng:e.latestDocument.lng},a=e.latestDocument.heading||0;ie(t,o,s,n,a);const c=await oe(e);t.setIcon(c)},oe=async e=>{var l,f,d,x,M;const t=(l=e==null?void 0:e.latestDocument)==null?void 0:l.imei,o=Ie(t),n=Me(e==null?void 0:e.latestDocument,o),s=((f=e==null?void 0:e.latestDocument)==null?void 0:f.heading)||0;return le((d=e==null?void 0:e.latestDocument)==null?void 0:d.imei)&&ke((x=e==null?void 0:e.latestDocument)==null?void 0:x.imei),{url:await ve(n,s),fillOpacity:2,strokeWeight:1,scale:4.5,rotation:(M=e==null?void 0:e.latestDocument)==null?void 0:M.heading,size:new k.Size(30,30),scaledSize:new k.Size(30,30)}},le=e=>q.includes(String(e)),ke=e=>g==null?void 0:g.some(t=>String(t.latestDocument.imei)===String(e)&&t.latestDocument.speed>0&&(t.latestDocument.ignition===!0||t.latestDocument.ignition===1)),ve=(e,t,o,n=80)=>{const s=`${e}-${t}-${n}-${o}`;if(ee[s])return Promise.resolve(ee[s]);const a=document.createElement("canvas"),c=a.getContext("2d");a.width=n,a.height=n;const l=new Image;return l.src=e,new Promise(f=>{l.onload=()=>{c.clearRect(0,0,a.width,a.height),c.translate(n/2,n/2),c.rotate(t*Math.PI/180),c.translate(-n/2,-n/2),c.drawImage(l,0,0,n,n);const d=a.toDataURL("image/png");ee[s]=d,f(d)},l.onerror=d=>{console.error("Error loading image for rotation:",d),f(e)}})},xe=(e,t,o)=>{Ae(e.latestDocument._id,e,t,o),Ce(e.latestDocument.imei)},ie=(e,t,o,n,s)=>{const c=performance.now(),l=()=>{const f=performance.now()-c,d=Math.min(f/500,1),x=t.lat()+d*(o.lat-t.lat()),M=t.lng()+d*(o.lng-t.lng()),N=(s-n+360)%360-180,W=(n+N*d+360)%360;e.setPosition({lat:x,lng:M});const C=e.getIcon();C&&typeof C=="object"&&e.setIcon({...C,rotation:W}),d<1?$.current[e.getPosition()]=requestAnimationFrame(l):(e.setPosition(o),C&&typeof C=="object"&&e.setIcon({...C,rotation:s}),delete $.current[e.getPosition()])};$.current[e.getPosition()]=requestAnimationFrame(l)},Se=(e,t)=>new Ne({map:t,markers:e,renderer:{render:({count:o,position:n})=>De(o,n)}}),De=(e,t)=>{const o=40+Math.min(e*2,40),n=30;let s;return e<10?s={start:"#76c7c0",end:"#34a853"}:e<50?s={start:"#fbbc05",end:"#f2994a"}:s={start:"#f45c42",end:"#d32f2f"},new k.Marker({position:t,icon:{url:`data:image/svg+xml,${encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="${o}" height="${o}" viewBox="0 0 100 100">
            <defs>
              <radialGradient id="gradient" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="${s.start}" />
                <stop offset="100%" stop-color="${s.end}" />
              </radialGradient>
              <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="rgba(0, 0, 0, 0.5)" />
              </filter>
            </defs>
            <!-- Outer Pulsating Ring -->
            <circle cx="50" cy="50" r="48" fill="url(#gradient)" filter="url(#shadow)" stroke="#ffffff" stroke-width="3" />
            <!-- Decorative Inner Ring -->
            <circle cx="50" cy="50" r="38" fill="none" stroke="#ffffff" stroke-width="2" stroke-dasharray="4 2" />
            <!-- Star Decoration -->
            <polygon points="50,15 54,38 70,38 57,50 62,68 50,57 38,68 43,50 30,38 46,38" fill="#ffffff" opacity="0.4" />
            <!-- Count Text -->
            <text x="50" y="55" font-size="${n}" fill="black" text-anchor="middle" font-family="'Courier New', monospace" font-weight="bold">
              ${e}
            </text>
          </svg>
        `)}`,scaledSize:new k.Size(o,o)},label:null})},be=async(e,t,o)=>{var a;const n=e.imei,s=t.current[n];if(s){const c=s.getPosition(),l=((a=s.getIcon())==null?void 0:a.rotation)||0,f={lat:e.lat,lng:e.lng},d=e.heading||0;ie(s,c,f,l,d);const x=await oe({latestDocument:e});s.setIcon(x)}},Ie=e=>{if(!e)return"motorBike";const t=_e(e);return t||console.error(`No vehicle type found for IMEI: ${e}, defaulting to motorBike`),t||"motorBike"},_e=e=>{if(!w||w.length===0)return console.error("vehicles_details is not available"),null;const t=w.find(o=>(o==null?void 0:o.value)===e&&(o==null?void 0:o.vehilce_type));return t||console.error(`No vehicle found for IMEI: ${e}`),t?t.vehilce_type:null},Me=(e,t)=>{let{speed:o,ignition:n,imei:s}=e,a=le(s);const c={"2W":{red:yt,green:pt,yellow:wt,black:kt},"3W":{red:rt,green:at,yellow:st,black:nt},"4W":{red:ot,green:tt,yellow:et,black:Qe},Tractor:{red:Je,green:Ze,yellow:Ye,black:Xe},Harvestor:{red:Ke,green:qe,yellow:ze,black:Ge},BUS:{red:Ue,green:He,yellow:Fe,black:We},default:{red:F,green:F,yellow:F,black:F}};let l=c[t]||c.default;if(!a)return l.black;if(a&&!n)return l.red;if(a&&n&&o>0)return l.green;if(a&&n&&o<=0)return l.yellow},Ae=(e,t,o,n)=>{var f,d,x;Q(ct(t.latestDocument.imei));const s={lat:(f=t==null?void 0:t.latestDocument)==null?void 0:f.lat,lng:(d=t==null?void 0:t.latestDocument)==null?void 0:d.lng};j(s),Q(lt(15)),D.current||(D.current=new k.InfoWindow);const a=D.current,l=`
      <div>
        <h3>Registration No: ${((x=U.find(M=>{var N,W;return((N=M==null?void 0:M.imei[0])==null?void 0:N.mac_id)===((W=t==null?void 0:t.latestDocument)==null?void 0:W.imei)}))==null?void 0:x.registration_id)||""}</h3>
      </div>
    `;O===e?(a.close(),B(null)):(a.setContent(l),a.open(n,o),B(e))},Ce=e=>{const t=w&&(w==null?void 0:w.length)>0&&w.find(o=>(o==null?void 0:o.value)===e&&o);re(t||null)};if(he)return"Error loading maps";if(!te)return"Loading maps";if(!k)return null;const je={height:"100vh",width:"100%",transition:"transform 0.5s ease-in-out"},Ee=()=>{window.location.reload()};return h.jsxs(h.Fragment,{children:[h.jsx(L,{sx:{position:"absolute",top:"780px",left:"250px",zIndex:1,background:Ve.bgColor,padding:"5px",borderRadius:"10px",color:"white"}}),h.jsxs($e,{id:"map",mapContainerStyle:je,zoom:G,center:H,onLoad:e=>{ce.current=e},options:{styles:R?X:""},children:[Object.keys(p).length>0&&h.jsx(Te,{setPlace:A,place:y}),K||v?h.jsx(L,{sx:{position:"absolute",top:"50%",left:"50%"},children:h.jsx(Le,{})}):E&&E.length>0&&E.map((e,t)=>{var o,n;return h.jsx(me,{position:{lat:parseFloat((o=e==null?void 0:e.location)==null?void 0:o.lat),lng:parseFloat((n=e==null?void 0:e.location)==null?void 0:n.lng)},animation:window.google.maps.Animation.DROP,icon:{path:z[`${y}`],fillOpacity:2,strokeWeight:1,scale:1,fillColor:"orange"}},t)}),h.jsx(L,{sx:{display:"flex",justifyContent:"center",mt:"20px"},children:h.jsx(Oe,{variant:"contained",onClick:Ee,children:" Go to vehicle location"})})]})]})}const St="https://cc.wikitrak.in/proxy-3031";function Ct(){const{locationData:v}=T(u=>u.liveMap),{vehicleNo:S,token:H}=it(),[j,m]=i.useState(!1),[p,U]=i.useState([]),{w_customer_id:G}=T(u=>u.auth),[z,g]=i.useState(!1),[E,de]=i.useState(!1),[q,ge]=i.useState(!0),[K,R]=i.useState(!1),[X,w]=i.useState({lat:21,lng:78});let D=fe();i.useEffect(()=>{D(ut({}))},[]),i.useEffect(()=>{k()},[]);const ae=async()=>{try{(await ht.post(`${St}/api/validate-token`,{token:H})).data.valid?m(!0):m(!1)}catch{m(!1)}};i.useEffect(()=>{ae()},[]),i.useEffect(()=>{var u;if(S){console.log("locationdata342423",v);const y=(v==null?void 0:v.length)>0&&(v==null?void 0:v.filter(P=>String(P.latestDocument.imei)===String(S)));if((y==null?void 0:y.length)<=0){se.error("Data not available for this vehicle",{id:"clipboard"});return}const{lat:A,lng:b}=((u=y==null?void 0:y[0])==null?void 0:u.latestDocument)??{},I={lat:A||ue.lat,lng:b||ue.lat};w(I)}},[v]);const k=async()=>{try{R(!0);let u=[],y=[];if(!S)return;const A=await D(ft({imei:S}));if(Array.isArray(A.payload)){A.payload.forEach(r=>{var O,B,Y,Z;Array.isArray(r.imei)&&r.imei.length>0&&((O=r.imei[0])!=null&&O.mac_id)?(u.push({id:r.id,label:r.registration_id,value:(B=r.imei[0])==null?void 0:B.mac_id,vehilce_type:r==null?void 0:r.segment,chassis_no:r==null?void 0:r.chassis_no,engine_no:r==null?void 0:r.engine_no,workShop:r==null?void 0:r.workshop,registration_id:r==null?void 0:r.registration_id,sell_date:r==null?void 0:r.sell_date,customer_name:r==null?void 0:r.customer_name,vehicle_model:(Y=r==null?void 0:r.vehicle_model)==null?void 0:Y.name,vehicle_group:r==null?void 0:r.vehicle_group}),y.push((Z=r.imei[0])==null?void 0:Z.mac_id)):console.error("IMEI data not found for item:",r)});const b="one",I=y;y.length>0&&D(dt({type:b,imei:I}));let P=u==null?void 0:u.filter(r=>r.value==S);U(P),D(gt(u)),R(!1)}else R(!1),console.error("Unexpected data format:",A),se.error("Unexpected data format:")}catch(u){console.error("Error fetching vehicle data:",u),se.error(`Error fetching vehicle data: ${u}`)}};return j?h.jsx("div",{className:"app",children:h.jsx("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:h.jsx(L,{style:{display:"flex",width:"100%",height:"95vh"},children:h.jsx(L,{style:{width:z||E?"80%":"100%"},children:h.jsx(xt,{showCard:q,loadingVehicle:K,vehicleData:p,center:X,setCenter:w})})})})}):h.jsx("h3",{children:"Invalid or Expired Link"})}export{Ct as default};
