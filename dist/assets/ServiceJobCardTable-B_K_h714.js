import{j as r,f1 as Te,f2 as Be,T as te,aY as H,ed as ke,f3 as Ae,f4 as qe,bc as U,a$ as M,a_ as me,fi as ie,fj as Pe,bk as _e,fk as I,fl as $e,fm as Ye,b as x,aW as ee,fn as Re,ep as c,dK as b,ff as Ve,bm as y,fg as Fe,bf as Oe,d4 as We,cf as Me,dT as He,dU as Le,dV as Ne,dW as be,dX as v,dY as Ee,f5 as Je,c4 as Ue,b7 as ve}from"./index-DUMpFwu0.js";import{u as Ie}from"./formik.esm-DazBl23l.js";import{c as ze,a as W,d as Ge,f as xe}from"./index.esm-ZL-GEdc7.js";import{A as w}from"./Autocomplete-qbivDt3m.js";import{R as Ke,A as Qe,D as ge}from"./Remove-4V6q9ucZ.js";import{T as Xe,d as Ze,C as De}from"./excelUtils-CEQK_gsD.js";import{T as we,E as es}from"./Edit-DsxnJwEN.js";const pe=["Approved","Rejected","Open"],ss=["Open","Close"],rs=({open:n,handleClose:p,updateData:L,rowData:R,isTechnician:h,isInspection:$})=>r.jsxs(Te,{open:n,onClose:p,maxWidth:"xl",fullWidth:!0,children:[r.jsxs(Be,{sx:{m:0,p:2},children:[r.jsx(te,{variant:"h6",children:"Vehicle Service Job Card"}),r.jsx(H,{"aria-label":"close",onClick:p,sx:{position:"absolute",right:8,top:8,color:_=>_.palette.grey[500]},children:r.jsx(ke,{})})]}),r.jsx(Ae,{dividers:!0,children:r.jsx(ns,{updateData:L,onClose:p,rowData:R,isTechnician:h,isInspection:$})}),r.jsx(qe,{children:r.jsx(U,{onClick:p,color:"secondary",variant:"outlined",children:"Close"})})]}),ns=({updateData:n,rowData:p,onClose:L,isTechnician:R,isInspection:h})=>{var Y,K,Q,E,X,Z;const{loading:$}=M(t=>t.breakdown),_=me();M(t=>t.liveMap);const{w_customer_id:z}=M(t=>t.auth),{sparePartList:V}=M(t=>t.inspection),{id:F,vehicle:u,service_type:se}=p||{};let re=(n?n==null?void 0:n.jobcard_parts:p==null?void 0:p.service_parts).map(t=>{var l;return{spare_parts:(l=t==null?void 0:t.spare_parts)==null?void 0:l.id,quantity:t==null?void 0:t.quantity}});const N=ze({vehicle:W().required("Vehicle is required"),chassis_no:W().required("Chassis No is required"),engine_no:W().required("Engine No is required"),hmr:Ge().required("Working Hrs is required").positive("Must be positive").integer("Must be an integer"),submission_date:xe().required("Date is required"),technician_observation:W().required("Technician Observations are required"),status:W().required("Status is required"),service_status:W().required("Status is required"),approval_date:h&&xe().required("Approval Date is required")}),s=Ie({initialValues:{vehicle:((Y=n==null?void 0:n.vehicle)==null?void 0:Y.id)||(u==null?void 0:u.id)||"",service:((K=n==null?void 0:n.service)==null?void 0:K.id)||F||"",chassis_no:(n==null?void 0:n.chassis_no)||(u==null?void 0:u.chassis_no),engine_no:(n==null?void 0:n.engine_no)||(u==null?void 0:u.engine_no),hmr:(n==null?void 0:n.hmr)||"",service_type:(n==null?void 0:n.service_type)||se,submission_date:(n==null?void 0:n.submission_date)||ie(new Date),completion_date:(n==null?void 0:n.completion_date)||"",technician_observation:(n==null?void 0:n.technician_observation)||"",jobcard_parts:re||[],service_status:(n==null?void 0:n.service_status)||"Open",status:(n==null?void 0:n.service_status)==="Rejected"||pe==="Rejected"?"Close":(n==null?void 0:n.status)||"Open",issued_attachment:(n==null?void 0:n.issued_attachment)||null,submitted_by:(n==null?void 0:n.submitted_by.id)||z,type:"ServiceRecord",approval_date:(n==null?void 0:n.approval_date)||"",reviewed_by:((Q=n==null?void 0:n.reviewed_by)==null?void 0:Q.id)||(h?z:"")},validationSchema:N,onSubmit:async t=>{var m,j;const l=new FormData;for(const a in s.values)if(a==="issued_attachment"){const o=s.values[a];o instanceof File?l.append("issued_attachment",o):typeof o=="string"&&l.append("issued_attachment_url",o)}else l.append(a,s.values[a]);let d;if(n?(console.log(n,t),d=await _(Pe({formData:l,id:n==null?void 0:n.id})).unwrap(),_(_e()),_(I({job_card_type:"ServiceRecord",isInspection:h}))):(d=await _($e(l)).unwrap(),_(_e()),_(I({job_card_type:"ServiceRecord",isInspection:h}))),d!=null&&d.payload){console.log("api response",(m=d==null?void 0:d.payload)==null?void 0:m.data);const{id:a}=(j=d==null?void 0:d.payload)==null?void 0:j.data,{jobcard_parts:o}=t;_(Ye({jobcard:a,parts:o})),L(),_(I({job_card_type:"ServiceRecord",isInspection:h}))}else L()}});return x.useEffect(()=>{s.values.service_status==="Rejected"?s.setFieldValue("status","Close"):n!=null&&n.status||s.setFieldValue("status","Open")},[s.values.service_status]),r.jsxs(ee,{sx:{padding:"15px"},children:[$&&r.jsx(Re,{}),r.jsx("form",{onSubmit:s.handleSubmit,children:r.jsxs(c,{container:!0,spacing:2,children:[r.jsx(c,{item:!0,xs:6,children:r.jsx(b,{label:"Vehicle*",fullWidth:!0,name:"vehicle",value:((E=n==null?void 0:n.vehicle)==null?void 0:E.registration_id)||(u==null?void 0:u.registration_id),onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.vehicle&&!!s.errors.vehicle,helperText:s.touched.vehicle&&s.errors.vehicle,disabled:!0})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(b,{label:"Chassis No*",fullWidth:!0,name:"chassis_no",value:s.values.chassis_no,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.chassis_no&&!!s.errors.chassis_no,helperText:s.touched.chassis_no&&s.errors.chassis_no,disabled:!0})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(b,{label:"Engine No*",fullWidth:!0,name:"engine_no",value:s.values.engine_no,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.engine_no&&!!s.errors.engine_no,helperText:s.touched.engine_no&&s.errors.engine_no,disabled:!0})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(w,{options:[],getOptionLabel:t=>t,value:s.values.service_type,onChange:(t,l)=>s.setFieldValue("service_type",l||""),disabled:!0,renderInput:t=>r.jsx(b,{...t,label:"Service Type",error:s.touched.service_type&&!!s.errors.service_type,helperText:s.touched.service_type&&s.errors.service_type})})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(b,{label:"HMR*",fullWidth:!0,type:"number",name:"hmr",value:s.values.hmr,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.hmr&&!!s.errors.hmr,helperText:s.touched.hmr&&s.errors.hmr,disabled:h||s.values.service_status==="Approved"})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(b,{label:"Date",name:"submission_date",type:"datetime-local",value:s.values.submission_date,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.submission_date&&!!s.errors.submission_date,helperText:s.touched.submission_date&&s.errors.submission_date,fullWidth:!0,InputLabelProps:{shrink:!0},disabled:!0})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(b,{label:"Completion Date",name:"completion_date",type:"datetime-local",value:s.values.completion_date,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.completion_date&&!!s.errors.completion_date,helperText:s.touched.completion_date&&s.errors.completion_date,fullWidth:!0,InputLabelProps:{shrink:!0},disabled:!0})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(b,{label:"Technician Observations*",fullWidth:!0,name:"technician_observation",value:s.values.technician_observation,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.technician_observation&&!!s.errors.technician_observation,helperText:s.touched.technician_observation&&s.errors.technician_observation,disabled:h||s.values.service_status==="Approved"})}),r.jsxs(c,{item:!0,xs:12,children:[r.jsx(te,{variant:"h6",gutterBottom:!0,children:"Parts Requirement*(If any information available)"}),(Z=(X=s==null?void 0:s.values)==null?void 0:X.jobcard_parts)==null?void 0:Z.map((t,l)=>{var j;const d=(j=s.values)==null?void 0:j.jobcard_parts.map(a=>a.spare_parts).filter((a,o)=>o!==l),m=V.filter(a=>!d.includes(a.id));return r.jsxs(c,{container:!0,spacing:2,marginTop:"0px",alignItems:"center",children:[r.jsx(c,{item:!0,xs:12,md:6,children:r.jsx(w,{options:m,getOptionLabel:a=>a.description,value:V.find(a=>a.id===t.spare_parts)||null,onChange:(a,o)=>s.setFieldValue(`jobcard_parts[${l}].spare_parts`,(o==null?void 0:o.id)||""),renderInput:a=>r.jsx(b,{...a,label:"Spare Part",fullWidth:!0})})}),r.jsx(c,{item:!0,xs:8,md:4,children:r.jsxs(ee,{display:"flex",alignItems:"center",children:[r.jsx(H,{onClick:()=>s.setFieldValue(`jobcard_parts[${l}].quantity`,Math.max(1,t.quantity-1)),children:r.jsx(Ke,{})}),r.jsx(b,{value:t.quantity,type:"number",inputProps:{min:1},onChange:a=>s.setFieldValue(`jobcard_parts[${l}].quantity`,parseInt(a.target.value,10)),sx:{width:90,mx:1,textAlign:"center"}}),r.jsx(H,{onClick:()=>s.setFieldValue(`jobcard_parts[${l}].quantity`,t.quantity+1),children:r.jsx(Qe,{})})]})}),r.jsx(c,{item:!0,xs:4,md:2,children:r.jsx(H,{color:"error",onClick:()=>{var o;const a=[...(o=s.values)==null?void 0:o.jobcard_parts];a.splice(l,1),s.setFieldValue("jobcard_parts",a)},children:r.jsx(ge,{})})})]},l)}),r.jsx(U,{variant:"outlined",onClick:()=>{var d,m,j;const t=(m=(d=s.values)==null?void 0:d.jobcard_parts)==null?void 0:m.map(a=>a.spare_parts);if(V.filter(a=>!(t!=null&&t.includes(a.id))).length===0){toast.error("All available spare parts have already been added.");return}s.setFieldValue("jobcard_parts",[...(j=s.values)==null?void 0:j.jobcard_parts,{spare_parts:"",quantity:1}])},sx:{mt:2},children:"+ Add Spare Part"})]}),r.jsx(c,{item:!0,xs:6,children:r.jsx(b,{label:"Approval Date",name:"approval_date",type:"datetime-local",value:s.values.approval_date,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.approval_date&&!!s.errors.approval_date,helperText:s.touched.approval_date&&s.errors.approval_date,fullWidth:!0,InputLabelProps:{shrink:!0},disabled:!0})}),r.jsx(c,{item:!0,xs:6,children:r.jsx(w,{options:pe,value:s.values.service_status,onChange:(t,l)=>{s.setFieldValue("service_status",l||""),s.setFieldValue("approval_date",ie(new Date))},disabled:!h,renderInput:t=>r.jsx(b,{...t,label:"Approval Status by Service Engineer*",error:s.touched.service_status&&!!s.errors.service_status,helperText:s.touched.service_status&&s.errors.service_status})})}),!h&&r.jsx(c,{item:!0,xs:6,children:r.jsx(w,{options:ss,value:s.values.status,onChange:(t,l)=>{s.setFieldValue("status",l||""),s.setFieldValue("completion_date",ie(new Date))},disabled:s.values.service_status!=="Approved",renderInput:t=>r.jsx(b,{...t,label:"Technician Status"})})}),r.jsxs(c,{item:!0,xs:6,children:[!h&&r.jsxs(U,{variant:"outlined",component:"label",fullWidth:!0,children:["Upload File",r.jsx("input",{type:"file",hidden:!0,onChange:t=>{const l=t.currentTarget.files[0];l&&s.setFieldValue("issued_attachment",l)}})]}),s.values.issued_attachment&&r.jsxs(c,{container:!0,spacing:1,mt:1,alignItems:"center",children:[r.jsx(c,{item:!0,children:r.jsxs(te,{variant:"body2",children:[r.jsx("b",{children:"Attachment:"})," ",typeof s.values.issued_attachment=="string"?s.values.issued_attachment.split("/").pop():s.values.issued_attachment.name]})}),r.jsx(c,{item:!0,children:r.jsx(U,{size:"small",variant:"text",onClick:()=>{const t=typeof s.values.issued_attachment=="string"?s.values.issued_attachment:URL.createObjectURL(s.values.issued_attachment);window.open(t,"_blank")},children:"View File"})})]})]}),r.jsx(c,{item:!0,xs:12,children:r.jsx(U,{type:"submit",variant:"contained",fullWidth:!0,color:"primary",children:n?"Update":"Submit"})})]})})]})},je=[{id:"service_record_id",label:"SRID"},{id:"registration_id",label:"Vehicle No"},{id:"service_type",label:"Service Type"},{id:"submission_date",label:"Submission Date"},{id:"submission_time",label:"Submission Time"},{id:"completion_date",label:"Completion date"},{id:"submitted_by",label:"Created By"},{id:"reviewed_by",label:"Reviewed By"},{id:"service_status",label:"Approval status"},{id:"status",label:"Status"}],is="https://cc.wikitrak.in/api-proxy/api/v1",ts=({isInspection:n})=>{const{breakdowns:p,breakdownJobCardList:L,serviceJobCardList:R}=M(e=>e.breakdown),[h,$]=x.useState(!1),[_,z]=x.useState(null),{searchTerm:V}=M(e=>e.inspection),F=me(),[u,se]=x.useState("asc"),[G,re]=x.useState("BDID"),[N,s]=x.useState(0),[Y,K]=x.useState(8),[Q,E]=x.useState(!1),[X,Z]=x.useState(null),[t,l]=x.useState("service_record_id");x.useState({id:"",status:"",workshop:"",user:""}),x.useEffect(()=>{F(Ve({}))},[]),x.useEffect(()=>{F(I({job_card_type:"ServiceRecord",isInspection:n}))},[]);const d=e=>{se(G===e&&u==="asc"?"desc":"asc"),re(e)},m=(e,g)=>{s(g)},j=e=>{K(parseInt(e.target.value,10)),s(0)},o=((e,g,C)=>!g||!C?e:e.filter(i=>(()=>{var S,T,B,k,A,q,P,f,ne,J,oe,de,ue,he;switch(g){case"service_record_id":return(((S=i==null?void 0:i.service)==null?void 0:S.service_record_id)||"").toString();case"registration_id":return((T=i==null?void 0:i.vehicle)==null?void 0:T.registration_id)||"";case"service_type":return(i==null?void 0:i.service_type)||"";case"user_name":return`${((k=(B=i==null?void 0:i.user)==null?void 0:B.us_user)==null?void 0:k.first_name)||""} ${((q=(A=i==null?void 0:i.user)==null?void 0:A.us_user)==null?void 0:q.last_name)||""}`;case"submission_date":return i!=null&&i.submission_date?y(i.submission_date).format("YYYY-MM-DD"):"";case"submission_time":return i!=null&&i.submission_date?y(i.submission_date).format("HH:mm A"):"";case"completion_date":return i!=null&&i.completion_date?y(i.completion_date).format("YYYY-MM-DD"):"";case"submitted_by":return`${((f=(P=i==null?void 0:i.submitted_by)==null?void 0:P.us_user)==null?void 0:f.first_name)||""} ${((J=(ne=i==null?void 0:i.submitted_by)==null?void 0:ne.us_user)==null?void 0:J.last_name)||""}`;case"reviewed_by":return`${((de=(oe=i==null?void 0:i.reviewed_by)==null?void 0:oe.us_user)==null?void 0:de.first_name)||""} ${((he=(ue=i==null?void 0:i.reviewed_by)==null?void 0:ue.us_user)==null?void 0:he.last_name)||""}`||"";case"service_status":return(i==null?void 0:i.service_status)||"";case"status":return(i==null?void 0:i.status)||"";default:return""}})().toLowerCase().includes(C.toLowerCase())))((R==null?void 0:R.slice())||[],t,V),le=o.slice(N*Y,N*Y+Y),ae={fontSize:"14px",fontWeight:"bold",fontFamily:"Ubuntu",color:"black",cursor:"pointer",background:"#f2f2f2"},fe=o&&o.map(e=>{var C,i,O,S,T,B,k,A,q,P;const g=e!=null&&e.jobcard_parts&&(e==null?void 0:e.jobcard_parts.length)>0?e==null?void 0:e.jobcard_parts.map((f,ne)=>{var J;return`${(J=f==null?void 0:f.spare_parts)==null?void 0:J.description}: Qty ${f==null?void 0:f.quantity}`}).join(";"):"N/A";return{SRID:((C=e==null?void 0:e.service)==null?void 0:C.service_record_id)||"","Vehicle No":((i=e==null?void 0:e.vehicle)==null?void 0:i.registration_id)||"","Service Type":(e==null?void 0:e.service_type)||"","Submission Date":e!=null&&e.submission_date?y(e.submission_date).format("YYYY-MM-DD"):"","Submission Time":e!=null&&e.submission_date?y(e.submission_date).format("HH:mm A"):"","Completion date":e!=null&&e.completion_date?y(e.completion_date).format("YYYY-MM-DD HH:mm A"):"","Created By":`${((S=(O=e==null?void 0:e.submitted_by)==null?void 0:O.us_user)==null?void 0:S.first_name)||""} ${((B=(T=e==null?void 0:e.submitted_by)==null?void 0:T.us_user)==null?void 0:B.last_name)||""}`,"Reviewed By":`${((A=(k=e==null?void 0:e.reviewed_by)==null?void 0:k.us_user)==null?void 0:A.first_name)||""} ${((P=(q=e==null?void 0:e.reviewed_by)==null?void 0:q.us_user)==null?void 0:P.last_name)||""}`,"Approval status":(e==null?void 0:e.service_status)||"",Status:(e==null?void 0:e.status)||"","Spare parts":g}});let D=Fe("Job Card");const ye=e=>{z(e),$(!0)},Ce=async()=>{console.log("breakdownData data deleting",_);try{await Ue.delete(`${is}/vehicles/create/breakdown-service/jobcard/${_.id}/`),ve.success("service data deleted successfully!"),F(I({job_card_type:"ServiceRecord",isInspection:n}))}catch(e){console.error("Error deleting service data:",e),ve.error("Failed to delete service data. Please try again.")}$(!1)},Se=()=>{$(!1)},ce=(D==null?void 0:D.includes("Update"))||D==="Read-Write-Only";return r.jsxs(ee,{sx:{m:"10px"},children:[r.jsxs(ee,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[r.jsx(Xe,{columns:je,selectedColumn:t,onColumnChange:l,searchTerm:V,onSearchChange:e=>F(Oe(e))}),r.jsx(We,{variant:"contained",color:"success",onClick:()=>Ze(fe,"service-job-card.xlsx"),children:"Download Excel"})]}),r.jsxs(Me,{children:[r.jsx(He,{sx:{height:"55vh",bgcolor:"white",borderRadius:"10px"},children:r.jsxs(Le,{stickyHeader:!0,children:[r.jsx(Ne,{children:r.jsxs(be,{children:[je.map(e=>r.jsx(v,{sx:ae,children:r.jsx(we,{active:G===e.id,direction:G===e.id?u:"asc",onClick:()=>d(e.id),children:e.label})},e.id)),ce&&r.jsx(v,{sx:ae,children:"Action"}),"              "]})}),r.jsx(Ee,{children:le.map((e,g)=>{var C,i,O,S,T,B,k,A,q,P;return r.jsxs(be,{children:[r.jsx(v,{children:(C=e==null?void 0:e.service)==null?void 0:C.service_record_id}),r.jsx(v,{children:(i=e==null?void 0:e.vehicle)==null?void 0:i.registration_id}),r.jsx(v,{children:e==null?void 0:e.service_type}),r.jsx(v,{children:(e==null?void 0:e.submission_date)&&y(e.submission_date).format("YYYY-MM-DD")||"N/A"}),r.jsx(v,{children:(e==null?void 0:e.submission_date)&&y(e.submission_date).format("HH:mm A")||"N/A"}),r.jsx(v,{children:(e==null?void 0:e.completion_date)&&y(e.completion_date).format("YYYY-MM-DD HH:mm A")||"N/A"}),r.jsx(v,{children:`${(S=(O=e==null?void 0:e.submitted_by)==null?void 0:O.us_user)==null?void 0:S.first_name} ${(B=(T=e==null?void 0:e.submitted_by)==null?void 0:T.us_user)==null?void 0:B.last_name}`||"N/A"}),r.jsx(v,{children:`${((A=(k=e==null?void 0:e.reviewed_by)==null?void 0:k.us_user)==null?void 0:A.first_name)||""} ${((P=(q=e==null?void 0:e.reviewed_by)==null?void 0:q.us_user)==null?void 0:P.last_name)||""}`||"N/A"}),r.jsx(v,{sx:{color:e.service_status==="Open"?"blue":e.service_status==="Approved"?"green":"red"},children:(e==null?void 0:e.service_status)||"N/A"}),r.jsx(v,{sx:{color:e.status==="Open"?"blue":e.status==="Close"?"green":"red"},children:e.status}),ce&&r.jsxs(v,{style:{display:"flex"},children:[r.jsx(H,{onClick:()=>{E(!0),Z(e)},color:"primary",disabled:(e==null?void 0:e.status.toLowerCase())==="close","aria-label":"edit record",children:r.jsx(es,{})}),r.jsx(H,{onClick:()=>ye(e),"aria-label":"edit record",children:r.jsx(ge,{})})]})]},g)})})]})}),r.jsx(Je,{component:"div",count:o.length,page:N,onPageChange:m,rowsPerPage:Y,onRowsPerPageChange:j,rowsPerPageOptions:[5,10,15]}),r.jsx(rs,{updateData:X,open:Q,handleClose:()=>E(!1),isTechnician:!0,isInspection:n})]}),r.jsx(De,{open:h,onClose:Se,onConfirm:Ce})]})},_s=ts;export{_s as S,rs as a};
