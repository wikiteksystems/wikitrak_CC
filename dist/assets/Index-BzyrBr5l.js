import{c as le,j as e,B as N,i as U,k as S,r as d,I as Y,aU as Z,aR as J,ai as ie,w as L,ak as ce,P as Q,ad as de,aG as ue,aP as he,aW as pe,aV as K,T as X,aX as ge,t as te,ax as me,W as ee,K as xe,L as fe,O as be,N as _e}from"./index-BJcd3W-Z.js";import{L as we}from"./LiveMapTopBar-BsmcK55N.js";import{V as je}from"./VehicleMenu-AhTI2EVz.js";import{L as ke,t as Ce}from"./LeftSideBar2-BtYnQ47k.js";import"./Loader-C5pnRoVm.js";import"./LiveMapServices-BwmfN1uP.js";import"./Socket-0N_gnJcr.js";import{P as ve}from"./Parameters-DUYgdGwa.js";/* empty css           */import"./proj-XQwXs9DQ.js";import{D as ae,a as re,b as ye,T as Se}from"./TablePagination-CvxH98_j.js";import{D as ne,a as Be,E as De,T as Le}from"./Edit-DMQ0-2Qw.js";import{B as T}from"./menu2-Ct75TrHg.js";import{T as Pe,a as Ae,b as Te,c as oe,d as Ie}from"./TableRow-BgZ1nxck.js";import{T as W}from"./TableCell-CImx4UIK.js";import{d as Ve}from"./Close-DifEn3SJ.js";import{d as Fe}from"./Add-CjCTKO53.js";import{u as Ee}from"./formik.esm-DuI0ywPe.js";import{c as Re,a as q}from"./index.esm-B3zcF_Op.js";import{A as se}from"./Autocomplete-DRLMUiSS.js";import{T as O}from"./TextField-CoU9Tngq.js";import{S as We}from"./SearchInput-DBeV3ylL.js";import{V as qe}from"./VehicleGroups-DDPrO7rT.js";import"./jcb-aCHXMCXy.js";import"./index-CpHE84zR.js";import"./createSvgIcon-BtBe02Vr.js";import"./useControlled-BwhHnJN8.js";import"./index-NsvhXo2o.js";import"./Card-CO8i7tiZ.js";import"./Skeleton-CPBuVODr.js";import"./CardContent-C3Gik8c_.js";const Oe=le(e.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"}),"Delete"),$e=({open:h,onClose:f,onConfirm:b})=>e.jsxs(ae,{open:h,onClose:f,children:[e.jsx(ne,{children:"Confirm Deletion"}),e.jsx(re,{children:e.jsxs(Be,{children:["Are you sure you want to delete this vehicle data?"," ",e.jsx("span",{style:{color:"red"},children:"This action cannot be undone."})]})}),e.jsxs(ye,{children:[e.jsx(N,{onClick:f,color:"primary",children:"Cancel"}),e.jsx(N,{onClick:b,color:"secondary",children:"Delete"})]})]}),Ge="http://134.209.145.234/api/v1",Me={display:"flex",alignItems:"left",justifyContent:"left",gap:"8px"},Ne=({breakdownData:h})=>{const f=U(),{isUpdateBreakdown:b}=S(x=>x.equipment),{w_customer_id:l}=S(x=>x.auth),[m,p]=d.useState(!1),C=()=>{console.log("breakdownData",h),localStorage.getItem("role"),f(Z(!b)),f(J(h))},j=()=>{console.log("dlt btn clicked");const x=localStorage.getItem("role");ie.includes(x)?p(!0):L.error(`Sorry! Your role is ${x}. You're not allowed to add, edit or delete the vehicle`)},_=async()=>{console.log("breakdownData data deleting");try{await ce.delete(`${Ge}/vehicles/breakdown/create/${h.id}/`),L.success("breakdownData data deleted successfully!"),f(Q(l))}catch(x){console.error("Error deleting breakdown data:",x),L.error("Failed to delete breakdown data. Please try again.")}p(!1)},P=()=>{p(!1)},v={color:"#686868"};return e.jsxs(T,{sx:Me,children:[e.jsx(Y,{onClick:C,children:e.jsx(De,{sx:v})}),e.jsx(Y,{onClick:j,children:e.jsx(Oe,{sx:v})}),e.jsx($e,{open:m,onClose:P,onConfirm:_})]})},He=[{id:"BDID",label:"BDID"},{id:"User",label:"User"},{id:"SubmissionDate",label:"Submission Date"},{id:"WorkshopGroup",label:"Workshop Group"},{id:"Status",label:"Status"},{id:"Actions",label:"Actions"}],ze=()=>{const{breakdowns:h}=S(t=>t.breakdown),{searchTerm:f}=S(t=>t.inspection),[b,l]=d.useState("asc"),[m,p]=d.useState("BDID"),[C,j]=d.useState(0),[_,P]=d.useState(5),[v,x]=d.useState({id:"",status:"",workshop:"",user:""}),E=t=>{l(m===t&&b==="asc"?"desc":"asc"),p(t)},I=(t,o)=>{j(o)},y=t=>{P(parseInt(t.target.value,10)),j(0)},s=(t,o,n)=>t.filter(a=>{var G,r,A,D,M,k,F;const i=new Date,c=new Date(a.submission_date);if(i.setHours(0,0,0,0),c.setHours(0,0,0,0),(n==null?void 0:n.toLowerCase())==="overdue"&&c<i&&a.status.toLowerCase()==="open")return!0;const g=n.toLowerCase(),u=(G=a==null?void 0:a.breakdown_id)==null?void 0:G.toLowerCase().includes(g),w=`${(A=(r=a==null?void 0:a.user)==null?void 0:r.us_user)==null?void 0:A.first_name} ${(M=(D=a==null?void 0:a.user)==null?void 0:D.us_user)==null?void 0:M.last_name}`.toLowerCase().includes(g),B=(k=a==null?void 0:a.status)==null?void 0:k.toLowerCase().includes(g),z=(F=a==null?void 0:a.workshop_group)==null?void 0:F.group_name.toLowerCase().includes(g);return!(n&&!(u||w||B||z)||o.id&&!a.breakdown_id.includes(o.id)||o.status&&a.status!==o.status||o.workshop&&a.workshop_group.group_name!==o.workshop||o.user&&!a.user.us_user.first_name.toLowerCase().includes(o.user.toLowerCase())&&!a.user.us_user.last_name.toLowerCase().includes(o.user.toLowerCase()))}),H=(t,o,n,a)=>{if(a==="User"){const i=`${t.user.us_user.first_name} ${t.user.us_user.last_name}`.toLowerCase(),c=`${o.user.us_user.first_name} ${o.user.us_user.last_name}`.toLowerCase();return n==="asc"?i.localeCompare(c):c.localeCompare(i)}if(a==="WorkshopGroup"){const i=t.workshop_group.group_name.toLowerCase(),c=o.workshop_group.group_name.toLowerCase();return n==="asc"?i.localeCompare(c):c.localeCompare(i)}if(a==="BDID"){const i=parseInt(t.breakdown_id.replace("BD-",""),10),c=parseInt(o.breakdown_id.replace("BD-",""),10);return n==="asc"?i-c:c-i}if(a==="SubmissionDate"){const i=new Date(t.submission_date),c=new Date(o.submission_date);return n==="asc"?i-c:c-i}if(a==="Status"){const i={Open:1,Close:2,Rejected:3},c=i[t.status]||0,g=i[o.status]||0;return n==="asc"?c-g:g-c}return 0},V=s(h.slice(),v,f).sort((t,o)=>H(t,o,b,m)),R=V.slice(C*_,C*_+_),$={fontSize:"14px",fontWeight:"bold",fontFamily:"Ubuntu",color:"black",cursor:"pointer",background:"#f2f2f2"};return e.jsx(T,{sx:{m:"10px"},children:e.jsxs(de,{children:[e.jsx(Pe,{sx:{height:"73vh",bgcolor:"white",borderRadius:"10px"},children:e.jsxs(Ae,{stickyHeader:!0,children:[e.jsx(Te,{children:e.jsx(oe,{children:He.map(t=>e.jsx(W,{sx:$,children:e.jsx(Le,{active:m===t.id,direction:m===t.id?b:"asc",onClick:()=>E(t.id),children:t.label})},t.id))})}),e.jsx(Ie,{children:R.map((t,o)=>{var n,a,i,c,g;return e.jsxs(oe,{children:[e.jsx(W,{children:t==null?void 0:t.breakdown_id}),e.jsx(W,{children:`${(a=(n=t==null?void 0:t.user)==null?void 0:n.us_user)==null?void 0:a.first_name} ${(c=(i=t==null?void 0:t.user)==null?void 0:i.us_user)==null?void 0:c.last_name}`}),e.jsx(W,{children:t.submission_date||"N/A"}),e.jsx(W,{children:(g=t==null?void 0:t.workshop_group)==null?void 0:g.group_name}),e.jsx(W,{sx:{color:t.status==="Open"?"blue":t.status==="Close"?"green":"red"},children:t.status}),e.jsx(W,{children:e.jsx(Ne,{breakdownData:t})})]},o)})})]})}),e.jsx(Se,{component:"div",count:V.length,page:C,onPageChange:I,rowsPerPage:_,onRowsPerPageChange:y,rowsPerPageOptions:[5,10,15]})]})})},Ue=ze;function Ye(){var $,t;const{vehicles_details:h}=S(o=>o.dashboard),{w_customer_id:f}=S(o=>o.auth),{breakdownTopics:b,UpdatedBreakdownData:l}=S(o=>o.breakdown),[m,p]=d.useState(null),[C,j]=d.useState(""),[_,P]=d.useState(!1),[v,x]=d.useState(!1),[E,I]=d.useState("");let y=U();d.useEffect(()=>{l&&(p(l.attachment),j("edit"))},[l]);const s=Ee({initialValues:{vehicle:(($=l==null?void 0:l.vehicle)==null?void 0:$.id)||"",breakdown_topic:((t=l==null?void 0:l.breakdown_topic)==null?void 0:t.id)||"",odometer_reading:(l==null?void 0:l.odometer_reading)||"",description:(l==null?void 0:l.description)||"",mob_no:(l==null?void 0:l.mob_no)||"",email:(l==null?void 0:l.email)||"",attachment:(l==null?void 0:l.attachment)||"",location:(l==null?void 0:l.location)||""},validationSchema:Re({vehicle:q().required("Vehicle is required"),breakdown_topic:q().required("Breakdown Topic is required"),odometer_reading:q().required("Odometer Reading is required"),description:q().required("Description is required"),mob_no:q().matches(/^\d{10,11}$/,"Mobile number must be 10-11 digits").required("Mobile number is required"),email:q().email("Invalid email format").required("Email is required"),location:q().required("Location is required")}),onSubmit:async(o,{resetForm:n})=>{var a,i,c;try{P(!0),console.log("Submitted values:",o);const g=V(o.vehicle);o.user=g[0].user.id,o.status="Open",o.workshop_group=(c=(i=(a=g[0])==null?void 0:a.workShop)==null?void 0:i.group_name)==null?void 0:c.id,o.submission_date=new Date().toISOString().split("T")[0];let u;if(l){let w=await ue(l.attachment);console.log("file conversion",w),o.attachment=w;const B=l.id;u=await y(he({values:o,id:B}))}else u=await y(pe(o));if(u.payload.success)L.success("Breakdown submitted successfully!"),n(),j(""),p(null),y(J(null)),y(Z(!1)),y(K(!1)),y(Q(f)),P(!1);else throw P(!1),new Error(u.payload.error||"Failed to submit breakdown")}catch(g){console.error("Submission Error:",g),L.error("Failed to submit breakdown. Please try again.")}}}),H=async()=>{x(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition(async o=>{const{latitude:n,longitude:a}=o.coords;try{const i=await ge(n,a);s.setFieldValue("location",i)}catch(i){console.error("Error fetching address:",i),L.error("Failed to convert coordinates to address.")}finally{x(!1)}},o=>{console.error("Geolocation Error:",o),L.error("Failed to retrieve location. Please try again."),x(!1)}):(L.error("Geolocation is not supported by this browser."),x(!1))},V=o=>(h==null?void 0:h.length)>0&&h.filter(a=>a.id===o),R=o=>{const n=o.currentTarget.files[0];if(s.setFieldValue("attachment",n),j((n==null?void 0:n.name)||""),n&&n.type.startsWith("image/")){const a=new FileReader;a.onload=()=>p(a.result),a.readAsDataURL(n)}else p(null)};return e.jsx(T,{sx:{p:3,maxWidth:600,margin:"auto"},children:_?e.jsx(X,{children:"Submitted the form data..."}):e.jsx(e.Fragment,{children:e.jsxs("form",{onSubmit:s.handleSubmit,children:[e.jsx(se,{options:h,getOptionLabel:o=>o.registration_id,value:h.find(o=>o.id===s.values.vehicle)||null,onChange:(o,n)=>s.setFieldValue("vehicle",(n==null?void 0:n.id)||""),renderInput:o=>e.jsx(O,{...o,label:"Vehicle",error:s.touched.vehicle&&!!s.errors.vehicle,helperText:s.touched.vehicle&&s.errors.vehicle,fullWidth:!0})}),e.jsx(se,{options:b,getOptionLabel:o=>o.topic,value:b.find(o=>o.id===s.values.breakdown_topic)||null,onChange:(o,n)=>s.setFieldValue("breakdown_topic",(n==null?void 0:n.id)||""),renderOption:(o,n)=>d.createElement("li",{...o,key:n.id},n.topic),renderInput:o=>e.jsx(O,{...o,label:"Breakdown Topic",error:s.touched.breakdown_topic&&!!s.errors.breakdown_topic,helperText:s.touched.breakdown_topic&&s.errors.breakdown_topic,fullWidth:!0,sx:{mt:2}})}),e.jsx(O,{label:"Odometer Reading",name:"odometer_reading",value:s.values.odometer_reading,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.odometer_reading&&!!s.errors.odometer_reading,helperText:s.touched.odometer_reading&&s.errors.odometer_reading,fullWidth:!0,sx:{mt:2}}),e.jsx(O,{label:"Description",name:"description",value:s.values.description,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.description&&!!s.errors.description,helperText:s.touched.description&&s.errors.description,fullWidth:!0,sx:{mt:2}}),e.jsx(O,{label:"Mobile Number",name:"mob_no",value:s.values.mob_no,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.mob_no&&!!s.errors.mob_no,helperText:s.touched.mob_no&&s.errors.mob_no,fullWidth:!0,sx:{mt:2}}),e.jsx(O,{label:"Email",name:"email",type:"email",value:s.values.email,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.email&&!!s.errors.email,helperText:s.touched.email&&s.errors.email,fullWidth:!0,sx:{mt:2}}),e.jsx(O,{label:"Location",name:"location",value:E||s.values.location,onChange:o=>{I(o.target.value),s.setFieldValue("location",o.target.value)},onBlur:s.handleBlur,error:s.touched.location&&!!s.errors.location,helperText:s.touched.location&&s.errors.location,fullWidth:!0,sx:{mt:2}}),e.jsx(N,{variant:"outlined",onClick:H,disabled:v,sx:{mt:2},children:v?"Fetching Location...":"Use Current Location"}),e.jsxs(N,{component:"label",sx:{mt:2,border:"1px solid #f5f5f5",color:"black"},children:["Upload Attachment",e.jsx("input",{type:"file",hidden:!0,onChange:R})]}),C&&e.jsxs(X,{variant:"body2",sx:{mt:1},children:["Uploaded File: ",C]}),m&&e.jsx(T,{component:"img",src:m,alt:"Image Preview",sx:{mt:1,width:"100%",maxHeight:200}}),e.jsx(N,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,sx:{mt:3},children:"Submit"})]})})})}function Ke({where:h}){const{isAddBreakdown:f,isUpdateBreakdown:b,UpdatedBreakdownData:l}=S(_=>_.breakdown);let m=U();const p=()=>{m(K(!1)),m(Z(!1)),m(J(null))},C=()=>{m(K(!f))},j={fontSize:"18px",fontWeight:500,lineHeight:"18.38px",textAlign:"center",paddingTop:"5px",fontFamily:"ubuntu"};return e.jsxs(T,{sx:{bgcolor:"white",m:"10px",display:"flex",textAlign:"left",justifyContent:"space-between",alignItems:"center",borderRadius:"6px",padding:"20px"},children:[e.jsx(X,{variant:"h6",sx:j,children:h==="breakdown"?"Breakdown New Request":"New Breakdown Requests"}),e.jsx(We,{}),h==="breakdown"&&e.jsxs(N,{onClick:C,sx:{color:"black",background:te.bgColor},children:[e.jsx(Fe,{}),"Breakdown"]}),e.jsxs(ae,{open:f||b,onClose:p,maxWidth:"md",fullWidth:!0,children:[e.jsxs(ne,{children:[b?"Update":"Add"," Breakdown",e.jsx(Y,{"aria-label":"close",onClick:p,sx:{position:"absolute",right:8,top:8,color:_=>_.palette.grey[500]},children:e.jsx(Ve,{})})]}),e.jsx(re,{children:e.jsx(Ye,{})})]})]})}function Do(){const{locationData:h,selectedVehicle:f,selectedParameterList:b,onlineVehicle:l}=S(u=>u.liveMap),{mode:m,selectedVehicleGroup:p,vehicleZone:C}=S(u=>u.dashboard),j=Ce(m),[_,P]=d.useState([]),{w_customer_id:v}=S(u=>u.auth),[x,E]=d.useState(),[I,y]=d.useState(!1),[s,H]=d.useState(!1),[V,R]=d.useState([]);d.useState(!0);const[$,t]=d.useState(!1),[o,n]=d.useState(!1);let a=U();d.useEffect(()=>{i(),a(me()),a(Q(v))},[]),d.useEffect(()=>{console.log("selectedVehicleGroup",p)},[p]),d.useEffect(()=>{R([]),a(ee([{reg_id:"",imei:"",params:[]}]))},[f]);const i=async()=>{try{t(!0);let u=[],w=[];const B=await a(xe({w_customer_id:v}));if(Array.isArray(B.payload)){B.payload.forEach(r=>{var A,D,M,k;Array.isArray(r.imei)&&r.imei.length>0&&((A=r.imei[0])!=null&&A.mac_id)?(u.push({id:r.id,label:r.registration_id,value:(D=r.imei[0])==null?void 0:D.mac_id,vehilce_type:r==null?void 0:r.segment,chassis_no:r==null?void 0:r.chassis_no,engine_no:r==null?void 0:r.engine_no,workShop:r==null?void 0:r.workshop,registration_id:r==null?void 0:r.registration_id,sell_date:r==null?void 0:r.sell_date,customer_name:r==null?void 0:r.customer_name,vehicle_model:(M=r==null?void 0:r.vehicle_model)==null?void 0:M.name,user:r==null?void 0:r.user,vehicle_group:r==null?void 0:r.vehicle_group}),w.push((k=r.imei[0])==null?void 0:k.mac_id)):console.error("IMEI data not found for item:",r)});const z="one",G=w;w.length>0&&a(fe({type:z,imei:G})),P(u),a(be({w_customer_id:v})),a(_e(u)),t(!1)}else t(!1),console.error("Unexpected data format:",B),L.error("Unexpected data format:")}catch(u){console.error("Error fetching vehicle data:",u),L.error(`Error fetching vehicle data: ${u}`)}},c=async u=>{const{label:w,imei:B,id:z,reg_id:G,checked:r}=u;E(k=>k.map(F=>F.id===z?{...F,checked:!r}:F));let A=[...V],D=[...V];if(!r)h.forEach(k=>{k.latestDocument.imei===B&&(A.push({label:w,value:k.latestDocument[w==="maininputvoltage"?"mainInputVoltage":w]}),D=A,R(A))});else{let k=V.filter(F=>F.label!==w);D=k,R(k)}console.log("tempParamList",D),a(ee([{reg_id:G,imei:B,params:D}]))},g=_.filter(u=>Object.keys(p).length===0||u.vehicle_group===p.id);return e.jsxs("div",{className:"app",children:[e.jsx(ke,{}),e.jsxs("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:[e.jsx(we,{title:"Breakdown",setShowVehicles:y,showVehicles:I,setShowVehiclesGroup:n,showVehiclesGroup:o}),e.jsx(qe,{setShowVehiclesGroup:n,showVehiclesGroup:o}),e.jsxs(T,{style:{display:"flex",width:"100%",height:"95vh"},children:[e.jsxs(T,{style:{width:I||s?"80%":"100%",background:te.bgShadow},children:[e.jsx(Ke,{where:"breakdown"}),e.jsx(Ue,{})]}),I&&e.jsx(T,{style:{width:"20%",backgroundColor:j.grey[100]},children:e.jsx(je,{vehicleData:g,title:"Inspections",setParameterData:E,loadingVehicle:$,setShowVehicles:y,showVehicles:I,showParameters:s,setShowParameters:H})}),s&&e.jsx(T,{style:{width:"20%",backgroundColor:j.grey[100]},children:e.jsx(ve,{parametersData:x,setParameterData:E,handleParameterChange:c})})]})]})]})}export{Do as default};
