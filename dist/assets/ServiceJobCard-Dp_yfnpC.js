import{j as r,ag as R,ah as M,T as q,m as g,ac as N,ai as U,aj as E,C as b,p as j,o as H,f0 as B,f1 as z,f2 as G,f3 as K,f4 as Q,B as P,d3 as X,cT as o}from"./index-rJKC5kjD.js";import{u as Y}from"./formik.esm-qVM3QrQ9.js";import{c as Z,f as L,a as x,e as D}from"./index.esm-CEVXtRC0.js";import{T as a}from"./TextField-W0cXux5x.js";import{A as p}from"./Autocomplete-B2Typk08.js";import{R as ee,A as re,D as se}from"./Remove-DCgaVOEP.js";const ie=["Approved","Rejected","Open","On Hold"],ne=["Open","Close","Rejected"],ve=({open:s,handleClose:u,updateData:y,rowData:T,isTechnician:h,isInspection:f})=>r.jsxs(R,{open:s,onClose:u,maxWidth:"xl",fullWidth:!0,children:[r.jsxs(M,{sx:{m:0,p:2},children:[r.jsx(q,{variant:"h6",children:"Vehicle Service Job Card"}),r.jsx(g,{"aria-label":"close",onClick:u,sx:{position:"absolute",right:8,top:8,color:v=>v.palette.grey[500]},children:r.jsx(N,{})})]}),r.jsx(U,{dividers:!0,children:r.jsx(le,{updateData:y,onClose:u,rowData:T,isTechnician:h,isInspection:f})}),r.jsx(E,{children:r.jsx(b,{onClick:u,color:"secondary",variant:"outlined",children:"Close"})})]}),le=({updateData:s,rowData:u,onClose:y,isTechnician:T,isInspection:h})=>{var F,k,V,A,W,w;const{loading:f}=j(i=>i.breakdown),v=H(),{vehicleList:oe}=j(i=>i.liveMap),{w_customer_id:S}=j(i=>i.auth),{sparePartList:C}=j(i=>i.inspection),{id:O,vehicle:d,service_type:$}=u||{};let J=(s?s==null?void 0:s.jobcard_parts:u==null?void 0:u.service_parts).map(i=>{var l;return{spare_parts:(l=i==null?void 0:i.spare_parts)==null?void 0:l.id,quantity:i==null?void 0:i.quantity}});const I=Z({vehicle:x().required("Vehicle is required"),chassis_no:x().required("Chassis No is required"),engine_no:x().required("Engine No is required"),hmr:D().required("Working Hrs is required").positive("Must be positive").integer("Must be an integer"),submission_date:L().required("Date is required"),technician_observation:x().required("Technician Observations are required"),status:x().required("Status is required"),service_status:x().required("Status is required"),approval_date:h&&L().required("Approval Date is required")}),e=Y({initialValues:{vehicle:((F=s==null?void 0:s.vehicle)==null?void 0:F.id)||(d==null?void 0:d.id)||"",service:((k=s==null?void 0:s.service)==null?void 0:k.id)||O||"",chassis_no:(s==null?void 0:s.chassis_no)||(d==null?void 0:d.chassis_no),engine_no:(s==null?void 0:s.engine_no)||(d==null?void 0:d.engine_no),hmr:(s==null?void 0:s.hmr)||"",service_type:(s==null?void 0:s.service_type)||$,submission_date:(s==null?void 0:s.submission_date)||B(new Date),completion_date:(s==null?void 0:s.completion_date)||"",technician_observation:(s==null?void 0:s.technician_observation)||"",jobcard_parts:J||[],status:(s==null?void 0:s.status)||"Open",service_status:(s==null?void 0:s.service_status)||"Open",issued_attachment:(s==null?void 0:s.issued_attachment)||null,submitted_by:(s==null?void 0:s.submitted_by.id)||S,type:"ServiceRecord",approval_date:(s==null?void 0:s.approval_date)||"",reviewed_by:((V=s==null?void 0:s.reviewed_by)==null?void 0:V.id)||(h?S:"")},validationSchema:I,onSubmit:async i=>{var m,_;const l=new FormData;for(const n in e.values)if(n==="issued_attachment"){const c=e.values[n];c instanceof File?l.append("issued_attachment",c):typeof c=="string"&&l.append("issued_attachment_url",c)}else l.append(n,e.values[n]);let t;if(s?(console.log(s,i),t=await v(z({formData:l,id:s==null?void 0:s.id}))):t=await v(G(l)),t!=null&&t.payload){console.log("api response",(m=t==null?void 0:t.payload)==null?void 0:m.data);const{id:n}=(_=t==null?void 0:t.payload)==null?void 0:_.data,{jobcard_parts:c}=i;v(K({jobcard:n,parts:c})),y(),v(Q({job_card_type:"ServiceRecord",isInspection:h}))}}});return r.jsxs(P,{sx:{padding:"15px"},children:[f&&r.jsx(X,{}),r.jsx("form",{onSubmit:e.handleSubmit,children:r.jsxs(o,{container:!0,spacing:2,children:[r.jsx(o,{item:!0,xs:6,children:r.jsx(a,{label:"Vehicle*",fullWidth:!0,name:"vehicle",value:((A=s==null?void 0:s.vehicle)==null?void 0:A.registration_id)||(d==null?void 0:d.registration_id),onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.vehicle&&!!e.errors.vehicle,helperText:e.touched.vehicle&&e.errors.vehicle,disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(a,{label:"Chassis No*",fullWidth:!0,name:"chassis_no",value:e.values.chassis_no,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.chassis_no&&!!e.errors.chassis_no,helperText:e.touched.chassis_no&&e.errors.chassis_no,disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(a,{label:"Engine No*",fullWidth:!0,name:"engine_no",value:e.values.engine_no,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.engine_no&&!!e.errors.engine_no,helperText:e.touched.engine_no&&e.errors.engine_no,disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(p,{options:[],getOptionLabel:i=>i,value:e.values.service_type,onChange:(i,l)=>e.setFieldValue("service_type",l||""),disabled:!0,renderInput:i=>r.jsx(a,{...i,label:"Service Type",error:e.touched.service_type&&!!e.errors.service_type,helperText:e.touched.service_type&&e.errors.service_type})})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(a,{label:"HMR*",fullWidth:!0,type:"number",name:"hmr",value:e.values.hmr,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.hmr&&!!e.errors.hmr,helperText:e.touched.hmr&&e.errors.hmr,disabled:h})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(a,{label:"Date",name:"submission_date",type:"datetime-local",value:e.values.submission_date,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.submission_date&&!!e.errors.submission_date,helperText:e.touched.submission_date&&e.errors.submission_date,fullWidth:!0,InputLabelProps:{shrink:!0},disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(a,{label:"Completion Date",name:"completion_date",type:"datetime-local",value:e.values.completion_date,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.completion_date&&!!e.errors.completion_date,helperText:e.touched.completion_date&&e.errors.completion_date,fullWidth:!0,InputLabelProps:{shrink:!0},disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(a,{label:"Technician Observations*",fullWidth:!0,name:"technician_observation",value:e.values.technician_observation,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.technician_observation&&!!e.errors.technician_observation,helperText:e.touched.technician_observation&&e.errors.technician_observation,disabled:h})}),r.jsxs(o,{item:!0,xs:12,children:[r.jsx(q,{variant:"h6",gutterBottom:!0,children:"Parts Requirement*(If any information available)"}),(w=(W=e==null?void 0:e.values)==null?void 0:W.jobcard_parts)==null?void 0:w.map((i,l)=>{var _;const t=(_=e.values)==null?void 0:_.jobcard_parts.map(n=>n.spare_parts).filter((n,c)=>c!==l),m=C.filter(n=>!t.includes(n.id));return r.jsxs(o,{container:!0,spacing:2,marginTop:"0px",alignItems:"center",children:[r.jsx(o,{item:!0,xs:12,md:6,children:r.jsx(p,{options:m,getOptionLabel:n=>n.description,value:C.find(n=>n.id===i.spare_parts)||null,onChange:(n,c)=>e.setFieldValue(`jobcard_parts[${l}].spare_parts`,(c==null?void 0:c.id)||""),renderInput:n=>r.jsx(a,{...n,label:"Spare Part",fullWidth:!0})})}),r.jsx(o,{item:!0,xs:8,md:4,children:r.jsxs(P,{display:"flex",alignItems:"center",children:[r.jsx(g,{onClick:()=>e.setFieldValue(`jobcard_parts[${l}].quantity`,Math.max(1,i.quantity-1)),children:r.jsx(ee,{})}),r.jsx(a,{value:i.quantity,type:"number",inputProps:{min:1},onChange:n=>e.setFieldValue(`jobcard_parts[${l}].quantity`,parseInt(n.target.value,10)),sx:{width:90,mx:1,textAlign:"center"}}),r.jsx(g,{onClick:()=>e.setFieldValue(`jobcard_parts[${l}].quantity`,i.quantity+1),children:r.jsx(re,{})})]})}),r.jsx(o,{item:!0,xs:4,md:2,children:r.jsx(g,{color:"error",onClick:()=>{var c;const n=[...(c=e.values)==null?void 0:c.jobcard_parts];n.splice(l,1),e.setFieldValue("jobcard_parts",n)},children:r.jsx(se,{})})})]},l)}),r.jsx(b,{variant:"outlined",onClick:()=>{var t,m,_;const i=(m=(t=e.values)==null?void 0:t.jobcard_parts)==null?void 0:m.map(n=>n.spare_parts);if(C.filter(n=>!(i!=null&&i.includes(n.id))).length===0){toast.error("All available spare parts have already been added.");return}e.setFieldValue("jobcard_parts",[...(_=e.values)==null?void 0:_.jobcard_parts,{spare_parts:"",quantity:1}])},sx:{mt:2},children:"+ Add Spare Part"})]}),r.jsx(o,{item:!0,xs:6,children:r.jsx(a,{label:"Approval Date",name:"approval_date",type:"datetime-local",value:e.values.approval_date,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.approval_date&&!!e.errors.approval_date,helperText:e.touched.approval_date&&e.errors.approval_date,fullWidth:!0,InputLabelProps:{shrink:!0},disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(p,{options:ie,value:e.values.service_status,onChange:(i,l)=>{e.setFieldValue("service_status",l||""),e.setFieldValue("approval_date",B(new Date))},disabled:!h,renderInput:i=>r.jsx(a,{...i,label:"Approval Status by Service Engineer*",error:e.touched.service_status&&!!e.errors.service_status,helperText:e.touched.service_status&&e.errors.service_status})})}),!h&&r.jsx(o,{item:!0,xs:6,children:r.jsx(p,{options:ne,value:e.values.status,onChange:(i,l)=>{e.setFieldValue("status",l||""),e.setFieldValue("completion_date",B(new Date))},disabled:e.values.service_status!=="Approved",renderInput:i=>r.jsx(a,{...i,label:"Technician Status"})})}),r.jsxs(o,{item:!0,xs:6,children:[!h&&r.jsxs(b,{variant:"outlined",component:"label",fullWidth:!0,children:["Upload File",r.jsx("input",{type:"file",hidden:!0,onChange:i=>{const l=i.currentTarget.files[0];l&&e.setFieldValue("issued_attachment",l)}})]}),e.values.issued_attachment&&r.jsxs(o,{container:!0,spacing:1,mt:1,alignItems:"center",children:[r.jsx(o,{item:!0,children:r.jsxs(q,{variant:"body2",children:[r.jsx("b",{children:"Attachment:"})," ",typeof e.values.issued_attachment=="string"?e.values.issued_attachment.split("/").pop():e.values.issued_attachment.name]})}),r.jsx(o,{item:!0,children:r.jsx(b,{size:"small",variant:"text",onClick:()=>{const i=typeof e.values.issued_attachment=="string"?e.values.issued_attachment:URL.createObjectURL(e.values.issued_attachment);window.open(i,"_blank")},children:"View File"})})]})]}),r.jsx(o,{item:!0,xs:12,children:r.jsx(b,{type:"submit",variant:"contained",fullWidth:!0,color:"primary",children:s?"Update":"Submit"})})]})})]})};export{ve as S};
