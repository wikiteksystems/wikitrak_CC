import{c as le,j as e,B as N,i as U,k as S,r as c,I as Y,aU as Z,aR as J,ai as ie,w as L,ak as ce,P as Q,ad as de,aG as ue,aP as he,aW as pe,aV as K,T as X,aX as ge,t as te,ax as me,W as ee,K as xe,L as fe,O as be,N as we}from"./index-Bln_Zu6f.js";import{L as _e}from"./LiveMapTopBar-SCOgj4az.js";import{V as je}from"./VehicleMenu-C1MvByXl.js";import{L as ke,t as Ce}from"./LeftSideBar2-CUkove_R.js";import"./Loader-DKgFwb6z.js";import"./LiveMapServices-DeucEvgb.js";import"./Socket-0N_gnJcr.js";import{P as ve}from"./Parameters-qfxdlL7F.js";/* empty css           */import"./proj-XQwXs9DQ.js";import{D as re,a as ae,b as ye,T as Se}from"./TablePagination-CJ38MhGP.js";import{D as ne,a as Be,E as De,T as Le}from"./Edit-BVfzTT4J.js";import{B as T}from"./menu2-BUw5nBhI.js";import{T as Pe,a as Ae}from"./TableHead-Bwtl_bCQ.js";import{T as Te,b as oe,a as Ie}from"./TableRow-Tvzchq1S.js";import{T as W}from"./TableCell-qDgJFKqb.js";import{d as Ve}from"./Close-BAiQ5CaJ.js";import{d as Fe}from"./Add-ql41n__e.js";import{u as Ee}from"./formik.esm-BuTKZxSm.js";import{c as Re,a as q}from"./index.esm-cLlbggPz.js";import{A as se}from"./Autocomplete-DxuDvdi7.js";import{T as O}from"./TextField-qfIyhWUR.js";import{S as We}from"./SearchInput-JzOpumki.js";import{V as qe}from"./VehicleGroups-l09Kdgt1.js";import"./jcb-aCHXMCXy.js";import"./index-o8EXcrtO.js";import"./createSvgIcon-wtvD1pH-.js";import"./useControlled-BXmZwoEU.js";import"./index-CphdzMZ0.js";import"./Card-Bv9mK2fD.js";import"./Skeleton-CCmP3vjo.js";import"./CardContent-BnWSiZC3.js";const Oe=le(e.jsx("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6zM19 4h-3.5l-1-1h-5l-1 1H5v2h14z"}),"Delete"),$e=({open:h,onClose:x,onConfirm:f})=>e.jsxs(re,{open:h,onClose:x,children:[e.jsx(ne,{children:"Confirm Deletion"}),e.jsx(ae,{children:e.jsxs(Be,{children:["Are you sure you want to delete this vehicle data?"," ",e.jsx("span",{style:{color:"red"},children:"This action cannot be undone."})]})}),e.jsxs(ye,{children:[e.jsx(N,{onClick:x,color:"primary",children:"Cancel"}),e.jsx(N,{onClick:f,color:"secondary",children:"Delete"})]})]}),Ge="http://134.209.145.234/api/v1",Me={display:"flex",alignItems:"left",justifyContent:"left",gap:"8px"},Ne=({breakdownData:h})=>{const x=U(),{isUpdateBreakdown:f}=S(m=>m.equipment),{w_customer_id:l}=S(m=>m.auth),[g,p]=c.useState(!1),C=()=>{console.log("breakdownData",h),localStorage.getItem("role"),x(Z(!f)),x(J(h))},j=()=>{console.log("dlt btn clicked");const m=localStorage.getItem("role");ie.includes(m)?p(!0):L.error(`Sorry! Your role is ${m}. You're not allowed to add, edit or delete the vehicle`)},b=async()=>{console.log("breakdownData data deleting");try{await ce.delete(`${Ge}/vehicles/breakdown/create/${h.id}/`),L.success("breakdownData data deleted successfully!"),x(Q(l))}catch(m){console.error("Error deleting breakdown data:",m),L.error("Failed to delete breakdown data. Please try again.")}p(!1)},P=()=>{p(!1)},v={color:"#686868"};return e.jsxs(T,{sx:Me,children:[e.jsx(Y,{onClick:C,children:e.jsx(De,{sx:v})}),e.jsx(Y,{onClick:j,children:e.jsx(Oe,{sx:v})}),e.jsx($e,{open:g,onClose:P,onConfirm:b})]})},He=[{id:"BDID",label:"BDID"},{id:"User",label:"User"},{id:"SubmissionDate",label:"Submission Date"},{id:"WorkshopGroup",label:"Workshop Group"},{id:"Status",label:"Status"},{id:"Actions",label:"Actions"}],ze=()=>{const{breakdowns:h}=S(a=>a.breakdown),{searchTerm:x}=S(a=>a.inspection),[f,l]=c.useState("asc"),[g,p]=c.useState("BDID"),[C,j]=c.useState(0),[b,P]=c.useState(5),[v,m]=c.useState({id:"",status:"",workshop:"",user:""}),E=a=>{l(g===a&&f==="asc"?"desc":"asc"),p(a)},I=(a,o)=>{j(o)},y=a=>{P(parseInt(a.target.value,10)),j(0)},s=(a,o,n)=>a.filter(t=>{var G,r,A,D,M,k,F;const i=new Date,u=new Date(t.submission_date);if(i.setHours(0,0,0,0),u.setHours(0,0,0,0),(n==null?void 0:n.toLowerCase())==="overdue"&&u<i&&t.status.toLowerCase()==="open")return!0;const w=n.toLowerCase(),d=(G=t==null?void 0:t.breakdown_id)==null?void 0:G.toLowerCase().includes(w),_=`${(A=(r=t==null?void 0:t.user)==null?void 0:r.us_user)==null?void 0:A.first_name} ${(M=(D=t==null?void 0:t.user)==null?void 0:D.us_user)==null?void 0:M.last_name}`.toLowerCase().includes(w),B=(k=t==null?void 0:t.status)==null?void 0:k.toLowerCase().includes(w),z=(F=t==null?void 0:t.workshop_group)==null?void 0:F.group_name.toLowerCase().includes(w);return!(n&&!(d||_||B||z)||o.id&&!t.breakdown_id.includes(o.id)||o.status&&t.status!==o.status||o.workshop&&t.workshop_group.group_name!==o.workshop||o.user&&!t.user.us_user.first_name.toLowerCase().includes(o.user.toLowerCase())&&!t.user.us_user.last_name.toLowerCase().includes(o.user.toLowerCase()))}),H=(a,o,n,t)=>{if(t==="User"){const i=`${a.user.us_user.first_name} ${a.user.us_user.last_name}`.toLowerCase(),u=`${o.user.us_user.first_name} ${o.user.us_user.last_name}`.toLowerCase();return n==="asc"?i.localeCompare(u):u.localeCompare(i)}if(t==="WorkshopGroup"){const i=a.workshop_group.group_name.toLowerCase(),u=o.workshop_group.group_name.toLowerCase();return n==="asc"?i.localeCompare(u):u.localeCompare(i)}if(t==="BDID"){const i=parseInt(a.breakdown_id.replace("BD-",""),10),u=parseInt(o.breakdown_id.replace("BD-",""),10);return n==="asc"?i-u:u-i}if(t==="SubmissionDate"){const i=new Date(a.submission_date),u=new Date(o.submission_date);return n==="asc"?i-u:u-i}if(t==="Status"){const i={Open:1,Close:2,Rejected:3},u=i[a.status]||0,w=i[o.status]||0;return n==="asc"?u-w:w-u}return 0},V=s(h.slice(),v,x).sort((a,o)=>H(a,o,f,g)),R=V.slice(C*b,C*b+b),$={fontSize:"14px",fontWeight:"bold",fontFamily:"Ubuntu",color:"black",cursor:"pointer",background:"#f2f2f2"};return e.jsx(T,{sx:{m:"10px"},children:e.jsxs(de,{children:[e.jsx(Pe,{sx:{height:"73vh",bgcolor:"white",borderRadius:"10px"},children:e.jsxs(Te,{stickyHeader:!0,children:[e.jsx(Ae,{children:e.jsx(oe,{children:He.map(a=>e.jsx(W,{sx:$,children:e.jsx(Le,{active:g===a.id,direction:g===a.id?f:"asc",onClick:()=>E(a.id),children:a.label})},a.id))})}),e.jsx(Ie,{children:R.map((a,o)=>e.jsxs(oe,{children:[e.jsx(W,{children:a.breakdown_id}),e.jsx(W,{children:`${a.user.us_user.first_name} ${a.user.us_user.last_name}`}),e.jsx(W,{children:a.submission_date||"N/A"}),e.jsx(W,{children:a.workshop_group.group_name}),e.jsx(W,{sx:{color:a.status==="Open"?"blue":a.status==="Close"?"green":"red"},children:a.status}),e.jsx(W,{children:e.jsx(Ne,{breakdownData:a})})]},o))})]})}),e.jsx(Se,{component:"div",count:V.length,page:C,onPageChange:I,rowsPerPage:b,onRowsPerPageChange:y,rowsPerPageOptions:[5,10,15]})]})})},Ue=ze;function Ye(){var $,a;const{vehicles_details:h}=S(o=>o.dashboard),{w_customer_id:x}=S(o=>o.auth),{breakdownTopics:f,UpdatedBreakdownData:l}=S(o=>o.breakdown),[g,p]=c.useState(null),[C,j]=c.useState(""),[b,P]=c.useState(!1),[v,m]=c.useState(!1),[E,I]=c.useState("");let y=U();c.useEffect(()=>{l&&(p(l.attachment),j("edit"))},[l]);const s=Ee({initialValues:{vehicle:(($=l==null?void 0:l.vehicle)==null?void 0:$.id)||"",breakdown_topic:((a=l==null?void 0:l.breakdown_topic)==null?void 0:a.id)||"",odometer_reading:(l==null?void 0:l.odometer_reading)||"",description:(l==null?void 0:l.description)||"",mob_no:(l==null?void 0:l.mob_no)||"",email:(l==null?void 0:l.email)||"",attachment:(l==null?void 0:l.attachment)||"",location:(l==null?void 0:l.location)||""},validationSchema:Re({vehicle:q().required("Vehicle is required"),breakdown_topic:q().required("Breakdown Topic is required"),odometer_reading:q().required("Odometer Reading is required"),description:q().required("Description is required"),mob_no:q().matches(/^\d{10,11}$/,"Mobile number must be 10-11 digits").required("Mobile number is required"),email:q().email("Invalid email format").required("Email is required"),location:q().required("Location is required")}),onSubmit:async(o,{resetForm:n})=>{var t,i,u;try{P(!0),console.log("Submitted values:",o);const w=V(o.vehicle);o.user=w[0].user.id,o.status="Open",o.workshop_group=(u=(i=(t=w[0])==null?void 0:t.workShop)==null?void 0:i.group_name)==null?void 0:u.id,o.submission_date=new Date().toISOString().split("T")[0];let d;if(l){let _=await ue(l.attachment);console.log("file conversion",_),o.attachment=_;const B=l.id;d=await y(he({values:o,id:B}))}else d=await y(pe(o));if(d.payload.success)L.success("Breakdown submitted successfully!"),n(),j(""),p(null),y(J(null)),y(Z(!1)),y(K(!1)),y(Q(x)),P(!1);else throw P(!1),new Error(d.payload.error||"Failed to submit breakdown")}catch(w){console.error("Submission Error:",w),L.error("Failed to submit breakdown. Please try again.")}}}),H=async()=>{m(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition(async o=>{const{latitude:n,longitude:t}=o.coords;try{const i=await ge(n,t);s.setFieldValue("location",i)}catch(i){console.error("Error fetching address:",i),L.error("Failed to convert coordinates to address.")}finally{m(!1)}},o=>{console.error("Geolocation Error:",o),L.error("Failed to retrieve location. Please try again."),m(!1)}):(L.error("Geolocation is not supported by this browser."),m(!1))},V=o=>(h==null?void 0:h.length)>0&&h.filter(t=>t.id===o),R=o=>{const n=o.currentTarget.files[0];if(s.setFieldValue("attachment",n),j((n==null?void 0:n.name)||""),n&&n.type.startsWith("image/")){const t=new FileReader;t.onload=()=>p(t.result),t.readAsDataURL(n)}else p(null)};return e.jsx(T,{sx:{p:3,maxWidth:600,margin:"auto"},children:b?e.jsx(X,{children:"Submitted the form data..."}):e.jsx(e.Fragment,{children:e.jsxs("form",{onSubmit:s.handleSubmit,children:[e.jsx(se,{options:h,getOptionLabel:o=>o.registration_id,value:h.find(o=>o.id===s.values.vehicle)||null,onChange:(o,n)=>s.setFieldValue("vehicle",(n==null?void 0:n.id)||""),renderInput:o=>e.jsx(O,{...o,label:"Vehicle",error:s.touched.vehicle&&!!s.errors.vehicle,helperText:s.touched.vehicle&&s.errors.vehicle,fullWidth:!0})}),e.jsx(se,{options:f,getOptionLabel:o=>o.topic,value:f.find(o=>o.id===s.values.breakdown_topic)||null,onChange:(o,n)=>s.setFieldValue("breakdown_topic",(n==null?void 0:n.id)||""),renderOption:(o,n)=>c.createElement("li",{...o,key:n.id},n.topic),renderInput:o=>e.jsx(O,{...o,label:"Breakdown Topic",error:s.touched.breakdown_topic&&!!s.errors.breakdown_topic,helperText:s.touched.breakdown_topic&&s.errors.breakdown_topic,fullWidth:!0,sx:{mt:2}})}),e.jsx(O,{label:"Odometer Reading",name:"odometer_reading",value:s.values.odometer_reading,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.odometer_reading&&!!s.errors.odometer_reading,helperText:s.touched.odometer_reading&&s.errors.odometer_reading,fullWidth:!0,sx:{mt:2}}),e.jsx(O,{label:"Description",name:"description",value:s.values.description,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.description&&!!s.errors.description,helperText:s.touched.description&&s.errors.description,fullWidth:!0,sx:{mt:2}}),e.jsx(O,{label:"Mobile Number",name:"mob_no",value:s.values.mob_no,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.mob_no&&!!s.errors.mob_no,helperText:s.touched.mob_no&&s.errors.mob_no,fullWidth:!0,sx:{mt:2}}),e.jsx(O,{label:"Email",name:"email",type:"email",value:s.values.email,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.email&&!!s.errors.email,helperText:s.touched.email&&s.errors.email,fullWidth:!0,sx:{mt:2}}),e.jsx(O,{label:"Location",name:"location",value:E||s.values.location,onChange:o=>{I(o.target.value),s.setFieldValue("location",o.target.value)},onBlur:s.handleBlur,error:s.touched.location&&!!s.errors.location,helperText:s.touched.location&&s.errors.location,fullWidth:!0,sx:{mt:2}}),e.jsx(N,{variant:"outlined",onClick:H,disabled:v,sx:{mt:2},children:v?"Fetching Location...":"Use Current Location"}),e.jsxs(N,{component:"label",sx:{mt:2,border:"1px solid #f5f5f5",color:"black"},children:["Upload Attachment",e.jsx("input",{type:"file",hidden:!0,onChange:R})]}),C&&e.jsxs(X,{variant:"body2",sx:{mt:1},children:["Uploaded File: ",C]}),g&&e.jsx(T,{component:"img",src:g,alt:"Image Preview",sx:{mt:1,width:"100%",maxHeight:200}}),e.jsx(N,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,sx:{mt:3},children:"Submit"})]})})})}function Ke({where:h}){const{isAddBreakdown:x,isUpdateBreakdown:f,UpdatedBreakdownData:l}=S(b=>b.breakdown);let g=U();const p=()=>{g(K(!1)),g(Z(!1)),g(J(null))},C=()=>{g(K(!x))},j={fontSize:"18px",fontWeight:500,lineHeight:"18.38px",textAlign:"center",paddingTop:"5px",fontFamily:"ubuntu"};return e.jsxs(T,{sx:{bgcolor:"white",m:"10px",display:"flex",textAlign:"left",justifyContent:"space-between",alignItems:"center",borderRadius:"6px",padding:"20px"},children:[e.jsx(X,{variant:"h6",sx:j,children:h==="breakdown"?"Breakdown New Request":"New Breakdown Requests"}),e.jsx(We,{}),h==="breakdown"&&e.jsxs(N,{onClick:C,sx:{color:"black",background:te.bgColor},children:[e.jsx(Fe,{}),"Breakdown"]}),e.jsxs(re,{open:x||f,onClose:p,maxWidth:"md",fullWidth:!0,children:[e.jsxs(ne,{children:[f?"Update":"Add"," Breakdown",e.jsx(Y,{"aria-label":"close",onClick:p,sx:{position:"absolute",right:8,top:8,color:b=>b.palette.grey[500]},children:e.jsx(Ve,{})})]}),e.jsx(ae,{children:e.jsx(Ye,{})})]})]})}function Lo(){const{locationData:h,selectedVehicle:x,selectedParameterList:f,onlineVehicle:l}=S(d=>d.liveMap),{mode:g,selectedVehicleGroup:p,vehicleZone:C}=S(d=>d.dashboard),j=Ce(g),[b,P]=c.useState([]),{w_customer_id:v}=S(d=>d.auth),[m,E]=c.useState(),[I,y]=c.useState(!1),[s,H]=c.useState(!1),[V,R]=c.useState([]);c.useState(!0);const[$,a]=c.useState(!1),[o,n]=c.useState(!1);let t=U();c.useEffect(()=>{i(),t(me()),t(Q(v))},[]),c.useEffect(()=>{console.log("selectedVehicleGroup",p)},[p]),c.useEffect(()=>{R([]),t(ee([{reg_id:"",imei:"",params:[]}]))},[x]);const i=async()=>{try{a(!0);let d=[],_=[];const B=await t(xe({w_customer_id:v}));if(Array.isArray(B.payload)){B.payload.forEach(r=>{var A,D,M,k;Array.isArray(r.imei)&&r.imei.length>0&&((A=r.imei[0])!=null&&A.mac_id)?(d.push({id:r.id,label:r.registration_id,value:(D=r.imei[0])==null?void 0:D.mac_id,vehilce_type:r==null?void 0:r.segment,chassis_no:r==null?void 0:r.chassis_no,engine_no:r==null?void 0:r.engine_no,workShop:r==null?void 0:r.workshop,registration_id:r==null?void 0:r.registration_id,sell_date:r==null?void 0:r.sell_date,customer_name:r==null?void 0:r.customer_name,vehicle_model:(M=r==null?void 0:r.vehicle_model)==null?void 0:M.name,user:r==null?void 0:r.user,vehicle_group:r==null?void 0:r.vehicle_group}),_.push((k=r.imei[0])==null?void 0:k.mac_id)):console.error("IMEI data not found for item:",r)});const z="one",G=_;_.length>0&&t(fe({type:z,imei:G})),P(d),t(be({w_customer_id:v})),t(we(d)),a(!1)}else a(!1),console.error("Unexpected data format:",B),L.error("Unexpected data format:")}catch(d){console.error("Error fetching vehicle data:",d),L.error(`Error fetching vehicle data: ${d}`)}},u=async d=>{const{label:_,imei:B,id:z,reg_id:G,checked:r}=d;E(k=>k.map(F=>F.id===z?{...F,checked:!r}:F));let A=[...V],D=[...V];if(!r)h.forEach(k=>{k.latestDocument.imei===B&&(A.push({label:_,value:k.latestDocument[_==="maininputvoltage"?"mainInputVoltage":_]}),D=A,R(A))});else{let k=V.filter(F=>F.label!==_);D=k,R(k)}console.log("tempParamList",D),t(ee([{reg_id:G,imei:B,params:D}]))},w=b.filter(d=>Object.keys(p).length===0||d.vehicle_group===p.id);return e.jsxs("div",{className:"app",children:[e.jsx(ke,{}),e.jsxs("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:[e.jsx(_e,{title:"Breakdown",setShowVehicles:y,showVehicles:I,setShowVehiclesGroup:n,showVehiclesGroup:o}),e.jsx(qe,{setShowVehiclesGroup:n,showVehiclesGroup:o}),e.jsxs(T,{style:{display:"flex",width:"100%",height:"95vh"},children:[e.jsxs(T,{style:{width:I||s?"80%":"100%",background:te.bgShadow},children:[e.jsx(Ke,{where:"breakdown"}),e.jsx(Ue,{})]}),I&&e.jsx(T,{style:{width:"20%",backgroundColor:j.grey[100]},children:e.jsx(je,{vehicleData:w,title:"Inspections",setParameterData:E,loadingVehicle:$,setShowVehicles:y,showVehicles:I,showParameters:s,setShowParameters:H})}),s&&e.jsx(T,{style:{width:"20%",backgroundColor:j.grey[100]},children:e.jsx(ve,{parametersData:m,setParameterData:E,handleParameterChange:u})})]})]})]})}export{Lo as default};
