import{n as le,j as e,z as V,b as c,y as Y,b3 as te,bc as pe,bd as me,be as re,bf as de,bg as be,bh as ie,a6 as ee,W as ce,C as E,bi as xe,T as M,M as d,I as K,G as Q,K as _e,V as ge,F as fe,bj as je,bk as ve,aC as we,aU as ye,af as ae,a1 as Se,a2 as Ce,a4 as ke,a5 as Be,E as Ve}from"./index-buw74RsQ.js";import{V as Pe}from"./VehicleMenu-CWI9esnK.js";import{t as Te}from"./SearchTab-oSBUlvrp.js";import"./Loader-Dd1SEo38.js";import"./LiveMapServices-BiOm6VcL.js";import"./Socket-DLjvxrzW.js";import{P as qe}from"./Parameters-EbYuyiFR.js";/* empty css           */import"./proj-XQwXs9DQ.js";import{L as Fe}from"./LeftSideBar2-DTdOvKR0.js";import{I as Ae}from"./InspectionsTable-aSsYwFlA.js";import{c as Le,a as y}from"./index.esm-DdVz_IhC.js";import{V as Re}from"./VehicleGroups-CgiaT2ln.js";import{P as X}from"./index-CgTwdvlv.js";import{S as Ee}from"./ServiceRecordTable-BmwOKsa8.js";import{d as Ie}from"./Close-0ChEfzLc.js";import{a as We}from"./formik.esm-BDuq_Jzs.js";import{B as v}from"./CircularProgress-CWJVtc_x.js";import{A as Z}from"./Autocomplete-Dp6xyU3E.js";import{T as j}from"./TextField-CqfIg_so.js";import{F as Me,a as Oe,S as $e,M as U}from"./menu2-Dh7P6BMK.js";import{D as Ge}from"./Delete-CyQajpg0.js";import{S as Ne}from"./SearchInput-CmFqP8hE.js";import{D as De,a as ze,b as He}from"./DialogTitle-D0zzqLFI.js";import{T as Je,a as oe}from"./Tabs-8lZaLePU.js";import{S as Ke}from"./ServicesTopBar-D8evIP-7.js";import"./createSvgIcon-SkBR_Tkl.js";import"./useControlled-BRe6AMer.js";import"./Card-nFevGPUY.js";import"./CardContent-BBVViR3l.js";import"./Edit-CaAjU4aO.js";import"./TableRow-B_joNbzM.js";import"./TablePagination-8BL60cnD.js";import"./DateTimePicker-sa870WR6.js";import"./NewLoader-Cbsv_tQT.js";import"./index-CBCpbs3G.js";import"./isBetween-B8AZzYfK.js";import"./usePreviousProps-CDuMTSJS.js";const Ye=le(e.jsx("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"}),"Add"),Qe=le(e.jsx("path",{d:"M19 13H5v-2h14z"}),"Remove");function Xe({searchTerm:x}){var R,N,b,D,z,H;const{vehicles_details:g}=V(t=>t.dashboard),{breakdownTopics:S,UpdatedBreakdownData:_}=V(t=>t.breakdown),{UpdatedInspectionData:r,sparePartList:C}=V(t=>t.inspection),{w_customer_id:P}=V(t=>t.auth),[O,k]=c.useState(null),[$,T]=c.useState(""),[A,q]=c.useState(!1);let p=Y(),I=JSON.parse(localStorage.getItem("w_userDetails"));c.useEffect(()=>{console.log("UpdatedInspectionData1111",r)},[r]),c.useEffect(()=>{r&&k(r.resolve_attachment)},[r]);const W=t=>{const i=new FormData;return i.append("vehicle",t.vehicle),i.append("breakdown_topic",t.breakdown_topic),i.append("odometer_reading",t.odometer_reading),i.append("description",t.description),i.append("mob_no",t.mob_no),i.append("email",t.email),i.append("submitted_by",t.submitted_by),i.append("resolved_issue",t.resolved_issue),i.append("pending_issue",t.pending_issue),i.append("status",t.status),i.append("type",t.type),t.resolve_attachment instanceof File&&i.append("resolve_attachment",t.resolve_attachment),t.issued_attachment instanceof File&&i.append("issued_attachment",t.issued_attachment),i};let L=r==null?void 0:r.inspection_parts_inspection.map(t=>{var i;return{spare_parts:(i=t==null?void 0:t.spare_parts)==null?void 0:i.id,quantity:t==null?void 0:t.quantity}});console.log("spare parts",L);const s=We({initialValues:{id:r==null?void 0:r.id,vehicle:((R=r==null?void 0:r.vehicle)==null?void 0:R.id)||"",breakdown_topic:((b=(N=r==null?void 0:r.breakdown)==null?void 0:N.breakdown_topic)==null?void 0:b.id)||"",odometer_reading:(r==null?void 0:r.odometer_reading)||"",description:(r==null?void 0:r.description)||"",mob_no:((D=r==null?void 0:r.breakdown)==null?void 0:D.mob_no)||"",email:((z=r==null?void 0:r.breakdown)==null?void 0:z.email)||"",resolve_attachment:(r==null?void 0:r.resolve_attachment)||null,submitted_by:`${I.first_name} ${I.last_name}`||"",resolved_issue:(r==null?void 0:r.resolved_issue)||"",pending_issue:r==null?void 0:r.pending_issue,status:(r==null?void 0:r.status)||"Open",inspection_parts_inspection:L||null,issued_attachment:r==null?void 0:r.issued_attachment,type:r==null?void 0:r.type},validationSchema:Le({vehicle:y().required("Vehicle is required"),breakdown_topic:y().required("Breakdown Topic is required"),odometer_reading:y().required("Odometer Reading is required"),description:y().required("Description is required"),mob_no:y().matches(/^\d{10,11}$/,"Mobile number must be 10-11 digits").required("Mobile number is required"),email:y().email("Invalid email format").required("Email is required"),resolved_issue:y().required("Resolved issue is required"),pending_issue:y().required("Pending issue is required"),status:y().oneOf(["Open","Close","Rejected"],"Invalid status").required("Status is required"),submitted_by:y().required("Submitted is required")}),onSubmit:async(t,{resetForm:i})=>{var o,u,m,n;try{q(!0),t.submitted_by=I.user_id,console.log("submit value",t);let h=null;t!=null&&t.issued_attachment&&(h=await te(t==null?void 0:t.issued_attachment));let a=null;t!=null&&t.resolve_attachment&&(a=await te(t==null?void 0:t.resolve_attachment)),t.issued_attachment=h||null,console.log("Submitted values:",t);let B=W(t);console.log("formdata11",B);const l=await p(pe({values:B,id:r==null?void 0:r.id}));if(console.log("response",(o=l==null?void 0:l.payload)==null?void 0:o.success),(u=l==null?void 0:l.payload)!=null&&u.success){console.log("response?.payload?.status",(m=l==null?void 0:l.payload)==null?void 0:m.data);const{id:F}=(n=l==null?void 0:l.payload)==null?void 0:n.data,{inspection_parts_inspection:ue}=t;let he=await p(me({inspection:F,parts:ue}));console.log("response2",he),i(),T(""),k(null),p(re(null)),p(de(!1)),p(be(null)),p(ie(!1)),p(ee(P)),p(ce()),q(!1)}else E.error("Error occurred during submission");const J=[];!0&&(i(),T(""),k(null),p(re(null)),p(ie(!1)),p(xe(!1)),p(ee(P))),q(!1)}catch(h){console.error("Submission Error:",h),E.error("Failed to submit breakdown or inspection. Please try again."),q(!1)}}}),G=t=>{const i=t.currentTarget.files[0];if(s.setFieldValue("resolve_attachment",i),T((i==null?void 0:i.name)||""),i&&i.type.startsWith("image/")){const o=new FileReader;o.onload=()=>k(o.result),o.readAsDataURL(i)}else k(null)},w=!!r;return e.jsx(v,{sx:{p:3,margin:"auto"},children:A?e.jsx(M,{children:"Submitted the form data..."}):e.jsx(e.Fragment,{children:e.jsx("form",{onSubmit:s.handleSubmit,children:e.jsxs(d,{container:!0,spacing:2,children:[e.jsx(d,{item:!0,xs:12,md:6,children:e.jsx(Z,{options:g,getOptionLabel:t=>t.registration_id,disabled:w,value:g.find(t=>t.id===s.values.vehicle)||null,onChange:(t,i)=>s.setFieldValue("vehicle",(i==null?void 0:i.id)||""),renderInput:t=>e.jsx(j,{...t,label:"Vehicle",fullWidth:!0,error:s.touched.vehicle&&!!s.errors.vehicle,helperText:s.touched.vehicle&&s.errors.vehicle,disabled:w})})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsx(Z,{disabled:w,options:S,getOptionLabel:t=>t.topic,value:S.find(t=>t.id===s.values.breakdown_topic)||null,onChange:(t,i)=>s.setFieldValue("breakdown_topic",(i==null?void 0:i.id)||""),renderInput:t=>e.jsx(j,{...t,label:"Breakdown Topic",fullWidth:!0,error:s.touched.breakdown_topic&&!!s.errors.breakdown_topic,helperText:s.touched.breakdown_topic&&s.errors.breakdown_topic})})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsx(j,{label:"Odometer Reading",name:"odometer_reading",disabled:w,value:s.values.odometer_reading,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.odometer_reading&&!!s.errors.odometer_reading,helperText:s.touched.odometer_reading&&s.errors.odometer_reading,fullWidth:!0})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsx(j,{label:"Description",name:"description",disabled:w,value:s.values.description,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.description&&!!s.errors.description,helperText:s.touched.description&&s.errors.description,fullWidth:!0})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsx(j,{label:"Mobile Number",name:"mob_no",disabled:w,value:s.values.mob_no,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.mob_no&&!!s.errors.mob_no,helperText:s.touched.mob_no&&s.errors.mob_no,fullWidth:!0})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsx(j,{label:"Email",name:"email",type:"email",disabled:w,value:s.values.email,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.email&&!!s.errors.email,helperText:s.touched.email&&s.errors.email,fullWidth:!0})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsx(j,{label:"Resolved Issue",name:"resolved_issue",value:s.values.resolved_issue,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.resolved_issue&&!!s.errors.resolved_issue,helperText:s.touched.resolved_issue&&s.errors.resolved_issue,fullWidth:!0})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsx(j,{label:"Pending Issue",name:"pending_issue",value:s.values.pending_issue,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.pending_issue&&!!s.errors.pending_issue,helperText:s.touched.pending_issue&&s.errors.pending_issue,fullWidth:!0})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsxs(Me,{fullWidth:!0,children:[e.jsx(Oe,{children:"Status"}),e.jsxs($e,{name:"status",value:s.values.status,onChange:s.handleChange,error:s.touched.status&&!!s.errors.status,children:[e.jsx(U,{value:"Open",children:"Open"}),e.jsx(U,{value:"Close",children:"Close"}),e.jsx(U,{value:"Rejected",children:"Rejected"})]})]})}),e.jsx(d,{item:!0,xs:12,md:6,children:e.jsx(j,{label:"Submitted By",name:"submitted_by",disabled:w,value:s.values.submitted_by,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.submitted_by&&!!s.errors.submitted_by,helperText:s.touched.submitted_by&&s.errors.submitted_by,fullWidth:!0})}),e.jsxs(d,{item:!0,xs:12,children:[e.jsx(M,{variant:"h6",gutterBottom:!0,children:"Spare Parts Used"}),(H=s==null?void 0:s.values)==null?void 0:H.inspection_parts_inspection.map((t,i)=>{var m;const o=(m=s.values)==null?void 0:m.inspection_parts_inspection.map(n=>n.spare_parts).filter((n,h)=>h!==i);console.log("selected part id",o),console.log("partlist",C);const u=C.filter(n=>!o.includes(n.id));return e.jsxs(d,{container:!0,spacing:2,marginTop:"0px",alignItems:"center",children:[e.jsx(d,{item:!0,xs:12,md:6,children:e.jsx(Z,{options:u,getOptionLabel:n=>n.description,value:C.find(n=>n.id===t.spare_parts)||null,onChange:(n,h)=>s.setFieldValue(`inspection_parts_inspection[${i}].spare_parts`,(h==null?void 0:h.id)||""),renderInput:n=>e.jsx(j,{...n,label:"Spare Part",fullWidth:!0})})}),e.jsx(d,{item:!0,xs:8,md:4,children:e.jsxs(v,{display:"flex",alignItems:"center",children:[e.jsx(K,{onClick:()=>s.setFieldValue(`inspection_parts_inspection[${i}].quantity`,Math.max(1,t.quantity-1)),children:e.jsx(Qe,{})}),e.jsx(j,{value:t.quantity,type:"number",inputProps:{min:1},onChange:n=>s.setFieldValue(`inspection_parts_inspection[${i}].quantity`,parseInt(n.target.value,10)),sx:{width:90,mx:1,textAlign:"center"}}),e.jsx(K,{onClick:()=>s.setFieldValue(`inspection_parts_inspection[${i}].quantity`,t.quantity+1),children:e.jsx(Ye,{})})]})}),e.jsx(d,{item:!0,xs:4,md:2,children:e.jsx(K,{color:"error",onClick:()=>{var h;const n=[...(h=s.values)==null?void 0:h.inspection_parts_inspection];n.splice(i,1),s.setFieldValue("inspection_parts_inspection",n)},children:e.jsx(Ge,{})})})]},i)}),e.jsx(Q,{variant:"outlined",onClick:()=>{var o,u;const t=(o=s.values)==null?void 0:o.inspection_parts_inspection.map(m=>m.spare_parts);if(C.filter(m=>!t.includes(m.id)).length===0){E.error("All available spare parts have already been added.");return}s.setFieldValue("inspection_parts_inspection",[...(u=s.values)==null?void 0:u.inspection_parts_inspection,{spare_parts:"",quantity:1}])},sx:{mt:2},children:"+ Add Spare Part"})]}),e.jsxs(d,{item:!0,xs:12,md:6,children:[e.jsxs(Q,{variant:"contained",component:"label",fullWidth:!0,children:["Upload Attachment",e.jsx("input",{type:"file",hidden:!0,onChange:G})]}),$&&e.jsx(M,{children:$})]}),e.jsx(d,{item:!0,xs:12,md:6,children:s.values.issued_attachment&&e.jsxs(M,{variant:"body2",children:[e.jsx("b",{children:"Submitted attachment:"})," ",e.jsx("a",{href:s.values.issued_attachment,target:"_blank",rel:"noopener noreferrer",children:"View File"})]})}),O&&e.jsx(d,{item:!0,xs:12,children:e.jsx(v,{component:"img",src:O,alt:"Preview",sx:{width:"100%",maxHeight:200,mt:2}})}),e.jsx(d,{item:!0,xs:12,children:e.jsx(Q,{type:"submit",variant:"contained",fullWidth:!0,children:"Submit"})})]})})})})}function Ze({where:x}){const{isUpdateInspection:g,UpdatedInspectionData:S}=V(P=>P.inspection);let _=Y();const r=()=>{_(de(!1))},C={fontSize:"18px",fontWeight:500,lineHeight:"18.38px",textAlign:"center",paddingTop:"5px",fontFamily:"ubuntu"};return e.jsxs(v,{sx:{bgcolor:"white",m:"10px",display:"flex",textAlign:"left",justifyContent:"space-between",alignItems:"center",borderRadius:"6px",padding:"20px"},children:[e.jsx(Ne,{}),e.jsx(M,{variant:"h6",sx:C,children:"New Breakdown Requests"}),e.jsxs(De,{open:g,onClose:r,maxWidth:"xl",fullWidth:!0,children:[e.jsxs(ze,{children:["Update Inspection Status",e.jsx(K,{"aria-label":"close",onClick:r,sx:{position:"absolute",right:8,top:8,color:P=>P.palette.grey[500]},children:e.jsx(Ie,{})})]}),e.jsx(He,{children:e.jsx(Xe,{})})]})]})}function se(x){const{children:g,value:S,index:_,...r}=x;return e.jsx("div",{role:"tabpanel",hidden:S!==_,id:`simple-tabpanel-${_}`,"aria-labelledby":`simple-tab-${_}`,...r,children:S===_&&e.jsx(v,{sx:{p:3},children:g})})}se.propTypes={children:X.node,index:X.number.isRequired,value:X.number.isRequired};function ne(x){return{id:`simple-tab-${x}`,"aria-controls":`simple-tabpanel-${x}`}}function Ue(){const{selectedTabValue:x}=V(_=>_.inspection),g=Y();c.useState(0);const S=(_,r)=>{g(_e("")),g(ge(r))};return e.jsxs(v,{sx:{width:"100%"},children:[e.jsx(v,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(Je,{value:x,onChange:S,"aria-label":"basic tabs example",children:[e.jsx(oe,{label:"Breakdowns",...ne(0)}),e.jsx(oe,{label:"Services",...ne(1)})]})}),e.jsxs(se,{value:x,index:0,children:[e.jsx(Ze,{where:"inspection"}),e.jsx(Ae,{})]}),e.jsx(se,{value:x,index:1,children:e.jsx(Ee,{isInspection:!0})})]})}function Ms(){const{locationData:x,selectedVehicle:g,selectedParameterList:S}=V(o=>o.liveMap),{mode:_,selectedVehicleGroup:r}=V(o=>o.dashboard),C=Te(_),[P,O]=c.useState([]),{w_customer_id:k}=V(o=>o.auth),[$,T]=c.useState(),[A,q]=c.useState(!1),[p,I]=c.useState(!1),[W,L]=c.useState([]);c.useState(!0);const[s,G]=c.useState(!1),[w,R]=c.useState(!1),N=JSON.parse(localStorage.getItem("w_userDetails"));let b=Y(),D=fe();c.useEffect(()=>{b(je()),b(ve())},[]),c.useEffect(()=>{we.includes(N.role)?console.log("you can access this route"):(console.log("you can't access this route"),z())},[]);const z=()=>{console.log("oh! this route not allowed"),D("/dashboard"),E.error("You're not allowed to access inspection.")};c.useEffect(()=>{H(),b(ce()),b(ee(k)),b(ye())},[]),c.useEffect(()=>{L([]),b(ae([{reg_id:"",imei:"",params:[]}]))},[g]);const H=async()=>{try{R(!0);let o=[],u=[];const m=await b(Se({w_customer_id:k}));if(Array.isArray(m.payload)){m.payload.forEach(a=>{var B,l,J,f;Array.isArray(a.imei)&&a.imei.length>0&&((B=a.imei[0])!=null&&B.mac_id)?(o.push({id:a.id,label:a.registration_id,value:(l=a.imei[0])==null?void 0:l.mac_id,vehilce_type:a==null?void 0:a.segment,chassis_no:a==null?void 0:a.chassis_no,engine_no:a==null?void 0:a.engine_no,workShop:a==null?void 0:a.workshop,registration_id:a==null?void 0:a.registration_id,sell_date:a==null?void 0:a.sell_date,customer_name:a==null?void 0:a.customer_name,vehicle_model:(J=a==null?void 0:a.vehicle_model)==null?void 0:J.name,vehicle_group:a==null?void 0:a.vehicle_group}),u.push((f=a.imei[0])==null?void 0:f.mac_id)):console.error("IMEI data not found for item:",a)});const n="one",h=u;u.length>0&&b(Ce({type:n,imei:h})),O(o),b(ke(o)),R(!1),b(Be({w_customer_id:k}))}else R(!1),console.error("Unexpected data format:",m),E.error("Unexpected data format:")}catch(o){console.error("Error fetching vehicle data:",o),E.error(`Error fetching vehicle data: ${o}`)}},t=async o=>{const{label:u,imei:m,id:n,reg_id:h,checked:a}=o;T(f=>f.map(F=>F.id===n?{...F,checked:!a}:F));let B=[...W],l=[...W];if(!a)x.forEach(f=>{f.latestDocument.imei===m&&(B.push({label:u,value:f.latestDocument[u==="maininputvoltage"?"mainInputVoltage":u]}),l=B,L(B))});else{let f=W.filter(F=>F.label!==u);l=f,L(f)}console.log("tempParamList",l),b(ae([{reg_id:h,imei:m,params:l}]))},i=P.filter(o=>Object.keys(r).length===0||o.vehicle_group===r.id);return e.jsxs("div",{className:"app",children:[e.jsx(Fe,{}),e.jsxs("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:[e.jsx(Ke,{title:"Inspections",setShowVehicles:q,showVehicles:A,setShowVehiclesGroup:G,showVehiclesGroup:s}),e.jsx(Re,{setShowVehiclesGroup:G,showVehiclesGroup:s}),e.jsxs(v,{style:{display:"flex",width:"100%",height:"95vh"},children:[e.jsx(v,{style:{width:A||p?"80%":"100%",background:Ve.bgShadow},children:e.jsx(Ue,{})}),A&&e.jsx(v,{style:{width:"20%",backgroundColor:C.grey[100]},children:e.jsx(Pe,{vehicleData:i,title:"Inspections",setParameterData:T,loadingVehicle:w,setShowVehicles:q,showVehicles:A,showParameters:p,setShowParameters:I})}),p&&e.jsx(v,{style:{width:"20%",backgroundColor:C.grey[100]},children:e.jsx(qe,{parametersData:$,setParameterData:T,handleParameterChange:t})})]})]})]})}export{Ms as default};
