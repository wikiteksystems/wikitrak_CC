import{r as a,k as v,j as s,i as ae,t as re,B as z,aC as ve,R as je,aD as Pe,a9 as U,J as Ce,w as T}from"./index-BqbafYZ_.js";import{a as oe,b as q,u as Ee,G as ke,D as Ie,P as Fe}from"./esm-D88AA1PR.js";import{d as Ae}from"./dayjs.min-qQx061uA.js";import{m as ne,t as Re,f as Le,a as Oe}from"./preet_tractor-CDwt_mVh.js";import{T as Te,g as Ve}from"./TripVehicleInfo-C2iMyMks.js";import{B as N,C as We}from"./menu2-be6SFaqr.js";import{d as Be}from"./Info-BoHzeC2z.js";function He({trip:t,tripPlay:r,setTripPlay:g,setSpeed:d}){const[i,m]=a.useState([]),[o,l]=a.useState(0),[f,u]=a.useState([]),[M,e]=a.useState([null]),V=a.useRef(null),{selectedVehicle:C}=v(p=>p.liveMap),{vehicles_details:E}=v(p=>p.dashboard),[W,k]=a.useState("2W");a.useEffect(()=>{e([null]);const p=[];if(t&&t.length>0&&(t==null||t.forEach(x=>{p.push(x.speed.toFixed(2))}),u(p)),t&&t.length>0){const x=t.map(y=>({lat:parseFloat(y.lat),lng:parseFloat(y.lng)}));m(x),e(x.slice(0))}},[t]),a.useEffect(()=>{if(r){const p=i.length,x=9e3,y=1e4,F=performance.now();let A=0;const j=R=>{const Y=R-F,B=Math.max(0,Math.min(Y/x,1)),P=Math.min(Math.floor(B*p),p-1);P!==V.current&&(l(P),d(f[P]),V.current=P),A<y&&(requestAnimationFrame(j),A++)};return requestAnimationFrame(j),()=>{}}},[r,i,f]);const D=p=>{const x=E&&E.length>0&&E.find(y=>y.value===p&&y.vehilce_type);return x?x.vehilce_type:null};a.useEffect(()=>{if(Object.keys(C).length>0){const p=D(C.imei);k(p)}},[C]);const I=a.useMemo(()=>{var p,x;return{lat:parseFloat((p=i[o])==null?void 0:p.lat),lng:parseFloat((x=i[o])==null?void 0:x.lng)}},[i,o]),G=a.useMemo(()=>({url:(()=>{switch(W){case"2W":return ne;case"3W":return Oe;case"4W":return Le;case"Tractor":return Re;default:return ne}})(),size:new window.google.maps.Size(80,80),scaledSize:new window.google.maps.Size(80,80),fillOpacity:2,strokeWeight:1,scale:2}),[W]);return s.jsxs("div",{children:[M.length>0&&s.jsx(s.Fragment,{children:s.jsx(oe,{path:M,options:{strokeColor:"red",strokeOpacity:1,strokeWeight:4}})}),r&&s.jsxs(s.Fragment,{children:[s.jsx(oe,{path:i.slice(0,o+1),options:{strokeColor:"green",strokeOpacity:1,strokeWeight:4,zIndex:1e3,geodesic:!0}}),s.jsx(q,{position:I,icon:G},o)]})]})}function _e({tripPlay:t,speed:r,totalDistance:g,Acreage:d,filterCoordinates:i,handleTrip:m,showGraph:o,handleShowGraph:l}){const{selectedTripData:f}=v(M=>M.dashboard);let u=ae();return s.jsxs(N,{sx:{bgcolor:re.bgColor,position:"relative",color:"white",display:"flex",alignItems:"center",overflowX:"hidden",flexWrap:"wrap",border:"1px solid white",gap:"5px",paddingLeft:"5px",padding:"10px 10px"},children:[s.jsxs(z,{sx:{background:"white",border:"1px solid white",borderRadius:"5px",padding:"5px 20px",color:"black"},onClick:()=>{i(f,u)},children:[" ","Calculate Acerage"]}),s.jsxs(z,{sx:{background:t?"transparent":"white",border:"1px solid white",borderRadius:"5px",height:"38px",padding:"5px 20px",color:t?"white":"black","&:hover":{background:"transparent",color:"white"}},onClick:()=>{m()},children:[t?"Pause":"Play","-Trip"]}),s.jsxs(z,{style:{height:"38px",padding:"5px 20px"},sx:{background:o?"transparent":"white",border:"1px solid white",borderRadius:"5px",color:o?"white":"black","&:hover":{background:"transparent",color:"white"}},onClick:()=>{l()},children:[o?"Hide":"Show","-Graph"]})]})}const ze=(t,r)=>{const i=[];t.length>0&&t.forEach(o=>{let l={latitude:o.lat,longitude:o.lng},f=[];t.forEach(u=>{const M={latitude:u.lat,longitude:u.lng};if(M.latitude&&M.longitude&&M.latitude!==l.latitude&&M.longitude!==l.longitude){const e=Ge(o.lat,o.lng,u.lat,u.lng);e<20&&e>10&&f.push(u)}}),f.length>10&&i.push(o)});const m=t.filter(o=>o.lat!==void 0&&o.lng!==void 0).map(o=>({lat:parseFloat(o.lat),lng:parseFloat(o.lng)}));if(m.length>0){r(Pe(i));try{const o=De(m),l=Ye(o),f=new window.google.maps.Polygon({paths:l});return Ue(f,r)}catch(o){return console.error("Error calculating convex hull or area:",o),r(U(0)),0}}else return r(U(0)),0},De=t=>{const r=(o,l,f)=>{const u=(l.lat-o.lat)*(f.lng-l.lng)-(l.lng-o.lng)*(f.lat-l.lat);return u===0?0:u>0?1:2},g=t.reduce((o,l)=>l.lng<o.lng?l:o);let d=[],i=g,m;do{d.push(i),m=t[0]===i?t[1]:t[0];for(let o=0;o<t.length;o++)r(i,m,t[o])===2&&(m=t[o]);i=m}while(i!==g);return d};function Ge(t,r,g,d){const m=t*Math.PI/180,o=g*Math.PI/180,l=(g-t)*Math.PI/180,f=(d-r)*Math.PI/180,u=Math.sin(l/2)*Math.sin(l/2)+Math.cos(m)*Math.cos(o)*Math.sin(f/2)*Math.sin(f/2);return 6371e3*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))}const Ye=t=>{t.sort((d,i)=>d.lng-i.lng||d.lat-i.lat);const r=[],g=[];for(const d of t){for(;r.length>=2&&se(r[r.length-2],r[r.length-1],d)<=0;)r.pop();r.push(d)}for(let d=t.length-1;d>=0;d--){const i=t[d];for(;g.length>=2&&se(g[g.length-2],g[g.length-1],i)<=0;)g.pop();g.push(i)}return[...r.slice(0,-1),...g.slice(0,-1)]},Ue=(t,r)=>{if(!window.google||!window.google.maps.geometry){console.log("not loaded");return}const d=window.google.maps.geometry.spherical.computeArea(t.getPath())/4046.86;return r(U(d)),d},se=(t,r,g)=>(r.lat-t.lat)*(g.lng-t.lng)-(r.lng-t.lng)*(g.lat-t.lat),qe=({selectedTrip:t,center:r,showCard:g})=>{var ee,te;const d=ae(),{isLoaded:i,loadError:m}=Ee({googleMapsApiKey:"AIzaSyD8TrUWS9FRTu-MRP339mJF_iWlORvEGUA",libraries:["drawing","geometry"]}),{Acreage:o}=v(n=>n.tripMonitor),{selectedVehicle:l}=v(n=>n.liveMap),{singleTrip_Data:f,tripLoading:u,cords:M}=v(n=>n.tripMonitor),{selectedTripData:e,mode:V,styles:C}=v(n=>n.dashboard),{collapsed:E}=v(n=>n.auth),W=a.useRef(null),[k,D]=a.useState(null),[I,G]=a.useState(null),[p,x]=a.useState([]);a.useState([]);const[y,F]=a.useState(!1),[A,j]=a.useState(0),[R,Y]=a.useState(!1),[B,P]=a.useState(0),[le,Ne]=a.useState([]);a.useState([]);const[H,J]=a.useState(!1),[ie,ce]=a.useState({}),[_,K]=a.useState([]),[X,L]=a.useState(null),[ge,$]=a.useState(null);a.useEffect(()=>{J(!0)},[l]),a.useEffect(()=>{(async()=>{if(l!=null&&l.imei){const c=Ae(),w=c.startOf("day").format("MM/DD/YYYY HH:mm:ss"),h=c.endOf("day").format("MM/DD/YYYY HH:mm:ss"),b={imei:[l.imei],startDate:w,endDate:h};try{const S=await Ce(b);console.log("result",S.data[0].data),ce(S.data[0].data)}catch(S){console.error("Error fetching report:",S)}}})()},[l,d]),a.useEffect(()=>{k&&I&&k.fitBounds(I)},[k,I,e]),a.useEffect(()=>{if(console.log("selectedTripData",e),(e==null?void 0:e.length)>0){const n=de({selectedTripData:e});P(n)}},[e]);const de=({selectedTripData:n})=>{const c=n.reduce((w,h,b)=>{if(b===0)return w;const S=n[b-1],O=ve(S.lat,S.lng,h.lat,h.lng);return w+O},0);return c==null?void 0:c.toFixed(2)};a.useEffect(()=>{var n,c,w,h,b;if(e&&(e==null?void 0:e.length)>0){const S=new window.google.maps.LatLngBounds,O=new window.google.maps.LatLng(parseFloat((n=e[0])==null?void 0:n.lat),parseFloat((c=e[0])==null?void 0:c.lng)),Me=new window.google.maps.LatLng(parseFloat((w=e[(e==null?void 0:e.length)-1])==null?void 0:w.lat),parseFloat((h=e[(e==null?void 0:e.length)-1])==null?void 0:h.lng));S.extend(O),S.extend(Me),j((b=e[0])==null?void 0:b.speed),G(S)}F(!1),he()},[e]);const he=()=>{if(e&&e.length>0){const n=(h,b)=>{const O=new Date(h.createdAt).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0});return{Date:h.createdAt.substring(0,10),Time:O,value:h[b]}},w=["speed","mainInputVoltage","ignition"].map(h=>({label:h==="speed"?"Speed":h==="mainInputVoltage"?"MainInputVoltage":"Ignition",randomColor:pe(),data:e.map(b=>n(b,h))}));x(w)}else x([])},pe=()=>"#"+Math.floor(Math.random()*16777215).toString(16),ue=()=>{var n;if((e==null?void 0:e.length)>0)F(!y),j(0);else return((n=Object.keys(e))==null?void 0:n.length)===0?T.error("Please Select Vehicle",{id:"vehicle"}):T.error("Please Select Trip",{id:"trip error"})},fe=()=>{var n;if((e==null?void 0:e.length)>0)Y(!R);else return((n=Object.keys(e))==null?void 0:n.length)===0?T.error("Please Select Vehicle",{id:"vehicle"}):T.error("Please Select Trip",{id:"trip error"})},Q=()=>{Object.keys(l).length>0||H?J(!H):T.error("Please select any vehicle")};if(m)return"Error loading maps";if(!i)return"Loading maps";const me={width:"100%",height:g?"87vh":"93vh"},xe=n=>{if(n.type==="polygon"){const c=n.overlay;c.setEditable(!0),K(w=>[...w,c]),L(c),google.maps.event.addListener(c.getPath(),"set_at",()=>L(c)),google.maps.event.addListener(c.getPath(),"insert_at",()=>L(c)),google.maps.event.addListener(c.getPath(),"remove_at",()=>L(c)),Z(c)}},Z=n=>{if(!n)return;const c=n.getPath().getArray(),h=(google.maps.geometry.spherical.computeArea(c)/4046.86).toFixed(2);$(h)},we=()=>{_.forEach(n=>n.setMap(null)),K([]),$(null),L(null)},Se=()=>{_.forEach(n=>n.setEditable(!0))},be=()=>{_.forEach(n=>n.setEditable(!1))},ye=()=>{X?Z(X):alert("No shape is selected. Please draw or select a shape.")};return s.jsxs(s.Fragment,{children:[u&&s.jsx(N,{sx:{position:"absolute",top:"50vh",left:"50%",zIndex:"1000"},children:s.jsx(We,{})}),g&&s.jsx(_e,{tripPlay:y,speed:A,totalDistance:B,Acreage:o,filterCoordinates:ze,handleTrip:ue,showGraph:R,handleShowGraph:fe}),s.jsx(N,{sx:{position:"absolute",top:"795px",left:E?"74px":"250px",zIndex:1,background:re.bgColor,padding:"5px",borderRadius:"10px",color:"white"},children:s.jsxs(z,{sx:{color:"white"},onClick:Q,children:[H?"Hide":"Show"," Vehicle Info",s.jsx(Be,{})]})}),H===!0&&s.jsx(Te,{handleVehicleInfo:Q,vehicleReport:ie,tripPlay:y,speed:A,totalDistance:B,Acreage:o,whereToUse:"TripMonitor"}),s.jsxs(ke,{ref:W,mapContainerStyle:me,zoom:10,center:r,onLoad:n=>D(n),options:{styles:V?C:""},children:[s.jsx(Ie,{onOverlayComplete:xe,options:{drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:["polygon"]}}}),s.jsxs("div",{style:{position:"absolute",bottom:80,left:20,background:"white",padding:"10px",borderRadius:"8px",boxShadow:"0 0 6px rgba(0,0,0,0.2)",zIndex:100,width:"auto"},children:[s.jsxs("p",{children:["Area: ",ge||0," acres"]}),_.length>0&&s.jsxs(s.Fragment,{children:[s.jsx("button",{onClick:Se,style:{marginTop:"10px",marginRight:"10px"},children:"Enable Editing"}),s.jsx("button",{onClick:be,style:{marginTop:"10px",marginRight:"10px"},children:"Disable Editing"}),s.jsx("button",{onClick:ye,style:{marginTop:"10px",marginRight:"10px"},children:"Calculate Area"}),s.jsx("button",{onClick:we,style:{marginTop:"10px"},children:"Clear All Shapes"})]})]}),s.jsx(Fe,{paths:le,options:{fillColor:"#00FF00",fillOpacity:.4,strokeColor:"#000",strokeOpacity:1,strokeWeight:2}}),e&&(e==null?void 0:e.length)>0&&(e==null?void 0:e.map((n,c)=>{var w,h,b,S;return s.jsxs(je.Fragment,{children:[s.jsx(q,{position:{lat:parseFloat((w=e[0])==null?void 0:w.lat),lng:parseFloat((h=e[0])==null?void 0:h.lng)},animation:"BOUNCE",icon:{url:"http://maps.google.com/mapfiles/ms/icons/green-dot.png"}}),s.jsx(He,{trip:e,tripPlay:y,setTripPlay:F,setSpeed:j}),s.jsx(q,{position:{lat:parseFloat((b=e[(e==null?void 0:e.length)-1])==null?void 0:b.lat),lng:parseFloat((S=e[(e==null?void 0:e.length)-1])==null?void 0:S.lng)},animation:"BOUNCE",icon:{url:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"}})]},c)})),s.jsx("div",{style:{position:"relative",top:200,left:12,color:"green"},children:((te=(ee=p[0])==null?void 0:ee.data)==null?void 0:te.length)>0&&R&&s.jsx(Ve,{item:p})})]})]})},tt=qe;export{tt as T,ze as f};
