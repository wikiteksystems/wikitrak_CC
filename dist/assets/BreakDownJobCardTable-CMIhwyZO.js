import{j as r,f1 as Ce,f2 as Be,T as ae,aY as N,ed as Se,f3 as Te,f4 as qe,bc as z,a_ as je,a$ as Y,fi as ue,fj as Ae,bB as le,fk as G,fl as Pe,fm as $e,b as g,aW as ee,ep as o,dK as x,ff as Ve,bm as L,fg as Fe,bf as Oe,d4 as We,fn as Re,cf as Le,dT as Ne,dU as Ye,dV as Ee,dW as he,dX as j,dY as He,f5 as Je,c4 as Ue,b7 as _e}from"./index-DUMpFwu0.js";import{T as Me,d as Ie,C as ze}from"./excelUtils-CEQK_gsD.js";import{u as Ge}from"./formik.esm-DazBl23l.js";import{c as Ke,a as O,d as Qe,f as be}from"./index.esm-ZL-GEdc7.js";import{A as te}from"./Autocomplete-qbivDt3m.js";import{R as Xe,A as Ze,D as ge}from"./Remove-4V6q9ucZ.js";import{T as we,E as De}from"./Edit-DsxnJwEN.js";const xe=["Approved","Rejected","Open"],es=["Open","Close"],ss=({open:n,handleClose:p,updateData:f,rowData:K,isTechnician:c,isInspection:b})=>r.jsxs(Ce,{open:n,onClose:p,maxWidth:"xl",fullWidth:!0,children:[r.jsxs(Be,{sx:{m:0,p:2},children:[r.jsx(ae,{variant:"h6",children:"Vehicle Breakdown Job Card"}),r.jsx(N,{"aria-label":"close",onClick:p,sx:{position:"absolute",right:8,top:8,color:v=>v.palette.grey[500]},children:r.jsx(Se,{})})]}),r.jsx(Te,{dividers:!0,children:r.jsx(rs,{updateData:f,onClose:p,rowData:K,isTechnician:c,isInspection:b})}),r.jsx(qe,{children:r.jsx(z,{onClick:p,color:"secondary",variant:"outlined",children:"Close"})})]}),rs=({updateData:n,rowData:p,onClose:f,isTechnician:K,isInspection:c})=>{var U,W,Q,X,M,Z,w;const b=je();Y(t=>t.dashboard);const{w_customer_id:v}=Y(t=>t.auth),{sparePartList:E}=Y(t=>t.inspection),{id:H,description:se,location:re,vehicle:d}=p||{};JSON.parse(localStorage.getItem("w_userDetails")),console.log(n,"updateData>>>>>>");let J=(n?n==null?void 0:n.jobcard_parts:p==null?void 0:p.breakdown_parts).map(t=>{var a;return{spare_parts:(a=t==null?void 0:t.spare_parts)==null?void 0:a.id,quantity:t==null?void 0:t.quantity}});const ne=Ke({vehicle:O().required("Vehicle is required"),chassis_no:O().required("Chassis No is required"),engine_no:O().required("Engine No is required"),working_hrs:Qe().required("Working Hrs is required").positive("Must be positive").integer("Must be an integer"),location:O().required("Vehicle Location is required"),submission_date:be().required("Date is required"),customer_complaint:O().required("Customer Complaint is required"),technician_observation:O().required("Technician Observations are required"),status:O().required("Status is required"),service_status:O().required("Status is required"),approval_date:c&&be().required("Date is required")}),s=Ge({initialValues:{vehicle:((U=n==null?void 0:n.vehicle)==null?void 0:U.id)||(d==null?void 0:d.id)||"",breakdown:((W=n==null?void 0:n.breakdown)==null?void 0:W.id)||H||"",chassis_no:(n==null?void 0:n.chassis_no)||(d==null?void 0:d.chassis_no),engine_no:(n==null?void 0:n.engine_no)||(d==null?void 0:d.engine_no),working_hrs:(n==null?void 0:n.working_hrs)||"",location:(n==null?void 0:n.location)||re||"",submission_date:(n==null?void 0:n.submission_date)||ue(new Date),customer_complaint:(n==null?void 0:n.customer_complaint)||se||"",technician_observation:(n==null?void 0:n.technician_observation)||"",jobcard_parts:J||[],service_status:(n==null?void 0:n.service_status)||"Open",status:(n==null?void 0:n.service_status)==="Rejected"||xe==="Rejected"?"Close":(n==null?void 0:n.status)||"Open",issued_attachment:n==null?void 0:n.issued_attachment,submitted_by:((Q=n==null?void 0:n.submitted_by)==null?void 0:Q.id)||v,type:"Breakdown",approval_date:(n==null?void 0:n.approval_date)||(c?ue(new Date):""),reviewed_by:((X=n==null?void 0:n.reviewed_by)==null?void 0:X.id)||(c?v:"")},validationSchema:ne,onSubmit:async t=>{var y;const a=new FormData;for(const _ in s.values)if(_==="issued_attachment"){const l=s.values[_];l instanceof File&&a.append("issued_attachment",l)}else a.append(_,s.values[_]);let u;if(n?(a.append("",n==null?void 0:n.id),u=await b(Ae({formData:a,id:n==null?void 0:n.id})).unwrap(),b(le({w_customer_id:v})),b(G({job_card_type:"Breakdown",isInspection:c}))):(u=await b(Pe(a)).unwrap(),b(le({w_customer_id:v})),b(G({job_card_type:"Breakdown",isInspection:c}))),u!=null&&u.payload){const{id:_}=(y=u==null?void 0:u.payload)==null?void 0:y.data,{jobcard_parts:l}=t;b($e({jobcard:_,parts:l})),b(G({job_card_type:"Breakdown",isInspection:c})),f()}else f()}});return g.useEffect(()=>{s.values.service_status==="Rejected"?s.setFieldValue("status","Close"):n!=null&&n.status||s.setFieldValue("status","Open")},[s.values.service_status]),r.jsx(ee,{sx:{padding:"15px"},children:r.jsx("form",{onSubmit:s.handleSubmit,children:r.jsxs(o,{container:!0,spacing:2,children:[r.jsx(o,{item:!0,xs:6,children:r.jsx(x,{label:"Vehicle*",fullWidth:!0,name:"vehicle",value:((M=n==null?void 0:n.vehicle)==null?void 0:M.registration_id)||(d==null?void 0:d.registration_id),onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.vehicle&&!!s.errors.vehicle,helperText:s.touched.vehicle&&s.errors.vehicle,disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(x,{label:"Chassis No*",fullWidth:!0,name:"chassis_no",value:s.values.chassis_no,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.chassis_no&&!!s.errors.chassis_no,helperText:s.touched.chassis_no&&s.errors.chassis_no,disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(x,{label:"Engine No*",fullWidth:!0,name:"engine_no",value:s.values.engine_no,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.engine_no&&!!s.errors.engine_no,helperText:s.touched.engine_no&&s.errors.engine_no,disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(x,{label:"Working Hrs*",fullWidth:!0,type:"number",name:"working_hrs",value:s.values.working_hrs,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.working_hrs&&!!s.errors.working_hrs,helperText:s.touched.working_hrs&&s.errors.working_hrs,disabled:c||s.values.service_status==="Approved"})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(x,{label:"Vehicle Location*",fullWidth:!0,name:"location",value:s.values.location,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.location&&!!s.errors.location,helperText:s.touched.location&&s.errors.location,disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(x,{label:"Date",name:"submission_date",type:"datetime-local",value:s.values.submission_date,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.submission_date&&!!s.errors.submission_date,helperText:s.touched.submission_date&&s.errors.submission_date,fullWidth:!0,InputLabelProps:{shrink:!0},disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(x,{label:"Customer Complaint*",fullWidth:!0,name:"customer_complaint",value:s.values.customer_complaint,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.customer_complaint&&!!s.errors.customer_complaint,helperText:s.touched.customer_complaint&&s.errors.customer_complaint,disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(x,{label:"Technician Observations*",fullWidth:!0,name:"technician_observation",value:s.values.technician_observation,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.technician_observation&&!!s.errors.technician_observation,helperText:s.touched.technician_observation&&s.errors.technician_observation,disabled:c||s.values.service_status==="Approved"})}),r.jsxs(o,{item:!0,xs:12,children:[r.jsx(ae,{variant:"h6",gutterBottom:!0,children:"Parts Requirement*(If any information available)"}),(w=(Z=s==null?void 0:s.values)==null?void 0:Z.jobcard_parts)==null?void 0:w.map((t,a)=>{var _;const u=(_=s.values)==null?void 0:_.jobcard_parts.map(l=>l.spare_parts).filter((l,h)=>h!==a),y=E.filter(l=>!u.includes(l.id));return r.jsxs(o,{container:!0,spacing:2,marginTop:"0px",alignItems:"center",children:[r.jsx(o,{item:!0,xs:12,md:6,children:r.jsx(te,{options:y,getOptionLabel:l=>l.description,value:E.find(l=>l.id===t.spare_parts)||null,onChange:(l,h)=>s.setFieldValue(`jobcard_parts[${a}].spare_parts`,(h==null?void 0:h.id)||""),renderInput:l=>r.jsx(x,{...l,label:"Spare Part",fullWidth:!0})})}),r.jsx(o,{item:!0,xs:8,md:4,children:r.jsxs(ee,{display:"flex",alignItems:"center",children:[r.jsx(N,{onClick:()=>s.setFieldValue(`jobcard_parts[${a}].quantity`,Math.max(1,t.quantity-1)),children:r.jsx(Xe,{})}),r.jsx(x,{value:t.quantity,type:"number",inputProps:{min:1},onChange:l=>s.setFieldValue(`jobcard_parts[${a}].quantity`,parseInt(l.target.value,10)),sx:{width:90,mx:1,textAlign:"center"}}),r.jsx(N,{onClick:()=>s.setFieldValue(`jobcard_parts[${a}].quantity`,t.quantity+1),children:r.jsx(Ze,{})})]})}),r.jsx(o,{item:!0,xs:4,md:2,children:r.jsx(N,{color:"error",onClick:()=>{var h;const l=[...(h=s.values)==null?void 0:h.jobcard_parts];l.splice(a,1),s.setFieldValue("jobcard_parts",l)},children:r.jsx(ge,{})})})]},a)}),r.jsx(z,{variant:"outlined",onClick:()=>{var u,y,_;const t=(y=(u=s.values)==null?void 0:u.jobcard_parts)==null?void 0:y.map(l=>l.spare_parts);if(E.filter(l=>!(t!=null&&t.includes(l.id))).length===0){toast.error("All available spare parts have already been added.");return}s.setFieldValue("jobcard_parts",[...(_=s.values)==null?void 0:_.jobcard_parts,{spare_parts:"",quantity:1}])},sx:{mt:2},children:"+ Add Spare Part"})]}),c&&r.jsx(o,{item:!0,xs:6,children:r.jsx(x,{label:"Approval Date",name:"approval_date",type:"datetime-local",value:s.values.approval_date,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.approval_date&&!!s.errors.approval_date,helperText:s.touched.approval_date&&s.errors.approval_date,fullWidth:!0,InputLabelProps:{shrink:!0},disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(te,{options:xe,value:s.values.service_status,onChange:(t,a)=>s.setFieldValue("service_status",a||""),disabled:!c,renderInput:t=>r.jsx(x,{...t,label:"Approval Status by Service Engineer*",error:s.touched.service_status&&!!s.errors.service_status,helperText:s.touched.service_status&&s.errors.service_status})})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(te,{options:es,value:s.values.status,onChange:(t,a)=>s.setFieldValue("status",a||""),disabled:s.values.service_status!=="Approved"||c,renderInput:t=>r.jsx(x,{...t,label:"Technician Status"})})}),r.jsxs(o,{item:!0,xs:6,children:[!c&&r.jsxs(z,{variant:"outlined",component:"label",fullWidth:!0,children:["Upload File",r.jsx("input",{type:"file",hidden:!0,onChange:t=>{const a=t.currentTarget.files[0];a&&s.setFieldValue("issued_attachment",a)}})]}),s.values.issued_attachment&&r.jsxs(o,{container:!0,spacing:1,mt:1,alignItems:"center",children:[r.jsx(o,{item:!0,children:r.jsxs(ae,{variant:"body2",children:[r.jsx("b",{children:"Attachment:"})," ",typeof s.values.issued_attachment=="string"?s.values.issued_attachment.split("/").pop():s.values.issued_attachment.name]})}),r.jsx(o,{item:!0,children:r.jsx(z,{size:"small",variant:"text",onClick:()=>{const t=typeof s.values.issued_attachment=="string"?s.values.issued_attachment:URL.createObjectURL(s.values.issued_attachment);window.open(t,"_blank")},children:"View File"})})]})]}),r.jsx(o,{item:!0,xs:12,children:r.jsx(z,{type:"submit",variant:"contained",fullWidth:!0,color:"primary",children:n?"Update job card":"Raise job card"})})]})})})},ve=[{id:"breakdown_id",label:"BDID"},{id:"registration_id",label:"Vehicle No"},{id:"topic",label:"Topic"},{id:"submission_date",label:"Submission Date"},{id:"submission_time",label:"Submission Time"},{id:"submitted_by",label:"Created By"},{id:"reviewed_by",label:"Reviewed By"},{id:"service_status",label:"Approval status"},{id:"Status",label:"Status"}],ns="https://cc.wikitrak.in/api-proxy/api/v1",is=({isInspection:n})=>{const{breakdowns:p,breakdownJobCardList:f,loading:K}=Y(e=>e.breakdown),{w_customer_id:c}=Y(e=>e.auth),{searchTerm:b}=Y(e=>e.inspection),v=je(),[E,H]=g.useState(!1),[se,re]=g.useState(null),[d,oe]=g.useState("asc"),[J,ne]=g.useState("BDID"),[s,U]=g.useState(0),[W,Q]=g.useState(8),[X,M]=g.useState(!1),[Z,w]=g.useState(null),[t,a]=g.useState("breakdown_id");g.useState({id:"",status:"",workshop:"",user:""}),g.useEffect(()=>{v(Ve({})),v(G({job_card_type:"Breakdown",isInspection:n}))},[]);const u=e=>{oe(J===e&&d==="asc"?"desc":"asc"),ne(e)},y=(e,m)=>{U(m)},_=e=>{Q(parseInt(e.target.value,10)),U(0)},h=((e,m,k)=>(console.log("data to filter",e,m,k),!m||!k?e:e.filter(i=>(()=>{var B,S,T,q,A,P,$,V,F,C,ie,I;switch(m){case"breakdown_id":return(((B=i==null?void 0:i.breakdown)==null?void 0:B.breakdown_id)||"").toString();case"registration_id":return((S=i==null?void 0:i.vehicle)==null?void 0:S.registration_id)||"";case"topic":return((q=(T=i==null?void 0:i.breakdown)==null?void 0:T.breakdown_topic)==null?void 0:q.topic)||"";case"submission_date":return i!=null&&i.submission_date?L(i.submission_date).format("YYYY-MM-DD"):"";case"submission_time":return i!=null&&i.submission_date?L(i.submission_date).format("HH:mm A"):"";case"submitted_by":return`${((P=(A=i==null?void 0:i.submitted_by)==null?void 0:A.us_user)==null?void 0:P.first_name)||""} ${((V=($=i==null?void 0:i.submitted_by)==null?void 0:$.us_user)==null?void 0:V.last_name)||""}`;case"reviewed_by":return`${((C=(F=i==null?void 0:i.reviewed_by)==null?void 0:F.us_user)==null?void 0:C.first_name)||""} ${((I=(ie=i==null?void 0:i.reviewed_by)==null?void 0:ie.us_user)==null?void 0:I.last_name)||""}`||"";case"service_status":return(i==null?void 0:i.service_status)||"";case"status":return(i==null?void 0:i.status)||"";default:return""}})().toLowerCase().includes(k.toLowerCase()))))((f==null?void 0:f.slice())||[],t,b);console.log("sortedData",f,h);const pe=h.slice(s*W,s*W+W),ce={fontSize:"14px",fontWeight:"bold",fontFamily:"Ubuntu",color:"black",cursor:"pointer",background:"#f2f2f2"},me=h&&h.map(e=>{var k,i,R,B,S,T,q,A,P,$,V,F;const m=e!=null&&e.jobcard_parts&&(e==null?void 0:e.jobcard_parts.length)>0?e==null?void 0:e.jobcard_parts.map((C,ie)=>{var I;return`${(I=C==null?void 0:C.spare_parts)==null?void 0:I.description}: Qty ${C==null?void 0:C.quantity}`}).join(";"):"N/A";return{BDID:((k=e==null?void 0:e.breakdown)==null?void 0:k.breakdown_id)||"","Vehicle No":((i=e==null?void 0:e.vehicle)==null?void 0:i.registration_id)||"","Breakdown topic":((B=(R=e==null?void 0:e.breakdown)==null?void 0:R.breakdown_topic)==null?void 0:B.topic)||"","Submission Date":e!=null&&e.submission_date?L(e.submission_date).format("YYYY-MM-DD"):"","Submission Time":e!=null&&e.submission_date?L(e.submission_date).format("HH:mm A"):"","Created By":`${((T=(S=e==null?void 0:e.submitted_by)==null?void 0:S.us_user)==null?void 0:T.first_name)||""} ${((A=(q=e==null?void 0:e.submitted_by)==null?void 0:q.us_user)==null?void 0:A.last_name)||""}`,"Reviewed By":`${(($=(P=e==null?void 0:e.reviewed_by)==null?void 0:P.us_user)==null?void 0:$.first_name)||""} ${((F=(V=e==null?void 0:e.reviewed_by)==null?void 0:V.us_user)==null?void 0:F.last_name)||""}`,"Approval status":(e==null?void 0:e.service_status)||"",Status:(e==null?void 0:e.status)||"","Spare parts":m}});let D=Fe("Job Card");const de=(D==null?void 0:D.includes("Update"))||D==="Read-Write-Only",fe=e=>{re(e),H(!0)},ye=async()=>{try{await Ue.delete(`${ns}/vehicles/create/breakdown-service/jobcard/${se.id}/`),_e.success("Breakdown data deleted successfully!"),v(G({job_card_type:"Breakdown",isInspection:n})),v(le({w_customer_id:c}))}catch(e){console.error("Error deleting Breakdown data:",e),_e.error("Failed to delete Breakdown data. Please try again.")}H(!1)},ke=()=>{H(!1)};return r.jsxs(ee,{sx:{m:"10px"},children:[r.jsxs(ee,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[r.jsx(Me,{columns:ve,selectedColumn:t,onColumnChange:a,searchTerm:b,onSearchChange:e=>v(Oe(e))}),r.jsx(We,{variant:"contained",color:"success",onClick:()=>Ie(me,"breakdown-job-card.xlsx"),children:"Download Excel"})]}),K&&r.jsx(Re,{}),r.jsxs(Le,{children:[r.jsx(Ne,{sx:{height:"55vh",bgcolor:"white",borderRadius:"10px"},children:r.jsxs(Ye,{stickyHeader:!0,children:[r.jsx(Ee,{children:r.jsxs(he,{children:[ve.map(e=>r.jsx(j,{sx:ce,children:r.jsx(we,{active:J===e.id,direction:J===e.id?d:"asc",onClick:()=>u(e.id),children:e.label})},e.id)),de&&r.jsx(j,{sx:ce,children:"Action"})]})}),r.jsx(He,{children:pe.map((e,m)=>{var k,i,R,B,S,T,q,A,P,$,V,F;return r.jsxs(he,{children:[r.jsx(j,{children:(k=e==null?void 0:e.breakdown)==null?void 0:k.breakdown_id}),r.jsx(j,{children:(i=e==null?void 0:e.vehicle)==null?void 0:i.registration_id}),r.jsx(j,{children:(B=(R=e==null?void 0:e.breakdown)==null?void 0:R.breakdown_topic)==null?void 0:B.topic}),r.jsx(j,{children:(e==null?void 0:e.submission_date)&&L(e.submission_date).format("YYYY-MM-DD")||"N/A"}),r.jsx(j,{children:(e==null?void 0:e.submission_date)&&L(e.submission_date).format("HH:mm A")||"N/A"}),r.jsx(j,{children:`${(T=(S=e==null?void 0:e.submitted_by)==null?void 0:S.us_user)==null?void 0:T.first_name} ${(A=(q=e==null?void 0:e.submitted_by)==null?void 0:q.us_user)==null?void 0:A.last_name}`||"N/A"}),r.jsx(j,{children:`${(($=(P=e==null?void 0:e.reviewed_by)==null?void 0:P.us_user)==null?void 0:$.first_name)||""} ${((F=(V=e==null?void 0:e.reviewed_by)==null?void 0:V.us_user)==null?void 0:F.last_name)||""}`||"N/A"}),r.jsx(j,{sx:{color:e.service_status==="Open"?"blue":e.service_status==="Approved"?"green":"red"},children:(e==null?void 0:e.service_status)||"N/A"}),"                  ",r.jsx(j,{sx:{color:e.status==="Open"?"blue":e.status==="Close"?"green":"red"},children:e.status}),de&&r.jsxs(j,{style:{display:"flex"},children:[r.jsx(N,{onClick:()=>{M(!0),w(e)},color:"primary",disabled:(e==null?void 0:e.status.toLowerCase())==="close","aria-label":"edit record",children:r.jsx(De,{})}),r.jsx(N,{onClick:()=>fe(e),"aria-label":"edit record",children:r.jsx(ge,{})})]})]},m)})})]})}),r.jsx(Je,{component:"div",count:h.length,page:s,onPageChange:y,rowsPerPage:W,onRowsPerPageChange:_,rowsPerPageOptions:[5,10,15]}),r.jsx(ss,{updateData:Z,open:X,handleClose:()=>M(!1),isTechnician:!0,isInspection:n})]}),r.jsx(ze,{open:E,onClose:ke,onConfirm:ye})]})},hs=is;export{hs as B,ss as a};
