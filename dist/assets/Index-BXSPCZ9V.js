import{k as _,r as i,i as U,aG as oe,aP as te,aQ as ae,w as b,aR as z,aS as Z,aT as ie,aU as K,P as H,C as ee,aV as le,j as s,T as J,B as Q,I as ne,x as de,ai as ce,ax as ue,W as Y,K as he,L as me,N as pe,O as ge,t as fe}from"./index-BiOyS6YP.js";import{L as xe}from"./LiveMapTopBar-PIZi8Mnx.js";import{V as be}from"./VehicleMenu-CxT8NBn0.js";import{L as _e,t as ve}from"./LeftSideBar2-DVnqaLUA.js";import"./Loader-Yt2EAQ6H.js";import"./LiveMapServices-tH21z6UA.js";import"./Socket-0N_gnJcr.js";import{P as we}from"./Parameters-B_aUnJ0g.js";/* empty css           */import"./proj-XQwXs9DQ.js";import{I as je}from"./InspectionsTable-cSIY-QFs.js";import{d as ye}from"./Close-DemS_4A6.js";import{u as Be}from"./formik.esm-DzVeAp1A.js";import{c as Se,a as m}from"./index.esm-CCnxcfJa.js";import{B as S,F as ke,a as Ce}from"./menu2-B0J8IAaf.js";import{A as X}from"./Autocomplete-D_mpvWVy.js";import{T as f,S as Ie,M as $}from"./TextField-DpgGIQtS.js";import{S as Ve}from"./SearchInput-DpwXuAJg.js";import{D as Te,a as qe}from"./TablePagination-CCEHFG5i.js";import{D as Pe}from"./Edit-DY5to7p4.js";import{V as Le}from"./VehicleGroups-B1O4vYwe.js";import"./jcb-aCHXMCXy.js";import"./index-B_xhtuRl.js";import"./createSvgIcon-C56nEWXV.js";import"./useControlled-Bl2IaA5y.js";import"./index-BT1hl09k.js";import"./Card-BtmHWQz8.js";import"./Skeleton-C7iqO0Z_.js";import"./CardContent-C_uK7hwQ.js";import"./TableHead-OJOPJ0fn.js";import"./TableCell-DmQy_pfS.js";import"./TableRow-D7GsfkM_.js";function Ee({searchTerm:F}){var V,W;const{vehicles_details:k}=_(o=>o.dashboard),{breakdownTopics:D,UpdatedBreakdownData:u}=_(o=>o.breakdown),{UpdatedInspectionData:t}=_(o=>o.inspection),{w_customer_id:v}=_(o=>o.auth),[x,w]=i.useState(null),[C,I]=i.useState(""),[L,p]=i.useState(!1);let n=U(),j=JSON.parse(localStorage.getItem("w_userDetails"));i.useEffect(()=>{console.log("UpdatedInspectionData",t)},[t]),i.useEffect(()=>{t&&(w(t.attachment),I("edit"))},[t]);const e=Be({initialValues:{vehicle:((V=t==null?void 0:t.vehicle)==null?void 0:V.id)||"",breakdown_topic:((W=t==null?void 0:t.breakdown_topic)==null?void 0:W.id)||"",odometer_reading:(t==null?void 0:t.odometer_reading)||"",description:(t==null?void 0:t.description)||"",mob_no:(t==null?void 0:t.mob_no)||"",email:(t==null?void 0:t.email)||"",attachment:(t==null?void 0:t.attachment)||"",submitted_by:`${j.first_name} ${j.last_name}`||"",resolved_issue:"",pending_issue:"",status:"Open"},validationSchema:Se({vehicle:m().required("Vehicle is required"),breakdown_topic:m().required("Breakdown Topic is required"),odometer_reading:m().required("Odometer Reading is required"),description:m().required("Description is required"),mob_no:m().matches(/^\d{10,11}$/,"Mobile number must be 10-11 digits").required("Mobile number is required"),email:m().email("Invalid email format").required("Email is required"),resolved_issue:m().required("Resolved issue is required"),pending_issue:m().required("Pending issue is required"),status:m().oneOf(["Open","Close","Rejected"],"Invalid status").required("Status is required"),submitted_by:m().required("Submitted is required")}),onSubmit:async(o,{resetForm:a})=>{try{p(!0),console.log("Submitted values:",o),o.submitted_by=j.user_id,o.location=u.location,o.breakdown=u.id,o.workshop_group=u.workshop_group.id;const d=[];if(u){if(u.attachment){let T=await oe(u.attachment);console.log("file conversion",T),o.attachment=T}const y=u.id;d.push(n(te({values:o,id:y})))}d.push(n(ae({values:o})));const O=await Promise.allSettled(d);let c=!0;O.forEach((y,T)=>{if(y.status==="fulfilled"){const R=y.value.payload;R.success?(T===0&&u?b.success("Breakdown updated successfully!"):b.success("Inspection created successfully!"),a(),I(""),w(null),n(z(null)),n(Z(!1)),n(ie(null)),n(K(!1)),n(H(v)),n(ee()),p(!1)):(c=!1,b.error(R.error||"Failed to submit breakdown or inspection"))}else c=!1,b.error(y.reason.message||"Error occurred during submission")}),c&&(a(),I(""),w(null),n(z(null)),n(K(!1)),n(le(!1)),n(H(v))),p(!1)}catch(d){console.error("Submission Error:",d),b.error("Failed to submit breakdown or inspection. Please try again."),p(!1)}}}),E=o=>{const a=o.currentTarget.files[0];if(e.setFieldValue("attachment",a),I((a==null?void 0:a.name)||""),a&&a.type.startsWith("image/")){const d=new FileReader;d.onload=()=>w(d.result),d.readAsDataURL(a)}else w(null)};return s.jsx(S,{sx:{p:3,maxWidth:600,margin:"auto"},children:L?s.jsx(J,{children:"Submitted the form data..."}):s.jsx(s.Fragment,{children:s.jsxs("form",{onSubmit:e.handleSubmit,children:[s.jsx(X,{options:k,getOptionLabel:o=>o.registration_id,value:k.find(o=>o.id===e.values.vehicle)||null,onChange:(o,a)=>e.setFieldValue("vehicle",(a==null?void 0:a.id)||""),renderInput:o=>s.jsx(f,{...o,label:"Vehicle",error:e.touched.vehicle&&!!e.errors.vehicle,helperText:e.touched.vehicle&&e.errors.vehicle,fullWidth:!0})}),s.jsx(X,{options:D,getOptionLabel:o=>o.topic,value:D.find(o=>o.id===e.values.breakdown_topic)||null,onChange:(o,a)=>e.setFieldValue("breakdown_topic",(a==null?void 0:a.id)||""),renderOption:(o,a)=>i.createElement("li",{...o,key:a.id},a.topic),renderInput:o=>s.jsx(f,{...o,label:"Breakdown Topic",error:e.touched.breakdown_topic&&!!e.errors.breakdown_topic,helperText:e.touched.breakdown_topic&&e.errors.breakdown_topic,fullWidth:!0,sx:{mt:2}})}),s.jsx(f,{label:"Odometer Reading",name:"odometer_reading",value:e.values.odometer_reading,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.odometer_reading&&!!e.errors.odometer_reading,helperText:e.touched.odometer_reading&&e.errors.odometer_reading,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Description",name:"description",value:e.values.description,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.description&&!!e.errors.description,helperText:e.touched.description&&e.errors.description,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Mobile Number",name:"mob_no",value:e.values.mob_no,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.mob_no&&!!e.errors.mob_no,helperText:e.touched.mob_no&&e.errors.mob_no,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Email",name:"email",type:"email",value:e.values.email,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.email&&!!e.errors.email,helperText:e.touched.email&&e.errors.email,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Submitted By",name:"submitted_by",value:e.values.submitted_by,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.submitted_by&&!!e.errors.submitted_by,helperText:e.touched.submitted_by&&e.errors.submitted_by,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Resolved Issue",name:"resolved_issue",value:e.values.resolved_issue,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.resolved_issue&&!!e.errors.resolved_issue,helperText:e.touched.resolved_issue&&e.errors.resolved_issue,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Pending Issue",name:"pending_issue",value:e.values.pending_issue,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.pending_issue&&!!e.errors.pending_issue,helperText:e.touched.pending_issue&&e.errors.pending_issue,fullWidth:!0,sx:{mt:2}}),s.jsxs(ke,{fullWidth:!0,sx:{mt:2},children:[s.jsx(Ce,{children:"Status"}),s.jsxs(Ie,{label:"Status",name:"status",value:e.values.status,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.status&&!!e.errors.status,children:[s.jsx($,{value:"Open",children:"Open"}),s.jsx($,{value:"Close",children:"Close"}),s.jsx($,{value:"Rejected",children:"Rejected"})]})]}),s.jsxs(Q,{component:"label",sx:{mt:2,border:"1px solid #f5f5f5",color:"black"},children:["Upload Attachment",s.jsx("input",{type:"file",hidden:!0,onChange:E})]}),C&&s.jsxs(J,{variant:"body2",sx:{mt:1},children:["Uploaded File: ",C]}),x&&s.jsx(S,{component:"img",src:x,alt:"Image Preview",sx:{mt:1,width:"100%",maxHeight:200}}),s.jsx(Q,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,sx:{mt:3},children:"Submit"})]})})})}function We({where:F}){const{isUpdateInspection:k,UpdatedInspectionData:D}=_(x=>x.inspection);let u=U();const t=()=>{u(Z(!1))},v={fontSize:"18px",fontWeight:500,lineHeight:"18.38px",textAlign:"center",paddingTop:"5px",fontFamily:"ubuntu"};return s.jsxs(S,{sx:{bgcolor:"white",m:"10px",display:"flex",textAlign:"left",justifyContent:"space-between",alignItems:"center",borderRadius:"6px",padding:"20px"},children:[s.jsx(Ve,{}),s.jsx(J,{variant:"h6",sx:v,children:"New Breakdown Requests"}),s.jsxs(Te,{open:k,onClose:t,maxWidth:"md",fullWidth:!0,children:[s.jsxs(Pe,{children:["Update Breakdown Status",s.jsx(ne,{"aria-label":"close",onClick:t,sx:{position:"absolute",right:8,top:8,color:x=>x.palette.grey[500]},children:s.jsx(ye,{})})]}),s.jsx(qe,{children:s.jsx(Ee,{})})]})]})}function ps(){const{locationData:F,selectedVehicle:k,selectedParameterList:D}=_(l=>l.liveMap),{mode:u,selectedVehicleGroup:t}=_(l=>l.dashboard),v=ve(u),[x,w]=i.useState([]),{w_customer_id:C}=_(l=>l.auth),[I,L]=i.useState(),[p,n]=i.useState(!1),[j,e]=i.useState(!1),[E,V]=i.useState([]);i.useState(!0);const[W,o]=i.useState(!1),[a,d]=i.useState(!1),O=JSON.parse(localStorage.getItem("w_userDetails"));let c=U(),y=de();i.useEffect(()=>{ce.includes(O.role)?console.log("you can access this route"):(console.log("you can't access this route"),T())},[]);const T=()=>{console.log("oh! this route not allowed"),y("/dashboard"),b.error("You're not allowed to access inspection.")};i.useEffect(()=>{R(),c(ee()),c(H(C)),c(ue())},[]),i.useEffect(()=>{V([]),c(Y([{reg_id:"",imei:"",params:[]}]))},[k]);const R=async()=>{try{d(!0);let l=[],g=[];const q=await c(he({w_customer_id:C}));if(Array.isArray(q.payload)){q.payload.forEach(r=>{var P,B,G,h;Array.isArray(r.imei)&&r.imei.length>0&&((P=r.imei[0])!=null&&P.mac_id)?(l.push({id:r.id,label:r.registration_id,value:(B=r.imei[0])==null?void 0:B.mac_id,vehilce_type:r==null?void 0:r.segment,chassis_no:r==null?void 0:r.chassis_no,engine_no:r==null?void 0:r.engine_no,workShop:r==null?void 0:r.workshop,registration_id:r==null?void 0:r.registration_id,sell_date:r==null?void 0:r.sell_date,customer_name:r==null?void 0:r.customer_name,vehicle_model:(G=r==null?void 0:r.vehicle_model)==null?void 0:G.name,vehicle_group:r==null?void 0:r.vehicle_group}),g.push((h=r.imei[0])==null?void 0:h.mac_id)):console.error("IMEI data not found for item:",r)});const N="one",M=g;g.length>0&&c(me({type:N,imei:M})),w(l),c(pe(l)),d(!1),c(ge({w_customer_id:C}))}else d(!1),console.error("Unexpected data format:",q),b.error("Unexpected data format:")}catch(l){console.error("Error fetching vehicle data:",l),b.error(`Error fetching vehicle data: ${l}`)}},se=async l=>{const{label:g,imei:q,id:N,reg_id:M,checked:r}=l;L(h=>h.map(A=>A.id===N?{...A,checked:!r}:A));let P=[...E],B=[...E];if(!r)F.forEach(h=>{h.latestDocument.imei===q&&(P.push({label:g,value:h.latestDocument[g==="maininputvoltage"?"mainInputVoltage":g]}),B=P,V(P))});else{let h=E.filter(A=>A.label!==g);B=h,V(h)}console.log("tempParamList",B),c(Y([{reg_id:M,imei:q,params:B}]))},re=x.filter(l=>Object.keys(t).length===0||l.vehicle_group===t.id);return s.jsxs("div",{className:"app",children:[s.jsx(_e,{}),s.jsxs("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:[s.jsx(xe,{title:"Inspections",setShowVehicles:n,showVehicles:p,setShowVehiclesGroup:o,showVehiclesGroup:W}),s.jsx(Le,{setShowVehiclesGroup:o,showVehiclesGroup:W}),s.jsxs(S,{style:{display:"flex",width:"100%",height:"95vh"},children:[s.jsxs(S,{style:{width:p||j?"80%":"100%",background:fe.bgShadow},children:[s.jsx(We,{where:"inspection"}),s.jsx(je,{})]}),p&&s.jsx(S,{style:{width:"20%",backgroundColor:v.grey[100]},children:s.jsx(be,{vehicleData:re,title:"Inspections",setParameterData:L,loadingVehicle:a,setShowVehicles:n,showVehicles:p,showParameters:j,setShowParameters:e})}),j&&s.jsx(S,{style:{width:"20%",backgroundColor:v.grey[100]},children:s.jsx(we,{parametersData:I,setParameterData:L,handleParameterChange:se})})]})]})]})}export{ps as default};
