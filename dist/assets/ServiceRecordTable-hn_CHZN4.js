import{c as ge,j as s,p as R,r as h,o as pe,fk as me,fl as fe,fm as be,V as N,P as xe,ff as je,B as k,d0 as d,cl as j,D as H,aw as Ce,T as oe,m as z,dg as ye,dh as Se,di as Pe,R as Te,dp as $e,S as O,fc as ue,J as qe,bJ as de,aQ as Le,cu as Re,cv as Fe,cw as Ae,cx as he,cy as _,cz as Ie,dq as Oe}from"./index-Ds6FVMyp.js";import{c as Ve,d as Me,a as V,f as We}from"./index.esm-D6DYQ70I.js";import{S as Ee}from"./ServiceJobCard-CMmeaskm.js";import{u as Ye}from"./formik.esm-B7HvObs5.js";import{A as B}from"./Autocomplete-DdKvbCmR.js";import{R as Ne,A as He,D as ze}from"./Remove-BIfc8E92.js";import{T as Je,d as Ge}from"./excelUtils-g5PpiC3H.js";import{T as Qe,E as Ke}from"./Edit-cUm7yG9h.js";const Xe=ge(s.jsx("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close"),Ze=({UpdatedBreakdownData:c,setOpen:C})=>{var K,X,Z,D;const{w_customer_id:L}=R(n=>n.auth),[M,W]=h.useState(null),{vehicleList:f}=R(n=>n.liveMap),{vendorList:ae,segMentList:F,loading:J}=R(n=>n.services),{technicianList:y}=R(n=>n.breakdown),{sparePartList:E}=R(n=>n.inspection),A=pe(),[U,G]=h.useState([]),[w,ee]=h.useState([]),[Q,I]=h.useState(!1),[re,ve]=h.useState(null);console.log("update service data",c),h.useEffect(()=>{},[y]);let ce=c==null?void 0:c.service_parts.map(n=>{var r;return{spare_parts:(r=n==null?void 0:n.spare_parts)==null?void 0:r.id,quantity:n==null?void 0:n.quantity}});const t=Ye({initialValues:{start_date:(c==null?void 0:c.start_date)||je(new Date),vehicle:((K=c==null?void 0:c.vehicle)==null?void 0:K.id)||"",service_type:(c==null?void 0:c.service_type)||"",technician:((X=c==null?void 0:c.technician)==null?void 0:X.id)||"",mob_no:(c==null?void 0:c.mob_no)||"",attachment:(c==null?void 0:c.attachment)||"",location:(c==null?void 0:c.location)||"",contact_person:(c==null?void 0:c.contact_person)||"",service_parts:ce||[],status:"Pending",user:L},validationSchema:Ve({start_date:We().required("Submission Date is required"),vehicle:V().required("Vehicle is required"),service_type:V().required("Service type is required"),technician:V().required("Technician is required"),mob_no:V().matches(/^\d{10,11}$/,"Mobile number must be 10-11 digits").required("Mobile number is required"),location:V().required("Location is required"),contact_person:V().required("Contact Person is required"),attachment:Me()}),onSubmit:async n=>{console.log("values",n);let r;if(c?((n==null?void 0:n.attachment)instanceof File||typeof(n==null?void 0:n.attachment)=="string"&&(n.attachment=""),r=await A(me({payload:n,id:c.id}))):r=await A(fe(n)),r.payload){console.log(r.payload),console.log("values",n.service_parts);const{id:v}=r.payload,{service_parts:g}=n;await A(be({service:v,parts:g})),N.success("Service created successfully"),t.resetForm(),W(null),A(xe()),C(!1)}}}),se=["Routine","Overdue","Emergency"];h.useEffect(()=>{let n=f.map(r=>({label:r.registration_id,value:r.id}));G(n)},[f]),h.useEffect(()=>{let n=F.map(r=>({label:r.segment_name,value:r.id}));ee(n)},[F]);const te=async()=>{I(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition(async n=>{const{latitude:r,longitude:v}=n.coords;try{const g=await getReadableAddress(r,v);t.setFieldValue("location",g)}catch{N.error("Failed to convert coordinates to address.")}finally{I(!1)}},()=>{N.error("Failed to retrieve location."),I(!1)}):(N.error("Geolocation not supported."),I(!1))};return s.jsx(k,{sx:{p:3,maxWidth:"100%",margin:"auto"},children:s.jsx("form",{onSubmit:t.handleSubmit,children:s.jsxs(d,{container:!0,spacing:2,children:[s.jsx(d,{item:!0,xs:12,sm:6,children:s.jsx(j,{label:"Start date",name:"start_date",type:"datetime-local",value:t.values.start_date,onChange:t.handleChange,onBlur:t.handleBlur,error:t.touched.start_date&&!!t.errors.start_date,helperText:t.touched.start_date&&t.errors.start_date,fullWidth:!0,InputLabelProps:{shrink:!0},disabled:!0})}),s.jsx(d,{item:!0,xs:12,sm:6,children:s.jsx(B,{options:f,getOptionLabel:n=>n.registration_id||"",value:f.find(n=>n.id===t.values.vehicle)||null,onChange:(n,r)=>t.setFieldValue("vehicle",(r==null?void 0:r.id)||""),renderInput:n=>s.jsx(j,{...n,label:"Vehicle",error:t.touched.vehicle&&!!t.errors.vehicle,helperText:t.touched.vehicle&&t.errors.vehicle})})}),s.jsx(d,{item:!0,xs:12,sm:6,children:s.jsx(B,{options:se,getOptionLabel:n=>n,value:t.values.service_type,onChange:(n,r)=>t.setFieldValue("service_type",r||""),renderInput:n=>s.jsx(j,{...n,label:"Service Type",error:t.touched.service_type&&!!t.errors.service_type,helperText:t.touched.service_type&&t.errors.service_type})})}),s.jsx(d,{item:!0,xs:12,sm:6,children:s.jsx(B,{options:y,getOptionLabel:n=>`${n.first_name} ${n.last_name}`||"",value:y.find(n=>n.id===t.values.technician)||null,onChange:(n,r)=>t.setFieldValue("technician",(r==null?void 0:r.id)||""),renderInput:n=>s.jsx(j,{...n,label:"Assign technician",error:t.touched.technician&&!!t.errors.technician,helperText:t.touched.technician&&t.errors.technician})})}),s.jsx(d,{item:!0,xs:12,sm:6,children:s.jsx(j,{label:"Contact Person Name*",name:"contact_person",value:t.values.contact_person,onChange:t.handleChange,onBlur:t.handleBlur,error:t.touched.contact_person&&!!t.errors.contact_person,helperText:t.touched.contact_person&&t.errors.contact_person,fullWidth:!0})}),s.jsx(d,{item:!0,xs:12,sm:6,children:s.jsx(j,{label:"Contact Person Mobile No*",name:"mob_no",value:t.values.mob_no,onChange:t.handleChange,onBlur:t.handleBlur,error:t.touched.mob_no&&!!t.errors.mob_no,helperText:t.touched.mob_no&&t.errors.mob_no,fullWidth:!0})}),s.jsxs(d,{item:!0,xs:12,sm:6,children:[s.jsx(j,{label:"Location",name:"location",value:t.values.location,onChange:t.handleChange,onBlur:t.handleBlur,error:t.touched.location&&!!t.errors.location,helperText:t.touched.location&&t.errors.location,fullWidth:!0}),s.jsx(H,{size:"small",onClick:te,disabled:Q,sx:{mt:1},children:Q?s.jsx(Ce,{size:16}):"Use Current Location"})]}),s.jsxs(d,{item:!0,xs:12,children:[s.jsx(oe,{variant:"h6",gutterBottom:!0,children:"Parts Requirement*(If any information available)"}),(D=(Z=t==null?void 0:t.values)==null?void 0:Z.service_parts)==null?void 0:D.map((n,r)=>{var S;const v=(S=t.values)==null?void 0:S.service_parts.map(i=>i.spare_parts).filter((i,x)=>x!==r),g=E.filter(i=>!v.includes(i.id));return s.jsxs(d,{container:!0,spacing:2,marginTop:"0px",alignItems:"center",children:[s.jsx(d,{item:!0,xs:12,md:6,children:s.jsx(B,{options:g,getOptionLabel:i=>i.description,value:E.find(i=>i.id===n.spare_parts)||null,onChange:(i,x)=>t.setFieldValue(`service_parts[${r}].spare_parts`,(x==null?void 0:x.id)||""),renderInput:i=>s.jsx(j,{...i,label:"Spare Part",fullWidth:!0})})}),s.jsx(d,{item:!0,xs:8,md:4,children:s.jsxs(k,{display:"flex",alignItems:"center",children:[s.jsx(z,{onClick:()=>t.setFieldValue(`service_parts[${r}].quantity`,Math.max(1,n.quantity-1)),children:s.jsx(Ne,{})}),s.jsx(j,{value:n.quantity,type:"number",inputProps:{min:1},onChange:i=>t.setFieldValue(`service_parts[${r}].quantity`,parseInt(i.target.value,10)),sx:{width:90,mx:1,textAlign:"center"}}),s.jsx(z,{onClick:()=>t.setFieldValue(`service_parts[${r}].quantity`,n.quantity+1),children:s.jsx(He,{})})]})}),s.jsx(d,{item:!0,xs:4,md:2,children:s.jsx(z,{color:"error",onClick:()=>{var x;const i=[...(x=t.values)==null?void 0:x.service_parts];i.splice(r,1),t.setFieldValue("service_parts",i)},children:s.jsx(ze,{})})})]},r)}),s.jsx(H,{variant:"outlined",onClick:()=>{var v,g,S;const n=(g=(v=t.values)==null?void 0:v.service_parts)==null?void 0:g.map(i=>i.spare_parts);if(E.filter(i=>!(n!=null&&n.includes(i.id))).length===0){N.error("All available spare parts have already been added.");return}t.setFieldValue("service_parts",[...(S=t.values)==null?void 0:S.service_parts,{spare_parts:"",quantity:1}])},sx:{mt:2},children:"+ Add Spare Part"})]}),s.jsxs(d,{item:!0,xs:6,children:[s.jsxs(H,{variant:"outlined",component:"label",fullWidth:!0,children:["Upload File",s.jsx("input",{type:"file",hidden:!0,onChange:n=>{const r=n.currentTarget.files[0];r&&t.setFieldValue("attachment",r)}})]}),t.values.attachment&&s.jsxs(d,{container:!0,spacing:1,mt:1,alignItems:"center",children:[s.jsx(d,{item:!0,children:s.jsxs(oe,{variant:"body2",children:[s.jsx("b",{children:"Attachment:"})," ",typeof t.values.attachment=="string"?t.values.attachment.split("/").pop():t.values.attachment.name]})}),s.jsx(d,{item:!0,children:s.jsx(H,{size:"small",variant:"text",onClick:()=>{const n=typeof t.values.attachment=="string"?t.values.attachment:URL.createObjectURL(t.values.attachment);window.open(n,"_blank")},children:"View File"})})]})]}),s.jsx(d,{item:!0,xs:12,children:s.jsx(H,{variant:"contained",type:"submit",fullWidth:!0,disabled:J,children:c?"Update Service request":"Raise Service request"})})]})})})};function De({open:c,setOpen:C,data:L,isInspection:M}){const W=()=>C(!1);return s.jsxs(ye,{open:c,onClose:W,maxWidth:"xl",fullWidth:!0,scroll:"paper",children:[s.jsxs(Se,{children:["Update service entry",s.jsx(z,{"aria-label":"close",onClick:()=>C(!1),sx:{position:"absolute",right:8,top:8},children:s.jsx(Xe,{})})]}),s.jsx(Pe,{dividers:!0,children:s.jsx(Ze,{UpdatedBreakdownData:L,setOpen:C})})]})}const _e=[{id:"service_record_id",label:"Service Record ID"},{id:"registration_id",label:"Registration ID"},{id:"service_type",label:"Service Type"},{id:"user_name",label:"Created by"},{id:"technician_name",label:"Technician Name"},{id:"contact_person",label:"Contact Person"},{id:"mob_no",label:"Mobile No"},{id:"start_date",label:"Start Date"},{id:"start_time",label:"Start Time"},{id:"status",label:"Status"}],as=()=>{const{servicesData:c}=R(e=>e.services),{searchTerm:C}=R(e=>e.inspection),L=pe(),[M,W]=h.useState("asc"),[f,ae]=h.useState("BDID"),[F,J]=h.useState(0),[y,E]=h.useState(8),[A,U]=h.useState(!1),[G,w]=h.useState(!1),[ee,Q]=h.useState(null),[I,re]=Te.useState(null),[ve,ce]=h.useState({service_record_id:"",registration_id:"",service_type:"",user_name:"",technician_name:"",contact_person:"",mob_no:"",start_date:"",start_time:"",status:""}),[t,se]=h.useState("service_record_id");h.useEffect(()=>{L($e({})),L(xe())},[]);const te=e=>{W(f===e&&M==="asc"?"desc":"asc"),ae(e)},K=(e,u)=>{J(u)},X=e=>{E(parseInt(e.target.value,10)),J(0)},Z=(e,u,p)=>!u||!p?e:e.filter(a=>(()=>{var l,m,P,T,$,q,b,ne,Y;switch(u){case"service_record_id":return((a==null?void 0:a.service_record_id)||"").toString();case"registration_id":return((l=a==null?void 0:a.vehicle)==null?void 0:l.registration_id)||"";case"service_type":return(a==null?void 0:a.service_type)||"";case"user_name":return`${((P=(m=a==null?void 0:a.user)==null?void 0:m.us_user)==null?void 0:P.first_name)||""} ${(($=(T=a==null?void 0:a.user)==null?void 0:T.us_user)==null?void 0:$.last_name)||""}`;case"technician_name":return`${((b=(q=a==null?void 0:a.technician)==null?void 0:q.us_user)==null?void 0:b.first_name)||""} ${((Y=(ne=a==null?void 0:a.technician)==null?void 0:ne.us_user)==null?void 0:Y.last_name)||""}`;case"contact_person":return(a==null?void 0:a.contact_person)||"";case"mob_no":return(a==null?void 0:a.mob_no)||"";case"start_date":return a!=null&&a.start_date?O(a.start_date).format("YYYY-MM-DD"):"";case"start_time":return a!=null&&a.start_date?O(a.start_date).format("HH:mm A"):"";case"status":return(a==null?void 0:a.status)||"";default:return""}})().toLowerCase().includes(p.toLowerCase())),D=(e,u,p,a)=>{if(a==="User"){const o=`${e.user.us_user.first_name} ${e.user.us_user.last_name}`.toLowerCase(),l=`${u.user.us_user.first_name} ${u.user.us_user.last_name}`.toLowerCase();return p==="asc"?o.localeCompare(l):l.localeCompare(o)}if(a==="WorkshopGroup"){const o=e.workshop_group.group_name.toLowerCase(),l=u.workshop_group.group_name.toLowerCase();return p==="asc"?o.localeCompare(l):l.localeCompare(o)}if(a==="BDID"){const o=parseInt(e.service_record_id.replace("BD-",""),10),l=parseInt(u.service_record_id.replace("BD-",""),10);return p==="asc"?o-l:l-o}if(a==="SubmissionDate"){const o=new Date(e.submission_date),l=new Date(u.submission_date);return p==="asc"?o-l:l-o}if(a==="Status"){const o={Open:1,Close:2,Rejected:3},l=o[e.status]||0,m=o[u.status]||0;return p==="asc"?l-m:m-l}return 0},n=Z((c==null?void 0:c.slice())||[],t,C).sort((e,u)=>D(e,u,M,f)),r=n.slice(F*y,F*y+y),v={fontSize:"14px",fontWeight:"bold",fontFamily:"Ubuntu",color:"black",cursor:"pointer",background:"#f2f2f2"},g=e=>{w(!G),re(e)},S=n&&n.map(e=>{var p,a,o,l,m,P,T,$,q;const u=e!=null&&e.service_parts&&(e==null?void 0:e.service_parts.length)>0?e==null?void 0:e.service_parts.map((b,ne)=>{var Y;return`${(Y=b==null?void 0:b.spare_parts)==null?void 0:Y.description}: Qty ${b==null?void 0:b.quantity}`}).join(";"):"N/A";return{"Service Record ID":(e==null?void 0:e.service_record_id)||"","Registration ID":((p=e==null?void 0:e.vehicle)==null?void 0:p.registration_id)||"","Service Type":(e==null?void 0:e.service_type)||"","User Name":`${((o=(a=e==null?void 0:e.user)==null?void 0:a.us_user)==null?void 0:o.first_name)||""} ${((m=(l=e==null?void 0:e.user)==null?void 0:l.us_user)==null?void 0:m.last_name)||""}`,"Technician Name":`${((T=(P=e==null?void 0:e.technician)==null?void 0:P.us_user)==null?void 0:T.first_name)||""} ${((q=($=e==null?void 0:e.technician)==null?void 0:$.us_user)==null?void 0:q.last_name)||""}`,"Contact Person":(e==null?void 0:e.contact_person)||"","Mobile No":(e==null?void 0:e.mob_no)||"","Start Date":e!=null&&e.start_date?O(e.start_date).format("YYYY-MM-DD"):"","Start Time":e!=null&&e.start_date?O(e.start_date).format("HH:mm A"):"",Status:(e==null?void 0:e.status)||"","Spare parts":u}});let i=ue("Service"),x=ue("Job Card");const ie=(x==null?void 0:x.includes("Create"))||x==="Read-Write-Only",le=(i==null?void 0:i.includes("Update"))||i==="Read-Write-Only";return s.jsxs(k,{sx:{m:"10px"},children:[s.jsxs(k,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[s.jsx(Je,{columns:_e,selectedColumn:t,onColumnChange:se,searchTerm:C,onSearchChange:e=>L(qe(e))}),s.jsx(de,{variant:"contained",color:"success",onClick:()=>Ge(S,"service-ticket.xlsx"),children:"Download Excel"})]}),s.jsxs(Le,{children:[s.jsx(Re,{sx:{height:"73vh",bgcolor:"white",borderRadius:"10px"},children:s.jsxs(Fe,{stickyHeader:!0,children:[s.jsx(Ae,{children:s.jsxs(he,{children:[_e.map(e=>s.jsx(_,{sx:v,children:s.jsx(Qe,{active:f===e.id,direction:f===e.id?M:"asc",onClick:()=>te(e.id),children:e.label})},e.id)),le&&s.jsx(_,{sx:v,children:"Action"}),ie&&s.jsx(_,{sx:v,children:"Job card"})]})}),s.jsx(Ie,{children:r.map((e,u)=>{var p,a,o,l,m,P,T,$,q;return s.jsxs(he,{children:[s.jsx(_,{children:e==null?void 0:e.service_record_id}),s.jsx(_,{children:(p=e==null?void 0:e.vehicle)==null?void 0:p.registration_id}),s.jsx(_,{children:e==null?void 0:e.service_type}),s.jsx(_,{children:`${(o=(a=e==null?void 0:e.user)==null?void 0:a.us_user)==null?void 0:o.first_name} ${(m=(l=e==null?void 0:e.user)==null?void 0:l.us_user)==null?void 0:m.last_name}`}),s.jsx(_,{children:`${((T=(P=e==null?void 0:e.technician)==null?void 0:P.us_user)==null?void 0:T.first_name)||""} ${((q=($=e==null?void 0:e.technician)==null?void 0:$.us_user)==null?void 0:q.last_name)||""}`}),s.jsx(_,{children:e==null?void 0:e.contact_person}),s.jsx(_,{children:e==null?void 0:e.mob_no}),s.jsx(_,{children:(e==null?void 0:e.start_date)&&O(e.start_date).format("YYYY-MM-DD")||"N/A"}),s.jsx(_,{children:(e==null?void 0:e.start_date)&&O(e.start_date).format("HH:mm A")||"N/A"}),s.jsx(_,{sx:{color:e.status==="Open"?"blue":e.status==="Completed"?"green":"red"},children:e.status}),le&&s.jsx(_,{children:s.jsx(z,{onClick:()=>g(e),color:"primary",disabled:(e==null?void 0:e.status.toLowerCase())==="completed","aria-label":"edit record",children:s.jsx(Ke,{})})}),ie&&s.jsx(_,{children:s.jsx(de,{variant:"outlined",onClick:()=>{U(!0),Q(e)},disabled:e==null?void 0:e.jobcard,children:"Create job card"})})]},u)})})]})}),s.jsx(Oe,{component:"div",count:n.length,page:F,onPageChange:K,rowsPerPage:y,onRowsPerPageChange:X,rowsPerPageOptions:[5,10,15]}),s.jsx(Ee,{rowData:ee,open:A,handleClose:()=>U(!1),isTechnician:!0})]}),s.jsx(De,{open:G,setOpen:w,data:I})]})};export{Ze as C,as as S};
