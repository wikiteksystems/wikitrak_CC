import{j as r,T as te,F as I,x as de,y as M,bh as ae,bi as he,bj as be,bk as _e,bl as ue,K as o,b as f,be as xe,L as R,bf as me,I as ve}from"./index-CTkhISWS.js";import{u as je}from"./formik.esm-dnupI6vH.js";import{c as pe,a as V,d as ge,f as le}from"./index.esm-VHIyZZ1X.js";import{d as fe}from"./Close-Pg18Ol1R.js";import{D as ye,a as Ce,b as ke,c as Be}from"./DialogTitle-1Pr93vft.js";import{I as U}from"./IconButton-BFq29S61.js";import{B as D}from"./CircularProgress-BtfWMK0B.js";import{T as b}from"./TextField-C-2EsYxU.js";import{A as ie}from"./Autocomplete-DbnD44Tt.js";import{R as Se,A as Te,D as qe,T as Ae,d as Pe}from"./excelUtils-DnQ0Klv3.js";import{N as $e}from"./NewLoader-qxQ6gpZB.js";import{B as Ve}from"./button-CZ2IJZOD.js";import{P as Fe}from"./Paper-CiQNsGfa.js";import{T as Oe,a as We,b as Re,c as oe,d as x,e as Le}from"./TableRow-B_DBKy_d.js";import{T as Ne,E as He}from"./Edit-C0KEOGWg.js";import{T as Ye}from"./TablePagination-DgfdBqA4.js";const Ee=["Approved","Rejected","Open","On Hold"],Je=["Open","Close","Rejected"],Ie=({open:n,handleClose:m,updateData:F,rowData:z,isTechnician:c,isInspection:v})=>r.jsxs(ye,{open:n,onClose:m,maxWidth:"xl",fullWidth:!0,children:[r.jsxs(Ce,{sx:{m:0,p:2},children:[r.jsx(te,{variant:"h6",children:"Vehicle Breakdown Job Card"}),r.jsx(U,{"aria-label":"close",onClick:m,sx:{position:"absolute",right:8,top:8,color:O=>O.palette.grey[500]},children:r.jsx(fe,{})})]}),r.jsx(ke,{dividers:!0,children:r.jsx(Me,{updateData:F,onClose:m,rowData:z,isTechnician:c,isInspection:v})}),r.jsx(Be,{children:r.jsx(I,{onClick:m,color:"secondary",variant:"outlined",children:"Close"})})]}),Me=({updateData:n,rowData:m,onClose:F,isTechnician:z,isInspection:c})=>{var G,K,E,Q,X,Z,w;const v=de();M(t=>t.dashboard);const{w_customer_id:O}=M(t=>t.auth),{sparePartList:L}=M(t=>t.inspection),{id:N,description:ee,location:H,vehicle:d}=m||{};JSON.parse(localStorage.getItem("w_userDetails"));let se=(n?n==null?void 0:n.jobcard_parts:m==null?void 0:m.breakdown_parts).map(t=>{var l;return{spare_parts:(l=t==null?void 0:t.spare_parts)==null?void 0:l.id,quantity:t==null?void 0:t.quantity}});const re=pe({vehicle:V().required("Vehicle is required"),chassis_no:V().required("Chassis No is required"),engine_no:V().required("Engine No is required"),working_hrs:ge().required("Working Hrs is required").positive("Must be positive").integer("Must be an integer"),location:V().required("Vehicle Location is required"),submission_date:le().required("Date is required"),customer_complaint:V().required("Customer Complaint is required"),technician_observation:V().required("Technician Observations are required"),status:V().required("Status is required"),service_status:V().required("Status is required"),approval_date:c&&le().required("Date is required")}),s=je({initialValues:{vehicle:((G=n==null?void 0:n.vehicle)==null?void 0:G.id)||(d==null?void 0:d.id)||"",breakdown:((K=n==null?void 0:n.breakdown)==null?void 0:K.id)||N||"",chassis_no:(n==null?void 0:n.chassis_no)||(d==null?void 0:d.chassis_no),engine_no:(n==null?void 0:n.engine_no)||(d==null?void 0:d.engine_no),working_hrs:(n==null?void 0:n.working_hrs)||"",location:(n==null?void 0:n.location)||H||"",submission_date:(n==null?void 0:n.submission_date)||ae(new Date),customer_complaint:(n==null?void 0:n.customer_complaint)||ee||"",technician_observation:(n==null?void 0:n.technician_observation)||"",jobcard_parts:se||[],status:(n==null?void 0:n.status)||"Open",service_status:(n==null?void 0:n.service_status)||"Open",issued_attachment:n==null?void 0:n.issued_attachment,submitted_by:((E=n==null?void 0:n.submitted_by)==null?void 0:E.id)||O,type:"Breakdown",approval_date:(n==null?void 0:n.approval_date)||(c?ae(new Date):""),reviewed_by:((Q=n==null?void 0:n.reviewed_by)==null?void 0:Q.id)||(c?O:"")},validationSchema:re,onSubmit:async t=>{var j;const l=new FormData;for(const h in s.values)if(h==="issued_attachment"){const a=s.values[h];a instanceof File&&l.append("issued_attachment",a)}else l.append(h,s.values[h]);let u;if(n?(l.append("",n==null?void 0:n.id),u=await v(he({formData:l,id:n==null?void 0:n.id}))):u=await v(be(l)),u!=null&&u.payload){const{id:h}=(j=u==null?void 0:u.payload)==null?void 0:j.data,{jobcard_parts:a}=t;v(_e({jobcard:h,parts:a})),v(ue({job_card_type:"Breakdown",isInspection:c})),F()}}});return r.jsx(D,{sx:{padding:"15px"},children:r.jsx("form",{onSubmit:s.handleSubmit,children:r.jsxs(o,{container:!0,spacing:2,children:[r.jsx(o,{item:!0,xs:6,children:r.jsx(b,{label:"Vehicle*",fullWidth:!0,name:"vehicle",value:((X=n==null?void 0:n.vehicle)==null?void 0:X.registration_id)||(d==null?void 0:d.registration_id),onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.vehicle&&!!s.errors.vehicle,helperText:s.touched.vehicle&&s.errors.vehicle,disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(b,{label:"Chassis No*",fullWidth:!0,name:"chassis_no",value:s.values.chassis_no,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.chassis_no&&!!s.errors.chassis_no,helperText:s.touched.chassis_no&&s.errors.chassis_no,disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(b,{label:"Engine No*",fullWidth:!0,name:"engine_no",value:s.values.engine_no,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.engine_no&&!!s.errors.engine_no,helperText:s.touched.engine_no&&s.errors.engine_no,disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(b,{label:"Working Hrs*",fullWidth:!0,type:"number",name:"working_hrs",value:s.values.working_hrs,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.working_hrs&&!!s.errors.working_hrs,helperText:s.touched.working_hrs&&s.errors.working_hrs,disabled:c})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(b,{label:"Vehicle Location*",fullWidth:!0,name:"location",value:s.values.location,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.location&&!!s.errors.location,helperText:s.touched.location&&s.errors.location,disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(b,{label:"Date",name:"submission_date",type:"datetime-local",value:s.values.submission_date,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.submission_date&&!!s.errors.submission_date,helperText:s.touched.submission_date&&s.errors.submission_date,fullWidth:!0,InputLabelProps:{shrink:!0},disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(b,{label:"Customer Complaint*",fullWidth:!0,name:"customer_complaint",value:s.values.customer_complaint,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.customer_complaint&&!!s.errors.customer_complaint,helperText:s.touched.customer_complaint&&s.errors.customer_complaint,disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(b,{label:"Technician Observations*",fullWidth:!0,name:"technician_observation",value:s.values.technician_observation,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.technician_observation&&!!s.errors.technician_observation,helperText:s.touched.technician_observation&&s.errors.technician_observation,disabled:c})}),r.jsxs(o,{item:!0,xs:12,children:[r.jsx(te,{variant:"h6",gutterBottom:!0,children:"Parts Requirement*(If any information available)"}),(w=(Z=s==null?void 0:s.values)==null?void 0:Z.jobcard_parts)==null?void 0:w.map((t,l)=>{var h;const u=(h=s.values)==null?void 0:h.jobcard_parts.map(a=>a.spare_parts).filter((a,_)=>_!==l),j=L.filter(a=>!u.includes(a.id));return r.jsxs(o,{container:!0,spacing:2,marginTop:"0px",alignItems:"center",children:[r.jsx(o,{item:!0,xs:12,md:6,children:r.jsx(ie,{options:j,getOptionLabel:a=>a.description,value:L.find(a=>a.id===t.spare_parts)||null,onChange:(a,_)=>s.setFieldValue(`jobcard_parts[${l}].spare_parts`,(_==null?void 0:_.id)||""),renderInput:a=>r.jsx(b,{...a,label:"Spare Part",fullWidth:!0})})}),r.jsx(o,{item:!0,xs:8,md:4,children:r.jsxs(D,{display:"flex",alignItems:"center",children:[r.jsx(U,{onClick:()=>s.setFieldValue(`jobcard_parts[${l}].quantity`,Math.max(1,t.quantity-1)),children:r.jsx(Se,{})}),r.jsx(b,{value:t.quantity,type:"number",inputProps:{min:1},onChange:a=>s.setFieldValue(`jobcard_parts[${l}].quantity`,parseInt(a.target.value,10)),sx:{width:90,mx:1,textAlign:"center"}}),r.jsx(U,{onClick:()=>s.setFieldValue(`jobcard_parts[${l}].quantity`,t.quantity+1),children:r.jsx(Te,{})})]})}),r.jsx(o,{item:!0,xs:4,md:2,children:r.jsx(U,{color:"error",onClick:()=>{var _;const a=[...(_=s.values)==null?void 0:_.jobcard_parts];a.splice(l,1),s.setFieldValue("jobcard_parts",a)},children:r.jsx(qe,{})})})]},l)}),r.jsx(I,{variant:"outlined",onClick:()=>{var u,j,h;const t=(j=(u=s.values)==null?void 0:u.jobcard_parts)==null?void 0:j.map(a=>a.spare_parts);if(L.filter(a=>!(t!=null&&t.includes(a.id))).length===0){toast.error("All available spare parts have already been added.");return}s.setFieldValue("jobcard_parts",[...(h=s.values)==null?void 0:h.jobcard_parts,{spare_parts:"",quantity:1}])},sx:{mt:2},children:"+ Add Spare Part"})]}),c&&r.jsx(o,{item:!0,xs:6,children:r.jsx(b,{label:"Approval Date",name:"approval_date",type:"datetime-local",value:s.values.approval_date,onChange:s.handleChange,onBlur:s.handleBlur,error:s.touched.approval_date&&!!s.errors.approval_date,helperText:s.touched.approval_date&&s.errors.approval_date,fullWidth:!0,InputLabelProps:{shrink:!0},disabled:!0})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(ie,{options:Ee,value:s.values.service_status,onChange:(t,l)=>s.setFieldValue("service_status",l||""),disabled:!c,renderInput:t=>r.jsx(b,{...t,label:"Approval Status by Service Engineer*",error:s.touched.service_status&&!!s.errors.service_status,helperText:s.touched.service_status&&s.errors.service_status})})}),r.jsx(o,{item:!0,xs:6,children:r.jsx(ie,{options:Je,value:s.values.status,onChange:(t,l)=>s.setFieldValue("status",l||""),disabled:s.values.service_status!=="Approved"||c,renderInput:t=>r.jsx(b,{...t,label:"Technician Status"})})}),r.jsxs(o,{item:!0,xs:6,children:[!c&&r.jsxs(I,{variant:"outlined",component:"label",fullWidth:!0,children:["Upload File",r.jsx("input",{type:"file",hidden:!0,onChange:t=>{const l=t.currentTarget.files[0];l&&s.setFieldValue("issued_attachment",l)}})]}),s.values.issued_attachment&&r.jsxs(o,{container:!0,spacing:1,mt:1,alignItems:"center",children:[r.jsx(o,{item:!0,children:r.jsxs(te,{variant:"body2",children:[r.jsx("b",{children:"Attachment:"})," ",typeof s.values.issued_attachment=="string"?s.values.issued_attachment.split("/").pop():s.values.issued_attachment.name]})}),r.jsx(o,{item:!0,children:r.jsx(I,{size:"small",variant:"text",onClick:()=>{const t=typeof s.values.issued_attachment=="string"?s.values.issued_attachment:URL.createObjectURL(s.values.issued_attachment);window.open(t,"_blank")},children:"View File"})})]})]}),r.jsx(o,{item:!0,xs:12,children:r.jsx(I,{type:"submit",variant:"contained",fullWidth:!0,color:"primary",children:n?"Update job card":"Raise job card"})})]})})})},ce=[{id:"breakdown_id",label:"BDID"},{id:"registration_id",label:"Vehicle No"},{id:"topic",label:"Topic"},{id:"submission_date",label:"Submission Date"},{id:"submission_time",label:"Submission Time"},{id:"submitted_by",label:"Created By"},{id:"reviewed_by",label:"Reviewed By"},{id:"service_status",label:"Approval status"},{id:"Status",label:"Status"}],Ue=({isInspection:n})=>{const{breakdowns:m,breakdownJobCardList:F,loading:z}=M(e=>e.breakdown),{searchTerm:c}=M(e=>e.inspection),v=de(),[O,L]=f.useState("asc"),[N,ee]=f.useState("BDID"),[H,d]=f.useState(0),[Y,se]=f.useState(8),[re,s]=f.useState(!1),[G,K]=f.useState(null),[E,Q]=f.useState("breakdown_id");f.useState({id:"",status:"",workshop:"",user:""}),f.useEffect(()=>{v(xe({})),v(ue({job_card_type:"Breakdown",isInspection:n}))},[]);const X=e=>{L(N===e&&O==="asc"?"desc":"asc"),ee(e)},Z=(e,p)=>{d(p)},w=e=>{se(parseInt(e.target.value,10)),d(0)},l=((e,p,y)=>!p||!y?e:e.filter(i=>(()=>{var C,k,B,S,T,q,A,P,$,g,ne,J;switch(p){case"breakdown_id":return(((C=i==null?void 0:i.breakdown)==null?void 0:C.breakdown_id)||"").toString();case"registration_id":return((k=i==null?void 0:i.vehicle)==null?void 0:k.registration_id)||"";case"topic":return((S=(B=i==null?void 0:i.breakdown)==null?void 0:B.breakdown_topic)==null?void 0:S.topic)||"";case"submission_date":return i!=null&&i.submission_date?R(i.submission_date).format("YYYY-MM-DD"):"";case"submission_time":return i!=null&&i.submission_date?R(i.submission_date).format("HH:mm A"):"";case"submitted_by":return`${((q=(T=i==null?void 0:i.submitted_by)==null?void 0:T.us_user)==null?void 0:q.first_name)||""} ${((P=(A=i==null?void 0:i.submitted_by)==null?void 0:A.us_user)==null?void 0:P.last_name)||""}`;case"reviewed_by":return`${((g=($=i==null?void 0:i.reviewed_by)==null?void 0:$.us_user)==null?void 0:g.first_name)||""} ${((J=(ne=i==null?void 0:i.reviewed_by)==null?void 0:ne.us_user)==null?void 0:J.last_name)||""}`||"";case"service_status":return(i==null?void 0:i.service_status)||"";case"status":return(i==null?void 0:i.status)||"";default:return""}})().toLowerCase().includes(y.toLowerCase())))((F==null?void 0:F.slice())||[],E,c),u=l.slice(H*Y,H*Y+Y),j={fontSize:"14px",fontWeight:"bold",fontFamily:"Ubuntu",color:"black",cursor:"pointer",background:"#f2f2f2"},h=l&&l.map(e=>{var y,i,W,C,k,B,S,T,q,A,P,$;const p=e!=null&&e.jobcard_parts&&(e==null?void 0:e.jobcard_parts.length)>0?e==null?void 0:e.jobcard_parts.map((g,ne)=>{var J;return`${(J=g==null?void 0:g.spare_parts)==null?void 0:J.description}: Qty ${g==null?void 0:g.quantity}`}).join(";"):"N/A";return{BDID:((y=e==null?void 0:e.breakdown)==null?void 0:y.breakdown_id)||"","Vehicle No":((i=e==null?void 0:e.vehicle)==null?void 0:i.registration_id)||"","Breakdown topic":((C=(W=e==null?void 0:e.breakdown)==null?void 0:W.breakdown_topic)==null?void 0:C.topic)||"","Submission Date":e!=null&&e.submission_date?R(e.submission_date).format("YYYY-MM-DD"):"","Submission Time":e!=null&&e.submission_date?R(e.submission_date).format("HH:mm A"):"","Created By":`${((B=(k=e==null?void 0:e.submitted_by)==null?void 0:k.us_user)==null?void 0:B.first_name)||""} ${((T=(S=e==null?void 0:e.submitted_by)==null?void 0:S.us_user)==null?void 0:T.last_name)||""}`,"Reviewed By":`${((A=(q=e==null?void 0:e.reviewed_by)==null?void 0:q.us_user)==null?void 0:A.first_name)||""} ${(($=(P=e==null?void 0:e.reviewed_by)==null?void 0:P.us_user)==null?void 0:$.last_name)||""}`,"Approval status":(e==null?void 0:e.service_status)||"",Status:(e==null?void 0:e.status)||"","Spare parts":p}});let a=me("Job Card");const _=(a==null?void 0:a.includes("Update"))||a==="Read-Write-Only";return r.jsxs(D,{sx:{m:"10px"},children:[r.jsxs(D,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[r.jsx(Ae,{columns:ce,selectedColumn:E,onColumnChange:Q,searchTerm:c,onSearchChange:e=>v(ve(e))}),r.jsx(Ve,{variant:"contained",color:"success",onClick:()=>Pe(h,"breakdown-job-card.xlsx"),children:"Download Excel"})]}),z&&r.jsx($e,{}),r.jsxs(Fe,{children:[r.jsx(Oe,{sx:{height:"73vh",bgcolor:"white",borderRadius:"10px"},children:r.jsxs(We,{stickyHeader:!0,children:[r.jsx(Re,{children:r.jsxs(oe,{children:[ce.map(e=>r.jsx(x,{sx:j,children:r.jsx(Ne,{active:N===e.id,direction:N===e.id?O:"asc",onClick:()=>X(e.id),children:e.label})},e.id)),_&&r.jsx(x,{sx:j,children:"Action"})]})}),r.jsx(Le,{children:u.map((e,p)=>{var y,i,W,C,k,B,S,T,q,A,P,$;return r.jsxs(oe,{children:[r.jsx(x,{children:(y=e==null?void 0:e.breakdown)==null?void 0:y.breakdown_id}),r.jsx(x,{children:(i=e==null?void 0:e.vehicle)==null?void 0:i.registration_id}),r.jsx(x,{children:(C=(W=e==null?void 0:e.breakdown)==null?void 0:W.breakdown_topic)==null?void 0:C.topic}),r.jsx(x,{children:(e==null?void 0:e.submission_date)&&R(e.submission_date).format("YYYY-MM-DD")||"N/A"}),r.jsx(x,{children:(e==null?void 0:e.submission_date)&&R(e.submission_date).format("HH:mm A")||"N/A"}),r.jsx(x,{children:`${(B=(k=e==null?void 0:e.submitted_by)==null?void 0:k.us_user)==null?void 0:B.first_name} ${(T=(S=e==null?void 0:e.submitted_by)==null?void 0:S.us_user)==null?void 0:T.last_name}`||"N/A"}),r.jsx(x,{children:`${((A=(q=e==null?void 0:e.reviewed_by)==null?void 0:q.us_user)==null?void 0:A.first_name)||""} ${(($=(P=e==null?void 0:e.reviewed_by)==null?void 0:P.us_user)==null?void 0:$.last_name)||""}`||"N/A"}),r.jsx(x,{sx:{color:e.service_status==="Open"?"blue":e.service_status==="Approved"?"green":"red"},children:(e==null?void 0:e.service_status)||"N/A"}),"                  ",r.jsx(x,{sx:{color:e.status==="Open"?"blue":e.status==="Close"?"green":"red"},children:e.status}),_&&r.jsx(x,{children:r.jsx(U,{onClick:()=>{s(!0),K(e)},color:"primary",disabled:(e==null?void 0:e.status.toLowerCase())==="close","aria-label":"edit record",children:r.jsx(He,{})})})]},p)})})]})}),r.jsx(Ye,{component:"div",count:l.length,page:H,onPageChange:Z,rowsPerPage:Y,onRowsPerPageChange:w,rowsPerPageOptions:[5,10,15]}),r.jsx(Ie,{updateData:G,open:re,handleClose:()=>s(!1),isTechnician:!0,isInspection:n})]})]})},os=Ue;export{os as B,Ie as a};
