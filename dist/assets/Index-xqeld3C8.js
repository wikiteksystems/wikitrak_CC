import{z as B,b as i,R as Ce,y as fe,j as g,a0 as Pe,D as Ae,F as Re,a5 as $e,a6 as ue,b_ as Le,Q as Ne,C as te,b$ as Be,W as Te,Y as Ve,a7 as Fe,a9 as de}from"./index-DwNllk2K.js";import{u as Oe,G as We,M as He,m as G}from"./motorbike-De34qZAL.js";import{M as Ue,r as ze,g as Ge,y as qe,b as Ke,a as Ye,c as Je,d as Qe,e as Xe,f as Ze,h as et,i as tt,j as ot,k as nt,l as st,m as at,n as rt,o as lt,p as ct,q as it,s as ut,t as dt,u as ft,v as gt,w as ht}from"./black_bike-CKMdXJNX.js";import"./NewLoader-CHdJey46.js";import{F as pt}from"./Loader-Dy_Kuh3G.js";import{L as yt}from"./LiveMapServices-Bd_FEHNG.js";import{s as oe}from"./Socket-0N_gnJcr.js";import{B as T,C as wt}from"./CircularProgress-CRImEXwy.js";import"./index-B31-_MFU.js";import"./createSvgIcon-CN7zO3db.js";import"./useControlled-C1hgaYnw.js";import"./Card-RJRPh1Bg.js";import"./CardContent-CYrtrvQr.js";const vt="AIzaSyD8TrUWS9FRTu-MRP339mJF_iWlORvEGUA";function kt({loadingVehicle:x,vehicleData:S,center:q,setCenter:_}){const{selectedParameterList:V,selectedVehicle:h,vehicleList:K,zoom:F,icons:ne,locationData:p,placesData:O,imeiNumbers:se,onlineVehicle:ae,loading:re,services_loading:C}=B(e=>e.liveMap),{mode:Y,styles:W,vehicles_details:y}=B(e=>e.dashboard),P=i.useRef(null);B(e=>e.auth);const[k,d]=i.useState(null),[w,M]=i.useState(""),[v,m]=i.useState([]),[A,a]=i.useState(),[H,R]=i.useState(null);i.useState("");const[J,$]=i.useState();i.useState(!1);const[I,Q]=i.useState(null);Ce.useState(!1);const U=fe(),X={},L=i.useRef([]),le=i.useRef(null),N=i.useRef({}),{isLoaded:Z,loadError:ge}=Oe({googleMapsApiKey:`${vt}`,loadingElement:g.jsx(pt,{})});i.useEffect(()=>{Z&&d(window.google.maps)},[Z]),i.useEffect(()=>{},[F]),i.useEffect(()=>{var e,t,o,n;if(Object.keys(h).length>0){const l=((I==null?void 0:I.length)>0?I:p).filter(r=>{var c;return((c=r==null?void 0:r.latestDocument)==null?void 0:c.imei)===(h==null?void 0:h.imei)});if(l.length>0){m(l);const r={lat:(t=(e=l[0])==null?void 0:e.latestDocument)==null?void 0:t.lat,lng:(n=(o=l[0])==null?void 0:o.latestDocument)==null?void 0:n.lng};_(r)}}},[p,h]),i.useEffect(()=>{if(!(Object.keys(h).length>0)){const e=p.filter(t=>S.some(o=>o.value===t.latestDocument.imei));m(e),Q(e)}},[p,h]),i.useEffect(()=>{var e,t,o,n;if(Object.keys(h).length>0){const l=((I==null?void 0:I.length)>0?I:p).filter(r=>{var c;return((c=r==null?void 0:r.latestDocument)==null?void 0:c.imei)===(h==null?void 0:h.imei)});if(l.length>0){m(l);const r={lat:(t=(e=l[0])==null?void 0:e.latestDocument)==null?void 0:t.lat,lng:(n=(o=l[0])==null?void 0:o.latestDocument)==null?void 0:n.lng};_(r)}}else{const s=p.filter(l=>S.some(r=>r.value===l.latestDocument.imei));m(s),Q(s)}},[p,h]),i.useEffect(()=>{U(Pe({}))},[]),i.useEffect(()=>{if(console.log("before: ",v),!k)return;const e=le.current;let t=null;return(async()=>{console.log("after: ",v);const n=await he(v,e);t&&t.clearMarkers(),t=xe(n,e),oe.on("locationinfo",s=>{console.log("locationinfo: ",s),De(s,L),Q(l=>{const r=Array.isArray(l)?l:[],c=r.findIndex(u=>Number(u.latestDocument.imei)===Number(s.imei));if(c!==-1){const u=[...r];return u[c]={...u[c],latestDocument:{...u[c].latestDocument,...s}},u}else return[...r,{_id:s.imei,latestDocument:s}]})})})(),()=>{t&&t.clearMarkers(),Object.keys(N.current).forEach(n=>cancelAnimationFrame(N.current[n])),oe.off("locationinfo")}},[k,v,oe,A,L,p]);const he=(e,t)=>e.map(o=>{const n=o.latestDocument.imei,s=L.current[n]||pe(o,t);return L.current[n]&&ye(o,s),s}),pe=(e,t)=>{const o=e.latestDocument.imei,n=new k.Marker({position:{lat:e.latestDocument.lat,lng:e.latestDocument.lng},map:t,icon:ee(e)});return n.addListener("click",()=>ke(e,n,t)),L.current[o]=n,n},ye=async(e,t)=>{var c;const o=t.getPosition(),n=((c=t.getIcon())==null?void 0:c.rotation)||0,s={lat:e.latestDocument.lat,lng:e.latestDocument.lng},l=e.latestDocument.heading||0;ie(t,o,s,n,l);const r=await ee(e);t.setIcon(r)},ee=async e=>{var c,u,f,b,D;const t=(c=e==null?void 0:e.latestDocument)==null?void 0:c.imei,o=Se(t),n=Ie(e==null?void 0:e.latestDocument,o),s=((u=e==null?void 0:e.latestDocument)==null?void 0:u.heading)||0;return ce((f=e==null?void 0:e.latestDocument)==null?void 0:f.imei)&&we((b=e==null?void 0:e.latestDocument)==null?void 0:b.imei),{url:await ve(n,s),fillOpacity:2,strokeWeight:1,scale:4.5,rotation:(D=e==null?void 0:e.latestDocument)==null?void 0:D.heading,size:new k.Size(30,30),scaledSize:new k.Size(30,30)}},ce=e=>ae.includes(Number(e)),we=e=>p==null?void 0:p.some(t=>Number(t.latestDocument.imei)===Number(e)&&t.latestDocument.speed>0&&(t.latestDocument.ignition===!0||t.latestDocument.ignition===1)),ve=(e,t,o,n=80)=>{const s=`${e}-${t}-${n}-${o}`;if(X[s])return Promise.resolve(X[s]);const l=document.createElement("canvas"),r=l.getContext("2d");l.width=n,l.height=n;const c=new Image;return c.src=e,new Promise(u=>{c.onload=()=>{if(r.clearRect(0,0,l.width,l.height),r.translate(n/2,n/2),r.rotate(t*Math.PI/180),r.translate(-n/2,-n/2),r.drawImage(c,0,0,n,n),o){const D=n-30-5,j=n-30-5;r.beginPath(),r.arc(D,j,30/2,0,Math.PI*2),r.fillStyle=o,r.fill()}const f=l.toDataURL("image/png");X[s]=f,u(f)},c.onerror=f=>{console.error("Error loading image for rotation:",f),u(e)}})},ke=(e,t,o)=>{Me(e.latestDocument._id,e,t,o),_e(e.latestDocument.imei)},ie=(e,t,o,n,s)=>{const r=performance.now(),c=()=>{const u=performance.now()-r,f=Math.min(u/500,1),b=t.lat()+f*(o.lat-t.lat()),D=t.lng()+f*(o.lng-t.lng()),j=(s-n+360)%360-180,z=(n+j*f+360)%360;e.setPosition({lat:b,lng:D});const E=e.getIcon();E&&typeof E=="object"&&e.setIcon({...E,rotation:z}),f<1?N.current[e.getPosition()]=requestAnimationFrame(c):(e.setPosition(o),E&&typeof E=="object"&&e.setIcon({...E,rotation:s}),delete N.current[e.getPosition()])};N.current[e.getPosition()]=requestAnimationFrame(c)},xe=(e,t)=>new Ue({map:t,markers:e,renderer:{render:({count:o,position:n})=>be(o,n)}}),be=(e,t)=>{const o=40+Math.min(e*2,40),n=30;let s;return e<10?s={start:"#76c7c0",end:"#34a853"}:e<50?s={start:"#fbbc05",end:"#f2994a"}:s={start:"#f45c42",end:"#d32f2f"},new k.Marker({position:t,icon:{url:`data:image/svg+xml,${encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="${o}" height="${o}" viewBox="0 0 100 100">
            <defs>
              <radialGradient id="gradient" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="${s.start}" />
                <stop offset="100%" stop-color="${s.end}" />
              </radialGradient>
              <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="rgba(0, 0, 0, 0.5)" />
              </filter>
            </defs>
            <!-- Outer Pulsating Ring -->
            <circle cx="50" cy="50" r="48" fill="url(#gradient)" filter="url(#shadow)" stroke="#ffffff" stroke-width="3" />
            <!-- Decorative Inner Ring -->
            <circle cx="50" cy="50" r="38" fill="none" stroke="#ffffff" stroke-width="2" stroke-dasharray="4 2" />
            <!-- Star Decoration -->
            <polygon points="50,15 54,38 70,38 57,50 62,68 50,57 38,68 43,50 30,38 46,38" fill="#ffffff" opacity="0.4" />
            <!-- Count Text -->
            <text x="50" y="55" font-size="${n}" fill="black" text-anchor="middle" font-family="'Courier New', monospace" font-weight="bold">
              ${e}
            </text>
          </svg>
        `)}`,scaledSize:new k.Size(o,o)},label:null})},De=async(e,t,o)=>{var l;const n=e.imei,s=t.current[n];if(s){const r=s.getPosition(),c=((l=s.getIcon())==null?void 0:l.rotation)||0,u={lat:e.lat,lng:e.lng},f=e.heading||0;ie(s,r,u,c,f);const b=await ee({latestDocument:e});s.setIcon(b)}},Se=e=>{if(!e)return"motorBike";const t=me(e);return t||console.error(`No vehicle type found for IMEI: ${e}, defaulting to motorBike`),t||"motorBike"},me=e=>{if(!y||y.length===0)return console.error("vehicles_details is not available"),null;const t=y.find(o=>(o==null?void 0:o.value)===e&&(o==null?void 0:o.vehilce_type));return t||console.error(`No vehicle found for IMEI: ${e}`),t?t.vehilce_type:null},Ie=(e,t)=>{let{speed:o,ignition:n,imei:s}=e,l=ce(s);const r={"2W":{red:ze,green:Ge,yellow:qe,black:Ke},"3W":{red:Ye,green:Je,yellow:Qe,black:Xe},"4W":{red:Ze,green:et,yellow:tt,black:ot},Tractor:{red:nt,green:st,yellow:at,black:rt},Harvestor:{red:lt,green:ct,yellow:it,black:ut},BUS:{red:dt,green:ft,yellow:gt,black:ht},default:{red:G,green:G,yellow:G,black:G}};let c=r[t]||r.default;if(!l)return c.black;if(l&&!n)return c.red;if(l&&n&&o>0)return c.green;if(l&&n&&o<=0)return c.yellow},Me=(e,t,o,n)=>{var u,f,b;U($e(t.latestDocument.imei));const s={lat:(u=t==null?void 0:t.latestDocument)==null?void 0:u.lat,lng:(f=t==null?void 0:t.latestDocument)==null?void 0:f.lng};_(s),U(ue(15)),P.current||(P.current=new k.InfoWindow);const l=P.current,c=`
      <div>
        <h3>Registration No: ${((b=K.find(D=>{var j,z;return((j=D==null?void 0:D.imei[0])==null?void 0:j.mac_id)===((z=t==null?void 0:t.latestDocument)==null?void 0:z.imei)}))==null?void 0:b.registration_id)||""}</h3>
      </div>
    `;H===e?(l.close(),R(null)):(l.setContent(c),l.open(n,o),R(e))},_e=e=>{const t=y&&(y==null?void 0:y.length)>0&&y.find(o=>(o==null?void 0:o.value)===e&&o);$(t||null)};if(ge)return"Error loading maps";if(!Z)return"Loading maps";if(!k)return null;const je={height:"100vh",width:"100%",transition:"transform 0.5s ease-in-out"},Ee=()=>{var e,t;if(console.log("vlocation",v),v&&v.length>0){let o={lat:(e=v[0])==null?void 0:e.latestDocument.lat,lng:(t=v[0])==null?void 0:t.latestDocument.lng};_(o),U(ue(15))}};return g.jsxs(g.Fragment,{children:[g.jsx(T,{sx:{position:"absolute",top:"780px",left:"250px",zIndex:1,background:Ae.bgColor,padding:"5px",borderRadius:"10px",color:"white"}}),g.jsxs(We,{id:"map",mapContainerStyle:je,zoom:F,center:q,onLoad:e=>{le.current=e},options:{styles:Y?W:""},children:[Object.keys(h).length>0&&g.jsx(yt,{setPlace:M,place:w}),C||x?g.jsx(T,{sx:{position:"absolute",top:"50%",left:"50%"},children:g.jsx(wt,{})}):O&&O.length>0&&O.map((e,t)=>{var o,n;return g.jsx(He,{position:{lat:parseFloat((o=e==null?void 0:e.location)==null?void 0:o.lat),lng:parseFloat((n=e==null?void 0:e.location)==null?void 0:n.lng)},animation:window.google.maps.Animation.DROP,icon:{path:ne[`${w}`],fillOpacity:2,strokeWeight:1,scale:1,fillColor:"orange"}},t)}),g.jsx(T,{sx:{display:"flex",justifyContent:"center",mt:"20px"},children:g.jsx(Re,{variant:"contained",onClick:Ee,children:" Go to vehicle location"})})]})]})}const xt="http://139.59.37.47:3031";function $t(){const{locationData:x}=B(d=>d.liveMap),{vehicleNo:S,token:q}=Le(),[_,V]=i.useState(!1),[h,K]=i.useState([]);B(d=>d.auth);const[F,ne]=i.useState(!1),[p,O]=i.useState(!1),[se,ae]=i.useState(!0),[re,C]=i.useState(!1),[Y,W]=i.useState({lat:21,lng:78});let y=fe();i.useEffect(()=>{y(Ne({}))},[]),i.useEffect(()=>{k()},[]);const P=async()=>{try{(await Fe.post(`${xt}/api/validate-token`,{token:q})).data.valid?V(!0):V(!1)}catch{V(!1)}};i.useEffect(()=>{P()},[]),i.useEffect(()=>{var d;if(S){console.log("locationdata342423",x);const w=(x==null?void 0:x.length)>0&&(x==null?void 0:x.filter(A=>Number(A.latestDocument.imei)===Number(S)));if((w==null?void 0:w.length)<=0){te.error("Data not available for this vehicle",{id:"clipboard"});return}const{lat:M,lng:v}=((d=w==null?void 0:w[0])==null?void 0:d.latestDocument)??{},m={lat:M||de.lat,lng:v||de.lat};W(m)}},[x]);const k=async()=>{try{C(!0);let d=[],w=[];if(!S)return;const M=await y(Be({imei:S}));if(Array.isArray(M.payload)){M.payload.forEach(a=>{var H,R,J,$;Array.isArray(a.imei)&&a.imei.length>0&&((H=a.imei[0])!=null&&H.mac_id)?(d.push({id:a.id,label:a.registration_id,value:(R=a.imei[0])==null?void 0:R.mac_id,vehilce_type:a==null?void 0:a.segment,chassis_no:a==null?void 0:a.chassis_no,engine_no:a==null?void 0:a.engine_no,workShop:a==null?void 0:a.workshop,registration_id:a==null?void 0:a.registration_id,sell_date:a==null?void 0:a.sell_date,customer_name:a==null?void 0:a.customer_name,vehicle_model:(J=a==null?void 0:a.vehicle_model)==null?void 0:J.name,vehicle_group:a==null?void 0:a.vehicle_group}),w.push(($=a.imei[0])==null?void 0:$.mac_id)):console.error("IMEI data not found for item:",a)});const v="one",m=w;w.length>0&&y(Te({type:v,imei:m}));let A=d.filter(a=>a.value==S);K(A),y(Ve(d)),C(!1)}else C(!1),console.error("Unexpected data format:",M),te.error("Unexpected data format:")}catch(d){console.error("Error fetching vehicle data:",d),te.error(`Error fetching vehicle data: ${d}`)}};return _?g.jsx("div",{className:"app",children:g.jsx("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:g.jsx(T,{style:{display:"flex",width:"100%",height:"95vh"},children:g.jsx(T,{style:{width:F||p?"80%":"100%"},children:g.jsx(kt,{showCard:se,loadingVehicle:re,vehicleData:h,center:Y,setCenter:W})})})})}):g.jsx("h3",{children:"Invalid or Expired Link"})}export{$t as default};
