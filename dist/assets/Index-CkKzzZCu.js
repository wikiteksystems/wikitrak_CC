import{z as B,b as i,R as Ee,y as ie,j as h,B as H,a0 as Ce,D as Pe,a5 as je,a6 as Ae,b_ as Re,Q as $e,C as te,b$ as Le,W as Ne,Y as Be,a7 as Te,a9 as ce}from"./index-Bnd8CDa6.js";import{u as Ve,G as Oe,M as Fe,m as W}from"./motorbike-DICHg5RN.js";import{M as We,r as He,g as Ue,y as ze,b as Ge,a as qe,c as Ke,d as Ye,e as Je,f as Qe,h as Xe,i as Ze,j as et,k as tt,l as ot,m as nt,n as st,o as at,p as rt,q as lt,s as ct,t as it,u as ut,v as dt,w as ft}from"./black_bike-DM11NcDH.js";import"./NewLoader-CVlTPCac.js";import{F as gt}from"./Loader-DLR2uDda.js";import{L as ht}from"./LiveMapServices-z5zyycST.js";import{s as oe}from"./Socket-0N_gnJcr.js";import{B as U,C as pt}from"./CircularProgress-DQ-JXarh.js";import"./index-DfSCV0bP.js";import"./createSvgIcon-0emflN8J.js";import"./useControlled-BuVu_fJ9.js";import"./Card-2tAMRyqG.js";import"./CardContent-C9fQuopg.js";const yt="AIzaSyD8TrUWS9FRTu-MRP339mJF_iWlORvEGUA";function wt({loadingVehicle:w,vehicleData:x}){const{center:z,selectedParameterList:ne,selectedVehicle:f,vehicleList:G,zoom:T,icons:q,locationData:p,placesData:P,imeiNumbers:ue,onlineVehicle:V,loading:de,services_loading:K}=B(e=>e.liveMap),{mode:j,styles:M,vehicles_details:v}=B(e=>e.dashboard),A=i.useRef(null);B(e=>e.auth);const[u,y]=i.useState(null),[D,R]=i.useState(""),[S,I]=i.useState([]),[a,Y]=i.useState(),[O,$]=i.useState(null);i.useState("");const[J,se]=i.useState();i.useState(!1);const[m,Q]=i.useState(null);Ee.useState(!1);const _=ie(),X={},L=i.useRef([]),ae=i.useRef(null),N=i.useRef({}),{isLoaded:Z,loadError:fe}=Ve({googleMapsApiKey:`${yt}`,loadingElement:h.jsx(gt,{})});i.useEffect(()=>{Z&&y(window.google.maps)},[Z]),i.useEffect(()=>{},[T]),i.useEffect(()=>{var e,t,o,n;if(Object.keys(f).length>0){const l=((m==null?void 0:m.length)>0?m:p).filter(r=>{var c;return((c=r==null?void 0:r.latestDocument)==null?void 0:c.imei)===(f==null?void 0:f.imei)});if(l.length>0){I(l);const r={lat:(t=(e=l[0])==null?void 0:e.latestDocument)==null?void 0:t.lat,lng:(n=(o=l[0])==null?void 0:o.latestDocument)==null?void 0:n.lng};_(H(r))}}},[p,f]),i.useEffect(()=>{if(!(Object.keys(f).length>0)){const e=p.filter(t=>x.some(o=>o.value===t.latestDocument.imei));I(e),Q(e)}},[p,f]),i.useEffect(()=>{var e,t,o,n;if(Object.keys(f).length>0){const l=((m==null?void 0:m.length)>0?m:p).filter(r=>{var c;return((c=r==null?void 0:r.latestDocument)==null?void 0:c.imei)===(f==null?void 0:f.imei)});if(l.length>0){I(l);const r={lat:(t=(e=l[0])==null?void 0:e.latestDocument)==null?void 0:t.lat,lng:(n=(o=l[0])==null?void 0:o.latestDocument)==null?void 0:n.lng};_(H(r))}}else{const s=p.filter(l=>x.some(r=>r.value===l.latestDocument.imei));I(s),Q(s)}},[p,f]),i.useEffect(()=>{_(Ce({}))},[]),i.useEffect(()=>{if(console.log("before: ",S),!u)return;const e=ae.current;let t=null;return(async()=>{console.log("after: ",S);const n=await ge(S,e);t&&t.clearMarkers(),t=ke(n,e),oe.on("locationinfo",s=>{console.log("locationinfo: ",s),xe(s,L),Q(l=>{const r=Array.isArray(l)?l:[],c=r.findIndex(d=>Number(d.latestDocument.imei)===Number(s.imei));if(c!==-1){const d=[...r];return d[c]={...d[c],latestDocument:{...d[c].latestDocument,...s}},d}else return[...r,{_id:s.imei,latestDocument:s}]})})})(),()=>{t&&t.clearMarkers(),Object.keys(N.current).forEach(n=>cancelAnimationFrame(N.current[n])),oe.off("locationinfo")}},[u,S,oe,a,L,p]);const ge=(e,t)=>e.map(o=>{const n=o.latestDocument.imei,s=L.current[n]||he(o,t);return L.current[n]&&pe(o,s),s}),he=(e,t)=>{const o=e.latestDocument.imei,n=new u.Marker({position:{lat:e.latestDocument.lat,lng:e.latestDocument.lng},map:t,icon:ee(e)});return n.addListener("click",()=>ve(e,n,t)),L.current[o]=n,n},pe=async(e,t)=>{var c;const o=t.getPosition(),n=((c=t.getIcon())==null?void 0:c.rotation)||0,s={lat:e.latestDocument.lat,lng:e.latestDocument.lng},l=e.latestDocument.heading||0;le(t,o,s,n,l);const r=await ee(e);t.setIcon(r)},ee=async e=>{var c,d,g,k,b;const t=(c=e==null?void 0:e.latestDocument)==null?void 0:c.imei,o=De(t),n=Ie(e==null?void 0:e.latestDocument,o),s=((d=e==null?void 0:e.latestDocument)==null?void 0:d.heading)||0;return re((g=e==null?void 0:e.latestDocument)==null?void 0:g.imei)&&ye((k=e==null?void 0:e.latestDocument)==null?void 0:k.imei),{url:await we(n,s),fillOpacity:2,strokeWeight:1,scale:4.5,rotation:(b=e==null?void 0:e.latestDocument)==null?void 0:b.heading,size:new u.Size(30,30),scaledSize:new u.Size(30,30)}},re=e=>(console.log("online vehicles",V),V.includes(Number(e))),ye=e=>p==null?void 0:p.some(t=>Number(t.latestDocument.imei)===Number(e)&&t.latestDocument.speed>0&&(t.latestDocument.ignition===!0||t.latestDocument.ignition===1)),we=(e,t,o,n=80)=>{const s=`${e}-${t}-${n}-${o}`;if(X[s])return Promise.resolve(X[s]);const l=document.createElement("canvas"),r=l.getContext("2d");l.width=n,l.height=n;const c=new Image;return c.src=e,new Promise(d=>{c.onload=()=>{if(r.clearRect(0,0,l.width,l.height),r.translate(n/2,n/2),r.rotate(t*Math.PI/180),r.translate(-n/2,-n/2),r.drawImage(c,0,0,n,n),o){const b=n-30-5,E=n-30-5;r.beginPath(),r.arc(b,E,30/2,0,Math.PI*2),r.fillStyle=o,r.fill()}const g=l.toDataURL("image/png");X[s]=g,d(g)},c.onerror=g=>{console.error("Error loading image for rotation:",g),d(e)}})},ve=(e,t,o)=>{me(e.latestDocument._id,e,t,o),Me(e.latestDocument.imei)},le=(e,t,o,n,s)=>{const r=performance.now(),c=()=>{const d=performance.now()-r,g=Math.min(d/500,1),k=t.lat()+g*(o.lat-t.lat()),b=t.lng()+g*(o.lng-t.lng()),E=(s-n+360)%360-180,F=(n+E*g+360)%360;e.setPosition({lat:k,lng:b});const C=e.getIcon();C&&typeof C=="object"&&e.setIcon({...C,rotation:F}),g<1?N.current[e.getPosition()]=requestAnimationFrame(c):(e.setPosition(o),C&&typeof C=="object"&&e.setIcon({...C,rotation:s}),delete N.current[e.getPosition()])};N.current[e.getPosition()]=requestAnimationFrame(c)},ke=(e,t)=>new We({map:t,markers:e,renderer:{render:({count:o,position:n})=>be(o,n)}}),be=(e,t)=>{const o=40+Math.min(e*2,40),n=30;let s;return e<10?s={start:"#76c7c0",end:"#34a853"}:e<50?s={start:"#fbbc05",end:"#f2994a"}:s={start:"#f45c42",end:"#d32f2f"},new u.Marker({position:t,icon:{url:`data:image/svg+xml,${encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="${o}" height="${o}" viewBox="0 0 100 100">
            <defs>
              <radialGradient id="gradient" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="${s.start}" />
                <stop offset="100%" stop-color="${s.end}" />
              </radialGradient>
              <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="rgba(0, 0, 0, 0.5)" />
              </filter>
            </defs>
            <!-- Outer Pulsating Ring -->
            <circle cx="50" cy="50" r="48" fill="url(#gradient)" filter="url(#shadow)" stroke="#ffffff" stroke-width="3" />
            <!-- Decorative Inner Ring -->
            <circle cx="50" cy="50" r="38" fill="none" stroke="#ffffff" stroke-width="2" stroke-dasharray="4 2" />
            <!-- Star Decoration -->
            <polygon points="50,15 54,38 70,38 57,50 62,68 50,57 38,68 43,50 30,38 46,38" fill="#ffffff" opacity="0.4" />
            <!-- Count Text -->
            <text x="50" y="55" font-size="${n}" fill="black" text-anchor="middle" font-family="'Courier New', monospace" font-weight="bold">
              ${e}
            </text>
          </svg>
        `)}`,scaledSize:new u.Size(o,o)},label:null})},xe=async(e,t,o)=>{var l;const n=e.imei,s=t.current[n];if(s){const r=s.getPosition(),c=((l=s.getIcon())==null?void 0:l.rotation)||0,d={lat:e.lat,lng:e.lng},g=e.heading||0;le(s,r,d,c,g);const k=await ee({latestDocument:e});s.setIcon(k)}},De=e=>{if(!e)return"motorBike";const t=Se(e);return t||console.error(`No vehicle type found for IMEI: ${e}, defaulting to motorBike`),t||"motorBike"},Se=e=>{if(!v||v.length===0)return console.error("vehicles_details is not available"),null;const t=v.find(o=>(o==null?void 0:o.value)===e&&(o==null?void 0:o.vehilce_type));return t||console.error(`No vehicle found for IMEI: ${e}`),t?t.vehilce_type:null},Ie=(e,t)=>{let{speed:o,ignition:n,imei:s}=e,l=re(s);const r={"2W":{red:He,green:Ue,yellow:ze,black:Ge},"3W":{red:qe,green:Ke,yellow:Ye,black:Je},"4W":{red:Qe,green:Xe,yellow:Ze,black:et},Tractor:{red:tt,green:ot,yellow:nt,black:st},Harvestor:{red:at,green:rt,yellow:lt,black:ct},BUS:{red:it,green:ut,yellow:dt,black:ft},default:{red:W,green:W,yellow:W,black:W}};let c=r[t]||r.default;if(!l)return c.black;if(l&&!n)return c.red;if(l&&n&&o>0)return c.green;if(l&&n&&o<=0)return c.yellow},me=(e,t,o,n)=>{var d,g,k;_(je(t.latestDocument.imei));const s={lat:(d=t==null?void 0:t.latestDocument)==null?void 0:d.lat,lng:(g=t==null?void 0:t.latestDocument)==null?void 0:g.lng};_(H(s)),_(Ae(15)),A.current||(A.current=new u.InfoWindow);const l=A.current,c=`
      <div>
        <h3>Registration No: ${((k=G.find(b=>{var E,F;return((E=b==null?void 0:b.imei[0])==null?void 0:E.mac_id)===((F=t==null?void 0:t.latestDocument)==null?void 0:F.imei)}))==null?void 0:k.registration_id)||""}</h3>
      </div>
    `;O===e?(l.close(),$(null)):(l.setContent(c),l.open(n,o),$(e))},Me=e=>{const t=v&&(v==null?void 0:v.length)>0&&v.find(o=>(o==null?void 0:o.value)===e&&o);se(t||null)};if(fe)return"Error loading maps";if(!Z)return"Loading maps";if(!u)return null;const _e={height:"100vh",width:"100%",transition:"transform 0.5s ease-in-out"};return h.jsxs(h.Fragment,{children:[h.jsx(U,{sx:{position:"absolute",top:"780px",left:"250px",zIndex:1,background:Pe.bgColor,padding:"5px",borderRadius:"10px",color:"white"}}),h.jsxs(Oe,{id:"map",mapContainerStyle:_e,zoom:T,center:z,onLoad:e=>{ae.current=e},options:{styles:j?M:""},children:[Object.keys(f).length>0&&h.jsx(ht,{setPlace:R,place:D}),K||w?h.jsx(U,{sx:{position:"absolute",top:"50%",left:"50%"},children:h.jsx(pt,{})}):P&&P.length>0&&P.map((e,t)=>{var o,n;return h.jsx(Fe,{position:{lat:parseFloat((o=e==null?void 0:e.location)==null?void 0:o.lat),lng:parseFloat((n=e==null?void 0:e.location)==null?void 0:n.lng)},animation:window.google.maps.Animation.DROP,icon:{path:q[`${D}`],fillOpacity:2,strokeWeight:1,scale:1,fillColor:"orange"}},t)})]})]})}const vt="http://139.59.37.47:3031";function At(){const{locationData:w}=B(u=>u.liveMap),{vehicleNo:x,token:z}=Re(),[ne,f]=i.useState(!1),[G,T]=i.useState([]);B(u=>u.auth);const[q,p]=i.useState(!1),[P,ue]=i.useState(!1),[V,de]=i.useState(!0),[K,j]=i.useState(!1);let M=ie();i.useEffect(()=>{M($e({}))},[]),i.useEffect(()=>{A()},[]);const v=async()=>{try{(await Te.post(`${vt}/api/validate-token`,{token:z})).data.valid?f(!0):f(!1)}catch{f(!1)}};i.useEffect(()=>{v()},[]),i.useEffect(()=>{var u;if(x){console.log("locationdata342423",w);const y=(w==null?void 0:w.length)>0&&(w==null?void 0:w.filter(I=>Number(I.latestDocument.imei)===Number(x)));if((y==null?void 0:y.length)<=0){te.error("Data not available for this vehicle",{id:"clipboard"});return}const{lat:D,lng:R}=((u=y==null?void 0:y[0])==null?void 0:u.latestDocument)??{},S={lat:D||ce.lat,lng:R||ce.lat};M(H(S))}},[w]);const A=async()=>{try{j(!0);let u=[],y=[];if(!x)return;const D=await M(Le({imei:x}));if(Array.isArray(D.payload)){D.payload.forEach(a=>{var Y,O,$,J;Array.isArray(a.imei)&&a.imei.length>0&&((Y=a.imei[0])!=null&&Y.mac_id)?(u.push({id:a.id,label:a.registration_id,value:(O=a.imei[0])==null?void 0:O.mac_id,vehilce_type:a==null?void 0:a.segment,chassis_no:a==null?void 0:a.chassis_no,engine_no:a==null?void 0:a.engine_no,workShop:a==null?void 0:a.workshop,registration_id:a==null?void 0:a.registration_id,sell_date:a==null?void 0:a.sell_date,customer_name:a==null?void 0:a.customer_name,vehicle_model:($=a==null?void 0:a.vehicle_model)==null?void 0:$.name,vehicle_group:a==null?void 0:a.vehicle_group}),y.push((J=a.imei[0])==null?void 0:J.mac_id)):console.error("IMEI data not found for item:",a)});const R="one",S=y;y.length>0&&M(Ne({type:R,imei:S}));let I=u.filter(a=>a.value==x);T(I),M(Be(u)),j(!1)}else j(!1),console.error("Unexpected data format:",D),te.error("Unexpected data format:")}catch(u){console.error("Error fetching vehicle data:",u),te.error(`Error fetching vehicle data: ${u}`)}};return ne?h.jsx("div",{className:"app",children:h.jsx("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:h.jsx(U,{style:{display:"flex",width:"100%",height:"95vh"},children:h.jsx(U,{style:{width:q||P?"80%":"100%"},children:h.jsx(wt,{showCard:V,loadingVehicle:K,vehicleData:G})})})})}):h.jsx("h3",{children:"Invalid or Expired Link"})}export{At as default};
