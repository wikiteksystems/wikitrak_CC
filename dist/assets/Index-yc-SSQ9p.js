import{a$ as V,b as i,R as Re,a_ as he,b0 as $e,j as h,fV as Be,bC as Le,bp as ee,aW as O,ba as Te,b3 as Ve,fW as Oe,bY as We,b4 as Fe,bc as Ne,fX as me,fx as He,fv as Ue,fY as ze,fZ as Ge,f_ as Ye,f$ as qe,g0 as Ke,g1 as Je,g2 as Xe,g3 as Ze,d8 as Qe,g4 as et,g5 as tt,g6 as nt,g7 as ot,g8 as st,g9 as at,ga as rt,gb as ct,gc as lt,gd as it,ge as ut,gf as dt,bl as ft,b7 as te,gg as gt,bx as ht,bz as pt,c4 as yt,bJ as ie}from"./index-HLSUgE-I.js";const ue="/assets/green_bike-qdoS7u1A.svg",de="/assets/red_bike-DD7SR04B.svg",fe="/assets/yellow_bike-D4yDBpYn.svg",ge="/assets/black_bike-CjClBA8k.svg",wt="AIzaSyD8TrUWS9FRTu-MRP339mJF_iWlORvEGUA";function kt({loadingVehicle:v,vehicleData:S,center:z,setCenter:E}){const{selectedParameterList:W,selectedVehicle:p,vehicleList:G,zoom:F,icons:ne,locationData:f,placesData:N,imeiNumbers:oe,onlineVehicle:se,loading:ae,services_loading:A}=V(e=>e.liveMap),{mode:Y,styles:m,vehicles_details:y}=V(e=>e.dashboard),P=i.useRef(null);V(e=>e.auth);const[k,u]=i.useState(null),[w,M]=i.useState(""),[D,I]=i.useState([]),[R,a]=i.useState(),[H,$]=i.useState(null);i.useState("");const[q,B]=i.useState();i.useState(!1);const[_,K]=i.useState(null);Re.useState(!1);const J=he(),X={},L=i.useRef([]),re=i.useRef(null),T=i.useRef({}),{isLoaded:Z,loadError:pe}=$e({googleMapsApiKey:`${wt}`,loadingElement:h.jsx(Be,{})});i.useEffect(()=>{Z&&u(window.google.maps)},[Z]),i.useEffect(()=>{},[F]),i.useEffect(()=>{var e,t,n,o;if(Object.keys(p).length>0){const s=(_==null?void 0:_.length)>0?_:f,r=s==null?void 0:s.filter(c=>{var l;return((l=c==null?void 0:c.latestDocument)==null?void 0:l.imei)===(p==null?void 0:p.imei)});if((r==null?void 0:r.length)>0){I(r);const c={lat:(t=(e=r[0])==null?void 0:e.latestDocument)==null?void 0:t.lat,lng:(o=(n=r[0])==null?void 0:n.latestDocument)==null?void 0:o.lng};E(c)}}},[f,p]),i.useEffect(()=>{if(!(Object.keys(p).length>0)){const e=f==null?void 0:f.filter(t=>S.some(n=>n.value===t.latestDocument.imei));I(e),K(e)}},[f,p]),i.useEffect(()=>{var e,t,n,o;if(Object.keys(p).length>0){const s=(_==null?void 0:_.length)>0?_:f,r=s==null?void 0:s.filter(c=>{var l;return((l=c==null?void 0:c.latestDocument)==null?void 0:l.imei)===(p==null?void 0:p.imei)});if((r==null?void 0:r.length)>0){I(r);const c={lat:(t=(e=r[0])==null?void 0:e.latestDocument)==null?void 0:t.lat,lng:(o=(n=r[0])==null?void 0:n.latestDocument)==null?void 0:o.lng};E(c)}}else{const s=f==null?void 0:f.filter(r=>S.some(c=>c.value===r.latestDocument.imei));I(s),K(s)}},[f,p]),i.useEffect(()=>{J(Le({}))},[]),i.useEffect(()=>{if(console.log("before: ",D),!k)return;const e=re.current;let t=null;return(async()=>{console.log("after: ",D);const o=await ye(D,e);t&&t.clearMarkers(),t=Se(o,e),ee.on("locationinfo",s=>{console.log("locationinfo: ",s),Ie(s,L),K(r=>{const c=Array.isArray(r)?r:[],l=c.findIndex(d=>String(d.latestDocument.imei)===String(s.imei));if(l!==-1){const d=[...c];return d[l]={...d[l],latestDocument:{...d[l].latestDocument,...s}},d}else return[...c,{_id:s.imei,latestDocument:s}]})})})(),()=>{t&&t.clearMarkers(),Object.keys(T.current).forEach(o=>cancelAnimationFrame(T.current[o])),ee.off("locationinfo")}},[k,D,ee,R,L,f]);const ye=(e,t)=>e.map(n=>{const o=n.latestDocument.imei,s=L.current[o]||we(n,t);return L.current[o]&&ke(n,s),s}),we=(e,t)=>{const n=e.latestDocument.imei,o=new k.Marker({position:{lat:e.latestDocument.lat,lng:e.latestDocument.lng},map:t,icon:Q(e)});return o.addListener("click",()=>xe(e,o,t)),L.current[n]=o,o},ke=async(e,t)=>{var l;const n=t.getPosition(),o=((l=t.getIcon())==null?void 0:l.rotation)||0,s={lat:e.latestDocument.lat,lng:e.latestDocument.lng},r=e.latestDocument.heading||0;le(t,n,s,o,r);const c=await Q(e);t.setIcon(c)},Q=async e=>{var l,d,g,b,x;const t=(l=e==null?void 0:e.latestDocument)==null?void 0:l.imei,n=_e(t),o=je(e==null?void 0:e.latestDocument,n),s=((d=e==null?void 0:e.latestDocument)==null?void 0:d.heading)||0;return ce((g=e==null?void 0:e.latestDocument)==null?void 0:g.imei)&&ve((b=e==null?void 0:e.latestDocument)==null?void 0:b.imei),{url:await be(o,s),fillOpacity:2,strokeWeight:1,scale:4.5,rotation:(x=e==null?void 0:e.latestDocument)==null?void 0:x.heading,size:new k.Size(30,30),scaledSize:new k.Size(30,30)}},ce=e=>se.includes(String(e)),ve=e=>f==null?void 0:f.some(t=>String(t.latestDocument.imei)===String(e)&&t.latestDocument.speed>0&&(t.latestDocument.ignition===!0||t.latestDocument.ignition===1)),be=(e,t,n,o=80)=>{const s=`${e}-${t}-${o}-${n}`;if(X[s])return Promise.resolve(X[s]);const r=document.createElement("canvas"),c=r.getContext("2d");r.width=o,r.height=o;const l=new Image;return l.src=e,new Promise(d=>{l.onload=()=>{if(c.clearRect(0,0,r.width,r.height),c.translate(o/2,o/2),c.rotate(t*Math.PI/180),c.translate(-o/2,-o/2),c.drawImage(l,0,0,o,o),n){const x=o-30-5,j=o-30-5;c.beginPath(),c.arc(x,j,30/2,0,Math.PI*2),c.fillStyle=n,c.fill()}const g=r.toDataURL("image/png");X[s]=g,d(g)},l.onerror=g=>{console.error("Error loading image for rotation:",g),d(e)}})},xe=(e,t,n)=>{Ce(e.latestDocument._id,e,t,n),Ee(e.latestDocument.imei)},le=(e,t,n,o,s)=>{const c=performance.now(),l=()=>{const d=performance.now()-c,g=Math.min(d/500,1),b=t.lat()+g*(n.lat-t.lat()),x=t.lng()+g*(n.lng-t.lng()),j=(s-o+360)%360-180,U=(o+j*g+360)%360;e.setPosition({lat:b,lng:x});const C=e.getIcon();C&&typeof C=="object"&&e.setIcon({...C,rotation:U}),g<1?T.current[e.getPosition()]=requestAnimationFrame(l):(e.setPosition(n),C&&typeof C=="object"&&e.setIcon({...C,rotation:s}),delete T.current[e.getPosition()])};T.current[e.getPosition()]=requestAnimationFrame(l)},Se=(e,t)=>new me({map:t,markers:e,renderer:{render:({count:n,position:o})=>De(n,o)}}),De=(e,t)=>{const n=40+Math.min(e*2,40),o=30;let s;return e<10?s={start:"#76c7c0",end:"#34a853"}:e<50?s={start:"#fbbc05",end:"#f2994a"}:s={start:"#f45c42",end:"#d32f2f"},new k.Marker({position:t,icon:{url:`data:image/svg+xml,${encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="${n}" height="${n}" viewBox="0 0 100 100">
            <defs>
              <radialGradient id="gradient" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="${s.start}" />
                <stop offset="100%" stop-color="${s.end}" />
              </radialGradient>
              <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="rgba(0, 0, 0, 0.5)" />
              </filter>
            </defs>
            <!-- Outer Pulsating Ring -->
            <circle cx="50" cy="50" r="48" fill="url(#gradient)" filter="url(#shadow)" stroke="#ffffff" stroke-width="3" />
            <!-- Decorative Inner Ring -->
            <circle cx="50" cy="50" r="38" fill="none" stroke="#ffffff" stroke-width="2" stroke-dasharray="4 2" />
            <!-- Star Decoration -->
            <polygon points="50,15 54,38 70,38 57,50 62,68 50,57 38,68 43,50 30,38 46,38" fill="#ffffff" opacity="0.4" />
            <!-- Count Text -->
            <text x="50" y="55" font-size="${o}" fill="black" text-anchor="middle" font-family="'Courier New', monospace" font-weight="bold">
              ${e}
            </text>
          </svg>
        `)}`,scaledSize:new k.Size(n,n)},label:null})},Ie=async(e,t,n)=>{var r;const o=e.imei,s=t.current[o];if(s){const c=s.getPosition(),l=((r=s.getIcon())==null?void 0:r.rotation)||0,d={lat:e.lat,lng:e.lng},g=e.heading||0;le(s,c,d,l,g);const b=await Q({latestDocument:e});s.setIcon(b)}},_e=e=>{if(!e)return"motorBike";const t=Me(e);return t||console.error(`No vehicle type found for IMEI: ${e}, defaulting to motorBike`),t||"motorBike"},Me=e=>{if(!y||y.length===0)return console.error("vehicles_details is not available"),null;const t=y.find(n=>(n==null?void 0:n.value)===e&&(n==null?void 0:n.vehilce_type));return t||console.error(`No vehicle found for IMEI: ${e}`),t?t.vehilce_type:null},je=(e,t)=>{let{speed:n,ignition:o,imei:s}=e,r=ce(s);const c={"2W":{red:de,green:ue,yellow:fe,black:ge},"3W":{red:ze,green:Ge,yellow:Ye,black:qe},"4W":{red:Ke,green:Je,yellow:Xe,black:Ze},Tractor:{red:Qe,green:et,yellow:tt,black:nt},Harvestor:{red:ot,green:st,yellow:at,black:rt},BUS:{red:ct,green:lt,yellow:it,black:ut},default:{red:de,green:ue,yellow:fe,black:ge}};let l=c[t]||c.default;if(!r)return l.black;if(r&&!o)return l.red;if(r&&o&&n>0)return l.green;if(r&&o&&n<=0)return l.yellow},Ce=(e,t,n,o)=>{var d,g,b;J(He(t.latestDocument.imei));const s={lat:(d=t==null?void 0:t.latestDocument)==null?void 0:d.lat,lng:(g=t==null?void 0:t.latestDocument)==null?void 0:g.lng};E(s),J(Ue(15)),P.current||(P.current=new k.InfoWindow);const r=P.current,l=`
      <div>
        <h3>Registration No: ${((b=G.find(x=>{var j,U;return((j=x==null?void 0:x.imei[0])==null?void 0:j.mac_id)===((U=t==null?void 0:t.latestDocument)==null?void 0:U.imei)}))==null?void 0:b.registration_id)||""}</h3>
      </div>
    `;H===e?(r.close(),$(null)):(r.setContent(l),r.open(o,n),$(e))},Ee=e=>{const t=y&&(y==null?void 0:y.length)>0&&y.find(n=>(n==null?void 0:n.value)===e&&n);B(t||null)};if(pe)return"Error loading maps";if(!Z)return"Loading maps";if(!k)return null;const Ae={height:"100vh",width:"100%",transition:"transform 0.5s ease-in-out"},Pe=()=>{window.location.reload()};return h.jsxs(h.Fragment,{children:[h.jsx(O,{sx:{position:"absolute",top:"780px",left:"250px",zIndex:1,background:Te.bgColor,padding:"5px",borderRadius:"10px",color:"white"}}),h.jsxs(Ve,{id:"map",mapContainerStyle:Ae,zoom:F,center:z,onLoad:e=>{re.current=e},options:{styles:Y?m:""},children:[Object.keys(p).length>0&&h.jsx(Oe,{setPlace:M,place:w}),A||v?h.jsx(O,{sx:{position:"absolute",top:"50%",left:"50%"},children:h.jsx(We,{})}):N&&N.length>0&&N.map((e,t)=>{var n,o;return h.jsx(Fe,{position:{lat:parseFloat((n=e==null?void 0:e.location)==null?void 0:n.lat),lng:parseFloat((o=e==null?void 0:e.location)==null?void 0:o.lng)},animation:window.google.maps.Animation.DROP,icon:{path:ne[`${w}`],fillOpacity:2,strokeWeight:1,scale:1,fillColor:"orange"}},t)}),h.jsx(O,{sx:{display:"flex",justifyContent:"center",mt:"20px"},children:h.jsx(Ne,{variant:"contained",onClick:Pe,children:" Go to vehicle location"})})]})]})}const vt="https://cc.wikitrak.in/proxy-3031";function xt(){const{locationData:v}=V(u=>u.liveMap),{vehicleNo:S,token:z}=dt(),[E,W]=i.useState(!1),[p,G]=i.useState([]);V(u=>u.auth);const[F,ne]=i.useState(!1),[f,N]=i.useState(!1),[oe,se]=i.useState(!0),[ae,A]=i.useState(!1),[Y,m]=i.useState({lat:21,lng:78});let y=he();i.useEffect(()=>{y(ft({}))},[]),i.useEffect(()=>{k()},[]);const P=async()=>{try{(await yt.post(`${vt}/api/validate-token`,{token:z})).data.valid?W(!0):W(!1)}catch{W(!1)}};i.useEffect(()=>{P()},[]),i.useEffect(()=>{var u;if(S){console.log("locationdata342423",v);const w=(v==null?void 0:v.length)>0&&(v==null?void 0:v.filter(R=>String(R.latestDocument.imei)===String(S)));if((w==null?void 0:w.length)<=0){te.error("Data not available for this vehicle",{id:"clipboard"});return}const{lat:M,lng:D}=((u=w==null?void 0:w[0])==null?void 0:u.latestDocument)??{},I={lat:M||ie.lat,lng:D||ie.lat};m(I)}},[v]);const k=async()=>{try{A(!0);let u=[],w=[];if(!S)return;const M=await y(gt({imei:S}));if(Array.isArray(M.payload)){M.payload.forEach(a=>{var H,$,q,B;Array.isArray(a.imei)&&a.imei.length>0&&((H=a.imei[0])!=null&&H.mac_id)?(u.push({id:a.id,label:a.registration_id,value:($=a.imei[0])==null?void 0:$.mac_id,vehilce_type:a==null?void 0:a.segment,chassis_no:a==null?void 0:a.chassis_no,engine_no:a==null?void 0:a.engine_no,workShop:a==null?void 0:a.workshop,registration_id:a==null?void 0:a.registration_id,sell_date:a==null?void 0:a.sell_date,customer_name:a==null?void 0:a.customer_name,vehicle_model:(q=a==null?void 0:a.vehicle_model)==null?void 0:q.name,vehicle_group:a==null?void 0:a.vehicle_group,segment:a==null?void 0:a.segment}),w.push((B=a.imei[0])==null?void 0:B.mac_id)):console.error("IMEI data not found for item:",a)});const D="one",I=w;w.length>0&&y(ht({type:D,imei:I}));let R=u==null?void 0:u.filter(a=>a.value==S);G(R),y(pt(u)),A(!1)}else A(!1),console.error("Unexpected data format:",M),te.error("Unexpected data format:")}catch(u){console.error("Error fetching vehicle data:",u),te.error(`Error fetching vehicle data: ${u}`)}};return E?h.jsx("div",{className:"app",children:h.jsx("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:h.jsx(O,{style:{display:"flex",width:"100%",height:"95vh"},children:h.jsx(O,{style:{width:F||f?"80%":"100%"},children:h.jsx(kt,{showCard:oe,loadingVehicle:ae,vehicleData:p,center:Y,setCenter:m})})})})}):h.jsx("h3",{children:"Invalid or Expired Link"})}export{xt as default};
