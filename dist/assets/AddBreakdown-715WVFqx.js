import{z as O,b as _,y as D,b3 as he,bC as xe,bD as ge,bE as fe,C as g,be as U,bh as ee,bi as V,a6 as be,j as e,T as H,G as L,bF as ve,ae as R,bs as te,E as Q,I as oe}from"./index-B36sJoZK.js";import{d as ie}from"./Close-C6oa8nkU.js";import{d as K}from"./Add-CXsDUoP4.js";import{a as ye,u as re,F as ae}from"./formik.esm-Cr26TiVS.js";import{c as J,a as c}from"./index.esm-Dd5xbjq8.js";import{B as F}from"./CircularProgress-yWj-JLbc.js";import{A as X}from"./Autocomplete-B0XjiLF_.js";import{T as d}from"./TextField-6cxVH9fy.js";import{S as je}from"./SearchInput-C4-015l1.js";import{N as le}from"./NewLoader-DnsIfqVJ.js";import{M as ne}from"./menu2-V1Z8FUVW.js";import{D as se,a as ce,b as de}from"./DialogTitle-B00TTLV2.js";function we(){var a,n;const{vehicles_details:x}=O(t=>t.dashboard),{w_customer_id:S}=O(t=>t.auth),{breakdownTopics:N,UpdatedBreakdownData:r}=O(t=>t.breakdown),u=JSON.parse(localStorage.getItem("w_userDetails")),[f,b]=_.useState(null),[v,k]=_.useState(""),[P,q]=_.useState(!1),[W,C]=_.useState(!1),[T,$]=_.useState("");let y=D();_.useEffect(()=>{r&&(b(r.attachment),k("edit"))},[r]);const o=ye({initialValues:{vehicle:((a=r==null?void 0:r.vehicle)==null?void 0:a.id)||"",breakdown_topic:((n=r==null?void 0:r.breakdown_topic)==null?void 0:n.id)||"",odometer_reading:(r==null?void 0:r.odometer_reading)||"",description:(r==null?void 0:r.description)||"",mob_no:(r==null?void 0:r.mob_no)||(u==null?void 0:u.mobile),email:(r==null?void 0:r.email)||(u==null?void 0:u.email),attachment:(r==null?void 0:r.attachment)||"",location:(r==null?void 0:r.location)||""},validationSchema:J({vehicle:c().required("Vehicle is required"),breakdown_topic:c().required("Breakdown Topic is required"),odometer_reading:c().required("Odometer Reading is required"),description:c().required("Description is required"),mob_no:c().matches(/^\d{10,11}$/,"Mobile number must be 10-11 digits").required("Mobile number is required"),email:c().email("Invalid email format").required("Email is required"),location:c().required("Location is required")}),onSubmit:async(t,{resetForm:i})=>{var s,h,j,B,M;try{q(!0),console.log("Submitted values:",t);const A=p(t.vehicle);t.user=A[0].user.id,t.status="Open",t.workshop_group=(j=(h=(s=A[0])==null?void 0:s.workShop)==null?void 0:h.group_name)==null?void 0:j.id,t.submission_date=new Date().toISOString();let w;if(r){typeof t.attachment=="string"&&(t.attachment=await he(t.attachment));const E=r.id;w=await y(xe({values:t,id:E}))}else w=await y(ge(t));if(w.payload.success){if(console.log(w.payload,"api response"),(B=w==null?void 0:w.payload)!=null&&B.data){let{vehicle:E,id:G,description:z,workshop_group:I,odometer_reading:Y,location:ue,user:me}=(M=w==null?void 0:w.payload)==null?void 0:M.data,pe={vehicle:E,breakdown:G,description:z,workshop_group:I,odometer_reading:Y,location:ue,submitted_by:me,status:"Open",issued_attachment:t==null?void 0:t.attachment,inspection_parts_inspection:null,type:"Breakdown"};await y(fe({values:pe}))}g.success("Breakdown submitted successfully!"),i(),k(""),b(null),y(U(null)),y(ee(!1)),y(V(!1)),y(be(S)),q(!1)}else throw q(!1),new Error(w.payload.error||"Failed to submit breakdown")}catch(A){console.error("Submission Error:",A),g.error("Failed to submit breakdown. Please try again.")}}}),m=async()=>{C(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition(async t=>{const{latitude:i,longitude:s}=t.coords;try{const h=await ve(i,s);o.setFieldValue("location",h)}catch(h){console.error("Error fetching address:",h),g.error("Failed to convert coordinates to address.")}finally{C(!1)}},t=>{console.error("Geolocation Error:",t),g.error("Failed to retrieve location. Please try again."),C(!1)}):(g.error("Geolocation is not supported by this browser."),C(!1))},p=t=>(x==null?void 0:x.length)>0&&x.filter(s=>s.id===t),l=t=>{const i=t.currentTarget.files[0];if(o.setFieldValue("attachment",i),k((i==null?void 0:i.name)||""),i&&i.type.startsWith("image/")){const s=new FileReader;s.onload=()=>b(s.result),s.readAsDataURL(i)}else b(null)};return e.jsx(F,{sx:{p:3,maxWidth:600,margin:"auto"},children:P?e.jsx(H,{children:"Submitted the form data..."}):e.jsx(e.Fragment,{children:e.jsxs("form",{onSubmit:o.handleSubmit,children:[e.jsx(X,{options:x,getOptionLabel:t=>t.registration_id,value:x.find(t=>t.id===o.values.vehicle)||null,onChange:(t,i)=>o.setFieldValue("vehicle",(i==null?void 0:i.id)||""),renderInput:t=>e.jsx(d,{...t,label:"Vehicle",error:o.touched.vehicle&&!!o.errors.vehicle,helperText:o.touched.vehicle&&o.errors.vehicle,fullWidth:!0})}),e.jsx(X,{options:N,getOptionLabel:t=>t.topic,value:N.find(t=>t.id===o.values.breakdown_topic)||null,onChange:(t,i)=>o.setFieldValue("breakdown_topic",(i==null?void 0:i.id)||""),renderOption:(t,i)=>_.createElement("li",{...t,key:i.id},i.topic),renderInput:t=>e.jsx(d,{...t,label:"Breakdown Topic",error:o.touched.breakdown_topic&&!!o.errors.breakdown_topic,helperText:o.touched.breakdown_topic&&o.errors.breakdown_topic,fullWidth:!0,sx:{mt:2}})}),e.jsx(d,{label:"Odometer Reading",name:"odometer_reading",value:o.values.odometer_reading,onChange:o.handleChange,onBlur:o.handleBlur,error:o.touched.odometer_reading&&!!o.errors.odometer_reading,helperText:o.touched.odometer_reading&&o.errors.odometer_reading,fullWidth:!0,sx:{mt:2}}),e.jsx(d,{label:"Description",name:"description",value:o.values.description,onChange:o.handleChange,onBlur:o.handleBlur,error:o.touched.description&&!!o.errors.description,helperText:o.touched.description&&o.errors.description,fullWidth:!0,sx:{mt:2}}),e.jsx(d,{label:"Mobile Number",name:"mob_no",value:o.values.mob_no,onChange:o.handleChange,onBlur:o.handleBlur,error:o.touched.mob_no&&!!o.errors.mob_no,helperText:o.touched.mob_no&&o.errors.mob_no,fullWidth:!0,sx:{mt:2},disabled:!0}),e.jsx(d,{label:"Email",name:"email",type:"email",value:o.values.email,onChange:o.handleChange,onBlur:o.handleBlur,error:o.touched.email&&!!o.errors.email,helperText:o.touched.email&&o.errors.email,fullWidth:!0,sx:{mt:2},disabled:!0}),e.jsx(d,{label:"Location",name:"location",value:T||o.values.location,onChange:t=>{$(t.target.value),o.setFieldValue("location",t.target.value)},onBlur:o.handleBlur,error:o.touched.location&&!!o.errors.location,helperText:o.touched.location&&o.errors.location,fullWidth:!0,sx:{mt:2}}),e.jsx(L,{variant:"outlined",onClick:m,disabled:W,sx:{mt:2},children:W?"Fetching Location...":"Use Current Location"}),e.jsxs(L,{component:"label",sx:{mt:2,border:"1px solid #f5f5f5",color:"black"},children:["Upload Attachment",e.jsx("input",{type:"file",hidden:!0,onChange:l})]}),v&&e.jsxs(H,{variant:"body2",sx:{mt:1},children:["Uploaded File: ",v]}),f&&e.jsx(F,{component:"img",src:f,alt:"Image Preview",sx:{mt:1,width:"100%",maxHeight:200}}),e.jsx(L,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,sx:{mt:3},children:"Submit"})]})})})}const Z="https://wikitek.io/api/v1",Ne=({setIsAdd:x,setIsUpdate:S})=>{const{vehicleList:N}=O(l=>l.liveMap),r=re("(min-width:600px)"),[u,f]=_.useState(!1),[b,v]=_.useState(!1),k=D(),P=l=>{v(!0);const{firstName:a,lastName:n,email:t,mobile:i,password:s,vehicleNo:h,location:j,model:B,description:M}=l;console.log("Form Submitted:",l);let A={first_name:a,last_name:n,email:t,mobile:i,password:s};try{R.post(`${Z}/users/new/user/register/`,A).then(E=>{var I;let G={ticket_id:"",user:(I=E==null?void 0:E.data)==null?void 0:I.id,status:"open",description:M,latlong:j,vehicle:h,model:B};R.post(`${Z}/tickets/create/ticket/`,G).then(Y=>{x(!1),S(!1),k(te()),v(!1),g.success("User registered and Ticket created successfully")}).catch(()=>{v(!1),g.error("Error occurred while creating ticket")})}).catch(E=>{v(!1),g.error("Error occurred while registering user")})}catch{v(!1),g.error("Error occurred while registering user")}},q=async l=>{f(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition(async a=>{const{latitude:n,longitude:t}=a.coords;try{l("location",`${n},${t}`)}catch(i){console.error("Error fetching address:",i),g.error("Failed to convert coordinates to address.")}finally{f(!1)}},a=>{console.error("Geolocation Error:",a),g.error("Failed to retrieve location. Please try again."),f(!1)}):(g.error("Geolocation is not supported by this browser."),f(!1))},W=/^((\+[1-9]{1,4}[ -]?)|(\([0-9]{2,3}\)[ -]?)|([0-9]{2,4})[ -]?)*?[0-9]{3,4}[ -]?[0-9]{3,4}$/,C=J().shape({firstName:c().required("required"),lastName:c().required("required"),fullName:c().required("required"),vehicleNo:c().required("required"),model:c().required("required"),email:c().email("invalid email").required("required"),mobile:c().matches(W,"Phone number is not valid").required("required"),location:c().required("required"),password:c().required("required"),description:c().required("required")}),T=JSON.parse(localStorage.getItem("w_userDetails")),{email:$,first_name:y,last_name:o,mobile:m}=T,p={firstName:y||"",lastName:o||"",fullName:`${y} ${o}`||"",vehicleNo:"",email:$||"",model:"",mobile:m||"",location:"",password:"",description:""};return e.jsxs(F,{m:"20px",children:[b&&e.jsx(le,{}),e.jsx(ae,{onSubmit:P,initialValues:p,validationSchema:C,children:({values:l,errors:a,touched:n,handleBlur:t,handleChange:i,handleSubmit:s,setFieldValue:h})=>e.jsxs("form",{onSubmit:s,children:[e.jsxs(F,{display:"grid",gap:"30px",gridTemplateColumns:"repeat(4, minmax(0, 1fr))",sx:{"& > div":{gridColumn:r?void 0:"span 4"}},children:[e.jsx(d,{fullWidth:!0,variant:"filled",type:"text",label:"First Name",onBlur:t,onChange:i,value:l.firstName,name:"firstName",error:!!n.firstName&&!!a.firstName,helperText:n.firstName&&a.firstName,sx:{gridColumn:"span 2"}}),e.jsx(d,{fullWidth:!0,variant:"filled",type:"text",label:"Last Name",onBlur:t,onChange:i,value:l.lastName,name:"lastName",error:!!n.lastName&&!!a.lastName,helperText:n.lastName&&a.lastName,sx:{gridColumn:"span 2"}}),e.jsx(d,{fullWidth:!0,variant:"filled",type:"text",label:"Full Name",onBlur:t,onChange:i,value:l.fullName,name:"fullName",error:!!n.fullName&&!!a.fullName,helperText:n.fullName&&a.fullName,sx:{gridColumn:"span 2"}}),e.jsx(d,{fullWidth:!0,select:!0,variant:"filled",label:"Vehicle No",onBlur:t,onChange:j=>{const B=N.find(M=>M.registration_id===j.target.value);h("vehicleNo",j.target.value),h("model",(B==null?void 0:B.vehicle_model.name)||"")},value:l.vehicleNo,name:"vehicleNo",error:!!n.vehicleNo&&!!a.vehicleNo,helperText:n.vehicleNo&&a.vehicleNo,sx:{gridColumn:"span 2"},MenuProps:{PaperProps:{style:{maxHeight:200,overflowY:"auto"}}},children:N.map(j=>e.jsx(ne,{value:j.registration_id,children:j.registration_id},j.id))}),e.jsx(d,{fullWidth:!0,variant:"filled",type:"text",label:"Email",onBlur:t,onChange:i,value:l.email,name:"email",error:!!n.email&&!!a.email,helperText:n.email&&a.email,sx:{gridColumn:"span 2"}}),e.jsx(d,{fullWidth:!0,variant:"filled",type:"text",label:"Model",value:l==null?void 0:l.model,name:"model",disabled:!0,sx:{gridColumn:"span 2"}}),e.jsx(d,{fullWidth:!0,variant:"filled",type:"text",label:"Mobile",onBlur:t,onChange:i,value:l.mobile,name:"mobile",error:!!n.mobile&&!!a.mobile,helperText:n.mobile&&a.mobile,sx:{gridColumn:"span 2"}}),e.jsx(d,{fullWidth:!0,variant:"filled",type:"password",label:"Password",onBlur:t,onChange:i,value:l.password,name:"password",error:!!n.password&&!!a.password,helperText:n.password&&a.password,sx:{gridColumn:"span 2"}}),e.jsx(d,{fullWidth:!0,variant:"filled",type:"text",label:"Location",onBlur:t,onChange:i,value:l.location,name:"location",disabled:!0,error:!!n.location&&!!a.location,helperText:n.location&&a.location,sx:{gridColumn:"span 2"}}),e.jsx(d,{fullWidth:!0,variant:"filled",type:"text",label:"Description",onBlur:t,onChange:i,value:l.description,name:"description",error:!!n.description&&!!a.description,helperText:n.description&&a.description,sx:{gridColumn:"span 2"}}),e.jsx(L,{variant:"outlined",onClick:()=>q(h),disabled:u,sx:{mt:-2,width:"300px"},children:u?"Fetching Location...":"Use Current Location"})]}),e.jsx(F,{display:"flex",justifyContent:"center",mt:"25px",children:e.jsx(L,{type:"submit",color:"secondary",variant:"contained",children:"Submit"})})]})})]})},ke="https://wikitek.io/api/v1",Ce=({userId:x,setIsAdd:S,setIsUpdate:N})=>{const r=D(),{vehicleList:u}=O(m=>m.liveMap),f=re("(min-width:600px)"),[b,v]=_.useState(!1),k=m=>{const{description:p,vehicleNo:l,model:a,location:n}=m;let t={ticket_id:"",user:x,status:"open",description:p,latlong:n,vehicle:l,model:a};localStorage.getItem("w_userToken");try{R.post(`${ke}/tickets/create/ticket/`,t).then(s=>{N(!1),S(!1),r(te()),g.success("Ticket created successfully")})}catch{g.error("Error occurred while creating ticket")}},P=async m=>{v(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition(async p=>{const{latitude:l,longitude:a}=p.coords;try{m("location",`${l},${a}`)}catch(n){console.error("Error fetching address:",n),g.error("Failed to convert coordinates to address.")}finally{v(!1)}},p=>{console.error("Geolocation Error:",p),g.error("Failed to retrieve location. Please try again."),v(!1)}):(g.error("Geolocation is not supported by this browser."),v(!1))},q=J().shape({fullName:c().required("required"),vehicleNo:c().required("required"),model:c().required("required"),location:c().required("required"),description:c().required("required")}),W=JSON.parse(localStorage.getItem("w_userDetails")),{email:C,first_name:T,last_name:$,mobile:y}=W,o={fullName:`${T} ${$}`||"",vehicleNo:"",model:"",location:"",description:""};return e.jsx(F,{m:"20px",children:e.jsx(ae,{onSubmit:k,initialValues:o,validationSchema:q,children:({values:m,errors:p,touched:l,handleBlur:a,handleChange:n,handleSubmit:t,setFieldValue:i})=>e.jsxs("form",{onSubmit:t,children:[e.jsxs(F,{display:"grid",gap:"30px",gridTemplateColumns:"repeat(4, minmax(0, 1fr))",sx:{"& > div":{gridColumn:f?void 0:"span 4"}},children:[e.jsx(d,{fullWidth:!0,variant:"filled",type:"text",label:"Full Name",onBlur:a,onChange:n,value:m.fullName,name:"fullName",disabled:!0,error:!!l.fullName&&!!p.fullName,helperText:l.fullName&&p.fullName,sx:{gridColumn:"span 4"}}),e.jsx(d,{fullWidth:!0,select:!0,variant:"filled",label:"Vehicle No",onBlur:a,onChange:s=>{const h=u.find(j=>j.registration_id===s.target.value);i("vehicleNo",s.target.value),i("model",(h==null?void 0:h.vehicle_model.name)||"")},value:m.vehicleNo,name:"vehicleNo",error:!!l.vehicleNo&&!!p.vehicleNo,helperText:l.vehicleNo&&p.vehicleNo,sx:{gridColumn:"span 4"},SelectProps:{MenuProps:{PaperProps:{sx:{maxHeight:250,overflowY:"auto"}}}},children:u.map(s=>e.jsx(ne,{value:s.registration_id,children:s.registration_id},s.id))}),e.jsx(d,{fullWidth:!0,variant:"filled",type:"text",label:"Model",value:m.model,name:"model",disabled:!0,sx:{gridColumn:"span 4"}}),e.jsx(d,{fullWidth:!0,variant:"filled",type:"text",label:"Description",onBlur:a,onChange:n,value:m.description,name:"description",error:!!l.description&&!!p.description,helperText:l.description&&p.description,sx:{gridColumn:"span 4"}}),e.jsx(d,{fullWidth:!0,variant:"filled",type:"text",label:"Location",onBlur:a,onChange:n,value:m.location,name:"location",disabled:!0,error:!!l.location&&!!p.location,helperText:l.location&&p.location,sx:{gridColumn:"span 4"}}),e.jsx(L,{variant:"outlined",onClick:()=>P(i),disabled:b,sx:{mt:-2,width:"300px"},children:b?"Fetching Location...":"Use Current Location"})]}),e.jsx(F,{display:"flex",justifyContent:"center",mt:"25px",children:e.jsx(L,{type:"submit",sx:{backgroundColor:"#8DA6C6DD"},variant:"contained",children:"Submit"})})]})})})},_e="https://wikitek.io/api/v1";function Ie({where:x,isAdd:S,isUpdate:N,setIsUpdate:r,setIsAdd:u}){const{isAddBreakdown:f,isUpdateBreakdown:b,UpdatedBreakdownData:v}=O(m=>m.breakdown);let k=D();const[P,q]=_.useState(null),[W,C]=_.useState(!1),T=()=>{k(V(!1)),k(ee(!1)),k(U(null)),u(!1),r(!1)},$=()=>{k(V(!f))},y=async()=>{var a,n;C(!0);const m=JSON.parse(localStorage.getItem("w_userDetails")),{email:p}=m;let l={email:p};try{R.post(`${_e}/users/check/user`,l).then(i=>{var s,h;(s=i==null?void 0:i.data)!=null&&s.success?(q((h=i==null?void 0:i.data)==null?void 0:h.user_id),r(!0),u(!0)):q(null),C(!1)}).catch(i=>{r(!1),u(!0),C(!1),console.log("error",i)})}catch(t){console.log("eror",t),u(!0),r(!1),C(!1),(n=(a=t==null?void 0:t.response)==null?void 0:a.data)!=null&&n.success}},o={fontSize:"18px",fontWeight:500,lineHeight:"18.38px",textAlign:"center",paddingTop:"5px",fontFamily:"ubuntu"};return e.jsxs(F,{sx:{bgcolor:"white",m:"10px",display:"flex",textAlign:"left",justifyContent:"space-between",alignItems:"center",borderRadius:"6px",padding:"20px"},children:[W&&e.jsx(le,{}),e.jsx(H,{variant:"h6",sx:o,children:`${x} New Requests`}),e.jsx(je,{}),x.toLowerCase()==="breakdown"&&e.jsxs(L,{onClick:$,sx:{color:"black",background:Q.bgColor},children:[e.jsx(K,{}),x]}),x.toLowerCase()==="rsa"&&e.jsxs(L,{onClick:y,sx:{color:"black",background:Q.bgColor},children:[e.jsx(K,{}),"Raise ticket"]}),e.jsxs(se,{open:f||b,onClose:T,maxWidth:"md",fullWidth:!0,children:[e.jsxs(ce,{children:[b?"Update":"Add"," Breakdown",e.jsx(oe,{"aria-label":"close",onClick:T,sx:{position:"absolute",right:8,top:8,color:m=>m.palette.grey[500]},children:e.jsx(ie,{})})]}),e.jsx(de,{children:e.jsx(we,{})})]}),e.jsx(Se,{isAdd:S,isUpdate:N,setIsUpdate:r,setIsAdd:u,handleClose:T,userId:P})]})}const Se=({isAdd:x,isUpdate:S,handleClose:N,userId:r,setIsAdd:u,setIsUpdate:f})=>(console.log("idupdate",S,x),e.jsxs(se,{open:x,onClose:N,maxWidth:"md",fullWidth:!0,children:[e.jsxs(ce,{children:[S?"Ticket For RSA":"Registration form for RSA",e.jsx(oe,{"aria-label":"close",onClick:N,sx:{position:"absolute",right:8,top:8,color:b=>b.palette.grey[500]},children:e.jsx(ie,{})})]}),e.jsx(de,{children:S?e.jsx(Ce,{userId:r,setIsUpdate:f,setIsAdd:u,children:" "}):e.jsx(Ne,{setIsUpdate:f,setIsAdd:u})})]}));export{Ie as A};
