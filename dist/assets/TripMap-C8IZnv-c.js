import{b as a,z as I,j as s,y as ce,D as ge,F as G,aO as ke,aj as W,C as R,bp as Fe,af as Re,bq as Te,U as Oe,aN as Le}from"./index-CmWSrtPV.js";import{a as re,b as U,u as ze,G as Ve,D as He,I as _e}from"./esm-zJWR5_rk.js";import{d as Ye}from"./dayjs.min-DDD_9kiF.js";import{r as Be}from"./redTractor-NXgVJyvR.js";import{T as De,g as Ge}from"./TripVehicleInfo-DtZj0sJ0.js";import{B as q,C as Ue}from"./CircularProgress-DzH6_aEN.js";import{d as We}from"./Info-DI3WUkmB.js";function Ne({trip:o,tripPlay:r,setTripPlay:g,setSpeed:d}){const[c,m]=a.useState([]),[n,i]=a.useState(0),[S,p]=a.useState([]),[y,e]=a.useState([null]),C=a.useRef(null),{selectedVehicle:M}=I(h=>h.liveMap),{vehicles_details:E}=I(h=>h.dashboard),[f,P]=a.useState("2W");a.useEffect(()=>{e([null]);const h=[];if(o&&o.length>0&&(o==null||o.forEach(w=>{h.push(w.speed.toFixed(2))}),p(h)),o&&o.length>0){const w=o.map(j=>({lat:parseFloat(j.lat),lng:parseFloat(j.lng)}));m(w),e(w.slice(0))}},[o]),a.useEffect(()=>{if(r){const h=c.length,w=29e3,j=1e4,_=performance.now();let A=0;const k=Y=>{const L=Y-_,z=Math.max(0,Math.min(L/w,1)),F=Math.min(Math.floor(z*h),h-1);F!==C.current&&(i(F),d(S[F]),C.current=F),A<j&&(requestAnimationFrame(k),A++)};return requestAnimationFrame(k),()=>{}}},[r,c,S]);const T=h=>{const w=E&&E.length>0&&E.find(j=>j.value===h&&j.vehilce_type);return w?w.vehilce_type:null};a.useEffect(()=>{if(Object.keys(M).length>0){const h=T(M.imei);P(h)}},[M]);const O=a.useMemo(()=>{var h,w;return{lat:parseFloat((h=c[n])==null?void 0:h.lat),lng:parseFloat((w=c[n])==null?void 0:w.lng)}},[c,n]),N=a.useMemo(()=>({url:Be,size:new window.google.maps.Size(30,30),scaledSize:new window.google.maps.Size(30,30),fillOpacity:2,strokeWeight:1,scale:2}),[f]);return s.jsxs("div",{children:[y.length>0&&s.jsx(s.Fragment,{children:s.jsx(re,{path:y,options:{strokeColor:"red",strokeOpacity:1,strokeWeight:4}})}),r&&s.jsxs(s.Fragment,{children:[s.jsx(re,{path:c.slice(0,n+1),options:{strokeColor:"green",strokeOpacity:1,strokeWeight:4,zIndex:1e3,geodesic:!0}}),s.jsx(U,{position:O,icon:N},n)]})]})}function qe({tripPlay:o,speed:r,totalDistance:g,Acreage:d,filterCoordinates:c,acreageTrips:m,handleTrip:n,showGraph:i,handleShowGraph:S}){const{selectedTripData:p}=I(C=>C.dashboard);let y=ce();const e=()=>{var C,M,E;if(console.log("selected trip data",(C=p[0])==null?void 0:C.venderId,m),p.length>0)if(((M=p[0])==null?void 0:M.venderId)==="VT200"||((E=p[0])==null?void 0:E.venderId)==="wtkpltf001")if(Object.keys(m).length>0){let f=0;Object.keys(m).map(P=>{let T=ke(m[P]);f+=T}),console.log("final acerage",f),y(W(f))}else R.error("No acreage trip found");else c(p,y)};return s.jsxs(q,{sx:{bgcolor:ge.bgColor,position:"relative",color:"white",display:"flex",alignItems:"center",overflowX:"hidden",flexWrap:"wrap",border:"1px solid white",gap:"5px",paddingLeft:"5px",padding:"10px 10px"},children:[s.jsxs(G,{sx:{background:"white",border:"1px solid white",borderRadius:"5px",padding:"5px 20px",color:"black"},onClick:e,children:[" ","Calculate Acerage"]}),s.jsxs(G,{sx:{background:o?"transparent":"white",border:"1px solid white",borderRadius:"5px",height:"38px",padding:"5px 20px",color:o?"white":"black","&:hover":{background:"transparent",color:"white"}},onClick:()=>{n()},children:[o?"Pause":"Play","-Trip"]}),s.jsxs(G,{style:{height:"38px",padding:"5px 20px"},sx:{background:i?"transparent":"white",border:"1px solid white",borderRadius:"5px",color:i?"white":"black","&:hover":{background:"transparent",color:"white"}},onClick:()=>{S()},children:[i?"Hide":"Show","-Graph"]})]})}const Ke="/assets/endTrip-CEqIwvWS.png",Je="/assets/endTrip_-BsrUUtoJ.png",Xe="/assets/startTrip-CGKteKGr.png",$e=(o,r)=>{const c=[];o.length>0&&o.forEach(n=>{let i={latitude:n.lat,longitude:n.lng},S=[];o.forEach(p=>{const y={latitude:p.lat,longitude:p.lng};if(y.latitude&&y.longitude&&y.latitude!==i.latitude&&y.longitude!==i.longitude){const e=Ze(n.lat,n.lng,p.lat,p.lng);e<20&&e>10&&S.push(p)}}),S.length>10&&c.push(n)});const m=o.filter(n=>n.lat!==void 0&&n.lng!==void 0).map(n=>({lat:parseFloat(n.lat),lng:parseFloat(n.lng)}));if(m.length>0){r(Te(c));try{const n=Qe(m),i=et(n),S=new window.google.maps.Polygon({paths:i});return tt(S,r)}catch(n){return console.error("Error calculating convex hull or area:",n),r(W(0)),0}}else return r(W(0)),0},Qe=o=>{const r=(n,i,S)=>{const p=(i.lat-n.lat)*(S.lng-i.lng)-(i.lng-n.lng)*(S.lat-i.lat);return p===0?0:p>0?1:2},g=o.reduce((n,i)=>i.lng<n.lng?i:n);let d=[],c=g,m;do{d.push(c),m=o[0]===c?o[1]:o[0];for(let n=0;n<o.length;n++)r(c,m,o[n])===2&&(m=o[n]);c=m}while(c!==g);return d};function Ze(o,r,g,d){const m=o*Math.PI/180,n=g*Math.PI/180,i=(g-o)*Math.PI/180,S=(d-r)*Math.PI/180,p=Math.sin(i/2)*Math.sin(i/2)+Math.cos(m)*Math.cos(n)*Math.sin(S/2)*Math.sin(S/2);return 6371e3*(2*Math.atan2(Math.sqrt(p),Math.sqrt(1-p)))}const et=o=>{o.sort((d,c)=>d.lng-c.lng||d.lat-c.lat);const r=[],g=[];for(const d of o){for(;r.length>=2&&ie(r[r.length-2],r[r.length-1],d)<=0;)r.pop();r.push(d)}for(let d=o.length-1;d>=0;d--){const c=o[d];for(;g.length>=2&&ie(g[g.length-2],g[g.length-1],c)<=0;)g.pop();g.push(c)}return[...r.slice(0,-1),...g.slice(0,-1)]},tt=(o,r)=>{if(!window.google||!window.google.maps.geometry){console.log("not loaded");return}const d=window.google.maps.geometry.spherical.computeArea(o.getPath())/4046.86;return r(W(d)),d},ie=(o,r,g)=>(r.lat-o.lat)*(g.lng-o.lng)-(r.lng-o.lng)*(g.lat-o.lat),ot=({selectedTrip:o,center:r,showCard:g})=>{var te,oe,ne,se,ae,le;const d=ce(),{isLoaded:c,loadError:m}=ze({googleMapsApiKey:"AIzaSyD8TrUWS9FRTu-MRP339mJF_iWlORvEGUA",libraries:["drawing","geometry"]}),{Acreage:n}=I(t=>t.tripMonitor),{selectedVehicle:i}=I(t=>t.liveMap),{singleTrip_Data:S,tripLoading:p,cords:y}=I(t=>t.tripMonitor),{selectedTripData:e,mode:C,styles:M}=I(t=>t.dashboard),{collapsed:E}=I(t=>t.auth),[f,P]=a.useState(null),T=a.useRef(null),[O,N]=a.useState(null),[h,w]=a.useState(null),[j,_]=a.useState([]);a.useState([]);const[A,k]=a.useState(!1),[Y,L]=a.useState(0),[z,F]=a.useState(!1),[K,de]=a.useState(0);a.useState([]),a.useState([]);const[B,J]=a.useState(!1),[pe,he]=a.useState({}),[D,X]=a.useState([]),[$,V]=a.useState(null),[ue,Q]=a.useState(null),[fe,me]=a.useState({});a.useEffect(()=>{J(!0)},[i]),a.useEffect(()=>{(async()=>{if(i!=null&&i.imei){const l=Ye(),x=l.startOf("day").format("MM/DD/YYYY HH:mm:ss"),u=l.endOf("day").format("MM/DD/YYYY HH:mm:ss"),b={imei:[i.imei],startDate:x,endDate:u};try{const v=await Oe(b);he(v.data[0].data)}catch(v){console.error("Error fetching report:",v)}}})()},[i,d]),a.useEffect(()=>{O&&h&&O.fitBounds(h)},[O,h,e]);let xe=t=>{let l=Le(t),x={};l.map((u,b)=>{let v=t.slice(u.start,u.end+1);x[b]=v}),me(x)};a.useEffect(()=>{if(console.log("selectedTripData",e),(e==null?void 0:e.length)>0){let t=e.map(x=>({lat:x.lat,lng:x.lng}));console.log("selected trip coordinate ",t);const l=Se({selectedTripData:e});de(l),xe(e)}},[e]);const Se=({selectedTripData:t})=>{const l=t.reduce((x,u,b)=>{if(b===0)return x;const v=t[b-1],H=Fe(v.lat,v.lng,u.lat,u.lng);return x+H},0);return l==null?void 0:l.toFixed(2)};a.useEffect(()=>{var t,l,x,u,b;if(e&&(e==null?void 0:e.length)>0){const v=new window.google.maps.LatLngBounds,H=new window.google.maps.LatLng(parseFloat((t=e[0])==null?void 0:t.lat),parseFloat((l=e[0])==null?void 0:l.lng)),Ae=new window.google.maps.LatLng(parseFloat((x=e[(e==null?void 0:e.length)-1])==null?void 0:x.lat),parseFloat((u=e[(e==null?void 0:e.length)-1])==null?void 0:u.lng));v.extend(H),v.extend(Ae),L((b=e[0])==null?void 0:b.speed),w(v)}k(!1),we()},[e]);const we=()=>{if(e&&e.length>0){const t=(u,b)=>{const H=new Date(u.createdAt).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0});return{Date:u.createdAt.substring(0,10),Time:H,value:u[b]}},x=["speed","mainInputVoltage","ignition"].map(u=>({label:u==="speed"?"Speed":u==="mainInputVoltage"?"MainInputVoltage":"Ignition",randomColor:be(),data:e.map(b=>t(b,u))}));_(x)}else _([])},be=()=>"#"+Math.floor(Math.random()*16777215).toString(16),ve=()=>{var t;if((e==null?void 0:e.length)>0)k(!A),L(0);else return((t=Object.keys(e))==null?void 0:t.length)===0?R.error("Please Select Vehicle",{id:"vehicle"}):R.error("Please Select Trip",{id:"trip error"})},ye=()=>{var t;if((e==null?void 0:e.length)>0)F(!z);else return((t=Object.keys(e))==null?void 0:t.length)===0?R.error("Please Select Vehicle",{id:"vehicle"}):R.error("Please Select Trip",{id:"trip error"})},Z=()=>{Object.keys(i).length>0||B?J(!B):R.error("Please select any vehicle")};if(m)return"Error loading maps";if(!c)return"Loading maps";const je={width:"100%",height:g?"87vh":"93vh"},Ce=t=>{if(t.type==="polygon"){const l=t.overlay;l.setEditable(!0),X(x=>[...x,l]),V(l),google.maps.event.addListener(l.getPath(),"set_at",()=>V(l)),google.maps.event.addListener(l.getPath(),"insert_at",()=>V(l)),google.maps.event.addListener(l.getPath(),"remove_at",()=>V(l)),ee(l)}},ee=t=>{if(!t)return;const l=t.getPath().getArray(),u=(google.maps.geometry.spherical.computeArea(l)/4046.86).toFixed(2);Q(u)},Me=()=>{D.forEach(t=>t.setMap(null)),X([]),Q(null),V(null)},Ee=()=>{D.forEach(t=>t.setEditable(!0))},Pe=()=>{D.forEach(t=>t.setEditable(!1))},Ie=()=>{$?ee($):alert("No shape is selected. Please draw or select a shape.")};return s.jsxs(s.Fragment,{children:[p&&s.jsx(q,{sx:{position:"absolute",top:"50vh",left:"50%",zIndex:"1000"},children:s.jsx(Ue,{})}),g&&s.jsx(qe,{tripPlay:A,speed:Y,totalDistance:K,Acreage:n,filterCoordinates:$e,acreageTrips:fe,handleTrip:ve,showGraph:z,handleShowGraph:ye}),s.jsx(q,{sx:{position:"absolute",top:"795px",left:E?"74px":"250px",zIndex:1,background:ge.bgColor,padding:"5px",borderRadius:"10px",color:"white"},children:s.jsxs(G,{sx:{color:"white"},onClick:Z,children:[B?"Hide":"Show"," Vehicle Info",s.jsx(We,{})]})}),B===!0&&s.jsx(De,{handleVehicleInfo:Z,vehicleReport:pe,tripPlay:A,speed:Y,totalDistance:K,Acreage:n,whereToUse:"TripMonitor"}),s.jsxs(Ve,{ref:T,mapContainerStyle:je,zoom:10,center:r,onLoad:t=>N(t),options:{styles:C?M:""},children:[s.jsx(He,{onOverlayComplete:Ce,options:{drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:["polygon"]}}}),s.jsxs("div",{style:{position:"absolute",bottom:80,left:20,background:"white",padding:"10px",borderRadius:"8px",boxShadow:"0 0 6px rgba(0,0,0,0.2)",zIndex:100,width:"auto"},children:[s.jsxs("p",{children:["Area: ",ue||0," acres"]}),D.length>0&&s.jsxs(s.Fragment,{children:[s.jsx("button",{onClick:Ee,style:{marginTop:"10px",marginRight:"10px"},children:"Enable Editing"}),s.jsx("button",{onClick:Pe,style:{marginTop:"10px",marginRight:"10px"},children:"Disable Editing"}),s.jsx("button",{onClick:Ie,style:{marginTop:"10px",marginRight:"10px"},children:"Calculate Area"}),s.jsx("button",{onClick:Me,style:{marginTop:"10px"},children:"Clear All Shapes"})]})]}),e&&(e==null?void 0:e.length)>0&&s.jsx(U,{onClick:()=>P(e[0]),position:{lat:parseFloat((te=e[0])==null?void 0:te.lat)+1e-6,lng:parseFloat((oe=e[0])==null?void 0:oe.lng)+1e-6},animation:"BOUNCE",icon:{url:Xe,scaledSize:new google.maps.Size(60,60)}}),e&&(e==null?void 0:e.length)>0&&s.jsx(U,{onClick:()=>P(e[(e==null?void 0:e.length)-1]),position:{lat:parseFloat(((ne=e[(e==null?void 0:e.length)-1])==null?void 0:ne.lat)+1e-5),lng:parseFloat(((se=e[(e==null?void 0:e.length)-1])==null?void 0:se.lng)+1e-6)},animation:"BOUNCE",icon:{url:Je,scaledSize:new google.maps.Size(60,60)}}),e&&e.length>0&&e.filter(t=>!t.ignition).map((t,l)=>(console.log("index",l),s.jsx(U,{position:{lat:parseFloat(t==null?void 0:t.lat),lng:parseFloat(t==null?void 0:t.lng)},onClick:()=>P(t),label:{text:(l+1).toString(),color:"white",fontWeight:"bold",fontSize:"14px"},animation:"BOUNCE",icon:{url:Ke,scaledSize:new google.maps.Size(40,40)}},l))),f&&s.jsx(_e,{position:{lat:parseFloat(f==null?void 0:f.lat),lng:parseFloat(f==null?void 0:f.lng)},onCloseClick:()=>P(null),children:s.jsxs("div",{children:["Date-time:",f!=null&&f.Date?Re(new Date(f==null?void 0:f.Date)).format("DD-MM-YYYY HH:mm"):""]})}),e&&(e==null?void 0:e.length)>0&&s.jsx(Ne,{trip:e,tripPlay:A,setTripPlay:k,setSpeed:L}),s.jsx("div",{style:{position:"relative",top:200,left:12,color:"green"},children:((le=(ae=j[0])==null?void 0:ae.data)==null?void 0:le.length)>0&&z&&s.jsx(Ge,{item:j})})]})]})},gt=ot;export{gt as T,$e as f};
