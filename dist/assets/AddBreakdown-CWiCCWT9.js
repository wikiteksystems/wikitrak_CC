import{z as R,b as k,y as I,aW as me,bs as pe,bt as he,bu as xe,C as g,ba as U,bd as ee,be as V,Z as ge,j as t,T as H,G as B,bv as fe,a6 as D,bj as te,E as Q,I as oe}from"./index-C7j2HP1Z.js";import{d as ie}from"./Close-BD9A-uFt.js";import{d as Z}from"./Add-BqBtPGCv.js";import{a as be,u as re,F as ae}from"./formik.esm-Cl5L3WAZ.js";import{c as J,a as s}from"./index.esm-Dr6zzgRy.js";import{B as E}from"./CircularProgress-C9QPDvo8.js";import{A as K}from"./Autocomplete-DZ7T6OrL.js";import{T as c,M as le}from"./TextField-4tf9mwAm.js";import{S as ve}from"./SearchInput-8y3grw5c.js";import{N as ne}from"./NewLoader-CYdY6nZZ.js";import{D as se,a as ce,b as de}from"./DialogTitle-DbiixGft.js";function je(){var n,a;const{vehicles_details:p}=R(e=>e.dashboard),{w_customer_id:C}=R(e=>e.auth),{breakdownTopics:y,UpdatedBreakdownData:r}=R(e=>e.breakdown),[h,x]=k.useState(null),[w,f]=k.useState(""),[_,T]=k.useState(!1),[L,S]=k.useState(!1),[F,W]=k.useState("");let v=I();k.useEffect(()=>{r&&(x(r.attachment),f("edit"))},[r]);const o=be({initialValues:{vehicle:((n=r==null?void 0:r.vehicle)==null?void 0:n.id)||"",breakdown_topic:((a=r==null?void 0:r.breakdown_topic)==null?void 0:a.id)||"",odometer_reading:(r==null?void 0:r.odometer_reading)||"",description:(r==null?void 0:r.description)||"",mob_no:(r==null?void 0:r.mob_no)||"",email:(r==null?void 0:r.email)||"",attachment:(r==null?void 0:r.attachment)||"",location:(r==null?void 0:r.location)||""},validationSchema:J({vehicle:s().required("Vehicle is required"),breakdown_topic:s().required("Breakdown Topic is required"),odometer_reading:s().required("Odometer Reading is required"),description:s().required("Description is required"),mob_no:s().matches(/^\d{10,11}$/,"Mobile number must be 10-11 digits").required("Mobile number is required"),email:s().email("Invalid email format").required("Email is required"),location:s().required("Location is required")}),onSubmit:async(e,{resetForm:i})=>{var l,u,b,j;try{T(!0),console.log("Submitted values:",e);const q=d(e.vehicle);e.user=q[0].user.id,e.status="Open",e.workshop_group=(b=(u=(l=q[0])==null?void 0:l.workShop)==null?void 0:u.group_name)==null?void 0:b.id,e.submission_date=new Date().toISOString().split("T")[0];let N;if(r){let $=await me(r.attachment);console.log("file conversion",$),e.issued_attachment=$;const A=r.id;N=await v(pe({values:e,id:A}))}else console.log("values",e),N=await v(he(e));if(N.payload.success){console.log(N.payload,"api response");let{vehicle:$,id:A,description:M,workshop_group:G,odometer_reading:z,location:O,user:Y}=(j=N==null?void 0:N.payload)==null?void 0:j.data,ue={vehicle:$,breakdown:A,description:M,workshop_group:G,odometer_reading:z,location:O,submitted_by:Y,status:"Open",issued_attachment:e==null?void 0:e.attachment,inspection_parts_inspection:null,type:"Breakdown"};await v(xe({values:ue})),g.success("Breakdown submitted successfully!"),i(),f(""),x(null),v(U(null)),v(ee(!1)),v(V(!1)),v(ge(C)),T(!1)}else throw T(!1),new Error(N.payload.error||"Failed to submit breakdown")}catch(q){console.error("Submission Error:",q),g.error("Failed to submit breakdown. Please try again.")}}}),P=async()=>{S(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition(async e=>{const{latitude:i,longitude:l}=e.coords;try{const u=await fe(i,l);o.setFieldValue("location",u)}catch(u){console.error("Error fetching address:",u),g.error("Failed to convert coordinates to address.")}finally{S(!1)}},e=>{console.error("Geolocation Error:",e),g.error("Failed to retrieve location. Please try again."),S(!1)}):(g.error("Geolocation is not supported by this browser."),S(!1))},d=e=>(p==null?void 0:p.length)>0&&p.filter(l=>l.id===e),m=e=>{const i=e.currentTarget.files[0];if(o.setFieldValue("attachment",i),f((i==null?void 0:i.name)||""),i&&i.type.startsWith("image/")){const l=new FileReader;l.onload=()=>x(l.result),l.readAsDataURL(i)}else x(null)};return t.jsx(E,{sx:{p:3,maxWidth:600,margin:"auto"},children:_?t.jsx(H,{children:"Submitted the form data..."}):t.jsx(t.Fragment,{children:t.jsxs("form",{onSubmit:o.handleSubmit,children:[t.jsx(K,{options:p,getOptionLabel:e=>e.registration_id,value:p.find(e=>e.id===o.values.vehicle)||null,onChange:(e,i)=>o.setFieldValue("vehicle",(i==null?void 0:i.id)||""),renderInput:e=>t.jsx(c,{...e,label:"Vehicle",error:o.touched.vehicle&&!!o.errors.vehicle,helperText:o.touched.vehicle&&o.errors.vehicle,fullWidth:!0})}),t.jsx(K,{options:y,getOptionLabel:e=>e.topic,value:y.find(e=>e.id===o.values.breakdown_topic)||null,onChange:(e,i)=>o.setFieldValue("breakdown_topic",(i==null?void 0:i.id)||""),renderOption:(e,i)=>k.createElement("li",{...e,key:i.id},i.topic),renderInput:e=>t.jsx(c,{...e,label:"Breakdown Topic",error:o.touched.breakdown_topic&&!!o.errors.breakdown_topic,helperText:o.touched.breakdown_topic&&o.errors.breakdown_topic,fullWidth:!0,sx:{mt:2}})}),t.jsx(c,{label:"Odometer Reading",name:"odometer_reading",value:o.values.odometer_reading,onChange:o.handleChange,onBlur:o.handleBlur,error:o.touched.odometer_reading&&!!o.errors.odometer_reading,helperText:o.touched.odometer_reading&&o.errors.odometer_reading,fullWidth:!0,sx:{mt:2}}),t.jsx(c,{label:"Description",name:"description",value:o.values.description,onChange:o.handleChange,onBlur:o.handleBlur,error:o.touched.description&&!!o.errors.description,helperText:o.touched.description&&o.errors.description,fullWidth:!0,sx:{mt:2}}),t.jsx(c,{label:"Mobile Number",name:"mob_no",value:o.values.mob_no,onChange:o.handleChange,onBlur:o.handleBlur,error:o.touched.mob_no&&!!o.errors.mob_no,helperText:o.touched.mob_no&&o.errors.mob_no,fullWidth:!0,sx:{mt:2}}),t.jsx(c,{label:"Email",name:"email",type:"email",value:o.values.email,onChange:o.handleChange,onBlur:o.handleBlur,error:o.touched.email&&!!o.errors.email,helperText:o.touched.email&&o.errors.email,fullWidth:!0,sx:{mt:2}}),t.jsx(c,{label:"Location",name:"location",value:F||o.values.location,onChange:e=>{W(e.target.value),o.setFieldValue("location",e.target.value)},onBlur:o.handleBlur,error:o.touched.location&&!!o.errors.location,helperText:o.touched.location&&o.errors.location,fullWidth:!0,sx:{mt:2}}),t.jsx(B,{variant:"outlined",onClick:P,disabled:L,sx:{mt:2},children:L?"Fetching Location...":"Use Current Location"}),t.jsxs(B,{component:"label",sx:{mt:2,border:"1px solid #f5f5f5",color:"black"},children:["Upload Attachment",t.jsx("input",{type:"file",hidden:!0,onChange:m})]}),w&&t.jsxs(H,{variant:"body2",sx:{mt:1},children:["Uploaded File: ",w]}),h&&t.jsx(E,{component:"img",src:h,alt:"Image Preview",sx:{mt:1,width:"100%",maxHeight:200}}),t.jsx(B,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,sx:{mt:3},children:"Submit"})]})})})}const X="https://wikitek.io/api/v1",ye=({setIsAdd:p,setIsUpdate:C})=>{const{vehicleList:y}=R(n=>n.liveMap),r=re("(min-width:600px)"),[h,x]=k.useState(!1),[w,f]=k.useState(!1),_=I(),T=n=>{f(!0);const{firstName:a,lastName:e,email:i,mobile:l,password:u,vehicleNo:b,location:j,model:q,description:N}=n;console.log("Form Submitted:",n);let $={first_name:a,last_name:e,email:i,mobile:l,password:u};try{D.post(`${X}/users/new/user/register/`,$).then(M=>{var O;let G={ticket_id:"",user:(O=M==null?void 0:M.data)==null?void 0:O.id,status:"open",description:N,latlong:j,vehicle:b,model:q};D.post(`${X}/tickets/create/ticket/`,G).then(Y=>{p(!1),C(!1),_(te()),f(!1),g.success("User registered and Ticket created successfully")}).catch(()=>{f(!1),g.error("Error occurred while creating ticket")})}).catch(M=>{f(!1),g.error("Error occurred while registering user")})}catch{f(!1),g.error("Error occurred while registering user")}},L=async n=>{x(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition(async a=>{const{latitude:e,longitude:i}=a.coords;try{n("location",`${e},${i}`)}catch(l){console.error("Error fetching address:",l),g.error("Failed to convert coordinates to address.")}finally{x(!1)}},a=>{console.error("Geolocation Error:",a),g.error("Failed to retrieve location. Please try again."),x(!1)}):(g.error("Geolocation is not supported by this browser."),x(!1))},S=/^((\+[1-9]{1,4}[ -]?)|(\([0-9]{2,3}\)[ -]?)|([0-9]{2,4})[ -]?)*?[0-9]{3,4}[ -]?[0-9]{3,4}$/,F=J().shape({firstName:s().required("required"),lastName:s().required("required"),fullName:s().required("required"),vehicleNo:s().required("required"),model:s().required("required"),email:s().email("invalid email").required("required"),mobile:s().matches(S,"Phone number is not valid").required("required"),location:s().required("required"),password:s().required("required"),description:s().required("required")}),W=JSON.parse(localStorage.getItem("w_userDetails")),{email:v,first_name:o,last_name:P,mobile:d}=W,m={firstName:o||"",lastName:P||"",fullName:`${o} ${P}`||"",vehicleNo:"",email:v||"",model:"",mobile:d||"",location:"",password:"",description:""};return t.jsxs(E,{m:"20px",children:[w&&t.jsx(ne,{}),t.jsx(ae,{onSubmit:T,initialValues:m,validationSchema:F,children:({values:n,errors:a,touched:e,handleBlur:i,handleChange:l,handleSubmit:u,setFieldValue:b})=>t.jsxs("form",{onSubmit:u,children:[t.jsxs(E,{display:"grid",gap:"30px",gridTemplateColumns:"repeat(4, minmax(0, 1fr))",sx:{"& > div":{gridColumn:r?void 0:"span 4"}},children:[t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"First Name",onBlur:i,onChange:l,value:n.firstName,name:"firstName",error:!!e.firstName&&!!a.firstName,helperText:e.firstName&&a.firstName,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Last Name",onBlur:i,onChange:l,value:n.lastName,name:"lastName",error:!!e.lastName&&!!a.lastName,helperText:e.lastName&&a.lastName,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Full Name",onBlur:i,onChange:l,value:n.fullName,name:"fullName",error:!!e.fullName&&!!a.fullName,helperText:e.fullName&&a.fullName,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,select:!0,variant:"filled",label:"Vehicle No",onBlur:i,onChange:j=>{const q=y.find(N=>N.registration_id===j.target.value);b("vehicleNo",j.target.value),b("model",(q==null?void 0:q.vehicle_model.name)||"")},value:n.vehicleNo,name:"vehicleNo",error:!!e.vehicleNo&&!!a.vehicleNo,helperText:e.vehicleNo&&a.vehicleNo,sx:{gridColumn:"span 2"},MenuProps:{PaperProps:{style:{maxHeight:200,overflowY:"auto"}}},children:y.map(j=>t.jsx(le,{value:j.registration_id,children:j.registration_id},j.id))}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Email",onBlur:i,onChange:l,value:n.email,name:"email",error:!!e.email&&!!a.email,helperText:e.email&&a.email,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Model",value:n==null?void 0:n.model,name:"model",disabled:!0,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Mobile",onBlur:i,onChange:l,value:n.mobile,name:"mobile",error:!!e.mobile&&!!a.mobile,helperText:e.mobile&&a.mobile,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"password",label:"Password",onBlur:i,onChange:l,value:n.password,name:"password",error:!!e.password&&!!a.password,helperText:e.password&&a.password,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Location",onBlur:i,onChange:l,value:n.location,name:"location",disabled:!0,error:!!e.location&&!!a.location,helperText:e.location&&a.location,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Description",onBlur:i,onChange:l,value:n.description,name:"description",error:!!e.description&&!!a.description,helperText:e.description&&a.description,sx:{gridColumn:"span 2"}}),t.jsx(B,{variant:"outlined",onClick:()=>L(b),disabled:h,sx:{mt:-2,width:"300px"},children:h?"Fetching Location...":"Use Current Location"})]}),t.jsx(E,{display:"flex",justifyContent:"center",mt:"25px",children:t.jsx(B,{type:"submit",color:"secondary",variant:"contained",children:"Submit"})})]})})]})},we="https://wikitek.io/api/v1",Ne=({userId:p,setIsAdd:C,setIsUpdate:y})=>{const r=I(),{vehicleList:h}=R(d=>d.liveMap),x=re("(min-width:600px)"),[w,f]=k.useState(!1),_=d=>{const{description:m,vehicleNo:n,model:a,location:e}=d;let i={ticket_id:"",user:p,status:"open",description:m,latlong:e,vehicle:n,model:a};localStorage.getItem("w_userToken");try{D.post(`${we}/tickets/create/ticket/`,i).then(u=>{y(!1),C(!1),r(te()),g.success("Ticket created successfully")})}catch{g.error("Error occurred while creating ticket")}},T=async d=>{f(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition(async m=>{const{latitude:n,longitude:a}=m.coords;try{d("location",`${n},${a}`)}catch(e){console.error("Error fetching address:",e),g.error("Failed to convert coordinates to address.")}finally{f(!1)}},m=>{console.error("Geolocation Error:",m),g.error("Failed to retrieve location. Please try again."),f(!1)}):(g.error("Geolocation is not supported by this browser."),f(!1))},L=J().shape({fullName:s().required("required"),vehicleNo:s().required("required"),model:s().required("required"),location:s().required("required"),description:s().required("required")}),S=JSON.parse(localStorage.getItem("w_userDetails")),{email:F,first_name:W,last_name:v,mobile:o}=S,P={fullName:`${W} ${v}`||"",vehicleNo:"",model:"",location:"",description:""};return t.jsx(E,{m:"20px",children:t.jsx(ae,{onSubmit:_,initialValues:P,validationSchema:L,children:({values:d,errors:m,touched:n,handleBlur:a,handleChange:e,handleSubmit:i,setFieldValue:l})=>t.jsxs("form",{onSubmit:i,children:[t.jsxs(E,{display:"grid",gap:"30px",gridTemplateColumns:"repeat(4, minmax(0, 1fr))",sx:{"& > div":{gridColumn:x?void 0:"span 4"}},children:[t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Full Name",onBlur:a,onChange:e,value:d.fullName,name:"fullName",disabled:!0,error:!!n.fullName&&!!m.fullName,helperText:n.fullName&&m.fullName,sx:{gridColumn:"span 4"}}),t.jsx(c,{fullWidth:!0,select:!0,variant:"filled",label:"Vehicle No",onBlur:a,onChange:u=>{const b=h.find(j=>j.registration_id===u.target.value);l("vehicleNo",u.target.value),l("model",(b==null?void 0:b.vehicle_model.name)||"")},value:d.vehicleNo,name:"vehicleNo",error:!!n.vehicleNo&&!!m.vehicleNo,helperText:n.vehicleNo&&m.vehicleNo,sx:{gridColumn:"span 4"},SelectProps:{MenuProps:{PaperProps:{sx:{maxHeight:250,overflowY:"auto"}}}},children:h.map(u=>t.jsx(le,{value:u.registration_id,children:u.registration_id},u.id))}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Model",value:d.model,name:"model",disabled:!0,sx:{gridColumn:"span 4"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Description",onBlur:a,onChange:e,value:d.description,name:"description",error:!!n.description&&!!m.description,helperText:n.description&&m.description,sx:{gridColumn:"span 4"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Location",onBlur:a,onChange:e,value:d.location,name:"location",disabled:!0,error:!!n.location&&!!m.location,helperText:n.location&&m.location,sx:{gridColumn:"span 4"}}),t.jsx(B,{variant:"outlined",onClick:()=>T(l),disabled:w,sx:{mt:-2,width:"300px"},children:w?"Fetching Location...":"Use Current Location"})]}),t.jsx(E,{display:"flex",justifyContent:"center",mt:"25px",children:t.jsx(B,{type:"submit",sx:{backgroundColor:"#8DA6C6DD"},variant:"contained",children:"Submit"})})]})})})},ke="https://wikitek.io/api/v1";function Me({where:p,isAdd:C,isUpdate:y,setIsUpdate:r,setIsAdd:h}){const{isAddBreakdown:x,isUpdateBreakdown:w,UpdatedBreakdownData:f}=R(d=>d.breakdown);let _=I();const[T,L]=k.useState(null),[S,F]=k.useState(!1),W=()=>{_(V(!1)),_(ee(!1)),_(U(null)),h(!1),r(!1)},v=()=>{_(V(!x))},o=async()=>{var a,e;F(!0);const d=JSON.parse(localStorage.getItem("w_userDetails")),{email:m}=d;let n={email:m};try{D.post(`${ke}/users/check/user`,n).then(l=>{var u,b;(u=l==null?void 0:l.data)!=null&&u.success?(L((b=l==null?void 0:l.data)==null?void 0:b.user_id),r(!0),h(!0)):L(null),F(!1)}).catch(l=>{r(!1),h(!0),F(!1),console.log("error",l)})}catch(i){console.log("eror",i),h(!0),r(!1),F(!1),(e=(a=i==null?void 0:i.response)==null?void 0:a.data)!=null&&e.success}},P={fontSize:"18px",fontWeight:500,lineHeight:"18.38px",textAlign:"center",paddingTop:"5px",fontFamily:"ubuntu"};return t.jsxs(E,{sx:{bgcolor:"white",m:"10px",display:"flex",textAlign:"left",justifyContent:"space-between",alignItems:"center",borderRadius:"6px",padding:"20px"},children:[S&&t.jsx(ne,{}),t.jsx(H,{variant:"h6",sx:P,children:`${p} New Requests`}),t.jsx(ve,{}),p.toLowerCase()==="breakdown"&&t.jsxs(B,{onClick:v,sx:{color:"black",background:Q.bgColor},children:[t.jsx(Z,{}),p]}),p.toLowerCase()==="rsa"&&t.jsxs(B,{onClick:o,sx:{color:"black",background:Q.bgColor},children:[t.jsx(Z,{}),"Raise ticket"]}),t.jsxs(se,{open:x||w,onClose:W,maxWidth:"md",fullWidth:!0,children:[t.jsxs(ce,{children:[w?"Update":"Add"," Breakdown",t.jsx(oe,{"aria-label":"close",onClick:W,sx:{position:"absolute",right:8,top:8,color:d=>d.palette.grey[500]},children:t.jsx(ie,{})})]}),t.jsx(de,{children:t.jsx(je,{})})]}),t.jsx(Ce,{isAdd:C,isUpdate:y,setIsUpdate:r,setIsAdd:h,handleClose:W,userId:T})]})}const Ce=({isAdd:p,isUpdate:C,handleClose:y,userId:r,setIsAdd:h,setIsUpdate:x})=>(console.log("idupdate",C,p),t.jsxs(se,{open:p,onClose:y,maxWidth:"md",fullWidth:!0,children:[t.jsxs(ce,{children:[C?"Ticket For RSA":"Registration form for RSA",t.jsx(oe,{"aria-label":"close",onClick:y,sx:{position:"absolute",right:8,top:8,color:w=>w.palette.grey[500]},children:t.jsx(ie,{})})]}),t.jsx(de,{children:C?t.jsx(Ne,{userId:r,setIsUpdate:x,setIsAdd:h,children:" "}):t.jsx(ye,{setIsUpdate:x,setIsAdd:h})})]}));export{Me as A};
