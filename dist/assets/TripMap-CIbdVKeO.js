import{b as a,z as P,j as s,y as ie,D as ce,F as Y,aO as Ie,aj as U,C as F,bp as Ae,bq as ke,U as Fe,aN as Re}from"./index-oCcClIVR.js";import{a as re,b as N,u as Oe,G as Le,D as Te}from"./esm-C6opi8fg.js";import{d as Ve}from"./dayjs.min-BrLTYef8.js";import{r as ze}from"./redTractor-NXgVJyvR.js";import{T as He,g as _e}from"./TripVehicleInfo-DzJgVFmg.js";import{B as q,C as Be}from"./CircularProgress-DrVUYvWS.js";import{d as Ge}from"./Info-CqEWa4kz.js";function Ye({trip:o,tripPlay:r,setTripPlay:g,setSpeed:d}){const[i,f]=a.useState([]),[n,l]=a.useState(0),[m,h]=a.useState([]),[v,e]=a.useState([null]),M=a.useRef(null),{selectedVehicle:j}=P(u=>u.liveMap),{vehicles_details:C}=P(u=>u.dashboard),[E,I]=a.useState("2W");a.useEffect(()=>{e([null]);const u=[];if(o&&o.length>0&&(o==null||o.forEach(x=>{u.push(x.speed.toFixed(2))}),h(u)),o&&o.length>0){const x=o.map(y=>({lat:parseFloat(y.lat),lng:parseFloat(y.lng)}));f(x),e(x.slice(0))}},[o]),a.useEffect(()=>{if(r){const u=i.length,x=29e3,y=1e4,L=performance.now();let T=0;const A=V=>{const D=V-L,_=Math.max(0,Math.min(D/x,1)),k=Math.min(Math.floor(_*u),u-1);k!==M.current&&(l(k),d(m[k]),M.current=k),T<y&&(requestAnimationFrame(A),T++)};return requestAnimationFrame(A),()=>{}}},[r,i,m]);const R=u=>{const x=C&&C.length>0&&C.find(y=>y.value===u&&y.vehilce_type);return x?x.vehilce_type:null};a.useEffect(()=>{if(Object.keys(j).length>0){const u=R(j.imei);I(u)}},[j]);const O=a.useMemo(()=>{var u,x;return{lat:parseFloat((u=i[n])==null?void 0:u.lat),lng:parseFloat((x=i[n])==null?void 0:x.lng)}},[i,n]),W=a.useMemo(()=>({url:ze,size:new window.google.maps.Size(30,30),scaledSize:new window.google.maps.Size(30,30),fillOpacity:2,strokeWeight:1,scale:2}),[E]);return s.jsxs("div",{children:[v.length>0&&s.jsx(s.Fragment,{children:s.jsx(re,{path:v,options:{strokeColor:"red",strokeOpacity:1,strokeWeight:4}})}),r&&s.jsxs(s.Fragment,{children:[s.jsx(re,{path:i.slice(0,n+1),options:{strokeColor:"green",strokeOpacity:1,strokeWeight:4,zIndex:1e3,geodesic:!0}}),s.jsx(N,{position:O,icon:W},n)]})]})}function Ue({tripPlay:o,speed:r,totalDistance:g,Acreage:d,filterCoordinates:i,acreageTrips:f,handleTrip:n,showGraph:l,handleShowGraph:m}){const{selectedTripData:h}=P(M=>M.dashboard);let v=ie();const e=()=>{var M,j,C;if(console.log("selected trip data",(M=h[0])==null?void 0:M.venderId,f),h.length>0)if(((j=h[0])==null?void 0:j.venderId)==="VT200"||((C=h[0])==null?void 0:C.venderId)==="wtkpltf001")if(Object.keys(f).length>0){let E=0;Object.keys(f).map(I=>{let R=Ie(f[I]);E+=R}),console.log("final acerage",E),v(U(E))}else F.error("No acreage trip found");else i(h,v)};return s.jsxs(q,{sx:{bgcolor:ce.bgColor,position:"relative",color:"white",display:"flex",alignItems:"center",overflowX:"hidden",flexWrap:"wrap",border:"1px solid white",gap:"5px",paddingLeft:"5px",padding:"10px 10px"},children:[s.jsxs(Y,{sx:{background:"white",border:"1px solid white",borderRadius:"5px",padding:"5px 20px",color:"black"},onClick:e,children:[" ","Calculate Acerage"]}),s.jsxs(Y,{sx:{background:o?"transparent":"white",border:"1px solid white",borderRadius:"5px",height:"38px",padding:"5px 20px",color:o?"white":"black","&:hover":{background:"transparent",color:"white"}},onClick:()=>{n()},children:[o?"Pause":"Play","-Trip"]}),s.jsxs(Y,{style:{height:"38px",padding:"5px 20px"},sx:{background:l?"transparent":"white",border:"1px solid white",borderRadius:"5px",color:l?"white":"black","&:hover":{background:"transparent",color:"white"}},onClick:()=>{m()},children:[l?"Hide":"Show","-Graph"]})]})}const We=(o,r)=>{const i=[];o.length>0&&o.forEach(n=>{let l={latitude:n.lat,longitude:n.lng},m=[];o.forEach(h=>{const v={latitude:h.lat,longitude:h.lng};if(v.latitude&&v.longitude&&v.latitude!==l.latitude&&v.longitude!==l.longitude){const e=Ne(n.lat,n.lng,h.lat,h.lng);e<20&&e>10&&m.push(h)}}),m.length>10&&i.push(n)});const f=o.filter(n=>n.lat!==void 0&&n.lng!==void 0).map(n=>({lat:parseFloat(n.lat),lng:parseFloat(n.lng)}));if(f.length>0){r(ke(i));try{const n=De(f),l=qe(n),m=new window.google.maps.Polygon({paths:l});return Je(m,r)}catch(n){return console.error("Error calculating convex hull or area:",n),r(U(0)),0}}else return r(U(0)),0},De=o=>{const r=(n,l,m)=>{const h=(l.lat-n.lat)*(m.lng-l.lng)-(l.lng-n.lng)*(m.lat-l.lat);return h===0?0:h>0?1:2},g=o.reduce((n,l)=>l.lng<n.lng?l:n);let d=[],i=g,f;do{d.push(i),f=o[0]===i?o[1]:o[0];for(let n=0;n<o.length;n++)r(i,f,o[n])===2&&(f=o[n]);i=f}while(i!==g);return d};function Ne(o,r,g,d){const f=o*Math.PI/180,n=g*Math.PI/180,l=(g-o)*Math.PI/180,m=(d-r)*Math.PI/180,h=Math.sin(l/2)*Math.sin(l/2)+Math.cos(f)*Math.cos(n)*Math.sin(m/2)*Math.sin(m/2);return 6371e3*(2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)))}const qe=o=>{o.sort((d,i)=>d.lng-i.lng||d.lat-i.lat);const r=[],g=[];for(const d of o){for(;r.length>=2&&le(r[r.length-2],r[r.length-1],d)<=0;)r.pop();r.push(d)}for(let d=o.length-1;d>=0;d--){const i=o[d];for(;g.length>=2&&le(g[g.length-2],g[g.length-1],i)<=0;)g.pop();g.push(i)}return[...r.slice(0,-1),...g.slice(0,-1)]},Je=(o,r)=>{if(!window.google||!window.google.maps.geometry){console.log("not loaded");return}const d=window.google.maps.geometry.spherical.computeArea(o.getPath())/4046.86;return r(U(d)),d},le=(o,r,g)=>(r.lat-o.lat)*(g.lng-o.lng)-(r.lng-o.lng)*(g.lat-o.lat),Ke=({selectedTrip:o,center:r,showCard:g})=>{var ee,te,oe,ne,se,ae;const d=ie(),{isLoaded:i,loadError:f}=Oe({googleMapsApiKey:"AIzaSyD8TrUWS9FRTu-MRP339mJF_iWlORvEGUA",libraries:["drawing","geometry"]}),{Acreage:n}=P(t=>t.tripMonitor),{selectedVehicle:l}=P(t=>t.liveMap),{singleTrip_Data:m,tripLoading:h,cords:v}=P(t=>t.tripMonitor),{selectedTripData:e,mode:M,styles:j}=P(t=>t.dashboard),{collapsed:C}=P(t=>t.auth),E=a.useRef(null),[I,R]=a.useState(null),[O,W]=a.useState(null),[u,x]=a.useState([]);a.useState([]);const[y,L]=a.useState(!1),[T,A]=a.useState(0),[V,D]=a.useState(!1),[_,k]=a.useState(0);a.useState([]),a.useState([]);const[B,J]=a.useState(!1),[ge,de]=a.useState({}),[G,K]=a.useState([]),[X,z]=a.useState(null),[he,$]=a.useState(null),[pe,ue]=a.useState({});a.useEffect(()=>{J(!0)},[l]),a.useEffect(()=>{(async()=>{if(l!=null&&l.imei){const c=Ve(),w=c.startOf("day").format("MM/DD/YYYY HH:mm:ss"),p=c.endOf("day").format("MM/DD/YYYY HH:mm:ss"),S={imei:[l.imei],startDate:w,endDate:p};try{const b=await Fe(S);de(b.data[0].data)}catch(b){console.error("Error fetching report:",b)}}})()},[l,d]),a.useEffect(()=>{I&&O&&I.fitBounds(O)},[I,O,e]);let fe=t=>{let c=Re(t),w={};c.map((p,S)=>{let b=t.slice(p.start,p.end+1);w[S]=b}),ue(w)};a.useEffect(()=>{if(console.log("selectedTripData",e),(e==null?void 0:e.length)>0){const t=me({selectedTripData:e});k(t),fe(e)}},[e]);const me=({selectedTripData:t})=>{const c=t.reduce((w,p,S)=>{if(S===0)return w;const b=t[S-1],H=Ae(b.lat,b.lng,p.lat,p.lng);return w+H},0);return c==null?void 0:c.toFixed(2)};a.useEffect(()=>{var t,c,w,p,S;if(e&&(e==null?void 0:e.length)>0){const b=new window.google.maps.LatLngBounds,H=new window.google.maps.LatLng(parseFloat((t=e[0])==null?void 0:t.lat),parseFloat((c=e[0])==null?void 0:c.lng)),Ee=new window.google.maps.LatLng(parseFloat((w=e[(e==null?void 0:e.length)-1])==null?void 0:w.lat),parseFloat((p=e[(e==null?void 0:e.length)-1])==null?void 0:p.lng));b.extend(H),b.extend(Ee),A((S=e[0])==null?void 0:S.speed),W(b)}L(!1),xe()},[e]);const xe=()=>{if(e&&e.length>0){const t=(p,S)=>{const H=new Date(p.createdAt).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0});return{Date:p.createdAt.substring(0,10),Time:H,value:p[S]}},w=["speed","mainInputVoltage","ignition"].map(p=>({label:p==="speed"?"Speed":p==="mainInputVoltage"?"MainInputVoltage":"Ignition",randomColor:we(),data:e.map(S=>t(S,p))}));x(w)}else x([])},we=()=>"#"+Math.floor(Math.random()*16777215).toString(16),Se=()=>{var t;if((e==null?void 0:e.length)>0)L(!y),A(0);else return((t=Object.keys(e))==null?void 0:t.length)===0?F.error("Please Select Vehicle",{id:"vehicle"}):F.error("Please Select Trip",{id:"trip error"})},be=()=>{var t;if((e==null?void 0:e.length)>0)D(!V);else return((t=Object.keys(e))==null?void 0:t.length)===0?F.error("Please Select Vehicle",{id:"vehicle"}):F.error("Please Select Trip",{id:"trip error"})},Q=()=>{Object.keys(l).length>0||B?J(!B):F.error("Please select any vehicle")};if(f)return"Error loading maps";if(!i)return"Loading maps";const ve={width:"100%",height:g?"87vh":"93vh"},ye=t=>{if(t.type==="polygon"){const c=t.overlay;c.setEditable(!0),K(w=>[...w,c]),z(c),google.maps.event.addListener(c.getPath(),"set_at",()=>z(c)),google.maps.event.addListener(c.getPath(),"insert_at",()=>z(c)),google.maps.event.addListener(c.getPath(),"remove_at",()=>z(c)),Z(c)}},Z=t=>{if(!t)return;const c=t.getPath().getArray(),p=(google.maps.geometry.spherical.computeArea(c)/4046.86).toFixed(2);$(p)},Me=()=>{G.forEach(t=>t.setMap(null)),K([]),$(null),z(null)},je=()=>{G.forEach(t=>t.setEditable(!0))},Ce=()=>{G.forEach(t=>t.setEditable(!1))},Pe=()=>{X?Z(X):alert("No shape is selected. Please draw or select a shape.")};return s.jsxs(s.Fragment,{children:[h&&s.jsx(q,{sx:{position:"absolute",top:"50vh",left:"50%",zIndex:"1000"},children:s.jsx(Be,{})}),g&&s.jsx(Ue,{tripPlay:y,speed:T,totalDistance:_,Acreage:n,filterCoordinates:We,acreageTrips:pe,handleTrip:Se,showGraph:V,handleShowGraph:be}),s.jsx(q,{sx:{position:"absolute",top:"795px",left:C?"74px":"250px",zIndex:1,background:ce.bgColor,padding:"5px",borderRadius:"10px",color:"white"},children:s.jsxs(Y,{sx:{color:"white"},onClick:Q,children:[B?"Hide":"Show"," Vehicle Info",s.jsx(Ge,{})]})}),B===!0&&s.jsx(He,{handleVehicleInfo:Q,vehicleReport:ge,tripPlay:y,speed:T,totalDistance:_,Acreage:n,whereToUse:"TripMonitor"}),s.jsxs(Le,{ref:E,mapContainerStyle:ve,zoom:10,center:r,onLoad:t=>R(t),options:{styles:M?j:""},children:[s.jsx(Te,{onOverlayComplete:ye,options:{drawingControl:!0,drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:["polygon"]}}}),s.jsxs("div",{style:{position:"absolute",bottom:80,left:20,background:"white",padding:"10px",borderRadius:"8px",boxShadow:"0 0 6px rgba(0,0,0,0.2)",zIndex:100,width:"auto"},children:[s.jsxs("p",{children:["Area: ",he||0," acres"]}),G.length>0&&s.jsxs(s.Fragment,{children:[s.jsx("button",{onClick:je,style:{marginTop:"10px",marginRight:"10px"},children:"Enable Editing"}),s.jsx("button",{onClick:Ce,style:{marginTop:"10px",marginRight:"10px"},children:"Disable Editing"}),s.jsx("button",{onClick:Pe,style:{marginTop:"10px",marginRight:"10px"},children:"Calculate Area"}),s.jsx("button",{onClick:Me,style:{marginTop:"10px"},children:"Clear All Shapes"})]})]}),e&&(e==null?void 0:e.length)>0&&s.jsx(N,{position:{lat:parseFloat((ee=e[0])==null?void 0:ee.lat),lng:parseFloat((te=e[0])==null?void 0:te.lng)},animation:"BOUNCE",icon:{url:"http://maps.google.com/mapfiles/ms/icons/green-dot.png"}}),e&&(e==null?void 0:e.length)>0&&s.jsx(N,{position:{lat:parseFloat((oe=e[(e==null?void 0:e.length)-1])==null?void 0:oe.lat),lng:parseFloat((ne=e[(e==null?void 0:e.length)-1])==null?void 0:ne.lng)},animation:"BOUNCE",icon:{url:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"}}),e&&(e==null?void 0:e.length)>0&&s.jsx(Ye,{trip:e,tripPlay:y,setTripPlay:L,setSpeed:A}),s.jsx("div",{style:{position:"relative",top:200,left:12,color:"green"},children:((ae=(se=u[0])==null?void 0:se.data)==null?void 0:ae.length)>0&&V&&s.jsx(_e,{item:u})})]})]})},nt=Ke;export{nt as T,We as f};
