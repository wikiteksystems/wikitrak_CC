import{w as T,e as i,R as Ee,v as de,j as h,aa as Ce,Y as te,B as V,G as Pe,ah as Ae,J as Re,ai as Le,aj as $e,eV as Be,U as Te,C as oe,eW as Ve,a5 as Oe,a7 as We,ao as Fe,aq as ue}from"./index-6PM0p98e.js";import{u as Ne,G as Ue,M as He}from"./esm-BzYbrRup.js";import{M as Ge,r as ze,g as qe,y as Ke,b as Je,a as Ye,c as Xe,d as Ze,e as Qe,f as et,h as tt,i as ot,j as nt,k as st,l as at,m as rt,n as ct,o as lt,p as it,q as ut,s as dt,t as ft,u as gt,v as ht}from"./black_bike-Cb8bY3px.js";import pt from"./Loader-BSGTG9QR.js";import{L as yt}from"./LiveMapServices-oCmHnvlA.js";import{m as G}from"./motorbike-Ci4voNFa.js";import{r as wt}from"./redTractor-NXgVJyvR.js";import"./Card-JDQl3YTh.js";import"./CardContent-CIphYqA0.js";const kt="AIzaSyD8TrUWS9FRTu-MRP339mJF_iWlORvEGUA";function vt({loadingVehicle:v,vehicleData:b,center:z,setCenter:E}){const{selectedParameterList:O,selectedVehicle:p,vehicleList:q,zoom:W,icons:ne,locationData:f,placesData:F,imeiNumbers:se,onlineVehicle:ae,loading:re,services_loading:C}=T(e=>e.liveMap),{mode:K,styles:N,vehicles_details:y}=T(e=>e.dashboard),P=i.useRef(null);T(e=>e.auth);const[k,u]=i.useState(null),[w,m]=i.useState(""),[D,I]=i.useState([]),[A,r]=i.useState(),[U,R]=i.useState(null);i.useState("");const[J,L]=i.useState();i.useState(!1);const[M,Y]=i.useState(null);Ee.useState(!1);const X=de(),Z={},$=i.useRef([]),ce=i.useRef(null),B=i.useRef({}),{isLoaded:Q,loadError:fe}=Ne({googleMapsApiKey:`${kt}`,loadingElement:h.jsx(pt,{})});i.useEffect(()=>{Q&&u(window.google.maps)},[Q]),i.useEffect(()=>{},[W]),i.useEffect(()=>{var e,t,o,n;if(Object.keys(p).length>0){const s=(M==null?void 0:M.length)>0?M:f,a=s==null?void 0:s.filter(c=>{var l;return((l=c==null?void 0:c.latestDocument)==null?void 0:l.imei)===(p==null?void 0:p.imei)});if((a==null?void 0:a.length)>0){I(a);const c={lat:(t=(e=a[0])==null?void 0:e.latestDocument)==null?void 0:t.lat,lng:(n=(o=a[0])==null?void 0:o.latestDocument)==null?void 0:n.lng};E(c)}}},[f,p]),i.useEffect(()=>{if(!(Object.keys(p).length>0)){const e=f==null?void 0:f.filter(t=>b.some(o=>o.value===t.latestDocument.imei));I(e),Y(e)}},[f,p]),i.useEffect(()=>{var e,t,o,n;if(Object.keys(p).length>0){const s=(M==null?void 0:M.length)>0?M:f,a=s==null?void 0:s.filter(c=>{var l;return((l=c==null?void 0:c.latestDocument)==null?void 0:l.imei)===(p==null?void 0:p.imei)});if((a==null?void 0:a.length)>0){I(a);const c={lat:(t=(e=a[0])==null?void 0:e.latestDocument)==null?void 0:t.lat,lng:(n=(o=a[0])==null?void 0:o.latestDocument)==null?void 0:n.lng};E(c)}}else{const s=f==null?void 0:f.filter(a=>b.some(c=>c.value===a.latestDocument.imei));I(s),Y(s)}},[f,p]),i.useEffect(()=>{X(Ce({}))},[]),i.useEffect(()=>{if(console.log("before: ",D),!k)return;const e=ce.current;let t=null;return(async()=>{console.log("after: ",D);const n=await ge(D,e);t&&t.clearMarkers(),t=ve(n,e),te.on("locationinfo",s=>{console.log("locationinfo: ",s),Se(s,$),Y(a=>{const c=Array.isArray(a)?a:[],l=c.findIndex(d=>String(d.latestDocument.imei)===String(s.imei));if(l!==-1){const d=[...c];return d[l]={...d[l],latestDocument:{...d[l].latestDocument,...s}},d}else return[...c,{_id:s.imei,latestDocument:s}]})})})(),()=>{t&&t.clearMarkers(),Object.keys(B.current).forEach(n=>cancelAnimationFrame(B.current[n])),te.off("locationinfo")}},[k,D,te,A,$,f]);const ge=(e,t)=>e.map(o=>{const n=o.latestDocument.imei,s=$.current[n]||he(o,t);return $.current[n]&&pe(o,s),s}),he=(e,t)=>{const o=e.latestDocument.imei,n=new k.Marker({position:{lat:e.latestDocument.lat,lng:e.latestDocument.lng},map:t,icon:ee(e)});return n.addListener("click",()=>ke(e,n,t)),$.current[o]=n,n},pe=async(e,t)=>{var l;const o=t.getPosition(),n=((l=t.getIcon())==null?void 0:l.rotation)||0,s={lat:e.latestDocument.lat,lng:e.latestDocument.lng},a=e.latestDocument.heading||0;ie(t,o,s,n,a);const c=await ee(e);t.setIcon(c)},ee=async e=>{var l,d,g,x,S;const t=(l=e==null?void 0:e.latestDocument)==null?void 0:l.imei,o=be(t),n=Ie(e==null?void 0:e.latestDocument,o),s=((d=e==null?void 0:e.latestDocument)==null?void 0:d.heading)||0;return le((g=e==null?void 0:e.latestDocument)==null?void 0:g.imei)&&ye((x=e==null?void 0:e.latestDocument)==null?void 0:x.imei),{url:await we(n,s),fillOpacity:2,strokeWeight:1,scale:4.5,rotation:(S=e==null?void 0:e.latestDocument)==null?void 0:S.heading,size:new k.Size(30,30),scaledSize:new k.Size(30,30)}},le=e=>ae.includes(String(e)),ye=e=>f==null?void 0:f.some(t=>String(t.latestDocument.imei)===String(e)&&t.latestDocument.speed>0&&(t.latestDocument.ignition===!0||t.latestDocument.ignition===1)),we=(e,t,o,n=80)=>{const s=`${e}-${t}-${n}-${o}`;if(Z[s])return Promise.resolve(Z[s]);const a=document.createElement("canvas"),c=a.getContext("2d");a.width=n,a.height=n;const l=new Image;return l.src=e,new Promise(d=>{l.onload=()=>{if(c.clearRect(0,0,a.width,a.height),c.translate(n/2,n/2),c.rotate(t*Math.PI/180),c.translate(-n/2,-n/2),c.drawImage(l,0,0,n,n),o){const S=n-30-5,_=n-30-5;c.beginPath(),c.arc(S,_,30/2,0,Math.PI*2),c.fillStyle=o,c.fill()}const g=a.toDataURL("image/png");Z[s]=g,d(g)},l.onerror=g=>{console.error("Error loading image for rotation:",g),d(e)}})},ke=(e,t,o)=>{Me(e.latestDocument._id,e,t,o),me(e.latestDocument.imei)},ie=(e,t,o,n,s)=>{const c=performance.now(),l=()=>{const d=performance.now()-c,g=Math.min(d/500,1),x=t.lat()+g*(o.lat-t.lat()),S=t.lng()+g*(o.lng-t.lng()),_=(s-n+360)%360-180,H=(n+_*g+360)%360;e.setPosition({lat:x,lng:S});const j=e.getIcon();j&&typeof j=="object"&&e.setIcon({...j,rotation:H}),g<1?B.current[e.getPosition()]=requestAnimationFrame(l):(e.setPosition(o),j&&typeof j=="object"&&e.setIcon({...j,rotation:s}),delete B.current[e.getPosition()])};B.current[e.getPosition()]=requestAnimationFrame(l)},ve=(e,t)=>new Ge({map:t,markers:e,renderer:{render:({count:o,position:n})=>xe(o,n)}}),xe=(e,t)=>{const o=40+Math.min(e*2,40),n=30;let s;return e<10?s={start:"#76c7c0",end:"#34a853"}:e<50?s={start:"#fbbc05",end:"#f2994a"}:s={start:"#f45c42",end:"#d32f2f"},new k.Marker({position:t,icon:{url:`data:image/svg+xml,${encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="${o}" height="${o}" viewBox="0 0 100 100">
            <defs>
              <radialGradient id="gradient" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="${s.start}" />
                <stop offset="100%" stop-color="${s.end}" />
              </radialGradient>
              <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="rgba(0, 0, 0, 0.5)" />
              </filter>
            </defs>
            <!-- Outer Pulsating Ring -->
            <circle cx="50" cy="50" r="48" fill="url(#gradient)" filter="url(#shadow)" stroke="#ffffff" stroke-width="3" />
            <!-- Decorative Inner Ring -->
            <circle cx="50" cy="50" r="38" fill="none" stroke="#ffffff" stroke-width="2" stroke-dasharray="4 2" />
            <!-- Star Decoration -->
            <polygon points="50,15 54,38 70,38 57,50 62,68 50,57 38,68 43,50 30,38 46,38" fill="#ffffff" opacity="0.4" />
            <!-- Count Text -->
            <text x="50" y="55" font-size="${n}" fill="black" text-anchor="middle" font-family="'Courier New', monospace" font-weight="bold">
              ${e}
            </text>
          </svg>
        `)}`,scaledSize:new k.Size(o,o)},label:null})},Se=async(e,t,o)=>{var a;const n=e.imei,s=t.current[n];if(s){const c=s.getPosition(),l=((a=s.getIcon())==null?void 0:a.rotation)||0,d={lat:e.lat,lng:e.lng},g=e.heading||0;ie(s,c,d,l,g);const x=await ee({latestDocument:e});s.setIcon(x)}},be=e=>{if(!e)return"motorBike";const t=De(e);return t||console.error(`No vehicle type found for IMEI: ${e}, defaulting to motorBike`),t||"motorBike"},De=e=>{if(!y||y.length===0)return console.error("vehicles_details is not available"),null;const t=y.find(o=>(o==null?void 0:o.value)===e&&(o==null?void 0:o.vehilce_type));return t||console.error(`No vehicle found for IMEI: ${e}`),t?t.vehilce_type:null},Ie=(e,t)=>{let{speed:o,ignition:n,imei:s}=e,a=le(s);const c={"2W":{red:ze,green:qe,yellow:Ke,black:Je},"3W":{red:Ye,green:Xe,yellow:Ze,black:Qe},"4W":{red:et,green:tt,yellow:ot,black:nt},Tractor:{red:wt,green:st,yellow:at,black:rt},Harvestor:{red:ct,green:lt,yellow:it,black:ut},BUS:{red:dt,green:ft,yellow:gt,black:ht},default:{red:G,green:G,yellow:G,black:G}};let l=c[t]||c.default;if(!a)return l.black;if(a&&!n)return l.red;if(a&&n&&o>0)return l.green;if(a&&n&&o<=0)return l.yellow},Me=(e,t,o,n)=>{var d,g,x;X(Le(t.latestDocument.imei));const s={lat:(d=t==null?void 0:t.latestDocument)==null?void 0:d.lat,lng:(g=t==null?void 0:t.latestDocument)==null?void 0:g.lng};E(s),X($e(15)),P.current||(P.current=new k.InfoWindow);const a=P.current,l=`
      <div>
        <h3>Registration No: ${((x=q.find(S=>{var _,H;return((_=S==null?void 0:S.imei[0])==null?void 0:_.mac_id)===((H=t==null?void 0:t.latestDocument)==null?void 0:H.imei)}))==null?void 0:x.registration_id)||""}</h3>
      </div>
    `;U===e?(a.close(),R(null)):(a.setContent(l),a.open(n,o),R(e))},me=e=>{const t=y&&(y==null?void 0:y.length)>0&&y.find(o=>(o==null?void 0:o.value)===e&&o);L(t||null)};if(fe)return"Error loading maps";if(!Q)return"Loading maps";if(!k)return null;const _e={height:"100vh",width:"100%",transition:"transform 0.5s ease-in-out"},je=()=>{window.location.reload()};return h.jsxs(h.Fragment,{children:[h.jsx(V,{sx:{position:"absolute",top:"780px",left:"250px",zIndex:1,background:Pe.bgColor,padding:"5px",borderRadius:"10px",color:"white"}}),h.jsxs(Ue,{id:"map",mapContainerStyle:_e,zoom:W,center:z,onLoad:e=>{ce.current=e},options:{styles:K?N:""},children:[Object.keys(p).length>0&&h.jsx(yt,{setPlace:m,place:w}),C||v?h.jsx(V,{sx:{position:"absolute",top:"50%",left:"50%"},children:h.jsx(Ae,{})}):F&&F.length>0&&F.map((e,t)=>{var o,n;return h.jsx(He,{position:{lat:parseFloat((o=e==null?void 0:e.location)==null?void 0:o.lat),lng:parseFloat((n=e==null?void 0:e.location)==null?void 0:n.lng)},animation:window.google.maps.Animation.DROP,icon:{path:ne[`${w}`],fillOpacity:2,strokeWeight:1,scale:1,fillColor:"orange"}},t)}),h.jsx(V,{sx:{display:"flex",justifyContent:"center",mt:"20px"},children:h.jsx(Re,{variant:"contained",onClick:je,children:" Go to vehicle location"})})]})]})}const xt="https://cc.wikitrak.in/proxy-3031";function Ct(){const{locationData:v}=T(u=>u.liveMap),{vehicleNo:b,token:z}=Be(),[E,O]=i.useState(!1),[p,q]=i.useState([]);T(u=>u.auth);const[W,ne]=i.useState(!1),[f,F]=i.useState(!1),[se,ae]=i.useState(!0),[re,C]=i.useState(!1),[K,N]=i.useState({lat:21,lng:78});let y=de();i.useEffect(()=>{y(Te({}))},[]),i.useEffect(()=>{k()},[]);const P=async()=>{try{(await Fe.post(`${xt}/api/validate-token`,{token:z})).data.valid?O(!0):O(!1)}catch{O(!1)}};i.useEffect(()=>{P()},[]),i.useEffect(()=>{var u;if(b){console.log("locationdata342423",v);const w=(v==null?void 0:v.length)>0&&(v==null?void 0:v.filter(A=>String(A.latestDocument.imei)===String(b)));if((w==null?void 0:w.length)<=0){oe.error("Data not available for this vehicle",{id:"clipboard"});return}const{lat:m,lng:D}=((u=w==null?void 0:w[0])==null?void 0:u.latestDocument)??{},I={lat:m||ue.lat,lng:D||ue.lat};N(I)}},[v]);const k=async()=>{try{C(!0);let u=[],w=[];if(!b)return;const m=await y(Ve({imei:b}));if(Array.isArray(m.payload)){m.payload.forEach(r=>{var U,R,J,L;Array.isArray(r.imei)&&r.imei.length>0&&((U=r.imei[0])!=null&&U.mac_id)?(u.push({id:r.id,label:r.registration_id,value:(R=r.imei[0])==null?void 0:R.mac_id,vehilce_type:r==null?void 0:r.segment,chassis_no:r==null?void 0:r.chassis_no,engine_no:r==null?void 0:r.engine_no,workShop:r==null?void 0:r.workshop,registration_id:r==null?void 0:r.registration_id,sell_date:r==null?void 0:r.sell_date,customer_name:r==null?void 0:r.customer_name,vehicle_model:(J=r==null?void 0:r.vehicle_model)==null?void 0:J.name,vehicle_group:r==null?void 0:r.vehicle_group}),w.push((L=r.imei[0])==null?void 0:L.mac_id)):console.error("IMEI data not found for item:",r)});const D="one",I=w;w.length>0&&y(Oe({type:D,imei:I}));let A=u==null?void 0:u.filter(r=>r.value==b);q(A),y(We(u)),C(!1)}else C(!1),console.error("Unexpected data format:",m),oe.error("Unexpected data format:")}catch(u){console.error("Error fetching vehicle data:",u),oe.error(`Error fetching vehicle data: ${u}`)}};return E?h.jsx("div",{className:"app",children:h.jsx("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:h.jsx(V,{style:{display:"flex",width:"100%",height:"95vh"},children:h.jsx(V,{style:{width:W||f?"80%":"100%"},children:h.jsx(vt,{showCard:se,loadingVehicle:re,vehicleData:p,center:K,setCenter:N})})})})}):h.jsx("h3",{children:"Invalid or Expired Link"})}export{Ct as default};
