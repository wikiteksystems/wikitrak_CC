import{z as $,b as i,R as Ee,y as de,j as p,B as U,a0 as Ce,D as Pe,a5 as je,a6 as Ae,b_ as Re,Q as Ve,C as te,V as Le,W as Ne,Y as $e,Z as Be,a7 as Te,a9 as ue}from"./index-XF1F12r5.js";import{u as Oe,G as Fe,M as We,m as H}from"./motorbike-PY_By168.js";import{M as He,r as Ue,g as ze,y as Ge,b as qe,a as Ke,c as Ye,d as Ze,e as Je,f as Qe,h as Xe,i as et,j as tt,k as ot,l as nt,m as st,n as at,o as rt,p as lt,q as ct,s as it,t as ut,u as dt,v as ft,w as gt}from"./black_bike-DRxQnFzk.js";import"./NewLoader--9HteRdz.js";import{F as ht}from"./Loader-DMJhLNdt.js";import{L as pt}from"./LiveMapServices-DYkd5q5i.js";import{s as oe}from"./Socket-0N_gnJcr.js";import{B as z,C as yt}from"./CircularProgress-deK7ax3h.js";import"./index-Lm56A98y.js";import"./createSvgIcon-PHVT_TUq.js";import"./useControlled-CsdylFJL.js";import"./Card-kXMHmN6i.js";import"./CardContent-WMyJVaNd.js";const wt="AIzaSyD8TrUWS9FRTu-MRP339mJF_iWlORvEGUA";function vt({loadingVehicle:x,vehicleData:M}){const{center:G,selectedParameterList:ne,selectedVehicle:f,vehicleList:q,zoom:B,icons:T,locationData:y,placesData:O,imeiNumbers:se,onlineVehicle:K,loading:ae,services_loading:re}=$(e=>e.liveMap),{mode:Y,styles:P,vehicles_details:h}=$(e=>e.dashboard),j=i.useRef(null);$(e=>e.auth);const[v,u]=i.useState(null),[w,m]=i.useState(""),[D,S]=i.useState([]),[A,a]=i.useState(),[F,R]=i.useState(null);i.useState("");const[Z,V]=i.useState();i.useState(!1);const[I,J]=i.useState(null);Ee.useState(!1);const _=de(),Q={},L=i.useRef([]),le=i.useRef(null),N=i.useRef({}),{isLoaded:X,loadError:fe}=Oe({googleMapsApiKey:`${wt}`,loadingElement:p.jsx(ht,{})});i.useEffect(()=>{X&&u(window.google.maps)},[X]),i.useEffect(()=>{},[B]),i.useEffect(()=>{var e,t,o,n;if(Object.keys(f).length>0){const l=((I==null?void 0:I.length)>0?I:y).filter(r=>{var c;return((c=r==null?void 0:r.latestDocument)==null?void 0:c.imei)===(f==null?void 0:f.imei)});if(l.length>0){S(l);const r={lat:(t=(e=l[0])==null?void 0:e.latestDocument)==null?void 0:t.lat,lng:(n=(o=l[0])==null?void 0:o.latestDocument)==null?void 0:n.lng};_(U(r))}}},[y,f]),i.useEffect(()=>{if(!(Object.keys(f).length>0)){const e=y.filter(t=>M.some(o=>o.value===t.latestDocument.imei));S(e),J(e)}},[y,f]),i.useEffect(()=>{var e,t,o,n;if(Object.keys(f).length>0){const l=((I==null?void 0:I.length)>0?I:y).filter(r=>{var c;return((c=r==null?void 0:r.latestDocument)==null?void 0:c.imei)===(f==null?void 0:f.imei)});if(l.length>0){S(l);const r={lat:(t=(e=l[0])==null?void 0:e.latestDocument)==null?void 0:t.lat,lng:(n=(o=l[0])==null?void 0:o.latestDocument)==null?void 0:n.lng};_(U(r))}}else{const s=y.filter(l=>M.some(r=>r.value===l.latestDocument.imei));S(s),J(s)}},[y,f]),i.useEffect(()=>{_(Ce({}))},[]),i.useEffect(()=>{if(console.log("before: ",D),!v)return;const e=le.current;let t=null;return(async()=>{console.log("after: ",D);const n=await ge(D,e);t&&t.clearMarkers(),t=ke(n,e),oe.on("locationinfo",s=>{console.log("locationinfo: ",s),xe(s,L),J(l=>{const r=Array.isArray(l)?l:[],c=r.findIndex(d=>Number(d.latestDocument.imei)===Number(s.imei));if(c!==-1){const d=[...r];return d[c]={...d[c],latestDocument:{...d[c].latestDocument,...s}},d}else return[...r,{_id:s.imei,latestDocument:s}]})})})(),()=>{t&&t.clearMarkers(),Object.keys(N.current).forEach(n=>cancelAnimationFrame(N.current[n])),oe.off("locationinfo")}},[v,D,oe,A,L,y]);const ge=(e,t)=>e.map(o=>{const n=o.latestDocument.imei,s=L.current[n]||he(o,t);return L.current[n]&&pe(o,s),s}),he=(e,t)=>{const o=e.latestDocument.imei,n=new v.Marker({position:{lat:e.latestDocument.lat,lng:e.latestDocument.lng},map:t,icon:ee(e)});return n.addListener("click",()=>ve(e,n,t)),L.current[o]=n,n},pe=async(e,t)=>{var c;const o=t.getPosition(),n=((c=t.getIcon())==null?void 0:c.rotation)||0,s={lat:e.latestDocument.lat,lng:e.latestDocument.lng},l=e.latestDocument.heading||0;ie(t,o,s,n,l);const r=await ee(e);t.setIcon(r)},ee=async e=>{var c,d,g,k,b;const t=(c=e==null?void 0:e.latestDocument)==null?void 0:c.imei,o=De(t),n=Ie(e==null?void 0:e.latestDocument,o),s=((d=e==null?void 0:e.latestDocument)==null?void 0:d.heading)||0;return ce((g=e==null?void 0:e.latestDocument)==null?void 0:g.imei)&&ye((k=e==null?void 0:e.latestDocument)==null?void 0:k.imei),{url:await we(n,s),fillOpacity:2,strokeWeight:1,scale:4.5,rotation:(b=e==null?void 0:e.latestDocument)==null?void 0:b.heading,size:new v.Size(30,30),scaledSize:new v.Size(30,30)}},ce=e=>(console.log("online vehicles",K),K.includes(Number(e))),ye=e=>y==null?void 0:y.some(t=>Number(t.latestDocument.imei)===Number(e)&&t.latestDocument.speed>0&&(t.latestDocument.ignition===!0||t.latestDocument.ignition===1)),we=(e,t,o,n=80)=>{const s=`${e}-${t}-${n}-${o}`;if(Q[s])return Promise.resolve(Q[s]);const l=document.createElement("canvas"),r=l.getContext("2d");l.width=n,l.height=n;const c=new Image;return c.src=e,new Promise(d=>{c.onload=()=>{if(r.clearRect(0,0,l.width,l.height),r.translate(n/2,n/2),r.rotate(t*Math.PI/180),r.translate(-n/2,-n/2),r.drawImage(c,0,0,n,n),o){const b=n-30-5,E=n-30-5;r.beginPath(),r.arc(b,E,30/2,0,Math.PI*2),r.fillStyle=o,r.fill()}const g=l.toDataURL("image/png");Q[s]=g,d(g)},c.onerror=g=>{console.error("Error loading image for rotation:",g),d(e)}})},ve=(e,t,o)=>{me(e.latestDocument._id,e,t,o),Me(e.latestDocument.imei)},ie=(e,t,o,n,s)=>{const r=performance.now(),c=()=>{const d=performance.now()-r,g=Math.min(d/500,1),k=t.lat()+g*(o.lat-t.lat()),b=t.lng()+g*(o.lng-t.lng()),E=(s-n+360)%360-180,W=(n+E*g+360)%360;e.setPosition({lat:k,lng:b});const C=e.getIcon();C&&typeof C=="object"&&e.setIcon({...C,rotation:W}),g<1?N.current[e.getPosition()]=requestAnimationFrame(c):(e.setPosition(o),C&&typeof C=="object"&&e.setIcon({...C,rotation:s}),delete N.current[e.getPosition()])};N.current[e.getPosition()]=requestAnimationFrame(c)},ke=(e,t)=>new He({map:t,markers:e,renderer:{render:({count:o,position:n})=>be(o,n)}}),be=(e,t)=>{const o=40+Math.min(e*2,40),n=30;let s;return e<10?s={start:"#76c7c0",end:"#34a853"}:e<50?s={start:"#fbbc05",end:"#f2994a"}:s={start:"#f45c42",end:"#d32f2f"},new v.Marker({position:t,icon:{url:`data:image/svg+xml,${encodeURIComponent(`
          <svg xmlns="http://www.w3.org/2000/svg" width="${o}" height="${o}" viewBox="0 0 100 100">
            <defs>
              <radialGradient id="gradient" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="${s.start}" />
                <stop offset="100%" stop-color="${s.end}" />
              </radialGradient>
              <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="rgba(0, 0, 0, 0.5)" />
              </filter>
            </defs>
            <!-- Outer Pulsating Ring -->
            <circle cx="50" cy="50" r="48" fill="url(#gradient)" filter="url(#shadow)" stroke="#ffffff" stroke-width="3" />
            <!-- Decorative Inner Ring -->
            <circle cx="50" cy="50" r="38" fill="none" stroke="#ffffff" stroke-width="2" stroke-dasharray="4 2" />
            <!-- Star Decoration -->
            <polygon points="50,15 54,38 70,38 57,50 62,68 50,57 38,68 43,50 30,38 46,38" fill="#ffffff" opacity="0.4" />
            <!-- Count Text -->
            <text x="50" y="55" font-size="${n}" fill="black" text-anchor="middle" font-family="'Courier New', monospace" font-weight="bold">
              ${e}
            </text>
          </svg>
        `)}`,scaledSize:new v.Size(o,o)},label:null})},xe=async(e,t,o)=>{var l;const n=e.imei,s=t.current[n];if(s){const r=s.getPosition(),c=((l=s.getIcon())==null?void 0:l.rotation)||0,d={lat:e.lat,lng:e.lng},g=e.heading||0;ie(s,r,d,c,g);const k=await ee({latestDocument:e});s.setIcon(k)}},De=e=>{if(!e)return"motorBike";const t=Se(e);return t||console.error(`No vehicle type found for IMEI: ${e}, defaulting to motorBike`),t||"motorBike"},Se=e=>{if(!h||h.length===0)return console.error("vehicles_details is not available"),null;const t=h.find(o=>(o==null?void 0:o.value)===e&&(o==null?void 0:o.vehilce_type));return t||console.error(`No vehicle found for IMEI: ${e}`),t?t.vehilce_type:null},Ie=(e,t)=>{console.log("packet and type",e,t);let{speed:o,ignition:n,imei:s}=e,l=ce(s);const r={"2W":{red:Ue,green:ze,yellow:Ge,black:qe},"3W":{red:Ke,green:Ye,yellow:Ze,black:Je},"4W":{red:Qe,green:Xe,yellow:et,black:tt},Tractor:{red:ot,green:nt,yellow:st,black:at},Harvestor:{red:rt,green:lt,yellow:ct,black:it},BUS:{red:ut,green:dt,yellow:ft,black:gt},default:{red:H,green:H,yellow:H,black:H}};let c=r[t]||r.default;if(!l)return c.black;if(l&&!n)return c.red;if(l&&n&&o>0)return c.green;if(l&&n&&o<=0)return c.yellow},me=(e,t,o,n)=>{var d,g,k;_(je(t.latestDocument.imei));const s={lat:(d=t==null?void 0:t.latestDocument)==null?void 0:d.lat,lng:(g=t==null?void 0:t.latestDocument)==null?void 0:g.lng};_(U(s)),_(Ae(15)),j.current||(j.current=new v.InfoWindow);const l=j.current,c=`
      <div>
        <h3>Registration No: ${((k=q.find(b=>{var E,W;return((E=b==null?void 0:b.imei[0])==null?void 0:E.mac_id)===((W=t==null?void 0:t.latestDocument)==null?void 0:W.imei)}))==null?void 0:k.registration_id)||""}</h3>
      </div>
    `;F===e?(l.close(),R(null)):(l.setContent(c),l.open(n,o),R(e))},Me=e=>{const t=h&&(h==null?void 0:h.length)>0&&h.find(o=>(o==null?void 0:o.value)===e&&o);V(t||null)};if(fe)return"Error loading maps";if(!X)return"Loading maps";if(!v)return null;const _e={height:"100vh",width:"100%",transition:"transform 0.5s ease-in-out"};return p.jsxs(p.Fragment,{children:[p.jsx(z,{sx:{position:"absolute",top:"780px",left:"250px",zIndex:1,background:Pe.bgColor,padding:"5px",borderRadius:"10px",color:"white"}}),p.jsxs(Fe,{id:"map",mapContainerStyle:_e,zoom:B,center:G,onLoad:e=>{le.current=e},options:{styles:Y?P:""},children:[Object.keys(f).length>0&&p.jsx(pt,{setPlace:m,place:w}),re||x?p.jsx(z,{sx:{position:"absolute",top:"50%",left:"50%"},children:p.jsx(yt,{})}):O&&O.length>0&&O.map((e,t)=>{var o,n;return p.jsx(We,{position:{lat:parseFloat((o=e==null?void 0:e.location)==null?void 0:o.lat),lng:parseFloat((n=e==null?void 0:e.location)==null?void 0:n.lng)},animation:window.google.maps.Animation.DROP,icon:{path:T[`${w}`],fillOpacity:2,strokeWeight:1,scale:1,fillColor:"orange"}},t)})]})]})}const kt="http://139.59.37.47:3031";function Rt(){const{locationData:x}=$(u=>u.liveMap),{vehicleNo:M,token:G}=Re(),[ne,f]=i.useState(!1),[q,B]=i.useState([]),{w_customer_id:T}=$(u=>u.auth),[y,O]=i.useState(!1),[se,K]=i.useState(!1),[ae,re]=i.useState(!0),[Y,P]=i.useState(!1);let h=de();i.useEffect(()=>{h(Ve({}))},[]),i.useEffect(()=>{v()},[]);const j=async()=>{try{const u=await Te.post(`${kt}/api/validate-token`,{token:G});console.log("response",u),u.data.valid?f(!0):f(!1)}catch{f(!1)}};i.useEffect(()=>{j()},[]),i.useEffect(()=>{var u;if(M){const w=(x==null?void 0:x.length)>0&&(x==null?void 0:x.filter(A=>Number(A.latestDocument.imei)===Number(M)));if((w==null?void 0:w.length)<=0){te.error("Data not available for this vehicle",{id:"clipboard"});return}const{lat:m,lng:D}=((u=w==null?void 0:w[0])==null?void 0:u.latestDocument)??{},S={lat:m||ue.lat,lng:D||ue.lat};h(U(S))}},[x]);const v=async()=>{try{P(!0);let u=[],w=[];const m=await h(Le({w_customer_id:T}));if(Array.isArray(m.payload)){m.payload.forEach(a=>{var F,R,Z,V;Array.isArray(a.imei)&&a.imei.length>0&&((F=a.imei[0])!=null&&F.mac_id)?(u.push({id:a.id,label:a.registration_id,value:(R=a.imei[0])==null?void 0:R.mac_id,vehilce_type:a==null?void 0:a.segment,chassis_no:a==null?void 0:a.chassis_no,engine_no:a==null?void 0:a.engine_no,workShop:a==null?void 0:a.workshop,registration_id:a==null?void 0:a.registration_id,sell_date:a==null?void 0:a.sell_date,customer_name:a==null?void 0:a.customer_name,vehicle_model:(Z=a==null?void 0:a.vehicle_model)==null?void 0:Z.name,vehicle_group:a==null?void 0:a.vehicle_group}),w.push((V=a.imei[0])==null?void 0:V.mac_id)):console.error("IMEI data not found for item:",a)});const D="one",S=w;w.length>0&&h(Ne({type:D,imei:S}));let A=u.filter(a=>a.value==M);B(A),h($e(u)),h(Be({w_customer_id:T})),P(!1)}else P(!1),console.error("Unexpected data format:",m),te.error("Unexpected data format:")}catch(u){console.error("Error fetching vehicle data:",u),te.error(`Error fetching vehicle data: ${u}`)}};return ne?p.jsx("div",{className:"app",children:p.jsx("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:p.jsx(z,{style:{display:"flex",width:"100%",height:"95vh"},children:p.jsx(z,{style:{width:y||se?"80%":"100%"},children:p.jsx(vt,{showCard:ae,loadingVehicle:Y,vehicleData:q})})})})}):p.jsx("h3",{children:"Invalid or Expired Link"})}export{Rt as default};
