import{k as _,r as i,i as K,aK as te,aT as oe,aU as ae,w as b,aV as U,aW as Q,aX as ie,aY as Y,P as H,C as ee,aZ as le,j as s,T as J,B as Z,I as ne,x as de,ai as ce,ax as ue,Z as z,K as he,L as me,N as pe,O as ge,t as fe}from"./index-BqbafYZ_.js";import{L as xe}from"./LiveMapTopBar-Z_1EdKZb.js";import{A as X,V as be}from"./VehicleMenu-BK6frfrr.js";import{L as _e,t as ve}from"./LeftSideBar2-CZpYIOYM.js";import"./Loader-ZFscCc2o.js";import"./LiveMapServices-BFWNuyH6.js";import"./Socket-0N_gnJcr.js";import{P as we}from"./Parameters-C2mcSZqn.js";/* empty css           */import"./proj-XQwXs9DQ.js";import{I as je}from"./InspectionsTable-DklIbmpT.js";import{d as ye}from"./Close-ByRrVX64.js";import{u as Be}from"./formik.esm-Ctx3TEWd.js";import{c as Se,a as m}from"./index.esm-DkA8kRq-.js";import{B as S,F as ke,a as Ce}from"./menu2-be6SFaqr.js";import{T as f,S as Ie,M as $}from"./TextField-pbAiEyqG.js";import{S as Ve}from"./SearchInput-BfjanyOL.js";import{D as Te,a as qe}from"./TablePagination-Ca3No-5S.js";import{D as Pe}from"./Edit-D_n5yfwn.js";import{V as Le}from"./VehicleGroups-D6t-2LiM.js";import"./jcb-aCHXMCXy.js";import"./index-CJxgHOxQ.js";import"./useControlled-Xop6mU4U.js";import"./createSvgIcon-BDSOXZTB.js";import"./index-CSuzkuwo.js";import"./Card-Br1VoqnT.js";import"./CardContent-D-W0CJcz.js";import"./TableRow-C52C7OlW.js";import"./TableCell-DGzQ8pqq.js";function Ee({searchTerm:O}){var V,W;const{vehicles_details:k}=_(t=>t.dashboard),{breakdownTopics:D,UpdatedBreakdownData:u}=_(t=>t.breakdown),{UpdatedInspectionData:o}=_(t=>t.inspection),{w_customer_id:v}=_(t=>t.auth),[x,w]=i.useState(null),[C,I]=i.useState(""),[L,p]=i.useState(!1);let n=K(),j=JSON.parse(localStorage.getItem("w_userDetails"));i.useEffect(()=>{console.log("UpdatedInspectionData",o)},[o]),i.useEffect(()=>{o&&(w(o.attachment),I("edit"))},[o]);const e=Be({initialValues:{vehicle:((V=o==null?void 0:o.vehicle)==null?void 0:V.id)||"",breakdown_topic:((W=o==null?void 0:o.breakdown_topic)==null?void 0:W.id)||"",odometer_reading:(o==null?void 0:o.odometer_reading)||"",description:(o==null?void 0:o.description)||"",mob_no:(o==null?void 0:o.mob_no)||"",email:(o==null?void 0:o.email)||"",attachment:(o==null?void 0:o.attachment)||"",submitted_by:`${j.first_name} ${j.last_name}`||"",resolved_issue:"",pending_issue:"",status:"Open"},validationSchema:Se({vehicle:m().required("Vehicle is required"),breakdown_topic:m().required("Breakdown Topic is required"),odometer_reading:m().required("Odometer Reading is required"),description:m().required("Description is required"),mob_no:m().matches(/^\d{10,11}$/,"Mobile number must be 10-11 digits").required("Mobile number is required"),email:m().email("Invalid email format").required("Email is required"),resolved_issue:m().required("Resolved issue is required"),pending_issue:m().required("Pending issue is required"),status:m().oneOf(["Open","Close","Rejected"],"Invalid status").required("Status is required"),submitted_by:m().required("Submitted is required")}),onSubmit:async(t,{resetForm:a})=>{try{p(!0),console.log("Submitted values:",t),t.submitted_by=j.user_id,t.location=u.location,t.breakdown=u.id,t.workshop_group=u.workshop_group.id;const d=[];if(u){if(u.attachment){let T=await te(u.attachment);console.log("file conversion",T),t.attachment=T}const y=u.id;d.push(n(oe({values:t,id:y})))}d.push(n(ae({values:t})));const R=await Promise.allSettled(d);let c=!0;R.forEach((y,T)=>{if(y.status==="fulfilled"){const F=y.value.payload;F.success?(T===0&&u?b.success("Breakdown updated successfully!"):b.success("Inspection created successfully!"),a(),I(""),w(null),n(U(null)),n(Q(!1)),n(ie(null)),n(Y(!1)),n(H(v)),n(ee()),p(!1)):(c=!1,b.error(F.error||"Failed to submit breakdown or inspection"))}else c=!1,b.error(y.reason.message||"Error occurred during submission")}),c&&(a(),I(""),w(null),n(U(null)),n(Y(!1)),n(le(!1)),n(H(v))),p(!1)}catch(d){console.error("Submission Error:",d),b.error("Failed to submit breakdown or inspection. Please try again."),p(!1)}}}),E=t=>{const a=t.currentTarget.files[0];if(e.setFieldValue("attachment",a),I((a==null?void 0:a.name)||""),a&&a.type.startsWith("image/")){const d=new FileReader;d.onload=()=>w(d.result),d.readAsDataURL(a)}else w(null)};return s.jsx(S,{sx:{p:3,maxWidth:600,margin:"auto"},children:L?s.jsx(J,{children:"Submitted the form data..."}):s.jsx(s.Fragment,{children:s.jsxs("form",{onSubmit:e.handleSubmit,children:[s.jsx(X,{options:k,getOptionLabel:t=>t.registration_id,value:k.find(t=>t.id===e.values.vehicle)||null,onChange:(t,a)=>e.setFieldValue("vehicle",(a==null?void 0:a.id)||""),renderInput:t=>s.jsx(f,{...t,label:"Vehicle",error:e.touched.vehicle&&!!e.errors.vehicle,helperText:e.touched.vehicle&&e.errors.vehicle,fullWidth:!0})}),s.jsx(X,{options:D,getOptionLabel:t=>t.topic,value:D.find(t=>t.id===e.values.breakdown_topic)||null,onChange:(t,a)=>e.setFieldValue("breakdown_topic",(a==null?void 0:a.id)||""),renderOption:(t,a)=>i.createElement("li",{...t,key:a.id},a.topic),renderInput:t=>s.jsx(f,{...t,label:"Breakdown Topic",error:e.touched.breakdown_topic&&!!e.errors.breakdown_topic,helperText:e.touched.breakdown_topic&&e.errors.breakdown_topic,fullWidth:!0,sx:{mt:2}})}),s.jsx(f,{label:"Odometer Reading",name:"odometer_reading",value:e.values.odometer_reading,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.odometer_reading&&!!e.errors.odometer_reading,helperText:e.touched.odometer_reading&&e.errors.odometer_reading,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Description",name:"description",value:e.values.description,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.description&&!!e.errors.description,helperText:e.touched.description&&e.errors.description,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Mobile Number",name:"mob_no",value:e.values.mob_no,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.mob_no&&!!e.errors.mob_no,helperText:e.touched.mob_no&&e.errors.mob_no,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Email",name:"email",type:"email",value:e.values.email,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.email&&!!e.errors.email,helperText:e.touched.email&&e.errors.email,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Submitted By",name:"submitted_by",value:e.values.submitted_by,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.submitted_by&&!!e.errors.submitted_by,helperText:e.touched.submitted_by&&e.errors.submitted_by,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Resolved Issue",name:"resolved_issue",value:e.values.resolved_issue,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.resolved_issue&&!!e.errors.resolved_issue,helperText:e.touched.resolved_issue&&e.errors.resolved_issue,fullWidth:!0,sx:{mt:2}}),s.jsx(f,{label:"Pending Issue",name:"pending_issue",value:e.values.pending_issue,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.pending_issue&&!!e.errors.pending_issue,helperText:e.touched.pending_issue&&e.errors.pending_issue,fullWidth:!0,sx:{mt:2}}),s.jsxs(ke,{fullWidth:!0,sx:{mt:2},children:[s.jsx(Ce,{children:"Status"}),s.jsxs(Ie,{label:"Status",name:"status",value:e.values.status,onChange:e.handleChange,onBlur:e.handleBlur,error:e.touched.status&&!!e.errors.status,children:[s.jsx($,{value:"Open",children:"Open"}),s.jsx($,{value:"Close",children:"Close"}),s.jsx($,{value:"Rejected",children:"Rejected"})]})]}),s.jsxs(Z,{component:"label",sx:{mt:2,border:"1px solid #f5f5f5",color:"black"},children:["Upload Attachment",s.jsx("input",{type:"file",hidden:!0,onChange:E})]}),C&&s.jsxs(J,{variant:"body2",sx:{mt:1},children:["Uploaded File: ",C]}),x&&s.jsx(S,{component:"img",src:x,alt:"Image Preview",sx:{mt:1,width:"100%",maxHeight:200}}),s.jsx(Z,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,sx:{mt:3},children:"Submit"})]})})})}function We({where:O}){const{isUpdateInspection:k,UpdatedInspectionData:D}=_(x=>x.inspection);let u=K();const o=()=>{u(Q(!1))},v={fontSize:"18px",fontWeight:500,lineHeight:"18.38px",textAlign:"center",paddingTop:"5px",fontFamily:"ubuntu"};return s.jsxs(S,{sx:{bgcolor:"white",m:"10px",display:"flex",textAlign:"left",justifyContent:"space-between",alignItems:"center",borderRadius:"6px",padding:"20px"},children:[s.jsx(Ve,{}),s.jsx(J,{variant:"h6",sx:v,children:"New Breakdown Requests"}),s.jsxs(Te,{open:k,onClose:o,maxWidth:"md",fullWidth:!0,children:[s.jsxs(Pe,{children:["Update Breakdown Status",s.jsx(ne,{"aria-label":"close",onClick:o,sx:{position:"absolute",right:8,top:8,color:x=>x.palette.grey[500]},children:s.jsx(ye,{})})]}),s.jsx(qe,{children:s.jsx(Ee,{})})]})]})}function us(){const{locationData:O,selectedVehicle:k,selectedParameterList:D}=_(l=>l.liveMap),{mode:u,selectedVehicleGroup:o}=_(l=>l.dashboard),v=ve(u),[x,w]=i.useState([]),{w_customer_id:C}=_(l=>l.auth),[I,L]=i.useState(),[p,n]=i.useState(!1),[j,e]=i.useState(!1),[E,V]=i.useState([]);i.useState(!0);const[W,t]=i.useState(!1),[a,d]=i.useState(!1),R=JSON.parse(localStorage.getItem("w_userDetails"));let c=K(),y=de();i.useEffect(()=>{ce.includes(R.role)?console.log("you can access this route"):(console.log("you can't access this route"),T())},[]);const T=()=>{console.log("oh! this route not allowed"),y("/dashboard"),b.error("You're not allowed to access inspection.")};i.useEffect(()=>{F(),c(ee()),c(H(C)),c(ue())},[]),i.useEffect(()=>{V([]),c(z([{reg_id:"",imei:"",params:[]}]))},[k]);const F=async()=>{try{d(!0);let l=[],g=[];const q=await c(he({w_customer_id:C}));if(Array.isArray(q.payload)){q.payload.forEach(r=>{var P,B,G,h;Array.isArray(r.imei)&&r.imei.length>0&&((P=r.imei[0])!=null&&P.mac_id)?(l.push({id:r.id,label:r.registration_id,value:(B=r.imei[0])==null?void 0:B.mac_id,vehilce_type:r==null?void 0:r.segment,chassis_no:r==null?void 0:r.chassis_no,engine_no:r==null?void 0:r.engine_no,workShop:r==null?void 0:r.workshop,registration_id:r==null?void 0:r.registration_id,sell_date:r==null?void 0:r.sell_date,customer_name:r==null?void 0:r.customer_name,vehicle_model:(G=r==null?void 0:r.vehicle_model)==null?void 0:G.name,vehicle_group:r==null?void 0:r.vehicle_group}),g.push((h=r.imei[0])==null?void 0:h.mac_id)):console.error("IMEI data not found for item:",r)});const N="one",M=g;g.length>0&&c(me({type:N,imei:M})),w(l),c(pe(l)),d(!1),c(ge({w_customer_id:C}))}else d(!1),console.error("Unexpected data format:",q),b.error("Unexpected data format:")}catch(l){console.error("Error fetching vehicle data:",l),b.error(`Error fetching vehicle data: ${l}`)}},se=async l=>{const{label:g,imei:q,id:N,reg_id:M,checked:r}=l;L(h=>h.map(A=>A.id===N?{...A,checked:!r}:A));let P=[...E],B=[...E];if(!r)O.forEach(h=>{h.latestDocument.imei===q&&(P.push({label:g,value:h.latestDocument[g==="maininputvoltage"?"mainInputVoltage":g]}),B=P,V(P))});else{let h=E.filter(A=>A.label!==g);B=h,V(h)}console.log("tempParamList",B),c(z([{reg_id:M,imei:q,params:B}]))},re=x.filter(l=>Object.keys(o).length===0||l.vehicle_group===o.id);return s.jsxs("div",{className:"app",children:[s.jsx(_e,{}),s.jsxs("main",{className:"content",style:{width:"100%",background:"#dad6d626"},children:[s.jsx(xe,{title:"Inspections",setShowVehicles:n,showVehicles:p,setShowVehiclesGroup:t,showVehiclesGroup:W}),s.jsx(Le,{setShowVehiclesGroup:t,showVehiclesGroup:W}),s.jsxs(S,{style:{display:"flex",width:"100%",height:"95vh"},children:[s.jsxs(S,{style:{width:p||j?"80%":"100%",background:fe.bgShadow},children:[s.jsx(We,{where:"inspection"}),s.jsx(je,{})]}),p&&s.jsx(S,{style:{width:"20%",backgroundColor:v.grey[100]},children:s.jsx(be,{vehicleData:re,title:"Inspections",setParameterData:L,loadingVehicle:a,setShowVehicles:n,showVehicles:p,showParameters:j,setShowParameters:e})}),j&&s.jsx(S,{style:{width:"20%",backgroundColor:v.grey[100]},children:s.jsx(we,{parametersData:I,setParameterData:L,handleParameterChange:se})})]})]})]})}export{us as default};
