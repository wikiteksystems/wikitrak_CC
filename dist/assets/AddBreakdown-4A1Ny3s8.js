import{z as P,b as w,y as A,aW as ce,b8 as de,br as ue,C as g,ba as Q,bd as K,be as O,$ as me,j as t,T as I,F as W,bs as pe,av as R,bl as X,D as H,I as Z}from"./index-CEzRChgC.js";import{d as U}from"./Close-CLIPdl_M.js";import{d as J}from"./Add-DHfP-j_g.js";import{a as he,u as ee,F as te}from"./formik.esm-CmCVf0t-.js";import{c as V,a as s}from"./index.esm-CgogikHX.js";import{B}from"./menu2-zBiw0l9T.js";import{A as z}from"./Autocomplete-DgxWdyei.js";import{T as c,M as oe}from"./TextField-DLtE_O06.js";import{S as xe}from"./SearchInput-C5BpIkDz.js";import{N as re}from"./NewLoader-WEqo-Pn1.js";import{D as ie,a as ae,b as le}from"./TablePagination-BSmpbPqI.js";function ge(){var n,a;const{vehicles_details:p}=P(e=>e.dashboard),{w_customer_id:C}=P(e=>e.auth),{breakdownTopics:j,UpdatedBreakdownData:i}=P(e=>e.breakdown),[h,x]=w.useState(null),[y,f]=w.useState(""),[_,q]=w.useState(!1),[T,k]=w.useState(!1),[L,F]=w.useState("");let N=A();w.useEffect(()=>{i&&(x(i.attachment),f("edit"))},[i]);const o=he({initialValues:{vehicle:((n=i==null?void 0:i.vehicle)==null?void 0:n.id)||"",breakdown_topic:((a=i==null?void 0:i.breakdown_topic)==null?void 0:a.id)||"",odometer_reading:(i==null?void 0:i.odometer_reading)||"",description:(i==null?void 0:i.description)||"",mob_no:(i==null?void 0:i.mob_no)||"",email:(i==null?void 0:i.email)||"",attachment:(i==null?void 0:i.attachment)||"",location:(i==null?void 0:i.location)||""},validationSchema:V({vehicle:s().required("Vehicle is required"),breakdown_topic:s().required("Breakdown Topic is required"),odometer_reading:s().required("Odometer Reading is required"),description:s().required("Description is required"),mob_no:s().matches(/^\d{10,11}$/,"Mobile number must be 10-11 digits").required("Mobile number is required"),email:s().email("Invalid email format").required("Email is required"),location:s().required("Location is required")}),onSubmit:async(e,{resetForm:r})=>{var l,u,b;try{q(!0),console.log("Submitted values:",e);const v=d(e.vehicle);e.user=v[0].user.id,e.status="Open",e.workshop_group=(b=(u=(l=v[0])==null?void 0:l.workShop)==null?void 0:u.group_name)==null?void 0:b.id,e.submission_date=new Date().toISOString().split("T")[0];let S;if(i){let E=await ce(i.attachment);console.log("file conversion",E),e.attachment=E;const D=i.id;S=await N(de({values:e,id:D}))}else S=await N(ue(e));if(S.payload.success)g.success("Breakdown submitted successfully!"),r(),f(""),x(null),N(Q(null)),N(K(!1)),N(O(!1)),N(me(C)),q(!1);else throw q(!1),new Error(S.payload.error||"Failed to submit breakdown")}catch(v){console.error("Submission Error:",v),g.error("Failed to submit breakdown. Please try again.")}}}),$=async()=>{k(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition(async e=>{const{latitude:r,longitude:l}=e.coords;try{const u=await pe(r,l);o.setFieldValue("location",u)}catch(u){console.error("Error fetching address:",u),g.error("Failed to convert coordinates to address.")}finally{k(!1)}},e=>{console.error("Geolocation Error:",e),g.error("Failed to retrieve location. Please try again."),k(!1)}):(g.error("Geolocation is not supported by this browser."),k(!1))},d=e=>(p==null?void 0:p.length)>0&&p.filter(l=>l.id===e),m=e=>{const r=e.currentTarget.files[0];if(o.setFieldValue("attachment",r),f((r==null?void 0:r.name)||""),r&&r.type.startsWith("image/")){const l=new FileReader;l.onload=()=>x(l.result),l.readAsDataURL(r)}else x(null)};return t.jsx(B,{sx:{p:3,maxWidth:600,margin:"auto"},children:_?t.jsx(I,{children:"Submitted the form data..."}):t.jsx(t.Fragment,{children:t.jsxs("form",{onSubmit:o.handleSubmit,children:[t.jsx(z,{options:p,getOptionLabel:e=>e.registration_id,value:p.find(e=>e.id===o.values.vehicle)||null,onChange:(e,r)=>o.setFieldValue("vehicle",(r==null?void 0:r.id)||""),renderInput:e=>t.jsx(c,{...e,label:"Vehicle",error:o.touched.vehicle&&!!o.errors.vehicle,helperText:o.touched.vehicle&&o.errors.vehicle,fullWidth:!0})}),t.jsx(z,{options:j,getOptionLabel:e=>e.topic,value:j.find(e=>e.id===o.values.breakdown_topic)||null,onChange:(e,r)=>o.setFieldValue("breakdown_topic",(r==null?void 0:r.id)||""),renderOption:(e,r)=>w.createElement("li",{...e,key:r.id},r.topic),renderInput:e=>t.jsx(c,{...e,label:"Breakdown Topic",error:o.touched.breakdown_topic&&!!o.errors.breakdown_topic,helperText:o.touched.breakdown_topic&&o.errors.breakdown_topic,fullWidth:!0,sx:{mt:2}})}),t.jsx(c,{label:"Odometer Reading",name:"odometer_reading",value:o.values.odometer_reading,onChange:o.handleChange,onBlur:o.handleBlur,error:o.touched.odometer_reading&&!!o.errors.odometer_reading,helperText:o.touched.odometer_reading&&o.errors.odometer_reading,fullWidth:!0,sx:{mt:2}}),t.jsx(c,{label:"Description",name:"description",value:o.values.description,onChange:o.handleChange,onBlur:o.handleBlur,error:o.touched.description&&!!o.errors.description,helperText:o.touched.description&&o.errors.description,fullWidth:!0,sx:{mt:2}}),t.jsx(c,{label:"Mobile Number",name:"mob_no",value:o.values.mob_no,onChange:o.handleChange,onBlur:o.handleBlur,error:o.touched.mob_no&&!!o.errors.mob_no,helperText:o.touched.mob_no&&o.errors.mob_no,fullWidth:!0,sx:{mt:2}}),t.jsx(c,{label:"Email",name:"email",type:"email",value:o.values.email,onChange:o.handleChange,onBlur:o.handleBlur,error:o.touched.email&&!!o.errors.email,helperText:o.touched.email&&o.errors.email,fullWidth:!0,sx:{mt:2}}),t.jsx(c,{label:"Location",name:"location",value:L||o.values.location,onChange:e=>{F(e.target.value),o.setFieldValue("location",e.target.value)},onBlur:o.handleBlur,error:o.touched.location&&!!o.errors.location,helperText:o.touched.location&&o.errors.location,fullWidth:!0,sx:{mt:2}}),t.jsx(W,{variant:"outlined",onClick:$,disabled:T,sx:{mt:2},children:T?"Fetching Location...":"Use Current Location"}),t.jsxs(W,{component:"label",sx:{mt:2,border:"1px solid #f5f5f5",color:"black"},children:["Upload Attachment",t.jsx("input",{type:"file",hidden:!0,onChange:m})]}),y&&t.jsxs(I,{variant:"body2",sx:{mt:1},children:["Uploaded File: ",y]}),h&&t.jsx(B,{component:"img",src:h,alt:"Image Preview",sx:{mt:1,width:"100%",maxHeight:200}}),t.jsx(W,{type:"submit",variant:"contained",color:"primary",fullWidth:!0,sx:{mt:3},children:"Submit"})]})})})}const Y="http://128.199.28.173/api/v1",fe=({setIsAdd:p,setIsUpdate:C})=>{const{vehicleList:j}=P(n=>n.liveMap),i=ee("(min-width:600px)"),[h,x]=w.useState(!1),[y,f]=w.useState(!1),_=A(),q=n=>{f(!0);const{firstName:a,lastName:e,email:r,mobile:l,password:u,vehicleNo:b,location:v,model:S,description:E}=n;console.log("Form Submitted:",n);let D={first_name:a,last_name:e,email:r,mobile:l,password:u};try{R.post(`${Y}/users/new/user/register/`,D).then(M=>{var G;let se={ticket_id:"",user:(G=M==null?void 0:M.data)==null?void 0:G.id,status:"open",description:E,latlong:v,vehicle:b,model:S};R.post(`${Y}/tickets/create/ticket/`,se).then(we=>{p(!1),C(!1),_(X()),f(!1),g.success("User registered and Ticket created successfully")}).catch(()=>{f(!1),g.error("Error occurred while creating ticket")})}).catch(M=>{f(!1),g.error("Error occurred while registering user")})}catch{f(!1),g.error("Error occurred while registering user")}},T=async n=>{x(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition(async a=>{const{latitude:e,longitude:r}=a.coords;try{n("location",`${e},${r}`)}catch(l){console.error("Error fetching address:",l),g.error("Failed to convert coordinates to address.")}finally{x(!1)}},a=>{console.error("Geolocation Error:",a),g.error("Failed to retrieve location. Please try again."),x(!1)}):(g.error("Geolocation is not supported by this browser."),x(!1))},k=/^((\+[1-9]{1,4}[ -]?)|(\([0-9]{2,3}\)[ -]?)|([0-9]{2,4})[ -]?)*?[0-9]{3,4}[ -]?[0-9]{3,4}$/,L=V().shape({firstName:s().required("required"),lastName:s().required("required"),fullName:s().required("required"),vehicleNo:s().required("required"),model:s().required("required"),email:s().email("invalid email").required("required"),mobile:s().matches(k,"Phone number is not valid").required("required"),location:s().required("required"),password:s().required("required"),description:s().required("required")}),F=JSON.parse(localStorage.getItem("w_userDetails")),{email:N,first_name:o,last_name:$,mobile:d}=F,m={firstName:o||"",lastName:$||"",fullName:`${o} ${$}`||"",vehicleNo:"",email:N||"",model:"",mobile:d||"",location:"",password:"",description:""};return t.jsxs(B,{m:"20px",children:[y&&t.jsx(re,{}),t.jsx(te,{onSubmit:q,initialValues:m,validationSchema:L,children:({values:n,errors:a,touched:e,handleBlur:r,handleChange:l,handleSubmit:u,setFieldValue:b})=>t.jsxs("form",{onSubmit:u,children:[t.jsxs(B,{display:"grid",gap:"30px",gridTemplateColumns:"repeat(4, minmax(0, 1fr))",sx:{"& > div":{gridColumn:i?void 0:"span 4"}},children:[t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"First Name",onBlur:r,onChange:l,value:n.firstName,name:"firstName",error:!!e.firstName&&!!a.firstName,helperText:e.firstName&&a.firstName,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Last Name",onBlur:r,onChange:l,value:n.lastName,name:"lastName",error:!!e.lastName&&!!a.lastName,helperText:e.lastName&&a.lastName,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Full Name",onBlur:r,onChange:l,value:n.fullName,name:"fullName",error:!!e.fullName&&!!a.fullName,helperText:e.fullName&&a.fullName,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,select:!0,variant:"filled",label:"Vehicle No",onBlur:r,onChange:v=>{const S=j.find(E=>E.registration_id===v.target.value);b("vehicleNo",v.target.value),b("model",(S==null?void 0:S.vehicle_model.name)||"")},value:n.vehicleNo,name:"vehicleNo",error:!!e.vehicleNo&&!!a.vehicleNo,helperText:e.vehicleNo&&a.vehicleNo,sx:{gridColumn:"span 2"},MenuProps:{PaperProps:{style:{maxHeight:200,overflowY:"auto"}}},children:j.map(v=>t.jsx(oe,{value:v.registration_id,children:v.registration_id},v.id))}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Email",onBlur:r,onChange:l,value:n.email,name:"email",error:!!e.email&&!!a.email,helperText:e.email&&a.email,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Model",value:n==null?void 0:n.model,name:"model",disabled:!0,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Mobile",onBlur:r,onChange:l,value:n.mobile,name:"mobile",error:!!e.mobile&&!!a.mobile,helperText:e.mobile&&a.mobile,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"password",label:"Password",onBlur:r,onChange:l,value:n.password,name:"password",error:!!e.password&&!!a.password,helperText:e.password&&a.password,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Location",onBlur:r,onChange:l,value:n.location,name:"location",disabled:!0,error:!!e.location&&!!a.location,helperText:e.location&&a.location,sx:{gridColumn:"span 2"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Description",onBlur:r,onChange:l,value:n.description,name:"description",error:!!e.description&&!!a.description,helperText:e.description&&a.description,sx:{gridColumn:"span 2"}}),t.jsx(W,{variant:"outlined",onClick:()=>T(b),disabled:h,sx:{mt:-2,width:"300px"},children:h?"Fetching Location...":"Use Current Location"})]}),t.jsx(B,{display:"flex",justifyContent:"center",mt:"25px",children:t.jsx(W,{type:"submit",color:"secondary",variant:"contained",children:"Submit"})})]})})]})},be="http://128.199.28.173/api/v1",ve=({userId:p,setIsAdd:C,setIsUpdate:j})=>{const i=A(),{vehicleList:h}=P(d=>d.liveMap),x=ee("(min-width:600px)"),[y,f]=w.useState(!1),_=d=>{const{description:m,vehicleNo:n,model:a,location:e}=d;let r={ticket_id:"",user:p,status:"open",description:m,latlong:e,vehicle:n,model:a};localStorage.getItem("w_userToken");try{R.post(`${be}/tickets/create/ticket/`,r).then(u=>{j(!1),C(!1),i(X()),g.success("Ticket created successfully")})}catch{g.error("Error occurred while creating ticket")}},q=async d=>{f(!0),navigator.geolocation?navigator.geolocation.getCurrentPosition(async m=>{const{latitude:n,longitude:a}=m.coords;try{d("location",`${n},${a}`)}catch(e){console.error("Error fetching address:",e),g.error("Failed to convert coordinates to address.")}finally{f(!1)}},m=>{console.error("Geolocation Error:",m),g.error("Failed to retrieve location. Please try again."),f(!1)}):(g.error("Geolocation is not supported by this browser."),f(!1))},T=V().shape({fullName:s().required("required"),vehicleNo:s().required("required"),model:s().required("required"),location:s().required("required"),description:s().required("required")}),k=JSON.parse(localStorage.getItem("w_userDetails")),{email:L,first_name:F,last_name:N,mobile:o}=k,$={fullName:`${F} ${N}`||"",vehicleNo:"",model:"",location:"",description:""};return t.jsx(B,{m:"20px",children:t.jsx(te,{onSubmit:_,initialValues:$,validationSchema:T,children:({values:d,errors:m,touched:n,handleBlur:a,handleChange:e,handleSubmit:r,setFieldValue:l})=>t.jsxs("form",{onSubmit:r,children:[t.jsxs(B,{display:"grid",gap:"30px",gridTemplateColumns:"repeat(4, minmax(0, 1fr))",sx:{"& > div":{gridColumn:x?void 0:"span 4"}},children:[t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Full Name",onBlur:a,onChange:e,value:d.fullName,name:"fullName",disabled:!0,error:!!n.fullName&&!!m.fullName,helperText:n.fullName&&m.fullName,sx:{gridColumn:"span 4"}}),t.jsx(c,{fullWidth:!0,select:!0,variant:"filled",label:"Vehicle No",onBlur:a,onChange:u=>{const b=h.find(v=>v.registration_id===u.target.value);l("vehicleNo",u.target.value),l("model",(b==null?void 0:b.vehicle_model.name)||"")},value:d.vehicleNo,name:"vehicleNo",error:!!n.vehicleNo&&!!m.vehicleNo,helperText:n.vehicleNo&&m.vehicleNo,sx:{gridColumn:"span 4"},SelectProps:{MenuProps:{PaperProps:{sx:{maxHeight:250,overflowY:"auto"}}}},children:h.map(u=>t.jsx(oe,{value:u.registration_id,children:u.registration_id},u.id))}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Model",value:d.model,name:"model",disabled:!0,sx:{gridColumn:"span 4"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Description",onBlur:a,onChange:e,value:d.description,name:"description",error:!!n.description&&!!m.description,helperText:n.description&&m.description,sx:{gridColumn:"span 4"}}),t.jsx(c,{fullWidth:!0,variant:"filled",type:"text",label:"Location",onBlur:a,onChange:e,value:d.location,name:"location",disabled:!0,error:!!n.location&&!!m.location,helperText:n.location&&m.location,sx:{gridColumn:"span 4"}}),t.jsx(W,{variant:"outlined",onClick:()=>q(l),disabled:y,sx:{mt:-2,width:"300px"},children:y?"Fetching Location...":"Use Current Location"})]}),t.jsx(B,{display:"flex",justifyContent:"center",mt:"25px",children:t.jsx(W,{type:"submit",sx:{backgroundColor:"#8DA6C6DD"},variant:"contained",children:"Submit"})})]})})})},je="http://128.199.28.173/api/v1";function Ee({where:p,isAdd:C,isUpdate:j,setIsUpdate:i,setIsAdd:h}){const{isAddBreakdown:x,isUpdateBreakdown:y,UpdatedBreakdownData:f}=P(d=>d.breakdown);let _=A();const[q,T]=w.useState(null),[k,L]=w.useState(!1),F=()=>{_(O(!1)),_(K(!1)),_(Q(null)),h(!1),i(!1)},N=()=>{_(O(!x))},o=async()=>{var a,e;L(!0);const d=JSON.parse(localStorage.getItem("w_userDetails")),{email:m}=d;let n={email:m};try{R.post(`${je}/users/check/user`,n).then(l=>{var u,b;(u=l==null?void 0:l.data)!=null&&u.success?(T((b=l==null?void 0:l.data)==null?void 0:b.user_id),i(!0),h(!0)):T(null),L(!1)}).catch(l=>{i(!1),h(!0),L(!1),console.log("error",l)})}catch(r){console.log("eror",r),h(!0),i(!1),L(!1),(e=(a=r==null?void 0:r.response)==null?void 0:a.data)!=null&&e.success}},$={fontSize:"18px",fontWeight:500,lineHeight:"18.38px",textAlign:"center",paddingTop:"5px",fontFamily:"ubuntu"};return t.jsxs(B,{sx:{bgcolor:"white",m:"10px",display:"flex",textAlign:"left",justifyContent:"space-between",alignItems:"center",borderRadius:"6px",padding:"20px"},children:[k&&t.jsx(re,{}),t.jsx(I,{variant:"h6",sx:$,children:`${p} New Requests`}),t.jsx(xe,{}),p.toLowerCase()==="breakdown"&&t.jsxs(W,{onClick:N,sx:{color:"black",background:H.bgColor},children:[t.jsx(J,{}),p]}),p.toLowerCase()==="rsa"&&t.jsxs(W,{onClick:o,sx:{color:"black",background:H.bgColor},children:[t.jsx(J,{}),"Raise ticket"]}),t.jsxs(ie,{open:x||y,onClose:F,maxWidth:"md",fullWidth:!0,children:[t.jsxs(ae,{children:[y?"Update":"Add"," Breakdown",t.jsx(Z,{"aria-label":"close",onClick:F,sx:{position:"absolute",right:8,top:8,color:d=>d.palette.grey[500]},children:t.jsx(U,{})})]}),t.jsx(le,{children:t.jsx(ge,{})})]}),t.jsx(ye,{isAdd:C,isUpdate:j,setIsUpdate:i,setIsAdd:h,handleClose:F,userId:q})]})}const ye=({isAdd:p,isUpdate:C,handleClose:j,userId:i,setIsAdd:h,setIsUpdate:x})=>(console.log("idupdate",C,p),t.jsxs(ie,{open:p,onClose:j,maxWidth:"md",fullWidth:!0,children:[t.jsxs(ae,{children:[C?"Ticket For RSA":"Registration form for RSA",t.jsx(Z,{"aria-label":"close",onClick:j,sx:{position:"absolute",right:8,top:8,color:y=>y.palette.grey[500]},children:t.jsx(U,{})})]}),t.jsx(le,{children:C?t.jsx(ve,{userId:i,setIsUpdate:x,setIsAdd:h,children:" "}):t.jsx(fe,{setIsUpdate:x,setIsAdd:h})})]}));export{Ee as A};
