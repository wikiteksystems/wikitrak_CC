import{r as a,k as j,j as r,i as Z,t as ee,B as H,aA as ge,R as de,aB as pe,a7 as _,J as ue,w as O}from"./index-C7djJrok.js";import{a as X,b as U,u as fe,G as me,P as xe}from"./esm-2IQ6u7-L.js";import{d as we}from"./dayjs.min-CxcwbX1a.js";import{m as $,t as Se,f as Me,a as ve}from"./preet_tractor-CDwt_mVh.js";import{T as ye,g as je}from"./TripVehicleInfo-pw0jBkFs.js";import{B as D,C as Pe}from"./menu2-CgqAzvxA.js";import{d as be}from"./Info-BIziA0bT.js";function ke({trip:t,tripPlay:n,setTripPlay:c,setSpeed:h}){const[l,f]=a.useState([]),[o,i]=a.useState(0),[u,d]=a.useState([]),[y,e]=a.useState([null]),V=a.useRef(null),{selectedVehicle:k}=j(g=>g.liveMap),{vehicles_details:C}=j(g=>g.dashboard),[W,F]=a.useState("2W");a.useEffect(()=>{e([null]);const g=[];if(t&&t.length>0&&(t==null||t.forEach(m=>{g.push(m.speed.toFixed(2))}),d(g)),t&&t.length>0){const m=t.map(S=>({lat:parseFloat(S.lat),lng:parseFloat(S.lng)}));f(m),e(m.slice(0))}},[t]),a.useEffect(()=>{if(n){const g=l.length,m=9e3,S=1e4,E=performance.now();let R=0;const P=A=>{const Y=A-E,B=Math.max(0,Math.min(Y/m,1)),b=Math.min(Math.floor(B*g),g-1);b!==V.current&&(i(b),h(u[b]),V.current=b),R<S&&(requestAnimationFrame(P),R++)};return requestAnimationFrame(P),()=>{}}},[n,l,u]);const z=g=>{const m=C&&C.length>0&&C.find(S=>S.value===g&&S.vehilce_type);return m?m.vehilce_type:null};a.useEffect(()=>{if(Object.keys(k).length>0){const g=z(k.imei);F(g)}},[k]);const I=a.useMemo(()=>{var g,m;return{lat:parseFloat((g=l[o])==null?void 0:g.lat),lng:parseFloat((m=l[o])==null?void 0:m.lng)}},[l,o]),G=a.useMemo(()=>({url:(()=>{switch(W){case"2W":return $;case"3W":return ve;case"4W":return Me;case"Tractor":return Se;default:return $}})(),size:new window.google.maps.Size(80,80),scaledSize:new window.google.maps.Size(80,80),fillOpacity:2,strokeWeight:1,scale:2}),[W]);return r.jsxs("div",{children:[y.length>0&&r.jsx(r.Fragment,{children:r.jsx(X,{path:y,options:{strokeColor:"red",strokeOpacity:1,strokeWeight:4}})}),n&&r.jsxs(r.Fragment,{children:[r.jsx(X,{path:l.slice(0,o+1),options:{strokeColor:"green",strokeOpacity:1,strokeWeight:4,zIndex:1e3,geodesic:!0}}),r.jsx(U,{position:I,icon:G},o)]})]})}function Ce({tripPlay:t,speed:n,totalDistance:c,Acreage:h,filterCoordinates:l,handleTrip:f,showGraph:o,handleShowGraph:i}){const{selectedTripData:u}=j(y=>y.dashboard);let d=Z();return r.jsxs(D,{sx:{bgcolor:ee.bgColor,position:"relative",color:"white",display:"flex",alignItems:"center",overflowX:"hidden",flexWrap:"wrap",border:"1px solid white",gap:"5px",paddingLeft:"5px",padding:"10px 10px"},children:[r.jsxs(H,{sx:{background:"white",border:"1px solid white",borderRadius:"5px",padding:"5px 20px",color:"black"},onClick:()=>{l(u,d)},children:[" ","Calculate Acerage"]}),r.jsxs(H,{sx:{background:t?"transparent":"white",border:"1px solid white",borderRadius:"5px",height:"38px",padding:"5px 20px",color:t?"white":"black","&:hover":{background:"transparent",color:"white"}},onClick:()=>{f()},children:[t?"Pause":"Play","-Trip"]}),r.jsxs(H,{style:{height:"38px",padding:"5px 20px"},sx:{background:o?"transparent":"white",border:"1px solid white",borderRadius:"5px",color:o?"white":"black","&:hover":{background:"transparent",color:"white"}},onClick:()=>{i()},children:[o?"Hide":"Show","-Graph"]})]})}const Fe=(t,n)=>{const l=[];t.length>0&&t.forEach(o=>{let i={latitude:o.lat,longitude:o.lng},u=[];t.forEach(d=>{const y={latitude:d.lat,longitude:d.lng};if(y.latitude&&y.longitude&&y.latitude!==i.latitude&&y.longitude!==i.longitude){const e=Ee(o.lat,o.lng,d.lat,d.lng);e<20&&e>10&&u.push(d)}}),u.length>10&&l.push(o)});const f=l.filter(o=>o.lat!==void 0&&o.lng!==void 0).map(o=>({lat:parseFloat(o.lat),lng:parseFloat(o.lng)}));if(f.length>0){n(pe(l));try{const o=Ie(f),i=Re(o),u=new window.google.maps.Polygon({paths:i});return Ae(u,n)}catch(o){return console.error("Error calculating convex hull or area:",o),n(_(0)),0}}else return n(_(0)),0},Ie=t=>{const n=(o,i,u)=>{const d=(i.lat-o.lat)*(u.lng-i.lng)-(i.lng-o.lng)*(u.lat-i.lat);return d===0?0:d>0?1:2},c=t.reduce((o,i)=>i.lng<o.lng?i:o);let h=[],l=c,f;do{h.push(l),f=t[0]===l?t[1]:t[0];for(let o=0;o<t.length;o++)n(l,f,t[o])===2&&(f=t[o]);l=f}while(l!==c);return h};function Ee(t,n,c,h){const f=t*Math.PI/180,o=c*Math.PI/180,i=(c-t)*Math.PI/180,u=(h-n)*Math.PI/180,d=Math.sin(i/2)*Math.sin(i/2)+Math.cos(f)*Math.cos(o)*Math.sin(u/2)*Math.sin(u/2);return 6371e3*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))}const Re=t=>{t.sort((h,l)=>h.lng-l.lng||h.lat-l.lat);const n=[],c=[];for(const h of t){for(;n.length>=2&&Q(n[n.length-2],n[n.length-1],h)<=0;)n.pop();n.push(h)}for(let h=t.length-1;h>=0;h--){const l=t[h];for(;c.length>=2&&Q(c[c.length-2],c[c.length-1],l)<=0;)c.pop();c.push(l)}return[...n.slice(0,-1),...c.slice(0,-1)]},Ae=(t,n)=>{if(!window.google||!window.google.maps.geometry){console.log("not loaded");return}const h=window.google.maps.geometry.spherical.computeArea(t.getPath())/4046.86;return n(_(h)),h},Q=(t,n,c)=>(n.lat-t.lat)*(c.lng-t.lng)-(n.lng-t.lng)*(c.lat-t.lat),Le=({selectedTrip:t,center:n,showCard:c})=>{var N,K;const h=Z(),{isLoaded:l,loadError:f}=fe({googleMapsApiKey:"AIzaSyD8TrUWS9FRTu-MRP339mJF_iWlORvEGUA"}),{Acreage:o}=j(s=>s.tripMonitor),{selectedVehicle:i}=j(s=>s.liveMap),{singleTrip_Data:u,tripLoading:d,cords:y}=j(s=>s.tripMonitor),{selectedTripData:e,mode:V,styles:k}=j(s=>s.dashboard),{collapsed:C}=j(s=>s.auth),W=a.useRef(null),[F,z]=a.useState(null),[I,G]=a.useState(null),[g,m]=a.useState([]);a.useState([]);const[S,E]=a.useState(!1),[R,P]=a.useState(0),[A,Y]=a.useState(!1),[B,b]=a.useState(0),[te,Oe]=a.useState([]);a.useState([]);const[T,q]=a.useState(!1),[oe,ne]=a.useState({});a.useEffect(()=>{q(!0)},[i]),a.useEffect(()=>{(async()=>{if(i!=null&&i.imei){const M=we(),v=M.startOf("day").format("MM/DD/YYYY HH:mm:ss"),p=M.endOf("day").format("MM/DD/YYYY HH:mm:ss"),w={imei:[i.imei],startDate:v,endDate:p};try{const x=await ue(w);console.log("result",x.data[0].data),ne(x.data[0].data)}catch(x){console.error("Error fetching report:",x)}}})()},[i,h]),a.useEffect(()=>{F&&I&&F.fitBounds(I)},[F,I,e]),a.useEffect(()=>{if(console.log("selectedTripData",e),(e==null?void 0:e.length)>0){const s=se({selectedTripData:e});b(s)}},[e]);const se=({selectedTripData:s})=>{const M=s.reduce((v,p,w)=>{if(w===0)return v;const x=s[w-1],L=ge(x.lat,x.lng,p.lat,p.lng);return v+L},0);return M==null?void 0:M.toFixed(2)};a.useEffect(()=>{var s,M,v,p,w;if(e&&(e==null?void 0:e.length)>0){const x=new window.google.maps.LatLngBounds,L=new window.google.maps.LatLng(parseFloat((s=e[0])==null?void 0:s.lat),parseFloat((M=e[0])==null?void 0:M.lng)),he=new window.google.maps.LatLng(parseFloat((v=e[(e==null?void 0:e.length)-1])==null?void 0:v.lat),parseFloat((p=e[(e==null?void 0:e.length)-1])==null?void 0:p.lng));x.extend(L),x.extend(he),P((w=e[0])==null?void 0:w.speed),G(x)}E(!1),ae()},[e]);const ae=()=>{if(e&&e.length>0){const s=(p,w)=>{const L=new Date(p.createdAt).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0});return{Date:p.createdAt.substring(0,10),Time:L,value:p[w]}},v=["speed","mainInputVoltage","ignition"].map(p=>({label:p==="speed"?"Speed":p==="mainInputVoltage"?"MainInputVoltage":"Ignition",randomColor:re(),data:e.map(w=>s(w,p))}));m(v)}else m([])},re=()=>"#"+Math.floor(Math.random()*16777215).toString(16),le=()=>{var s;if((e==null?void 0:e.length)>0)E(!S),P(0);else return((s=Object.keys(e))==null?void 0:s.length)===0?O.error("Please Select Vehicle",{id:"vehicle"}):O.error("Please Select Trip",{id:"trip error"})},ie=()=>{var s;if((e==null?void 0:e.length)>0)Y(!A);else return((s=Object.keys(e))==null?void 0:s.length)===0?O.error("Please Select Vehicle",{id:"vehicle"}):O.error("Please Select Trip",{id:"trip error"})},J=()=>{Object.keys(i).length>0||T?q(!T):O.error("Please select any vehicle")};if(f)return"Error loading maps";if(!l)return"Loading maps";const ce={width:"100%",height:c?"87vh":"93vh"};return r.jsxs(r.Fragment,{children:[d&&r.jsx(D,{sx:{position:"absolute",top:"50vh",left:"50%",zIndex:"1000"},children:r.jsx(Pe,{})}),c&&r.jsx(Ce,{tripPlay:S,speed:R,totalDistance:B,Acreage:o,filterCoordinates:Fe,handleTrip:le,showGraph:A,handleShowGraph:ie}),r.jsx(D,{sx:{position:"absolute",top:"795px",left:C?"74px":"250px",zIndex:1,background:ee.bgColor,padding:"5px",borderRadius:"10px",color:"white"},children:r.jsxs(H,{sx:{color:"white"},onClick:J,children:[T?"Hide":"Show"," Vehicle Info",r.jsx(be,{})]})}),T===!0&&r.jsx(ye,{handleVehicleInfo:J,vehicleReport:oe,tripPlay:S,speed:R,totalDistance:B,Acreage:o,whereToUse:"TripMonitor"}),r.jsxs(me,{ref:W,mapContainerStyle:ce,zoom:10,center:n,onLoad:s=>z(s),options:{styles:V?k:""},children:[r.jsx(xe,{paths:te,options:{fillColor:"#00FF00",fillOpacity:.4,strokeColor:"#000",strokeOpacity:1,strokeWeight:2}}),e&&(e==null?void 0:e.length)>0&&(e==null?void 0:e.map((s,M)=>{var v,p,w,x;return r.jsxs(de.Fragment,{children:[r.jsx(U,{position:{lat:parseFloat((v=e[0])==null?void 0:v.lat),lng:parseFloat((p=e[0])==null?void 0:p.lng)},animation:"BOUNCE",icon:{url:"http://maps.google.com/mapfiles/ms/icons/green-dot.png"}}),r.jsx(ke,{trip:e,tripPlay:S,setTripPlay:E,setSpeed:P}),r.jsx(U,{position:{lat:parseFloat((w=e[(e==null?void 0:e.length)-1])==null?void 0:w.lat),lng:parseFloat((x=e[(e==null?void 0:e.length)-1])==null?void 0:x.lng)},animation:"BOUNCE",icon:{url:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"}})]},M)})),r.jsx("div",{style:{position:"relative",top:200,left:12,color:"green"},children:((K=(N=g[0])==null?void 0:N.data)==null?void 0:K.length)>0&&A&&r.jsx(je,{item:g})})]})]})},Ye=Le;export{Ye as T,Fe as f};
